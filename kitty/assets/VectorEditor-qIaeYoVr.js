import{EcsComponentType as lt,tsObject as ut,tsArray as $e,vec2TypeSchema as ft,tsBoolean as ct,tsNumber as Be,s as J,Vec2 as ht,t as Z,d as xe,a as vt,EcsWorld as Rt,u as Ct,i as Ue}from"./lib-Dbgxobrh.js";import{q as W,l as Q,F as _t,s as ie,I as dt,S as St,m as re,Y as ne,O as pt,N as le,w as mt,b as Et,c as Dt}from"./dev-B9-ass9r.js";import{a as Ie}from"./dev-CC7pdsS5.js";import{i as Nt}from"./index-XNH-lkY3.js";const $t=ut({controlPoints:$e(ft),isClosed:ct()}),yt=new lt({typeName:"CatmullRomSpline",typeSchema:$t}),xt=ut({controlPoints:$e(ft),weights:$e(Be()),degree:Be(),closed:ct()}),gt=new lt({typeName:"Nurbs",typeSchema:xt});var de,Ke;function wt(){return Ke||(Ke=1,de=function(i){if(!i||!i.dtype)return!1;var a=new RegExp("function View[0-9]+d(:?"+i.dtype+")+");return a.test(String(i.constructor))}),de}var pe,We;function ze(){return We||(We=1,pe=function(i){return i?i.data!==void 0&&Array.isArray(i.shape)&&i.offset!==void 0&&i.stride!==void 0:!1}),pe}var me,Ze;function se(){return Ze||(Ze=1,me=function(a){return Array.isArray(a)||ArrayBuffer.isView(a)}),me}var ye,Xe;function ae(){if(Xe)return ye;Xe=1;var i=wt(),a=ze(),s=se();function c(r){if(r){if(i(r)||a(r))return r.dtype==="generic"?c.GENERIC_NDARRAY:c.NDARRAY;if(s(r))return c.ARRAY_OF_ARRAYS;throw new Error("Unhandled data type. Got type: "+typeof r)}}return c.ARRAY_OF_ARRAYS="Arr",c.NDARRAY="Nd",c.GENERIC_NDARRAY="GenNd",c.PACKED="PackArr",ye=c,ye}var ge,He;function It(){if(He)return ge;He=1;var i=se();function a(s){return s[0].toUpperCase()+s.slice(1)}return ge=function(s,c,r,l,t,v){var n,u=[],y=!1;for(n=0;n<s.splineDimension;n++){var P=i(s.knots)&&i(s.knots[n]);P&&(y=!0),u.push("Deg"+s.degree[n]+(P?"":"Uniform")+a(s.boundary[n]))}var R=[[y?"NU":"",s.weights?"RBS":"BS"].join("")+s.dimension+"D",u.join("_")];return l&&R.push(l+"Pts"),t&&R.push(t+"Wts"),v&&R.push(v+"Kts"),c&&R.push("debug"),r&&R.push("chk"),R.join("_")},ge}var we,Je;function fe(){if(Je)return we;Je=1;var i=function a(s,c){return function(r,l){r!==void 0&&!Array.isArray(r)&&(r=[r]);for(var t=[],v=0;v<r.length;v++)t.push(a.sum(r[v]));if(l)for(r=0;r<t.length;r++)l[r]!==void 0&&(t[r]="("+t[r]+" + "+l[r]+") % "+l[r]);return s+t.join("_")}};return i.sum=function(a){return a=Array.isArray(a)?a:[a],a=a.filter(function(s){return s!==void 0&&s!==0}),a.length===0&&a.push(0),a.join(" + ")},we=i,we}var Ae,Qe;function zt(){if(Qe)return Ae;Qe=1;var i=ae(),a=fe();function s(r){return function(l,t){l!==void 0&&!Array.isArray(l)&&(l=[l]);for(var v=[],n=0;n<l.length;n++)v.push(a.sum(l[n]));if(t)for(l=0;l<v.length;l++)t[l]!==void 0&&(v[l]="("+v[l]+" + "+t[l]+") % "+t[l]);return r(v)}}function c(r,l){var t;if(l)switch(i(l)){case i.ARRAY_OF_ARRAYS:return s(function(v){return r+"["+v.join("][")+"]"});case i.GENERIC_NDARRAY:return s(function(v){return r+".get("+v.join(",")+")"});case i.NDARRAY:return s(function(v){var n=[r+"Offset"];for(t=0;t<v.length;t++)n.push(r+"Stride"+t+" * ("+v[t]+")");return r+"["+n.join(" + ")+"]"});case i.PACKED:default:return}}return Ae=function(r){var l={},t;return t=c("x",r.points),t&&(l.point=t),t=c("w",r.weights),t&&(l.weight=t),t=c("k",r.knots),t&&(l.knot=t),l},Ae}var ke,et;function jt(){if(et)return ke;et=1;var i=[],a=[];return ke=function(c,r,l){if(r!==1)throw new Error("Numerical derivative not implemented for order n = "+r+".");var t,v=arguments[this.splineDimension+3]===void 0?1e-4:arguments[this.splineDimension+3];for(i.length=this.splineDimension,t=0;t<this.splineDimension;t++)i[t+1]=arguments[t+3];var n=this.domain,u=n[l][0],y=n[l][1],P,R,k,C=i[l+1],o=(y-u)*v;for(this.boundary[l]==="closed"?(k=y-u,P=u+(C-u-o+k)%k,R=u+(C-u+o+k)%k,o*=2):(P=Math.min(y,Math.max(u,C-o)),R=Math.min(y,Math.max(u,C+o)),o=R-P),i[l+1]=P,i[0]=a,this.evaluate.apply(null,i),i[l+1]=R,i[0]=c,this.evaluate.apply(null,i),t=0;t<this.dimension;t++)c[t]=(c[t]-a[t])/o;return c},ke}var Pe,tt;function At(){return tt||(tt=1,Pe=function(a,s){for(var c=1,r=0,l=[];r<a.length;r++)c*=Array.isArray(a[r])?a[r][1]-a[r][0]:a[r],l[r]=Array.isArray(a[r])?a[r][0]:0;for(var t=0;t<c;t++)for(s(l.slice()),r=a.length-1;r>=0;r--)if(l[r]===(Array.isArray(a[r])?a[r][1]:a[r])-1)l[r]=Array.isArray(a[r])?a[r][0]:0;else{l[r]++;break}}),Pe}var be,rt;function je(){if(rt)return be;rt=1;var i=ae();return be=function(a,s,c,r){var l,t=[];switch(i(r)){case i.NDARRAY:for(t.push("  var "+s+" = "+c+".data;"),t.push("  var "+s+"Offset = "+c+".offset;"),l=0;l<r.dimension;l++)t.push("  var "+s+"Stride"+l+" = "+c+".stride["+l+"];");break;case i.ARRAY_OF_ARRAYS:t.push("  var "+s+" = "+c+";")}return t.join(`
`)},be}var Re,nt;function qe(){if(nt)return Re;nt=1;var i=ze();return Re=function(a,s,c){if(a){if(i(a))return s+".shape["+c+"]";for(var r=s,l=0;l<c;l++)r+="[0]";return r+".length"}else return"this.size["+c+"]"},Re}var Ce,it;function qt(){if(it)return Ce;it=1;var i=At(),a=fe(),s=je(),c=ae(),r=se(),l=qe(),t={},v={};return Ce=function(n,u,y,P,R,k,C){var o=u.splineDimension,f,p,m,d,e,h,b=u.points,g=u.degree,z=u.weights,_=z!==void 0,E=u.knots,N=u.dimension,A=u.boundary;if(C!=null){Array.isArray(C)||(C=[C]);var j=0;for(f=0;f<o;f++)C[f]===void 0&&(C[f]=0),j+=C[f];if(_&&j>1)throw new Error("Analytical derivative not implemented for rational b-splines with order n = "+j+".")}k&&(n="Basis"+n),C&&(n="Der"+C.join("_")+"_"+n);var M=t[n];if(P)var X=typeof P=="function"?P:console.log;if(M)return P&&X(v[n]),M.bind(u);var q=[],V="evaluate"+n,F=y.point;k&&(F=function($,x){for(var T=[],S=0;S<$.length;S++){for(var I=$[S],K=[],te=0;te<I.length;te++)I[te]!==0&&K.push(I[te]);I=K.join(" + "),x[S]&&(I="("+I+" + "+x[S]+") % "+x[S]),T.push(I+" === "+Ye(S))}return"(("+T.join(" && ")+") ? 1 : 0)"});var U=y.weight,O=y.knot,D=a("k"),L=a("x"),G=a("w"),Ye=a("i"),ee=a("t"),oe=P?"domain":"d",B=a(P?"size":"s"),Y=a(P?"knotIndex":"j"),Te=!0;for(e=0;e<o;e++)r(E)&&r(E[e])&&(Te=!1);function w($){q.push("  "+($||""))}function H($){P&&w($)}if(k)var Le=[];var Fe=[];for(f=0;f<o;f++)k&&Le.push(Ye([f])),Fe.push(ee([f]));for(q.push("function "+V+" ("+(k?"":"out, ")+Fe.join(", ")+(k?", "+Le.join(", "):"")+") {"),w("var h, m, a, b;"),R&&(w("var "+oe+" = this.domain;"),w("for (var i = 0; i < this.splineDimension; i++) {"),w("  a = arguments[i + 1];"),w("  if (a < "+oe+"[i][0] || a > "+oe+"[i][1] || a === undefined || isNaN(a)) {"),w("    throw new Error('Invalid Spline parameter in dimension '+i+'. Valid domain is ['+"+oe+"[i][0]+', '+"+oe+"[i][1]+']. but got t'+i+' = '+arguments[i + 1]+'.');"),w("  }"),w("}")),e=0;e<o;e++)w("var "+B(e)+" = "+l(b,"this.points",e)+";");q.push(s(u,"x","this.points",b)),_&&q.push(s(u,"w","this.weights",z)),Te||q.push(s(u,"k","this.knots",E));function Oe($,x,T){return"("+$+") ? ("+x+") : ("+T+")"}var ce=[];for(e=0;e<o;e++)switch(c(E)){case c.NDARRAY:ce[e]=!0;break;case c.ARRAY_OF_ARRAYS:ce[e]=r(E[e]);break}for(e=0;e<o;e++)if(ce[e])for(H(`
  // Bisect to locate the knot interval in dimension `+e+`
`),w("var "+Y(e)+" = 0;"),w("h = "+B(e)+";"),w("while(h > "+Y(e)+" + 1) {"),w("  m = 0.5 * (h + "+Y(e)+") | 0;"),w("  if ("+O([e,"m"])+" > "+ee(e)+") h = m;"),w("  else "+Y(e)+" = m;"),w("}"),H(`
  // Fetch knots for dimension `+e+`
`),f=-g[e]+1;f<=g[e];f++)A[e]==="closed"?f<0?w("var "+D([e,f+g[e]-1])+" = "+Oe(Y(e)+" < "+-f,O([e,0])+" + "+O([e,[B(e),Y(e),f]])+" - "+O([e,[B(e)]]),O([e,[Y(e),f]]))+";"):f>0?w("var "+D([e,f+g[e]-1])+" = "+Oe(Y(e)+" + "+f+" > "+B(e),O([e,B(e)])+" + "+O([e,f+" + "+Y(e)+" - "+B(e)])+" - "+O([e,0]),O([e,[Y(e),f]]))+";"):w("var "+D([e,f+g[e]-1])+" = "+O([e,[Y(e),f]])+";"):w("var "+D([e,f+g[e]-1])+" = "+O([e,[Y(e),f]])+";");else{for(H(`
  // Directly compute knot interval for dimension `+e+`
`),A[e]==="closed"?w(Y(e)+" = ("+ee(e)+" | 0) % "+B(e)+";"):(w(Y(e)+" = ("+ee(e)+" | 0);"),w("if ("+Y(e)+" < "+g[e]+") "+Y(e)+" = "+g[e]+";"),w("if ("+Y(e)+" > "+B(e)+" - 1) "+Y(e)+" = "+B(e)+" - 1;")),H(`
  // Compute and clamp knots for dimension `+e+`
`),f=-g[e]+1;f<=g[e];f++)h=D([e,f+g[e]-1]),w("var "+h+" = "+Y(e)+" + "+f+";");if(A[e]==="clamped")for(f=-g[e]+1;f<=g[e];f++)h=D([e,f+g[e]-1]),f<0&&w("if ("+h+" < "+g[e]+") "+h+" = "+g[e]+";"),f>0&&w("if ("+h+" > "+B(e)+") "+h+" = "+B(e)+";");A[e]==="closed"&&(H(`
  // Wrap the B-Spline parameter for closed boundary`),w(ee(e)+" %= "+B(e)+";"))}for(e=0,m=[];e<o;e++)m[e]=g[e]+1;for(_&&(H(`
  // Fetch weights
`),i(m,function($){for(var x=[],T=[],S=0;S<o;S++)x[S]=[Y(S),$[S]-g[S]],A[S]==="closed"&&$[S]-g[S]<0&&(T[S]=B(S));w("var "+G($)+" = "+U(x,T)+";")})),P&&w(_?`
  // Fetch points and project into homogeneous (weighted) coordinates
`:`
  // Fetch points
`),i(m,function($){for(var x=[],T=[],S=0;S<o;S++)x[S]=[Y(S),$[S]-g[S]],A[S]==="closed"&&$[S]-g[S]<0&&(T[S]=B(S));if(k)w(_?"var "+L($)+" = "+F(x,T)+" * "+G($)+";":"var "+L($)+" = "+F(x,T)+";");else for(S=0;S<N;S++){var I=$.concat(S);x[o]=S,w(_?"var "+L(I)+" = "+F(x,T)+" * "+G($)+";":"var "+L(I)+" = "+F(x,T)+";")}}),H(`
`),H("// Perform De Boor's algorithm"),e=m.length-1;e>=0;e--)for(m[e]=[g[e],g[e]+1],f=0;f<g[e];f++)for(H(`
  // Degree `+g[e]+" evaluation in dimension "+e+", step "+(f+1)+`
`),p=g[e];p>f;p--){var he=C&&g[e]-f-C[e]<=0;he?(w("m = 1 / ("+D([e,p-f+g[e]-1])+" - "+D([e,p-1])+");"),_&&(w("a = ("+ee(e)+" - "+D([e,p-1])+") * m;"),w("b = 1 - a;"))):(w("a = ("+ee(e)+" - "+D([e,p-1])+") / ("+D([e,p-f+g[e]-1])+" - "+D([e,p-1])+");"),w("b = 1 - a;")),_&&i(m,function($){var x=$.slice(),T=$.slice();x[e]=p,T[e]=p-1,he&&_&&w("h = "+G(x)+";"),w(G(x)+" = b * "+G(T)+" + a * "+G(x)+";")}),i(m,function($){var x,T,S,I=$.slice(),K=$.slice();if(I[e]=p,K[e]=p-1,he){var te=f+1;if(k)x=_?"h * "+G(K)+" / "+G(I)+" * ":"",T=L(I)+(_?" / h":""),S=L(K)+(_?" / "+G(K):""),w(L(I)+" = "+te+" * "+x+"("+T+" - "+S+") * m;");else{var ve=I.slice(),Ge=K.slice();for(d=0;d<N;d++)ve[o]=Ge[o]=d,x=_?"h * "+G(K)+" / "+G(I)+" * ":"",T=L(ve)+(_?" / h":""),S=L(Ge)+(_?" / "+G(K):""),w(L(ve)+" = "+te+" * "+x+"("+T+" - "+S+") * m;")}}else if(k)w(L(I)+" = b * "+L(K)+" + a * "+L(I)+";");else for(d=0;d<N;d++)I[o]=K[o]=d,w(L(I)+" = b * "+L(K)+" + a * "+L(I)+";")}),H(`
`)}if(P&&w(_?`
  // Project back from homogeneous coordinates and return final output
`:`
  // Return final output
`),k)w(_?"return "+L(g)+" / "+G(g)+";":"return "+L(g)+";");else for(e=0;e<N;e++)w(_?"out["+e+"] = "+L(g.concat([e]))+" / "+G(g)+";":"out["+e+"] = "+L(g.concat([e]))+";");if(k||w("return out;"),q.push("}"),P){var Ve=q.join(`
`);X(Ve),v[n]=Ve}var Me=new Function([q.join(`
`),"; return ",V].join(""))();return t[n]=Me,Me.bind(u)},Ce}var _e,ot;function Yt(){if(ot)return _e;ot=1;var i={},a=je(),s=qe(),c=fe();return _e=function(l,t,v,n){var u,y,P,R,k,C,o,f,p=i[l];if(p)return p.bind(t);var m=[],d="transform"+l;m.push("function "+d+"(m) {"),m.push("var i, w;"),m.push(a(t,"x","this.points",t.points));var e=c(n?"size":"s");for(u=0;u<t.splineDimension;u++)m.push("var "+e(u)+" = "+s(t.points,"this.points",u)+";");for(R=[],u=0;u<t.splineDimension;u++)P="i"+u,R.push(P),m.push("for ("+P+" = "+e(u)+"- 1; "+P+" >= 0; "+P+"--) {");for(u=0;u<t.dimension;u++)m.push("x"+u+" = "+v.point(R.concat([u])));for(k=[],u=0;u<t.dimension;u++)k.push("m["+((t.dimension+1)*(u+1)-1)+"] * x"+u);for(k.push("m["+((t.dimension+1)*(t.dimension+1)-1)+"]"),m.push("var w = ("+k.join(" + ")+") || 1.0;"),u=0;u<t.dimension;u++){for(k=[],C=t.dimension,y=0;y<C;y++)k.push("m["+(y*(C+1)+u)+"] * x"+y);k.push("m["+(y*(C+1)+u)+"]"),f=v.point(R.concat([u])),o="("+k.join(" + ")+") / w",m.push(f+" = "+o+";")}for(u=t.splineDimension-1;u>=0;u--)m.push("}");m.push("return this;"),m.push("}");var h=new Function([m.join(`
`),"; return ",d].join(""))();return n&&console.log(m.join(`
`)),i[l]=h,h.bind(t)},_e}var Se,st;function Tt(){if(st)return Se;st=1;var i=At(),a=fe(),s=je(),c=ae(),r=se(),l=qe(),t={};return Se=function(v,n,u,y,P){var R=t[v];if(R)return R.bind(n);var k=n.degree,C=n.knots,o=n.splineDimension,f=n.boundary,p,m,d,e=[],h="support"+v,b=u.knot,g=a("t"),z=y?"domain":"d",_=a(y?"size":"s"),E=a(y?"knotIndex":"i"),N=!0;for(d=0;d<o;d++)r(C)&&r(C[d])&&(N=!1);function A(F){e.push("  "+(F||""))}var j=[];for(p=0;p<o;p++)j.push(g([p]));e.push("function "+h+" (out, "+j.join(", ")+") {");var M=0;function X(F,U){A(U===void 0?"out["+M+++"] = "+F.join(" + ")+";":"out["+M+++"] = ("+F.join(" + ")+" + "+U+") % "+U+";")}for(A("var h, m;"),A("var c = 0;"),P&&(A("var "+z+" = this.domain;"),A("for (var i = 0; i < this.splineDimension; i++) {"),A("  a = arguments[i + 1];"),A("  if (a < "+z+"[i][0] || a > "+z+"[i][1] || a === undefined || isNaN(a)) {"),A("    throw new Error('Invalid Spline parameter in dimension '+i+'. Valid domain is ['+"+z+"[i][0]+', '+"+z+"[i][1]+']. but got t'+i+' = '+arguments[i + 1]+'.');"),A("  }"),A("}")),d=0;d<o;d++)A("var "+_(d)+" = "+l(n.points,"this.points",d)+";");N||e.push(s(n,"k","this.knots",C));var q=[];for(d=0;d<o;d++)switch(c(C)){case c.NDARRAY:q[d]=!0;break;case c.ARRAY_OF_ARRAYS:q[d]=r(C[d]);break}for(d=0;d<o;d++)q[d]?(A("var "+E(d)+" = 0;"),A("h = "+_(d)+";"),A("while(h > "+E(d)+" + 1) {"),A("  m = 0.5 * (h + "+E(d)+") | 0;"),A("  if ("+b([d,"m"])+" > "+g(d)+") h = m;"),A("  else "+E(d)+" = m;"),A("}")):f[d]==="closed"?A(E(d)+" = ("+g(d)+" | 0) % "+_(d)+";"):(A(E(d)+" = ("+g(d)+" | 0);"),A("if ("+E(d)+" < "+k[d]+") "+E(d)+" = "+k[d]+";"),A("if ("+E(d)+" > "+_(d)+" - 1) "+E(d)+" = "+_(d)+" - 1;"));for(d=0,m=[];d<o;d++)m[d]=k[d]+1;i(m,function(F){for(var U=[],O=[],D=0;D<o;D++)U[D]=[E(D),F[D]-k[D]],f[D]==="closed"&&F[D]-k[D]<0&&(O[D]=_(D));for(D=0;D<o;D++)X(U[D],O[D])}),A("out.length = "+M+";"),A("return out;"),e.push("}"),y&&console.log(e.join(`
`));var V=new Function([e.join(`
`),"; return ",h].join(""))();return t[v]=V,V.bind(n)},Se}var Ee,at;function Lt(){if(at)return Ee;at=1;var i=ae(),a=It(),s=wt(),c=ze(),r=zt(),l=jt(),t=se(),v=qt(),n=Yt(),u=Tt(),y={open:"open",closed:"closed",clamped:"clamped"};function P(o){return o==null}function R(o,f,p,m,d,e){var h,b;o&&!t(o)&&!s(o)?(e=o,this.debug=o.debug,this.checkBounds=!!o.checkBounds,this.weights=o.weights,this.knots=o.knots,this.degree=o.degree,this.boundary=o.boundary,this.points=o.points,Object.defineProperty(this,"size",{value:e.size,writable:!0,configurable:!0})):(e=e||{},this.weights=m,this.knots=p,this.degree=f,this.points=o,this.boundary=d,this.debug=e.debug,this.checkBounds=!!e.checkBounds,Object.defineProperty(this,"size",{value:e.size,writable:!0,configurable:!0}));var g=i(this.points),z=i(this.weights),_=i(this.knots);if(this.points)switch(g){case i.GENERIC_NDARRAY:case i.NDARRAY:Object.defineProperties(this,{splineDimension:{value:this.points.shape.length-1,writable:!1,configurable:!0},dimension:{value:this.points.shape[this.points.shape.length-1],writable:!1,configurable:!0},size:{get:function(){return this.points.shape.slice(0,this.points.shape.length-1)},set:function(){throw new Error("Cannot assign to read only property 'size'")},configurable:!0}});break;case i.ARRAY_OF_ARRAYS:var E=0,N=this.size||[];N.length=0;for(var A=this.points;t(A[0]);A=A[0])E++,N.push(A.length);if(E===0)throw new Error("Expected an array of points");Object.defineProperties(this,{splineDimension:{value:E,writable:!1,configurable:!0},dimension:{value:A.length,writable:!1,configurable:!0},size:{get:function(){var F=[];F.length=0;for(var U=0,O=this.points;U<this.splineDimension;U++,O=O[0])F[U]=O.length;return F},set:function(){throw new Error("Cannot assign to read only property 'size'")},configurable:!0}});break;case i.PACKED:default:throw new Error("Expected either a packed array, array of arrays, or ndarray of points")}else{if(this.size===void 0||this.size===null)throw new Error("Either points or a control hull size must be provided.");if(t(this.size)||Object.defineProperty(this,"size",{value:[this.size],writable:!0,configurable:!0}),this.size.length===0)throw new Error("`size` must be a number or an array of length at least one.");Object.defineProperties(this,{splineDimension:{value:this.size.length,writable:!1,configurable:!0},dimension:{value:0,writable:!1,configurable:!0}})}if(t(this.degree)){for(h=0;h<this.splineDimension;h++)if(P(this.degree[h]))throw new Error("Missing degree in dimension "+(h+1))}else{var j=!P(this.degree),M=P(this.degree)?2:this.degree;for(this.degree=[],h=0;h<this.splineDimension;h++)if(this.size[h]<=M){if(j)throw new Error("Expected at least "+(M+1)+" points for degree "+M+" spline in dimension "+(h+1)+" but got only "+this.size[h]);this.degree[h]=this.size[h]-1}else this.degree[h]=M}if(b=typeof this.boundary!="string"?"open":this.boundary,!y[b])throw new Error("Boundary type must be one of "+Object.keys(y)+". Got "+b);for(this.boundary=t(this.boundary)?this.boundary:[],this.boundary.length=this.splineDimension,h=0;h<this.splineDimension;h++)if(this.boundary[h]=P(this.boundary[h])?b:this.boundary[h],!y[b])throw new Error("Boundary type must be one of "+Object.keys(y)+". Got "+b+" for dimension "+(h+1));switch(_){case i.ARRAY_OF_ARRAYS:for(t(this.knots)&&this.knots.length>0&&!t(this.knots[0])&&(this.knots=[this.knots]),h=0;h<this.splineDimension;h++){if(this.size[h]<=this.degree[h])throw new Error("Expected at least "+(this.degree[h]+1)+" points in dimension "+(h+1)+" but got "+this.size[h]+".");if(t(this.knots[h])){if(this.boundary[h]!=="closed"&&this.knots[h].length!==this.degree[h]+this.size[h]+1)throw new Error("Expected "+(this.degree[h]+this.size[h]+1)+" knots in dimension "+(h+1)+" but got "+this.knots[h].length+".");if(this.boundary[h]==="closed"&&this.knots[h].length!==this.size[h]+1){var X=this.knots[h].length===this.size[h]+this.degree[h]+1;if(!X)throw new Error("Expected "+(this.size[h]+1)+" knots for closed spline in dimension "+(h+1)+" but got "+this.knots[h].length+".")}}}break;case i.NDARRAY:break}var q=a(this,this.debug,this.checkBounds,g,z,_);if(q!==this.__cacheKey){this.__cacheKey=q;var V=r(this);this.evaluate=v(this.__cacheKey,this,V,this.debug,this.checkBounds,!1),this.transform=n(this.__cacheKey,this,V,this.debug),this.support=u(this.__cacheKey,this,V,this.debug,this.checkBounds),this.evaluator=function(F,U){return v(this.__cacheKey,this,V,this.debug,this.checkBounds,U,F)}}return this.numericalDerivative=l.bind(this),this}function k(){var o,f=[],p=this.points;p?c(p)&&(o=p.shape):o=this.size;for(var m=0;m<this.splineDimension;m++){var d=o?o[m]:p.length,e=this.degree[m],h=this.boundary[m]==="closed";if(this.knots&&this.knots[m]){var b=this.knots[m];f[m]=[b[h?0:e],b[d]]}else f[m]=[h?0:e,d];p&&(p=p[0])}return f}function C(o,f,p,m,d,e){var h=function(g,z,_,E,N,A){return b(g,z,_,E,N,A),h},b=R.bind(h);return Object.defineProperty(h,"domain",{get:k}),b(o,f,p,m,d,e),h}return Ee=C,Ee}var Ft=Lt();const Ot=Nt(Ft);var kt=Z("<svg><path stroke=black stroke-width=2 fill=none></svg>",!1,!0),Pt=Z("<svg><circle r=8 stroke=red stroke-width=1 fill=none></svg>",!1,!0);class Vt{Render;constructor(a){let s=W(()=>a.world.entities());this.Render=()=>Q(_t,{get each(){return s()},children:c=>{let r=[],l=a.world.getComponents(c);for(let t of l)switch(t.type.typeName){case yt.typeName:{let n=t.state;r.push(Q(Mt,{state:n}));break}case gt.typeName:let v=t.state;r.push(Q(Kt,{state:v}));break}return r}})}}const Mt=i=>{let a=W(()=>bt(i.state.controlPoints.map(c=>[c.x,c.y]),i.state.isClosed).map(c=>c.type+" "+c.values.join(" ")).join(" "));return[(()=>{var s=kt();return ie(()=>J(s,"d",a())),s})(),Q(dt,{get each(){return i.state.controlPoints},children:s=>(()=>{var c=Pt();return ie(r=>{var l=s().x,t=s().y;return l!==r.e&&J(c,"cx",r.e=l),t!==r.t&&J(c,"cy",r.t=t),r},{e:void 0,t:void 0}),c})()})]},ue=1e-12;function bt(i,a=!1,s=.5){let c;return a?c=Ut(i,s):c=Bt(i,s),c}function Gt(i,a=!1){return i.length==0||(a?i.unshift(i.pop()):i.push(i.shift())),i}function Bt(i,a){let s=[],c=!1,r=!1,l,t,v,n,u,y,P,R,k,C,o,f,p,m,d=()=>{P=0,R=0,k=0,C=0,o=0,f=0,p=0},e=()=>{p===2?(r=!0,s.push({type:"L",values:[u,y]})):p===3&&h(u,y),(m||m!==0&&p===1)&&r&&s.push({type:"Z",values:[]}),m=1-m},h=(b,g)=>{if(p){let z=u-b,_=y-g;f=Math.pow(z*z+_*_,a),k=Math.sqrt(f)}if(p===0)p=1,m?(r=!0,s.push({type:"L",values:[b,g]})):(r=!0,s.push({type:"M",values:[b,g]}));else if(p===1)p=2;else{p===2&&(p=3);let z=v,_=n,E=u,N=y;if(P>ue){let A=2*C+3*P*R+o,j=3*P*(P+R);z=(z*A-l*o+u*C)/j,_=(_*A-t*o+y*C)/j}if(k>ue){let A=2*f+3*k*R+o,j=3*k*(k+R);E=(E*A+v*f-b*o)/j,N=(N*A+n*f-g*o)/j}r=!0,s.push({type:"C",values:[z,_,E,N,u,y]})}P=R,R=k,C=o,o=f,l=v,v=u,u=b,t=n,n=y,y=g};for(let b=0,g=i.length;b<=g;b+=1)b<g?(c===!1&&(c=!0,d()),h(i[b][0],i[b][1])):c===!0&&(c=!1,e());return s}function Ut(i,a=.5){let s=[],c=!1,r,l,t,v,n,u,y,P,R,k,C,o,f,p,m,d,e,h,b,g=()=>{f=0,p=0,m=0,d=0,e=0,h=0,b=0},z=()=>{b===1?s.push({type:"M",values:[y,P]},{type:"Z",values:[]}):b===2?s.push({type:"L",values:[y,P]},{type:"Z",values:[]}):b===3&&(_(y,P),_(R,k),_(C,o))},_=(E,N)=>{if(b){let A=n-E,j=u-N;h=Math.pow(A*A+j*j,a),m=Math.sqrt(h)}if(b===0)b=1,y=E,P=N;else if(b===1)b=2,R=E,k=N,s.push({type:"M",values:[R,k]});else if(b===2)b=3,C=E,o=N;else{let A=t,j=v,M=n,X=u;if(f>ue){let q=2*d+3*f*p+e,V=3*f*(f+p);A=(A*q-r*e+n*d)/V,j=(j*q-l*e+u*d)/V}if(m>ue){let q=2*h+3*m*p+e,V=3*m*(m+p);M=(M*q+t*h-E*e)/V,X=(X*q+v*h-N*e)/V}s.push({type:"C",values:[A,j,M,X,n,u]})}f=p,p=m,d=e,e=h,r=t,t=n,n=E,l=v,v=u,u=N};i=Gt(i,!0);for(let E=0,N=i.length;E<=N;E+=1)E<N?(c===!1&&(c=!0,g()),_(i[E][0],i[E][1])):c===!0&&(c=!1,z());return s}const Kt=i=>{let a=W(()=>{let s=i.state;if(s.controlPoints.length<4)return;let c=[],r=s.controlPoints.length*10,l=Ot({points:s.controlPoints.map(n=>[n.x,n.y]),degree:s.degree,boundary:s.closed?"closed":"clamped"}),t=l.domain[0];for(let n=0;n<=r;++n){let u=n/r,y=l.evaluate({},(t[1]-t[0])*u+t[0]);c.push(ht.create(y[0],y[1]))}return bt(c.map(n=>[n.x,n.y]),!1).map(n=>n.type+" "+n.values.join(" ")).join(" ")});return Q(St,{get when(){return a()},children:s=>[(()=>{var c=kt();return ie(()=>J(c,"d",s())),c})(),Q(dt,{get each(){return i.state.controlPoints},children:c=>(()=>{var r=Pt();return ie(l=>{var t=c().x,v=c().y;return t!==l.e&&J(r,"cx",l.e=t),v!==l.t&&J(r,"cy",l.t=v),l},{e:void 0,t:void 0}),r})()})]})};var De=Z("<br>"),Wt=Z("<button class=btn>End Mode"),Zt=Z("<input type=checkbox>"),Xt=Z("<label>Closed");class Ht{instructions;click;constructor(a){let[s,c]=Ie({controlPoints:[],isClosed:!1}),r=W(()=>{let v=a.mousePos();if(v!=null)return a.screenPtToWorldPt(v)}),l=W(()=>{if(s.controlPoints.length==0)return;let v=r();if(!(s.controlPoints.length==1&&v==null))return[...s.controlPoints,...vt(v)]}),t=()=>{};{let v=W(()=>l()!=null);re(()=>{if(!v())return;let n=l,u=a.world(),y=yt.create({controlPoints:ne(n),isClosed:ne(()=>s.isClosed)}),P=ne(()=>u.createEntity([y])),R=!1;t=()=>{R=!0,a.onDone()},pt(()=>{t=()=>{},!R&&u.destroyEntity(P)}),re(le(n,()=>{y.setState("controlPoints",n())})),re(le(()=>s.isClosed,()=>{y.setState("isClosed",s.isClosed)}))})}this.instructions=()=>{let v=mt();return["Click in the control points for your curve.",De(),(()=>{var n=Wt();return n.$$click=()=>t(),n})(),De(),De(),(()=>{var n=Zt();return n.addEventListener("change",u=>{c("isClosed",u.currentTarget.checked)}),J(n,"id",v),ie(()=>n.checked=s.isClosed),n})(),(()=>{var n=Xt();return J(n,"for",v),n.style.setProperty("padding-left","5px"),n})()]},this.click=()=>{let v=r();v!=null&&c("controlPoints",n=>[...n,v])}}}xe(["click"]);class Jt{constructor(a){}}var Ne=Z("<br>"),Qt=Z("<button class=btn>End Mode"),er=Z("<input type=checkbox>"),tr=Z("<label>Closed");class rr{instructions;click;constructor(a){let[s,c]=Ie({controlPoints:[],isClosed:!1}),r=W(()=>{let v=a.mousePos();if(v!=null)return a.screenPtToWorldPt(v)}),l=W(()=>{if(s.controlPoints.length==0)return;let v=r();return s.controlPoints.length==1&&v==null?void 0:{controlPoints:[...s.controlPoints,...vt(v)]}}),t=()=>{};{let v=W(()=>l()!=null);re(()=>{if(!v())return;let n=l,u=a.world(),y=gt.create({controlPoints:ne(()=>n().controlPoints),weights:ne(()=>n().controlPoints).map(k=>1),degree:3,closed}),P=ne(()=>u.createEntity([y])),R=!1;t=()=>{R=!0,a.onDone()},pt(()=>{t=()=>{},!R&&u.destroyEntity(P)}),re(le(n,()=>{let{controlPoints:k}=n();Et(()=>{y.setState("controlPoints",k),y.setState("weights",k.map(C=>1))})},{defer:!0})),re(le(()=>s.isClosed,()=>{y.setState("closed",s.isClosed)},{defer:!0}))})}this.instructions=()=>{let v=mt();return["Click in the control points for your curve.",Ne(),(()=>{var n=Qt();return n.$$click=()=>t(),n})(),Ne(),Ne(),(()=>{var n=er();return n.addEventListener("change",u=>{c("isClosed",u.currentTarget.checked)}),J(n,"id",v),ie(()=>n.checked=s.isClosed),n})(),(()=>{var n=tr();return J(n,"for",v),n.style.setProperty("padding-left","5px"),n})()]},this.click=()=>{let v=r();v!=null&&c("controlPoints",n=>[...n,v])}}}xe(["click"]);var nr=Z("<div><div><button class=btn>Insert Catmull Rom Spline</button><button class=btn>Insert Nurbs</button></div><div><svg></svg><div>");const lr=()=>{let[i,a]=Ie({mousePos:void 0,mode:"Idle"}),s=o=>o,c=o=>o,r=new Rt,l=new Vt({world:r}),t={mousePos:()=>i.mousePos,screenPtToWorldPt:s,worldPtToScreenPt:c,world:()=>r,onDone:()=>a("mode","Idle")},v=W(()=>{switch(i.mode){case"Idle":return new Jt(t);case"Insert Catmull Rom Spline":return new Ht(t);case"Insert Nurbs":return new rr(t)}}),n=()=>W(()=>v().instructions?.({})),[u,y]=Dt(),P=o=>{let f=u();f!=null&&(f.setPointerCapture(o.pointerId),o.preventDefault())},R=o=>{let f=u();f!=null&&(f.releasePointerCapture(o.pointerId),v().click?.(),o.preventDefault())},k=o=>{let f=u();if(f==null)return;let p=f.getBoundingClientRect(),m=ht.create(o.clientX-p.left,o.clientY-p.top);a("mousePos",m),o.preventDefault()},C=o=>{a("mousePos",void 0),o.preventDefault()};return(()=>{var o=nr(),f=o.firstChild,p=f.firstChild,m=p.nextSibling,d=f.nextSibling,e=d.firstChild,h=e.nextSibling;o.style.setProperty("width","100%"),o.style.setProperty("height","100%"),o.style.setProperty("display","flex"),o.style.setProperty("flex-direction","column"),p.$$click=()=>{a("mode","Insert Catmull Rom Spline")},m.$$click=()=>{a("mode","Insert Nurbs")},d.style.setProperty("flex-grow","1"),d.style.setProperty("position","relative"),d.style.setProperty("display","flex"),d.style.setProperty("flex-direction","column"),e.addEventListener("pointerleave",C),e.$$pointermove=k,e.$$pointerup=R,e.$$pointerdown=P;var b=y;return typeof b=="function"?Ct(b,e):y=e,e.style.setProperty("flex-grow","1"),e.style.setProperty("background-color","white"),e.style.setProperty("touch-action","none"),Ue(e,Q(l.Render,{})),h.style.setProperty("position","absolute"),h.style.setProperty("left","0"),h.style.setProperty("top","0"),Ue(h,Q(n,{})),o})()};xe(["click","pointerdown","pointerup","pointermove"]);export{lr as default};
