import{c as A,p as P,J as D,q as _,O as M,t as $,Y as R}from"./dev-B9-ass9r.js";import{a as C,p as F}from"./dev-CC7pdsS5.js";import m from"typescript";function p(r){var s;return((s=r.split("/").slice(-1)[0])==null?void 0:s.split(".")[1])||""}function b(r){return r.replace(/^\/+/,"")}function O(r,s){const a=L(r),f=a?r:new URL(r,"http://example.com/"),u=new URL(s,f);return b(a?u.href:u.pathname)}function L(r){return r.startsWith("blob:")||r.startsWith("http:")||r.startsWith("https:")}function U(r,s){let a,f=()=>!a||a.state==="unresolved"?void 0:a.latest;[a]=$(()=>r(R(f)),n=>n,s);const u=()=>a();return Object.defineProperty(u,"latest",{get(){return a.latest}}),u}function T(r,s){const[a,f]=C({}),u={get(n){var l;return(l=a[n])==null?void 0:l.get()},invalidate(n){var l;return(l=a[n])==null?void 0:l.invalidate()},create(n){var l;return(l=a[n])==null?void 0:l.create()}};return P(D(()=>Object.keys(r()).filter(n=>r()[n]!==null),n=>{const l=p(n),[d,c]=A(null,{equals:!1}),S=U(async()=>{var y,v;return((v=(y=s[l])==null?void 0:y.transform)==null?void 0:v.call(y,{path:n,source:r()[n],executables:u}))||r()[n]});function w(){var y;const v=S();if(!v)return;const e=new Blob([v],{type:`text/${((y=s[l])==null?void 0:y.type)||"plain"}`});return URL.createObjectURL(e)}const g=_(y=>(y&&URL.revokeObjectURL(y),d(),w()));f({[n]:{get:g,create:w,invalidate:c}}),M(()=>f({[n]:void 0}))})),u}function E(r){return r.split("/").slice(0,-1).join("/")}function z(r){const s=r.replace(/\*\*/g,".*").replace(/\*/g,"[^/]*").replace(/\?/g,".");return new RegExp(`^${s}$`)}function q(r){const[s,a]=C({}),f=T(()=>s,r),[u,n]=A(e=>{const t=z(e);return i=>i.filter(o=>t.test(o))});function l(e,t){const i=_(()=>u()(e));P(D(()=>i()(v.getPaths()),o=>P(()=>t(o))))}function d(e){const t=e.split("/");if(!t.map((o,x)=>t.slice(0,x+1).join("/")).filter(Boolean).every(o=>o in s))throw`Path is invalid ${e}`;return!0}function c(e){if(s[e]===null)throw`Path is not a file: ${e}`}function S(e){return e=b(e),c(e),f.get(e)}function w(e){return e=b(e),c(e),f.invalidate(e)}function g(e){return e=b(e),c(e),f.create(e)}function y(e,t){return e=b(e),d(e),t?.withFileTypes?Object.entries(s).filter(([i])=>E(i)===e&&e!==i).map(([i,o])=>{var x;return{type:o===null?"dir":((x=r[p(i)])==null?void 0:x.type)||"plain",path:i}}):Object.keys(s).filter(i=>E(i)===e)}const v={getExecutable:S,invalidateExecutable:w,createExecutable:g,getPaths:()=>Object.keys(s),getType(e){var t;return e=b(e),d(e),s[e]===null?"dir":((t=r[p(e)])==null?void 0:t.type)||"plain"},readdir:y,mkdir(e,t){if(e=b(e),t?.recursive){const i=e.split("/");i.forEach((o,x)=>{a(i.slice(0,x+1).join("/"),null)});return}d(E(e)),a(e,null)},readFile(e){e=b(e);const t=s[e];if(t===null)throw`Path is not a file ${e}`;return t},rename(e,t){e=b(e),t=b(t),d(e),a(F(i=>{Object.keys(s).forEach(o=>{if(o.startsWith(e)){const x=o.replace(e,t);i[x]=i[o],delete i[o]}})}))},rm(e,t){if(e=b(e),(!t||!t.force)&&d(e),!t||!t.recursive){const i=Object.keys(f).filter(o=>o===e?!1:o.includes(e));if(i.length>0)throw`Directory is not empty ${i}`}a(F(i=>{Object.keys(i).filter(o=>o.includes(e)).forEach(o=>delete i[o])}))},writeFile(e,t){if(e=b(e),d(E(e)),s[e]===null)throw`A directory already exist with the same name: ${e}`;a(e,t)},watchExecutable(e,t){l(e,i=>t(v.getExecutable(i),i))},watchFile(e,t){l(e,i=>t(v.readFile(i),i))},watchDir(e,t){t(v.readdir(e,{withFileTypes:!0}),e)},watchPaths(e){P(()=>e(v.getPaths()))},setMatch:n};return v}function N(r,s){const a=m.createSourceFile("",r,m.ScriptTarget.Latest,!0,m.ScriptKind.TS);let f=!1;const u=m.transform(a,[l=>{const d=c=>{if((m.isImportDeclaration(c)||m.isExportDeclaration(c))&&c.moduleSpecifier&&m.isStringLiteral(c.moduleSpecifier)){const S=m.isImportDeclaration(c),w=c.moduleSpecifier.text,g=s(c.moduleSpecifier.text,S);if(g===null){f=!0;return}if(c.moduleSpecifier.text=g,w!==c.moduleSpecifier.text)return f=!0,S?m.factory.updateImportDeclaration(c,c.modifiers,c.importClause,m.factory.createStringLiteral(g),c.assertClause):m.factory.updateExportDeclaration(c,c.modifiers,!1,c.exportClause,m.factory.createStringLiteral(g),c.assertClause)}return m.visitEachChild(c,d,l)};return c=>m.visitNode(c,d)}]);return u.transformed[0]?f?m.createPrinter({newLine:m.NewLineKind.LineFeed}).printFile(u.transformed[0]):r:void 0}const j=typeof DOMParser<"u"?new DOMParser:void 0,k=typeof XMLSerializer<"u"?new XMLSerializer:void 0;function X({path:r,source:s,executables:a}){if(!j||!k)throw"`parseHtml` can only be used in environments where DOMParser and XMLSerializer are available. Please use `parseHtmlWorker` for a worker-friendly alternative.";const f=j.parseFromString(s,"text/html"),u={select(n,l){return Array.from(f.querySelectorAll(n)).forEach(l),u},bindLinkHref(){return u.select("link[href]",n=>{const l=n.getAttribute("href");if(L(l))return;const d=a.get(O(r,l));d&&n.setAttribute("href",d)})},bindScriptSrc(){return u.select("script[src]",n=>{const l=n.getAttribute("src");if(L(l))return;const d=a.get(O(r,n.getAttribute("src")));d&&n.setAttribute("src",d)})},transformModuleScriptContent(n){return u.select('script[type="module"]',l=>{l.type!=="module"||!l.textContent||(l.textContent=n({path:r,source:l.textContent,executables:a}))})},toString(){return k.serializeToString(f)}};return u}export{q as c,L as i,X as p,O as r,N as t};
