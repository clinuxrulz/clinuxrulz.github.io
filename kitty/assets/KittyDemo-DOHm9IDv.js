import{d as Jt,g as Vt,t as _t,V as qt,i as L,C as yt}from"./lib-CajXKAK5.js";import{c as Zt,f as Qt,A as X,g as U,T as K,h as te,S as bt,C as rt}from"./index-XNH-lkY3.js";import{q as y,Y as M,s as ee,c as oe,O as b,p as mt,N as nt,t as se,l as Y,b as lt,S as Gt,J as ct,m as R}from"./dev-B9-ass9r.js";import{a as O}from"./dev-CC7pdsS5.js";import{F as ie}from"./Filter-BDK7ILDO.js";import{A as wt}from"./AnimatedSprite-CrPahPC5.js";import"./State-3sV0XrC-.js";const ae="kitty-sprites.png",i=16,a=16,J=128,V=8,xt=24,q=152,Z=32,gt=24,re=8+24*5,ne=32,le=8+24*9,ce=8,ue=8+24*9,de=32,he=8+24*9,fe=56,_e=128,pe=80,Q=8+24*5,tt=56,kt=24,Tt=128-24*3,vt=80,Se=24,j=8,D=8+24*4,et=24,ye=8+24*6,me=8+24*3,Ot=8+24*7,Pt=8+24*3,Ge=24,ut={frames:{kitty_flying_1:{frame:{x:J,y:V,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_flying_2:{frame:{x:J+xt,y:V,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_flying_3:{frame:{x:J+xt*2,y:V,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_running_1:{frame:{x:q,y:Z,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_running_2:{frame:{x:q+gt,y:Z,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_running_3:{frame:{x:q+gt*2,y:Z,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_stand:{frame:{x:re,y:ne,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_bump:{frame:{x:le,y:ce,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_skid:{frame:{x:ue,y:de,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_jump:{frame:{x:he,y:fe,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_drop:{frame:{x:_e,y:pe,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_pump_1:{frame:{x:Q,y:tt,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_pump_2:{frame:{x:Q+kt,y:tt,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_pump_3:{frame:{x:Q+kt*2,y:tt,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_hurt_1:{frame:{x:Tt,y:vt,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_hurt_2:{frame:{x:Tt+Se,y:vt,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_fall_1:{frame:{x:j,y:D,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_fall_2:{frame:{x:j+et,y:D,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_fall_3:{frame:{x:j+et*2,y:D,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},kitty_fall_4:{frame:{x:j+et*3,y:D,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},balloon:{frame:{x:ye,y:me,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},balloon_pair_1:{frame:{x:Ot,y:Pt,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}},balloon_pair_2:{frame:{x:Ot+Ge,y:Pt,w:i,h:a},sourceSize:{w:i,h:a},spriteSourceSize:{x:0,y:0,w:i,h:a}}},meta:{image:ae,format:"RGBA8888",size:{w:128,h:32},scale:1},animations:{kitty_flying:["kitty_flying_1","kitty_flying_2","kitty_flying_3","kitty_flying_2"],kitty_running:["kitty_running_1","kitty_running_2","kitty_running_3","kitty_running_2"],kitty_stand:["kitty_stand"],kitty_bump:["kitty_bump"],kitty_skid:["kitty_skid"],kitty_jump:["kitty_jump"],kitty_drop:["kitty_drop"],kitty_pump:["kitty_pump_1","kitty_pump_2","kitty_pump_3","kitty_pump_2"],kitty_hurt:["kitty_hurt_1","kitty_hurt_2"],kitty_fall:["kitty_fall_1","kitty_fall_2","kitty_fall_3","kitty_fall_4"],balloon:["balloon"],balloon_pair:["balloon_pair_1","balloon_pair_2"]}},we=1;class pt{state;setState;constructor(t){let[o,e]=O({spawnHome:t.spawnHome==null?void 0:{xIdx:t.spawnHome.xIdx,yIdx:t.spawnHome.yIdx},pos:{x:t.initPos?.x??0,y:t.initPos?.y??0},size:{x:t.initSize?.x??72,y:t.initSize?.y??72},vel:{x:t.initVel?.x??0,y:t.initVel?.y??0},acc:{x:0,y:0},maxVel:{x:10,y:10},collideBlocks:!0,tint:void 0});this.state=o,this.setState=e}get actor(){return this}update(t){t.onGround||this.actor.setState("acc","y",o=>o+we)}onCollide(t){}}const xe=39,Rt=43,ge=42,ke=31,Te=16,ve=16,g=Te*3,T=ve*3,Oe=1,St=20,Pe=50,Ft=100;class C{state;setState;actor;animated;constructor(t){let[o,e]=O({facing:"Right",onGround:!1,lastJumpPressed:!1,jumpHeld:!1,remainingJumpHeldFrames:0,dead:!1,deadInitPosY:0,deadSequence:0,deadFrame:0});this.state=o,this.setState=e,this.actor=new pt({spawnHome:t.spawnHome,initPos:t.initPos,initVel:t.initVel}),this.animated={flipX:y(()=>o.facing=="Left"),animation:y(()=>this.state.dead?"kitty_hurt":this.state.onGround?this.actor.state.vel.x!=0?"kitty_running":"kitty_stand":this.actor.state.vel.y<0?"kitty_jump":"kitty_drop")}}update(t){if(this.state.dead){if(this.state.deadSequence==0){let e=this.state.deadFrame;e++,this.setState("deadFrame",e),e>=Pe&&(this.setState("deadSequence",1),this.setState("deadFrame",0)),this.actor.setState("vel","x",0),this.actor.setState("vel","y",0)}else{let e=this.state.deadFrame;if(e++,this.setState("deadFrame",e),e>=Ft){if(this.setState("dead",!1),this.setState("deadSequence",0),this.setState("deadFrame",0),this.actor.setState("collideBlocks",!0),this.actor.actor.state.spawnHome!=null){let s=this.actor.actor.state.spawnHome;this.actor.setState("pos",{x:s.xIdx*g,y:s.yIdx*T}),t.playBackgroundMusic(9)}}else{let s=Math.sin(e*3/4*2*Math.PI/Ft);this.actor.setState("pos","y",this.state.deadInitPosY-s*400),this.actor.setState("vel","x",0),this.actor.setState("vel","y",0)}}return}this.setState("onGround",t.onGround);let o=0;t.leftPressed&&(o-=1),t.rightPressed&&(o+=1),o<0?this.setState("facing","Left"):o>0&&this.setState("facing","Right"),t.jumpPressed&&!this.state.lastJumpPressed&&t.onGround?(t.playSoundEffect(xe),this.actor.setState("vel","y",-10),this.setState("jumpHeld",!0),this.setState("remainingJumpHeldFrames",St)):t.jumpPressed&&this.state.jumpHeld&&this.state.remainingJumpHeldFrames!=0?(this.actor.setState("vel","y",-10),this.setState("remainingJumpHeldFrames",e=>e-1)):t.onGround||this.setState("jumpHeld",!1),!this.state.onGround&&!this.state.jumpHeld&&this.actor.setState("acc","y",e=>e+Oe),this.actor.setState("acc","x",e=>e+o),this.actor.setState("vel","x",e=>{let s=.9*e;return this.actor.state.acc.x==0&&Math.abs(s)<1&&(s=0),s}),this.setState("lastJumpPressed",t.jumpPressed)}onCollide(t){}onHurt(t){this.state.dead||(t.playBackgroundMusic(ke),this.setState("dead",!0),this.setState("deadInitPosY",this.actor.state.pos.y),this.actor.setState("collideBlocks",!1))}}const Fe=100;class Ee{state;setState;actor;animated;constructor(t){let[o,e]=O({isFlat:!1,flatCounter:0});this.state=o,this.setState=e,this.actor=new pt({spawnHome:t.spawnHome,initPos:t.initPos}),this.animated={flipX:()=>!1,animation:y(()=>o.isFlat?"goomba_flat":"goomba_walking")}}update(t){if(this.actor.update(t),this.state.isFlat){this.actor.setState("vel","x",0);let o=this.state.flatCounter;o--,this.setState("flatCounter",o),o==0&&t.removeSelf();return}this.actor.setState("vel","x",-1)}onCollide(t){if(!this.state.isFlat&&t.other instanceof C&&!t.other.state.dead){let o=this.actor.state.pos.y+this.actor.state.size.y*.2;t.other.actor.state.pos.y+t.other.actor.state.size.y<=o?(this.setState("flatCounter",Fe),this.setState("isFlat",!0),t.other.actor.setState("vel","y",-100),t.other.setState("jumpHeld",!0),t.other.setState("remainingJumpHeldFrames",St),t.playSoundEffect(Rt)):t.other.onHurt({playBackgroundMusic:t.playBackgroundMusic})}}}const Ce="smb3-spritesheet.png",ot=16,st=16,Ae=47,ze=65,Me=83,it=724,E=17,N=27,A=16,be=3,Re=21,Ie=38,He=56,Be=74,Le=92,Xe=111,Et=778,I=790,dt={frames:{goomba_walking_1:{frame:{x:Ae,y:it,w:ot,h:st}},goomba_walking_2:{frame:{x:ze,y:it,w:ot,h:st}},goomba_flat:{frame:{x:Me,y:it,w:ot,h:st}},koopa_troopa_walking_1:{frame:{x:be,y:Et,w:E,h:N}},koopa_troopa_walking_2:{frame:{x:Re,y:Et,w:E,h:N}},koopa_troopa_shell_1:{frame:{x:Ie,y:I,w:E,h:A}},koopa_troopa_shell_2:{frame:{x:He,y:I,w:E,h:A}},koopa_troopa_shell_3:{frame:{x:Be,y:I,w:E,h:A}},koopa_troopa_shell_4:{frame:{x:Le,y:I,w:E,h:A}},koopa_troopa_waking_up:{frame:{x:Xe,y:I,w:E,h:A}}},meta:{image:Ce,format:"RGBA8888",scale:1},animations:{goomba_walking:["goomba_walking_1","goomba_walking_2"],goomba_flat:["goomba_flat"],koopa_troopa_walking:["koopa_troopa_walking_1","koopa_troopa_walking_2"],koopa_troopa_shell:["koopa_troopa_shell_1"],koopa_troopa_shell_spin:["koopa_troopa_shell_1","koopa_troopa_shell_2","koopa_troopa_shell_3","koopa_troopa_shell_4"],koopa_troopa_waking_up:["koopa_troopa_waking_up","koopa_troopa_shell_1"]}};class Ye{state;setState;actor;animated;constructor(t){let[o,e]=O({state:"Walking",facing:"Left"});this.state=o,this.setState=e,this.actor=new pt({spawnHome:t.spawnHome,initPos:t.initPos,initSize:{x:E*5,y:N*5}}),this.animated={flipX:y(()=>o.facing=="Left"),animation:y(()=>{switch(o.state){case"Walking":return"koopa_troopa_walking";case"Shell":return"koopa_troopa_shell";case"Spinning":return"koopa_troopa_shell_spin";case"WakingUp":return"koopa_troopa_waking_up"}}),animationSpeed:y(()=>{if(o.state=="Spinning")return .4})}}update(t){if(this.actor.update(t),this.state.state=="Walking"){let o=this.state.facing=="Left"?-1:1;this.actor.setState("vel","x",o)}else if(this.state.state=="Spinning"){let o=this.state.facing=="Left"?-10:10;this.actor.setState("vel","x",o)}}onCollide(t){if(this.state.state=="Walking"){if(t.other instanceof C&&!t.other.state.dead){let o=this.actor.state.pos.y+this.actor.state.size.y*.2;t.other.actor.state.pos.y+t.other.actor.state.size.y<=o?(this.setState("state","Shell"),this.actor.setState("size","y",A*5),this.actor.setState("pos","y",s=>s-(A-N)*5),this.actor.setState("vel","x",0),t.other.actor.setState("vel","y",-100),t.other.setState("jumpHeld",!0),t.other.setState("remainingJumpHeldFrames",St),t.playSoundEffect(Rt)):t.other.onHurt({playBackgroundMusic:t.playBackgroundMusic})}}else if(this.state.state=="Shell"&&t.other instanceof C&&!t.other.state.dead){let o=this.actor.state.pos.x+.5*this.actor.state.size.x;t.other.actor.state.pos.x+.5*t.other.actor.state.size.x<o?this.setState("facing","Right"):this.setState("facing","Left"),this.setState("state","Spinning"),t.playSoundEffect(ge)}}}class je{state;setState;constructor(t){let[o,e]=O({blocks:t.map(s=>new Array(s.length).fill(void 0).map((r,_)=>s.charAt(_)))});this.state=o,this.setState=e}readBlock(t,o){let e=this.state.blocks;if(o<0||o>=e.length)return;let s=e[o];if(!(t<0||t>=s.length))return this.state.blocks[o][t]}readTile(t,o){let e=this.state.blocks;if(o<0||o>=e.length)return;let s=e[o];if(t<0||t>=s.length)return;let r=this.state.blocks[o][t];if(r=="G"){let _=t>0&&s[t-1]=="G",l=t<s.length-1&&s[t+1]=="G";return o>0&&t<e[o-1].length&&e[o-1][t]=="G"?_?l?"woodGroundCentreCentre":"woodGroundCentreRight":"woodGroundCentreLeft":_?l?"woodGroundTopCentre":"woodGroundTopRight":"woodGroundTopLeft"}else if(r=="c"){let _=this.readBlock(t-1,o)=="c",l=this.readBlock(t+1,o)=="c",d=this.readBlock(t,o-1)=="c";return this.readBlock(t,o+1)=="c",_?l?d?"bgCloudBottomCentre":"bgCloudTopCentre":d?"bgCloudBottomRight":"bgCloudTopRight":d?"bgCloudBottomLeft":"bgCloudTopLeft"}}}const De=["                     ","         ccc     GG  ","         ccc         ","            @        ","  ccccc     GG       ","  ccccc              ","      GG          @  ","                 GG  ","                 GG  ","     GG   GGG    GG  ","                     ","                     ","               &                          @                @   &","GGGGGGGGGGGGGGGGGGGGG  GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG","GGGGGGGGGGGGGGGGGGGGG  GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG","GGGGGGGGGGGGGGGGGGGGG  GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG"],Ne="@",Ue="&";function Ke(c){return c==Ne?Ee:c==Ue?Ye:void 0}const We=(()=>{let t=new Array(100);return o=>{let e=t;e.length=0;for(let s of o.objects)e.push(s);e.sort((s,r)=>o.hasBox.x(s)-o.hasBox.x(r));for(let s=0;s<e.length-1;++s){let r=e[s],_=o.hasBox.x(r)+o.hasBox.w(r),l=o.hasBox.y(r)+o.hasBox.h(r);for(let d=s+1;d<e.length;++d){let h=e[d];if(o.hasBox.x(h)<_&&o.hasBox.y(h)+o.hasBox.h(h)>o.hasBox.y(r)&&o.hasBox.y(h)<l)o.onCollide(r,h);else break}}e.length=0}})();class $e{state;setState;constructor(){let t=Math.round(100/g),o=Math.round(210/T),e=new C({spawnHome:{xIdx:t,yIdx:o},initPos:{x:t*g,y:o*T}}),[s,r]=O({camera:{pos:{x:M(()=>e.actor.state.pos.x-100),y:M(()=>e.actor.state.pos.y-300)}},actors:[e],blockSpawns:[],level:new je(De)});this.state=s,this.setState=r}update(t){{let e=t.windowSize.width/3,s=t.windowSize.width*2/3,r=t.windowSize.height/3,_=t.windowSize.height*2/3;for(let l=0;l<this.state.actors.length;++l){let d=this.state.actors[l];if(d instanceof C){if(d.state.dead)continue;let h=d.actor.state,f=h.pos.x-this.state.camera.pos.x,u=h.pos.y-this.state.camera.pos.y;f<e?this.setState("camera","pos","x",n=>n+f-e):f>s&&this.setState("camera","pos","x",n=>n+f-s),u<r?this.setState("camera","pos","y",n=>n+u-r):u>_&&this.setState("camera","pos","y",n=>n+u-_)}}}{let e=Math.floor(this.state.camera.pos.y/T),s=Math.floor(this.state.camera.pos.x/g),r=Math.ceil(t.windowSize.height/g),_=Math.ceil(t.windowSize.width/T);for(let l=e;l<e+r;++l)for(let d=s;d<s+_;++d){let h=Ke(this.state.level.readBlock(d,l)??"");if(h!=null){let f=!1;for(let n of this.state.actors)if(n.actor.state.spawnHome!=null){let m=n.actor.state.spawnHome;m.xIdx==d&&m.yIdx==l&&(f=!0)}for(let n of this.state.blockSpawns)n.xIdx==d&&n.yIdx==l&&(f=!0);if(f)continue;this.setState("blockSpawns",n=>[...n,{xIdx:d,yIdx:l}]);let u=new h({spawnHome:{xIdx:d,yIdx:l}});u.actor.setState("pos",{x:d*g,y:(l+1)*T-u.actor.state.size.y}),this.setState("actors",n=>[...n,u])}}}{let e=Math.floor(this.state.camera.pos.x/g),s=Math.floor(this.state.camera.pos.y/T),r=Math.ceil(t.windowSize.height/g),_=Math.ceil(t.windowSize.width/T),l=e+_,d=s+r,h=!1,f=[...this.state.actors];for(let m=f.length-1;m>=0;--m){let G=f[m];if(G instanceof C)continue;let p=Math.ceil(G.actor.state.pos.x/g),S=Math.ceil(G.actor.state.pos.y/T);(p<e||p>l||S<s||S>d)&&(f.splice(m,1),h=!0)}h&&this.setState("actors",f);let u=!1,n=[...this.state.blockSpawns];for(let m=n.length-1;m>=0;--m){let G=n[m],p=G.xIdx,S=G.yIdx;(p<e||p>l||S<s||S>d)&&(n.splice(m,1),u=!0)}u&&this.setState("blockSpawns",n)}for(let e of this.state.actors)e.actor.setState("acc","x",0),e.actor.setState("acc","y",0);let o=[];for(let e=0;e<this.state.actors.length;++e){let s=this.state.actors[e],r=e,_=!1;{let l=s.actor.state;const d=24,h=24;let f=l.pos.x,u=l.pos.y,n=f+d,m=u+h,G=Math.floor(f/g),p=Math.ceil(n/g),w=Math.ceil((m+1)/T);for(let v=G;v<=p;++v)if(this.state.level.readBlock(v,w)=="G"){_=!0;break}}s.update({leftPressed:t.leftPressed,rightPressed:t.rightPressed,jumpPressed:t.jumpPressed,onGround:_,playSoundEffect:t.playSoundEffect,playBackgroundMusic:t.playBackgroundMusic,removeSelf:()=>{o.push(r)}})}if(o.length!=0){o.sort((s,r)=>s-r);let e=[...this.state.actors];for(let s=o.length-1;s>=0;--s)e.splice(o[s],1);this.setState("actors",e)}for(let e of this.state.actors){if(!e.actor.state.collideBlocks)continue;e.actor.state.pos.x,e.actor.state.pos.y;let s=e.actor.state,r=s.vel.x+s.acc.x,_=s.vel.y+s.acc.y;Math.abs(r)>s.maxVel.x&&(r=Math.sign(r)*s.maxVel.x),Math.abs(_)>s.maxVel.y&&(_=Math.sign(_)*s.maxVel.y);let l=e.actor.state.pos.x+r,d=e.actor.state.pos.y+_;e.actor.setState("vel","x",r),e.actor.setState("vel","y",_),e.actor.setState("pos","x",l),e.actor.setState("pos","y",d);{let h=e.actor.state;const f=16*3,u=16*3,n=h.size.x,m=h.size.y;let G=h.pos.x,p=h.pos.y,S=G+n,w=p+m,v=Math.floor(G/f),z=Math.floor(p/u),x=Math.ceil(S/f),P=Math.ceil(w/u);for(let k=z;k<=P;++k)for(let F=v;F<=x;++F){let Nt=this.state.level.readBlock(F,k),Ut=this.state.level.readBlock(F-1,k),Kt=this.state.level.readBlock(F+1,k),Wt=this.state.level.readBlock(F,k-1),$t=this.state.level.readBlock(F,k+1);if(Nt=="G"){let H=F*f,W=H+f,B=k*u,$=B+u;if(S<H||G>W||w<B||p>$)continue;Ut!="G"&&S-H<20?(e.actor.setState("pos","x",H-e.actor.state.size.x),e.actor.setState("vel","x",0)):Kt!="G"&&W-G<20?(e.actor.setState("pos","x",W),e.actor.setState("vel","x",0)):Wt!="G"&&w-B<20?(e.actor.setState("pos","y",B-e.actor.state.size.y),e.actor.setState("vel","y",0)):$t!="G"&&p-$<20&&(e.actor.setState("pos","y",$),e.actor.setState("vel","y",0),e instanceof C&&e.setState("jumpHeld",!1))}}}}for(let e of this.state.actors)e.actor.setState("tint",void 0);We({hasBox:{x:e=>e.actor.state.pos.x,y:e=>e.actor.state.pos.y,w:e=>24*3,h:e=>24*3},objects:this.state.actors,onCollide(e,s){e.onCollide({other:s,playSoundEffect:t.playSoundEffect,playBackgroundMusic:t.playBackgroundMusic}),s.onCollide({other:e,playSoundEffect:t.playSoundEffect,playBackgroundMusic:t.playBackgroundMusic})}})}}const Je="smb3-tileset.png",ht={frames:{woodGroundTopLeft:{frame:{x:2,y:197,w:16,h:16}},woodGroundTopCentre:{frame:{x:19,y:197,w:16,h:16}},woodGroundTopRight:{frame:{x:36,y:197,w:16,h:16}},woodGroundCentreLeft:{frame:{x:2,y:214,w:16,h:16}},woodGroundCentreCentre:{frame:{x:19,y:214,w:16,h:16}},woodGroundCentreRight:{frame:{x:36,y:214,w:16,h:16}},bgCloudTopLeft:{frame:{x:138,y:197,w:16,h:16}},bgCloudTopCentre:{frame:{x:155,y:197,w:16,h:16}},bgCloudTopRight:{frame:{x:138+17*2,y:197,w:16,h:16}},bgCloudBottomLeft:{frame:{x:138,y:214,w:16,h:16}},bgCloudBottomCentre:{frame:{x:155,y:214,w:16,h:16}},bgCloudBottomRight:{frame:{x:138+17*2,y:214,w:16,h:16}}},meta:{image:Je,scale:1}},Ve=`in vec2 aPosition;

out vec2 vTextureCoord;
out vec2 vMaskCoord;


uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;
uniform mat3 uFilterMatrix;

vec4 filterVertexPosition(  vec2 aPosition )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
       
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord(  vec2 aPosition )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

vec2 getFilterCoord( vec2 aPosition )
{
    return  ( uFilterMatrix * vec3( filterTextureCoord(aPosition), 1.0)  ).xy;
}   

void main(void)
{
    gl_Position = filterVertexPosition(aPosition);
    vTextureCoord = filterTextureCoord(aPosition);
    vMaskCoord = getFilterCoord(aPosition);
}
`,qe=`
in vec2 vTextureCoord;
in vec4 vColor;

out vec4 finalColor;

uniform float uNoise;
uniform float uSeed;
uniform sampler2D uTexture;

float colorDifference(vec4 c1, vec4 c2) {
    vec4 delta = c1 - c2;
    return length(delta);
}


void main()
{
    vec4 currentColor = texture(uTexture, vTextureCoord);
    vec4 whiteColor = vec4(1.0);
    float difference = colorDifference(currentColor, whiteColor);

    if (difference < 0.01) {
        finalColor = vec4(0.0, 0.0, 0.0, 0.0); // Transparent black
    } else {
        finalColor = currentColor;
    }
}
`;class Ze extends ie{constructor(){super({glProgram:new Zt({vertex:Ve,fragment:qe}),resources:{}})}}var Qe=_t("<div><div></div><div>A");class to{jumpPressed;state;setState;Render;constructor(){let[t,o]=O({jumpPressed:!1});this.jumpPressed=()=>t.jumpPressed,this.state=t,this.setState=o,this.Render=e=>{const s=this;let r=Math.min(window.innerWidth,window.innerHeight),_=l=>({"background-color":l()?"green":"grey",border:"2px lightgrey solid",width:`${r*.12}px`,height:`${r*.12}px`,"border-radius":`${.5*r*.12}px`,"font-size":`${r*.08}px`,"text-align":"center",cursor:"pointer","user-select":"none"});return(()=>{var l=Qe(),d=l.firstChild,h=d.nextSibling;return l.style.setProperty("display","grid"),l.style.setProperty("grid-template-columns","auto auto"),l.style.setProperty("position","absolute"),`${r*.12}px`!=null?l.style.setProperty("right",`${r*.12}px`):l.style.removeProperty("right"),`${r*.12}px`!=null?l.style.setProperty("bottom",`${r*.12}px`):l.style.removeProperty("bottom"),h.$$pointerout=()=>s.setState("jumpPressed",!1),h.$$pointerover=()=>s.setState("jumpPressed",!0),ee(f=>Vt(h,_(s.jumpPressed),f)),l})()}}}Jt(["pointerover","pointerout"]);const eo="micro-mario.png",oo=4,so=2,io=11,ao=10,ft={frames:{mario_standing:{frame:{x:oo,y:so,w:io,h:ao}}},meta:{image:eo,format:"RGBA8888",scale:1},animations:{}};var ro=_t("<div>Click / Tap Screen to start"),no=_t("<div style=position:relative;width:100%;height:100%;>");let It,Ht=0,Bt,Lt=0,Ct=c=>{Bt?.play?.(Lt,c)},At=c=>{It?.play?.(Ht,c)},[at,lo]=oe(!1),zt=!0;function co(){zt&&(lo(!0),zt=!1,fetch("./smb3.nsf").then(c=>c.arrayBuffer()).then(async c=>{let t=await yt.init();{let e=await t.load(c);if(e.type=="Err"){console.log(e.message);return}let{emu:s}=e.value;await t.play(s,9),It=t,Ht=s}let o=await yt.init();{let e=await o.load(c);if(e.type=="Err"){console.log(e.message);return}let{emu:s}=e.value;Bt=o,Lt=s}}))}document.addEventListener("mousedown",()=>{co()});Qt.defaultOptions.scaleMode="nearest";const uo=60,ho=1/uo;await Promise.all([X.load(ht.meta.image),X.load(ut.meta.image),X.load(dt.meta.image),X.load(ft.meta.image)]);const Xt=new U(K.from(ut.meta.image),ut);await Xt.parse();const Yt=new U(K.from(dt.meta.image),dt);await Yt.parse();const jt=new U(K.from(ft.meta.image),ft);await jt.parse();const Dt=new U(K.from(ht.meta.image),ht);await Dt.parse();function fo(c){return c.dt>1?{dtOffset:0}:lt(()=>{let t=c.dtOffset+c.dt;for(;t>0;)c.updateFn(),t-=ho;return{dtOffset:t}})}let _o=new Ze;const To=()=>{let[c,t]=O({width:window.innerWidth,height:window.innerHeight}),o=p=>{lt(()=>{t("width",window.innerWidth),t("height",window.innerHeight)})};window.addEventListener("resize",o),b(()=>{window.removeEventListener("resize",o)});let[e,s]=O({leftPressed:!1,rightPressed:!1,jumpPressed:!1}),r=new $e;const _="ArrowLeft",l="ArrowRight",d=" ";let h=new qt,f=new to;mt(()=>{s("leftPressed",h.leftPressed()),s("rightPressed",h.rightPressed()),s("jumpPressed",f.jumpPressed())});let u=p=>{p.key==_?s("leftPressed",!0):p.key==l?s("rightPressed",!0):p.key==d&&s("jumpPressed",!0)},n=p=>{p.key==_?s("leftPressed",!1):p.key==l?s("rightPressed",!1):p.key==d&&s("jumpPressed",!1)};document.addEventListener("keydown",u),document.addEventListener("keyup",n),b(()=>{document.removeEventListener("keydown",u),document.removeEventListener("keyup",n)});{let p=0,S=0,w=v=>{let z=v/1e3,x=z-S;S=z,lt(()=>{let{dtOffset:P}=fo({dtOffset:p,dt:x,updateFn:()=>r.update({windowSize:c,leftPressed:e.leftPressed,rightPressed:e.rightPressed,jumpPressed:e.jumpPressed,playSoundEffect:Ct,playBackgroundMusic:At})});p=P}),requestAnimationFrame(w)};r.update({windowSize:c,leftPressed:e.leftPressed,rightPressed:e.rightPressed,jumpPressed:e.jumpPressed,playSoundEffect:Ct,playBackgroundMusic:At}),mt(nt(at,()=>{at()&&requestAnimationFrame(w)}))}const m=new te;let[G]=se(async()=>(await m.init({background:"#00f8f8",resizeTo:window}),m));return b(()=>{m.destroy()}),(()=>{var p=no();return L(p,Y(Gt,{get when(){return G()},children:S=>{m.stage.addChild(po({windowSize:c,tileset:Dt,spritesheet:Xt,smSpritesheet:Yt,world:r}));let w=new bt({texture:jt.textures.mario_standing,x:100,y:100,scale:5});return m.stage.addChild(w),m.canvas}}),null),L(p,Y(h.Render,{}),null),L(p,Y(f.Render,{}),null),L(p,Y(Gt,{get when(){return!at()},get children(){var S=ro();return S.style.setProperty("position","absolute"),S.style.setProperty("left","0"),S.style.setProperty("top","0"),S.style.setProperty("right","0"),S.style.setProperty("bottom","0"),S.style.setProperty("display","flex"),S.style.setProperty("align-items","center"),S.style.setProperty("justify-content","center"),S.style.setProperty("color","red"),S.style.setProperty("font-weight","bold"),S.style.setProperty("font-size","32pt"),S}}),null),p})()};function po(c){let t=y(()=>c.world.state.camera.pos.x),o=y(()=>c.world.state.camera.pos.y),e=r=>{let _=M(()=>c.spritesheet),l=M(()=>c.smSpritesheet);if(r instanceof C){let d=r.actor.state,h=r.animated.animation,f=y(()=>_.animations[h()]),u=new wt(M(f));return y(()=>{u.x=d.pos.x-t(),u.y=d.pos.y-o()}),R(()=>{u.tint=d.tint??16777215}),y(nt(f,()=>{u.textures=f(),u.play()},{defer:!0})),R(()=>{let n;switch(h()){case"kitty_hurt":n=.15;break;default:n=.3;break}u.animationSpeed=n}),u.scale=5,y(()=>{r.animated.flipX()?(u.scale.set(-5,5),u.pivot.set(12,0)):(u.scale=5,u.pivot.set(0,0))}),u.play(),u}else if(r.animated!=null){let d=r.animated,h=r.actor.state,f=r.animated.animation,u=y(()=>l.animations[f()]),n=new wt(M(u));return y(()=>{n.x=h.pos.x-t(),n.y=h.pos.y-o()}),R(()=>{n.tint=h.tint??16777215}),y(nt(u,()=>{n.textures=u(),n.play()},{defer:!0})),n.animationSpeed=.1,R(()=>{n.animationSpeed=d.animationSpeed?.()??.1}),n.scale=5,R(()=>{d.flipX()?(n.scale.set(-5,5),n.pivot.set(h.size.x/5,0)):(n.scale=5,n.pivot.set(0,0))}),n.filters=_o,n.play(),n}},s=new rt;return s.addChild(So({get windowSize(){return c.windowSize},get tileset(){return c.tileset},get cameraX(){return t()},get cameraY(){return o()},get level(){return c.world.state.level}})),y(ct(()=>c.world.state.actors,(r,_)=>{let l=e(r);l!=null&&(s.addChild(l),b(()=>{s.removeChild(l)}))})),s}function Mt(c,t){let o=c%t;return o<0&&(o+=t),o}function So(c){const t=()=>48,o=t,e=()=>Math.ceil(c.windowSize.width/t())+1,s=()=>Math.ceil(c.windowSize.height/o())+1,r=()=>t()*e(),_=()=>o()*s();let l=y(()=>new Array(e()).fill(void 0).map((f,u)=>u)),d=y(()=>new Array(s()).fill(void 0).map((f,u)=>u)),h=new rt;return y(ct(d,f=>{let u=y(()=>f*o()-c.cameraY),n=y(()=>Mt(u()+o(),_())-o()),m=y(()=>Math.floor((_()-u()-o())/_())*s()+f),G=new rt;y(ct(l,p=>{let S=y(()=>p*t()-c.cameraX),w=y(()=>Mt(S()+t(),r())-t()),v=y(()=>Math.floor((r()-S()-t())/r())*e()+p),z=y(()=>{let P=v(),k=m();return c.level.readTile(P,k)}),x=new bt;x.scale=3,y(()=>{let P=z();P==null?x.visible=!1:(x.texture=c.tileset.textures[P],x.visible=!0)}),y(()=>{x.x=w(),x.y=n()}),G.addChild(x),b(()=>{G.removeChild(x)})})),h.addChild(G),b(()=>{h.removeChild(G)})})),h}export{To as default};
