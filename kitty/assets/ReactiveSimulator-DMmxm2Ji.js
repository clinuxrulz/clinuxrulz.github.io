import{Vec2 as z,s as f,t as D,a as R,i as I,u as K,d as ee}from"./lib-DkxVE27J.js";import{s as U,l as v,q as u,S as $,F,c as A,m as B,Y as O,O as H,N as te}from"./dev-B9-ass9r.js";import{a as W}from"./dev-CC7pdsS5.js";import"./index-XNH-lkY3.js";class re{constructor(t){}}var oe=D("<svg><circle r=20 pointer-events=none></svg>",!1,!0),ne=D("<svg><line stroke=black stroke-width=2 pointer-events=none></svg>",!1,!0),se=D("<svg><path fill=black pointer-events=none></svg>",!1,!0);const ie=(()=>{let n=new Map([["Unknown","blue"],["Dirty","brown"],["Clean","green"]]);return t=>n.get(t)})(),P=20,le=P*P,V=20;class de{state;setState;constructor(t){let[o,e]=W({position:t.initPos??z.zero,sources:[],sinks:[],flag:"Unknown"});this.state=o,this.setState=e}Render=t=>{const o=this;return[(()=>{var e=oe();return U(r=>{var i=o.state.position.x,s=o.state.position.y,l=t.isSelected?"red":"black",d=t.isHighlighted||t.isSelected?6:2,g=ie(o.state.flag);return i!==r.e&&f(e,"cx",r.e=i),s!==r.t&&f(e,"cy",r.t=s),l!==r.a&&f(e,"stroke",r.a=l),d!==r.o&&f(e,"stroke-width",r.o=d),g!==r.i&&f(e,"fill",r.i=g),r},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),e})(),v(F,{get each(){return o.state.sinks},children:e=>{let r=u(()=>e.state.sources.some(s=>s===o)),i=u(()=>{let s=e.state.position.sub(o.state.position).normalize();if(!Number.isFinite(s.x))return;let l=s.multScalar(P).add(o.state.position),d=s.multScalar(-P).add(e.state.position);return{v1:l,v2:d}});return v($,{get when(){return i()},children:s=>v(Y,{get v1(){return s().v1},get v2(){return s().v2},get hasArrowStart(){return r()},hasArrowEnd:!0,arrowSize:V})})}}),v(F,{get each(){return o.state.sources},children:e=>{let r=u(()=>e.state.sinks.some(s=>s===o)),i=u(()=>{let s=o.state.position.sub(e.state.position).normalize();if(!Number.isFinite(s.x))return;let l=s.multScalar(P).add(e.state.position),d=s.multScalar(-P).add(o.state.position);return{v1:l,v2:d}});return v($,{get when(){return u(()=>!!r())()?void 0:i()},children:s=>v(Y,{get v1(){return s().v1},get v2(){return s().v2},hasArrowStart:!0,hasArrowEnd:!1,arrowSize:V})})}})]}}const Y=n=>{let t=u(()=>{let o=n.v2.sub(n.v1).normalize();return Number.isFinite(o.x)?o.multScalar(.25*V*Math.sqrt(3)).add(n.v1.add(n.v2).multScalar(.5)):n.v1.add(n.v2).multScalar(.5)});return[(()=>{var o=ne();return U(e=>{var r=n.v1.x,i=n.v1.y,s=n.v2.x,l=n.v2.y;return r!==e.e&&f(o,"x1",e.e=r),i!==e.t&&f(o,"y1",e.t=i),s!==e.a&&f(o,"x2",e.a=s),l!==e.o&&f(o,"y2",e.o=l),e},{e:void 0,t:void 0,a:void 0,o:void 0}),o})(),v(E,{get v1(){return n.v1},get v2(){return t()},get arrowSize(){return n.arrowSize}}),v($,{get when(){return n.hasArrowStart},get children(){return v(E,{get v1(){return n.v2},get v2(){return n.v1},get arrowSize(){return n.arrowSize}})}}),v($,{get when(){return n.hasArrowEnd},get children(){return v(E,{get v1(){return n.v1},get v2(){return n.v2},get arrowSize(){return n.arrowSize}})}})]},E=n=>{let t=u(()=>{let o=n.v2.sub(n.v1).normalize();if(!Number.isFinite(o.x))return;let e=z.create(o.y,-o.x),r=.5*n.arrowSize*Math.sqrt(3),i=o.multScalar(-r).add(n.v2),s=`matrix(${o.x},${o.y},${e.x},${e.y},${i.x},${i.y})`,l=`M 0 ${-.5*n.arrowSize} L ${r} 0 L 0 ${.5*n.arrowSize} Z`;return{transformStr:s,pathStr:l}});return v($,{get when(){return t()},children:o=>(()=>{var e=se();return U(r=>{var i=o().transformStr,s=o().pathStr;return i!==r.e&&f(e,"transform",r.e=i),s!==r.t&&f(e,"d",r.t=s),r},{e:void 0,t:void 0}),e})()})};class ue{instructions;click;constructor(t){let o=u(()=>{let l=t.mousePos();if(l!=null)return t.screenPtToWorldPt(l)}),[e,r]=A(0),i=()=>{r(l=>1-l)},s=()=>{};{let l=u(()=>o()!=null);B(()=>{if(e(),!l())return;let d=o,g=O(()=>new de({initPos:d()}));O(()=>{t.addNode(g)});let M=!1;s=()=>{M=!0,i()},H(()=>{s=()=>{},!M&&t.removeNode(g)}),B(te(d,()=>{g.setState("position",d())},{defer:!0}))})}this.instructions=()=>"Click where you would like to place the nodes. Press escape when finished.",this.click=()=>{s()}}}class Z{instructions;highlightNodes;selectedNodes;click;constructor(t){let o=t.modeParams,e=()=>t.type,[r,i]=W({sourceNode:void 0}),s=o.pickingSystem.nodeUnderMouse;this.instructions=()=>(r.sourceNode==null?"Select source node.":"Select target node.")+" (Press escape when you are done.)",this.highlightNodes=u(()=>R(s())),this.selectedNodes=u(()=>R(r.sourceNode)),this.click=()=>{if(r.sourceNode==null){let d=s();d!=null&&i("sourceNode",d);return}let l=s();l!=null&&(e()=="Double"&&r.sourceNode.setState("sinks",[...r.sourceNode.state.sinks,l]),l.setState("sources",[...l.state.sources,r.sourceNode]),i("sourceNode",void 0))}}}class ae{instructions;click;constructor(t){let o=t.pickingSystem.nodeUnderMouse,e=r=>{r.state.flag=="Dirty"?r.setState("flag","Unknown"):r.setState("flag","Dirty")};this.instructions=()=>"Click nodes to toggle their dirtyness. Press escape when done.",this.click=()=>{let r=o();r!=null&&e(r)}}}var ce=D("<div>Simulation is running.<br>Step: ");const ve=1e3;class ge{instructions;highlightNodes;selectedNodes;constructor(t){let e={isDone:!1,nodesToVisit:O(()=>{let i=[];for(let s of t.nodes())s.state.flag=="Dirty"&&i.push(s);return i}),nodesToResetUnknown:[],stepCounter:A(0),cursorAt:A(void 0),executingNode:A(void 0)},r=setInterval(()=>{this.stepAlgorithmn(e),e.isDone&&t.onDone()},ve);H(()=>{for(let i of e.nodesToResetUnknown)i.setState("flag","Unknown");clearInterval(r)}),this.instructions=()=>(()=>{var i=ce(),s=i.firstChild,l=s.nextSibling;return l.nextSibling,I(i,()=>e.stepCounter[0](),null),i})(),this.highlightNodes=u(()=>R(e.cursorAt[0]())),this.selectedNodes=u(()=>R(e.executingNode[0]()))}stepAlgorithmn(t){{let e=t.executingNode[0]();if(e!=null){e.setState("flag","Clean"),t.nodesToResetUnknown.push(e);for(let r of e.state.sinks)r.setState("flag","Dirty"),t.nodesToResetUnknown.push(r),t.nodesToVisit.push(r);t.executingNode[1](void 0),t.stepCounter[1](r=>r+1);return}}let o=t.cursorAt[0]();if(o==null){let e=t.nodesToVisit.pop();if(e==null)return;t.cursorAt[1](e),t.stepCounter[1](r=>r+1);return}for(let e of o.state.sources)if(e.state.flag!="Clean"){t.nodesToVisit.push(o),t.cursorAt[1](e),t.stepCounter[1](r=>r+1);return}if(o.state.flag=="Unknown"){o.setState("flag","Clean"),t.nodesToResetUnknown.push(o),t.cursorAt[1](void 0),t.stepCounter[1](e=>e+1);return}if(o.state.flag=="Dirty"){t.executingNode[1](o),t.cursorAt[1](void 0),t.stepCounter[1](e=>e+1);return}for(let e of t.nodesToResetUnknown)e.setState("flag","Unknown"),t.isDone=!0}}class fe{nodeUnderMouse;constructor(t){let o=u(()=>{let r=t.mousePos();if(r!=null)return t.screenPtToWorldPt(r)}),e=u(()=>{let r=o();if(r==null)return;let i,s;for(let l of t.nodes()){let d=r.distanceSquared(l.state.position);d>le||(s==null||d<s)&&(i=l,s=d)}return i});this.nodeUnderMouse=e}}var ye=D('<div><div><button><i class="fa-solid fa-circle-plus"></i></button><button><i class="fa-solid fa-arrows-left-right"></i></button><button><i class="fa-solid fa-arrow-left-long"></i></button><button><i class="fa-solid fa-poo"></i></button><button><i class="fa-solid fa-person-running"></i></button></div><div><svg></svg><div>');const we=()=>{let[n,t]=W({mousePos:z.zero,nodes:[],mode:"Idle"}),o=a=>a,e=a=>a,[r,i]=A(),s=a=>{a.key=="Escape"&&t("mode","Idle")};document.addEventListener("keydown",s),H(()=>{document.removeEventListener("keydown",s)});let l=new fe({mousePos:()=>n.mousePos,screenPtToWorldPt:o,nodes:()=>n.nodes}),d={mousePos:()=>n.mousePos,screenPtToWorldPt:o,worldPtToScreenPt:e,nodes:()=>n.nodes,addNode:a=>{t("nodes",[...n.nodes,a])},removeNode:a=>{t("nodes",n.nodes.filter(y=>y!==a))},onDone:()=>{t("mode","Idle")},pickingSystem:l},g=u(()=>{switch(n.mode){case"Idle":return new re(d);case"Add Node":return new ue(d);case"Add Double Link":return new Z({modeParams:d,type:"Double"});case"Add Single Link":return new Z({modeParams:d,type:"Single"});case"Mark Dirty":return new ae(d);case"Running":return new ge(d)}}),M=()=>u(()=>g().instructions?.({})),G=u(()=>new Set(g().highlightNodes?.()??[])),Q=u(()=>new Set(g().selectedNodes?.()??[])),X=a=>{let y=r();if(y==null)return;let m=y.getBoundingClientRect(),S=z.create(a.clientX-m.left,a.clientY-m.top);t("mousePos",S)},j=a=>{n.mousePos,t("mousePos",void 0)},J=a=>{g().click?.()};return(()=>{var a=ye(),y=a.firstChild,m=y.firstChild,S=m.nextSibling,k=S.nextSibling,w=k.nextSibling,b=w.nextSibling,N=y.nextSibling,h=N.firstChild,C=h.nextSibling;a.style.setProperty("flex-grow","1"),a.style.setProperty("display","flex"),a.style.setProperty("flex-direction","column"),y.style.setProperty("margin-top","5px"),y.style.setProperty("margin-bottom","5px"),m.$$click=()=>t("mode","Add Node"),m.style.setProperty("font-size","24pt"),m.style.setProperty("margin-left","5px"),S.$$click=()=>t("mode","Add Double Link"),S.style.setProperty("font-size","24pt"),S.style.setProperty("margin-left","5px"),k.$$click=()=>t("mode","Add Single Link"),k.style.setProperty("font-size","24pt"),k.style.setProperty("margin-left","5px"),w.$$click=()=>t("mode","Mark Dirty"),w.style.setProperty("font-size","24pt"),w.style.setProperty("margin-left","5px"),b.$$click=()=>t("mode","Running"),b.style.setProperty("font-size","24pt"),b.style.setProperty("margin-left","5px"),N.style.setProperty("position","relative"),N.style.setProperty("flex-grow","1"),N.style.setProperty("display","flex"),N.style.setProperty("flex-direction","column"),h.$$click=J,h.$$mouseout=j,h.$$mousemove=X;var q=i;return typeof q=="function"?K(q,h):i=h,h.style.setProperty("flex-grow","1"),h.style.setProperty("background-color","lightgrey"),I(h,v(F,{get each(){return n.nodes},children:c=>{let x=u(()=>G().has(c)),p=u(()=>Q().has(c));return v(c.Render,{get isHighlighted(){return x()},get isSelected(){return p()}})}})),C.style.setProperty("position","absolute"),C.style.setProperty("left","0"),C.style.setProperty("top","0"),I(C,v(M,{})),U(c=>{var x=n.mode=="Add Node"?"blue":void 0,p=n.mode=="Add Double Link"?"blue":void 0,T=n.mode=="Add Single Link"?"blue":void 0,L=n.mode=="Mark Dirty"?"blue":void 0,_=n.mode=="Running"?"blue":void 0;return x!==c.e&&((c.e=x)!=null?m.style.setProperty("background-color",x):m.style.removeProperty("background-color")),p!==c.t&&((c.t=p)!=null?S.style.setProperty("background-color",p):S.style.removeProperty("background-color")),T!==c.a&&((c.a=T)!=null?k.style.setProperty("background-color",T):k.style.removeProperty("background-color")),L!==c.o&&((c.o=L)!=null?w.style.setProperty("background-color",L):w.style.removeProperty("background-color")),_!==c.i&&((c.i=_)!=null?b.style.setProperty("background-color",_):b.style.removeProperty("background-color")),c},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),a})()};ee(["click","mousemove","mouseout"]);export{we as default};
