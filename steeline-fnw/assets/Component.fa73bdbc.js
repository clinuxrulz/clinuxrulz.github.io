import{f as $,a as p,D as K,E as T,g as U,t as A,G as _,H as R,c as P,y as G}from"./index.5aba22ff.js";import{a as v}from"./Vec3.ce1f4f7a.js";import{d as D,e as I,f as H,g as L,h as F,P as q}from"./PropertiesForm.c69fa44e.js";import{a3 as S,T as M,b as Q}from"./Component.6024a649.js";function h(e){return{type:"Ok",value:e}}function d(e){return{type:"Err",message:e}}function ce(e,i,t){return{type:"InvMap",typeSchema:t,fn1:e,fn2:i}}function X(e){return e.type=="InvMap"&&typeof e.fn1=="function"}function Y(e,i,t){if(typeof i!="object")return d("Expected JSON Object.");if(e.type=="InvMap"&&typeof e.fn1=="function"){let n=e,o=Y(n.propertiesSchema,i,t);return o.type=="Err"?d("Failed to parse through properties invariant map. "+o.message):h(n.fn1(o.value))}let r=e,l={};for(let n in r){let o=r[n],a=o.optional??!1,s;if(i.hasOwnProperty(n)){let u=N(o.typeSchema,i[n]);if(u.type=="Err")return d("Failed to parse JSON Object at key `"+n+"`. "+u.message);s=u.value}else if(a||!t)s=o.defaultValue;else return d("Missing key `"+n+"` on JSON Object.");l[n]=s}return h(l)}function N(e,i,t){switch(e.type){case"Optional":{if(i==null)return h({has:!1});let a=N(e.elemTypeSchema,i);return a.type=="Err"?d("Failed to parse Optional value. "+a.message):h({has:!0,value:a.value})}case"MaybeUndefined":{if(i==null)return h(void 0);let a=N(e.elemTypeSchema,i);return a.type=="Err"?d("Failed to parse MaybeUndefined value. "+a.message):h(a.value)}case"Boolean":return typeof i!="boolean"?d("Expected Boolean."):h(i);case"Number":return typeof i!="number"?d("Expected Number."):h(i);case"String":return typeof i!="string"?d("Expected String."):h(i);case"Array":{if(typeof i!="object"||!i.hasOwnProperty("length"))return d("Expected JSON Array.");let a=i.length;if(typeof a!="number")return d("Expected JSON Array.");let s=[];for(let u=0;u<a;++u){let c=N(e.elemTypeSchema,i[u]);if(c.type=="Err")return d("Failed to parse JSON Array element at "+u+". "+c.message);s.push(c.value)}return h(s)}case"Union":if(typeof i!="object")return d("Expected JSON Object.");if(!i.hasOwnProperty("type"))return d("JSON Object missing field `type`. (Parsing union.)");let r=i.type;if(typeof r!="string")return d("JSON Object field `type` is meant to be of type string.");if(!e.parts.hasOwnProperty(r))return d("JSON Object `type` is not one of the valid types in the union type schema.");let l=e.parts[r],o=N({type:"Object",properties:l},i);return o.type=="Err"?d("Failed to parse union. "+o.message):h({...o.value,type:r});case"Object":{if(typeof i!="object")return d("Expected JSON Object.");let a={};for(let s in e.properties){let u=e.properties[s],c=u.typeSchema,f,y=u.optional??!1;if(i.hasOwnProperty(s)){let m=N(c,i[s]);if(m.type=="Err")return d("Failed to parse JSON Object at key `"+s+"`. "+m.message);f=m.value}else if(y)f=u.defaultValue;else return d("Missing key `"+s+"` on JSON Object.");a[s]=f}return h(a)}case"Json":return h(i);case"InvMap":{let a=e.typeSchema,s=N(a,i);return s.type=="Err"?d("Failed to parse through invariant map. "+s.message):h(e.fn1(s.value))}case"Recursive":{let a=e.typeSchema();return N(a,i)}}}function Z(e,i){if(e.type=="InvMap"&&typeof e.fn1=="function")return Z(e.propertiesSchema,e.fn2(i));let t=e,r={};for(let l in t){let n=t[l],o=E(n.typeSchema,i[l]);r[l]=o}return r}function fe(e,i){let t=Z(e,i),r=Y(e,t);if(r.type=="Err")throw new Error("deepCopyViaPropertiesSchema failed: "+r.message);return r.value}function E(e,i){switch(e.type){case"Optional":return i.has?E(e.elemTypeSchema,i.value):null;case"MaybeUndefined":return i==null?null:E(e.elemTypeSchema,i);case"Boolean":return i;case"Number":return i;case"String":return i;case"Array":{let t=[],r=i;for(let l=0;l<r.length;++l){let n=r[l],o=E(e.elemTypeSchema,n);t.push(o)}return t}case"Union":{let t=i.type,r=i,l={type:"Object",properties:e.parts[t]};return{...E(l,r),type:t}}case"Object":{let t={};for(let r in e.properties){let l=e.properties[r],n=E(l.typeSchema,i[r]);t[r]=n}return t}case"Json":return i;case"InvMap":{let t=e.typeSchema;return E(t,e.fn2(i))}}}function j(e){if(X(e)){let r=e;return r.fn1(j(r.propertiesSchema))}let i=e,t={};for(let r in i){let l=i[r];t[r]=l.defaultValue}return t}function O(e){switch(e.type){case"Optional":return{has:!1};case"MaybeUndefined":return;case"Boolean":return!1;case"Number":return 0;case"String":return"";case"Array":return[];case"Union":{let i=Object.keys(e.parts)[0],t=e.parts[i];return{...O({type:"Object",properties:t}),type:i}}case"Object":{let i={};for(let t in e.properties){let r=e.properties[t];i[t]=r.defaultValue}return i}case"Json":return{};case"InvMap":{let i=e.typeSchema;return e.fn1(O(i))}case"Recursive":{let i=e.typeSchema();return O(i)}}}const W=A('<input class="btn btn-primary" type="button" value="Delete">'),ee=A('<input class="btn btn-primary" type="button" value="Add">');function C(e){if(X(e.propertiesSchema)){let l=e.propertiesSchema;return C({get displayName(){return e.displayName},propertiesSchema:l.propertiesSchema,values:p(()=>e.values().map(l.fn2)),setValue:(n,o)=>{e.setValue(n,l.fn1(o))}})}let i=e.propertiesSchema,r=x({typeSchema:{type:"Object",properties:i},fieldDisplayName:p(()=>""),values:e.values,setValue:e.setValue});return p(()=>({displayName:e.displayName,fields:r(),expanded:()=>!0}))}function x(e){let i=e.typeSchema;switch(i.type){case"InvMap":{let t=i;return x({typeSchema:t.typeSchema,fieldDisplayName:e.fieldDisplayName,values:p(()=>e.values().map(t.fn2)),setValue:(r,l)=>{e.setValue(r,t.fn1(l))}})}case"Recursive":return x({...e,typeSchema:i.typeSchema()});case"MaybeUndefined":{let t=i,r=p(()=>T(e.values().map(a=>a!=null))),l=p(()=>e.values().flatMap((a,s)=>a!=null?[{x:a,index:s}]:[])),n=x({typeSchema:t.elemTypeSchema,fieldDisplayName:e.fieldDisplayName,values:p(()=>l().map(a=>a.x)),setValue:(a,s)=>{let u=l()[a].index;e.setValue(u,s)}}),o=p(()=>e.values().some(a=>a!=null));return p(()=>[F({displayName:()=>"Has "+e.fieldDisplayName(),value:r,setValue:a=>{U(()=>{let s=e.values(),u=0;for(let c of s)a?c==null&&e.setValue(u,O(t.elemTypeSchema)):c!=null&&e.setValue(u,void 0),++u})}}),...o()?n():[]])}case"Optional":{let t=i,r=e.values,l=p(()=>T(r().map(s=>s.has))),n=p(()=>r().flatMap((s,u)=>s.has?[{x:s.value,index:u}]:[])),o=x({typeSchema:t.elemTypeSchema,fieldDisplayName:e.fieldDisplayName,values:p(()=>n().map(s=>s.x)),setValue:(s,u)=>{let c=n()[s].index;e.setValue(c,{has:!0,value:u})}}),a=p(()=>e.values().some(s=>s.has==!0));return p(()=>[F({displayName:()=>"Has "+e.fieldDisplayName(),value:l,setValue:s=>{U(()=>{let u=e.values(),c=0;for(let f of u)s?f==null&&e.setValue(c,{has:!0,value:O(t.elemTypeSchema)}):f!=null&&e.setValue(c,{has:!1}),++c})}}),...a()?o():[]])}case"Boolean":{let t=p(()=>T(e.values()));return p(()=>[F({displayName:e.fieldDisplayName,value:t,setValue:r=>{let l=e.values().length;for(let n=0;n<l;++n)e.setValue(n,r)}})])}case"Number":{let t=p(()=>T(e.values()));return p(()=>[L({displayName:e.fieldDisplayName,value:t,setValue:r=>{let l=e.values().length;for(let n=0;n<l;++n)e.setValue(n,r)}})])}case"String":{let t=p(()=>T(e.values()));if(i.possibleValues!=null){let r=i.possibleValues;return p(()=>[I({displayName:e.fieldDisplayName,value:t,setValue:l=>{let n=e.values().length;for(let o=0;o<n;++o)e.setValue(o,l)},possibleValues:()=>r})])}else return p(()=>[H({displayName:e.fieldDisplayName,value:t,setValue:r=>{let l=e.values().length;for(let n=0;n<l;++n)e.setValue(n,r)}})])}case"Array":{let t=i,r=e.values,l=p(()=>r().reduce((a,s)=>Math.max(a,s.length),0)),n=p(()=>{let a=[],s=l();for(let u=0;u<s;++u)a.push(u);return a}),o=p(K(n,a=>{let s=p(()=>r().flatMap((c,f)=>a<c.length?[{x:c[a],index:f}]:[])),u=x({typeSchema:t.elemTypeSchema,fieldDisplayName:p(()=>e.fieldDisplayName()+"["+a+"]"),values:p(()=>s().map(({x:c})=>c)),setValue:(c,f)=>{let y=s()[c].index,m=r()[y];if(a<m.length){let g=[...m];g[a]=f,e.setValue(y,g)}}});return p(()=>[...u(),D({displayName:()=>"Delete "+e.fieldDisplayName()+"["+a+"]",component:c=>(()=>{const f=W.cloneNode(!0);return f.$$click=()=>{let y=r();for(let m=0;m<y.length;++m){let g=y[m];if(a<g.length){let b=[...g];b.splice(a,1),e.setValue(m,b)}}},f})()})])}));return p(()=>[...o().flatMap(a=>a()),D({displayName:()=>"Add "+e.fieldDisplayName(),component:a=>(()=>{const s=ee.cloneNode(!0);return s.$$click=()=>{let u=l(),c=r();for(let f=0;f<c.length;++f){let y=c[f];if(y.length==u){let m=[...y,O(t.elemTypeSchema)];e.setValue(f,m)}}},s})()})])}case"Union":{let t=i,r=e.values,l=p(()=>T(r().map(s=>s.type))),n=p(()=>{let s=l();return s==null?p(()=>[]):x({typeSchema:{type:"Object",properties:t.parts[s]},fieldDisplayName:e.fieldDisplayName,values:e.values,setValue:(u,c)=>{let f=l();f!=null&&e.setValue(u,{type:f,...c})}})}),o=p(()=>n()()),a=p(()=>l()!=null);return p(()=>[I({displayName:p(()=>e.fieldDisplayName()+" Type"),value:l,setValue:s=>{U(()=>{let u=e.values();for(let c=0;c<u.length;++c)if(u[c].type!=s){let y=O({type:"Object",properties:t.parts[s]});y.type=s,e.setValue(c,y)}})},possibleValues:p(()=>Object.keys(t.parts))}),...a()?o():[]])}case"Object":{let t=i,r=p(K(p(()=>Object.keys(t.properties)),l=>{let n=t.properties[l],o=p(()=>e.values().map(a=>a[l]));return x({typeSchema:n.typeSchema,fieldDisplayName:p(()=>e.fieldDisplayName().length==0?n.displayName:e.fieldDisplayName()+"."+n.displayName),values:o,setValue:(a,s)=>{let c={...e.values()[a]};c[l]=s,e.setValue(a,c)}})}));return p(()=>r().flatMap(l=>l()))}case"Json":return p(()=>[D({displayName:e.fieldDisplayName,component:({editing:t,onDoneEdit:r})=>"TODO"})])}}$(["click"]);function J(e){let i=S.empty();for(let t of e){let r=(t.transform??(()=>M.identity))();if(t.children!=null){let l=J(t.children());Number.isFinite(l.minX)&&l.forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)})}if(t.ceeProperties!=null&&t.length!=null&&new S({minX:0,minY:0,minZ:0,maxX:t.length(),maxY:t.ceeProperties().webSize,maxZ:t.ceeProperties().flangeSize}).forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)}),t.panelMemberProperties!=null&&t.length!=null&&new S({minX:0,minY:0,minZ:0,maxX:t.length(),maxY:t.panelMemberProperties().webSize,maxZ:t.panelMemberProperties().flangeSize}).forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)}),t.timberProperties!=null&&t.length!=null&&new S({minX:0,minY:0,minZ:0,maxX:t.length(),maxY:t.timberProperties().webSize,maxZ:t.timberProperties().flangeSize}).forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)}),t.wireProperties!=null&&t.length!=null&&new S({minX:0,minY:-.5*t.wireProperties().diameter,minZ:-.5*t.wireProperties().diameter,maxX:t.length(),maxY:.5*t.wireProperties().diameter,maxZ:.5*t.wireProperties().diameter}).forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)}),t.mkObject3d!=null&&_(l=>{t.localAabbFromMkObject3d()().forEachCorner((o,a,s)=>{let u=r.pointFromThisSpace(v.create(o,a,s));i.includePoint(u)}),l()}),t.rhsProperties!=null&&t.length!=null&&new S({minX:0,minY:0,minZ:0,maxX:t.length(),maxY:t.rhsProperties().webSize,maxZ:t.rhsProperties().flangeSize}).forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)}),t.shsProperties!=null&&t.length!=null&&new S({minX:0,minY:0,minZ:0,maxX:t.length(),maxY:t.shsProperties().size,maxZ:t.shsProperties().size}).forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)}),t.flatProperties!=null&&t.length!=null&&new S({minX:0,minY:0,minZ:0,maxX:t.length(),maxY:t.flatProperties().width,maxZ:t.flatProperties().thickness}).forEachCorner((n,o,a)=>{let s=r.pointFromThisSpace(v.create(n,o,a));i.includePoint(s)}),t.line!=null){let l=t.line();new S({minX:Math.min(l.v1.x,l.v2.x)-10,minY:Math.min(l.v1.y,l.v2.y)-10,minZ:Math.min(l.v1.z,l.v2.z)-10,maxX:Math.max(l.v1.x,l.v2.x)+10,maxY:Math.max(l.v1.y,l.v2.y)+10,maxZ:Math.max(l.v1.z,l.v2.z)+10}).forEachCorner((o,a,s)=>{let u=r.pointFromThisSpace(v.create(o,a,s));i.includePoint(u)})}}return i}function te(e){let i=K(e,({id:t,kit:r,children:l,space:n})=>{let o=l==null?p(()=>[]):te(l);return new Q({children:p(()=>[...r.components?.call(void 0)??[],...o()]),transform:p(()=>n?.call(void 0)??M.identity)})});return p(()=>i())}function de(e,i){let t=[...i].reverse();for(;;){let r=t.pop();if(r==null)break;if(r.kit.allocateLabels!=null&&r.kit.allocateLabels(e),r.kit.kits!=null){let l=r.kit.kits();for(let n=l.length-1;n>=0;--n){let o=l[n];t.push(o)}}if(r.children!=null){let l=r.children();for(let n=l.length-1;n>=0;--n){let o=l[n];t.push(o)}}}}let V=[];function ye(e){let i=!1;for(let t=0;t<V.length;++t)if(V[t].componentType.typeName==e.componentType.typeName){V[t]=e,i=!0;break}i||V.push(e)}function me(){return V}async function he(e,i){let t=e.componentType.propertiesSchema,r=j(t),[l,n]=P(r),[o,a]=P({});return()=>e.create(i,l,n,()=>o,a)}function ve(e,i){let[t,r]=[e.state,e.setState],[l,n]=[e.kitsUserEdits,e.setKitsUserEdits];return e.type.create(i,t,r,l,n)}function be(e){if(e.properties!=null)return e.properties;let i=C({displayName:e.type.componentType.displayName,propertiesSchema:e.type.componentType.propertiesSchema,values:p(()=>[e.state]),setValue:(t,r)=>{e.setState(r)}});return p(()=>[i()])}function Se(e){return new ie(e).mkKitFunction}class ie{constructor(i){this.kitsUserEdits=i.kitsUserEdits,this.setKitsUserEdits=i.setKitsUserEdits}get mkKitFunction(){return i=>this.mkKit(i)}mkKit(i){return le({kitsUserEdits:this.kitsUserEdits,setKitsUserEdits:this.setKitsUserEdits,id:i.id,kitType:i.kitType,state:i.state,space:i.space,children:i.children})}}function le(e){let i=p(()=>e.kitsUserEdits()[e.id]),t=p(()=>i()?.type=="Delete"),r=p(()=>{let l=i();return l==null?!0:l.type=="Override Properties"});return p(()=>{if(!t()&&r()){let l=p(()=>{let u=i();return u?.type=="Override Properties"?u.userProperties:{}}),n=p(()=>{let u=i();return u?.type=="Override Properties"?u.childKitsEdits:{}}),o=(...u)=>{U(()=>{e.setKitsUserEdits(e.id,"type","Override Properties"),e.setKitsUserEdits(e.id,"childKitEdits",...u)})},a=(...u)=>{let c=f=>{let y=u[u.length-1];return typeof y=="function"?y(f):y};for(let f=u.length-2;f>=0;--f){let y=c,m=u[f],g=b=>{let w={};return w[m]=y(b[m]),{...b,...w}};c=b=>g(b??{})}e.setKitsUserEdits.apply(e.setKitsUserEdits,[e.id,c])},s=G();return{id:e.id,kitId:s,kit:e.kitType.create(s,re(e.kitType.componentType.propertiesSchema,e.state,l),(...u)=>{U(()=>{a("type","Override Properties"),a("userProperties",...u)})},n,o),space:e.space,children:e.children}}})}function re(e,i,t){return new Proxy({},{get:(l,n)=>{let o=n,a=t()==null?void 0:t()[n],s=e[o];if(a==null){let u=i[o];return u?.()}return k(s.typeSchema,i[o],a)}})}function k(e,i,t){switch(e.type){case"InvMap":return e.fn1(k(e.typeSchema,p(()=>e.fn2(i())),t));case"Recursive":return k(e.typeSchema(),i,t);case"Optional":if(typeof t!="object"||t==null||!t.hasOwnProperty("has")||typeof t.has!="boolean")return i();if(t.has){if(!t.hasOwnProperty("value"))return i();let s,u=i();return u.has?s=u.value:s=O(e.elemTypeSchema),{has:!0,value:k(e.elemTypeSchema,()=>s,t.value)}}else return{has:!1};case"MaybeUndefined":{if(t==null)return;let s=i?.call(void 0);return s==null?t:k(e.elemTypeSchema,()=>s,t)}case"Boolean":return typeof t!="boolean"?i():t;case"Number":return typeof t!="number"?i():t;case"String":return typeof t!="string"?i():t;case"Array":return typeof t!="object"||t==null||!t.hasOwnProperty("length")||typeof t.length!="number"?i():t;case"Union":if(typeof t!="object"||t==null||!t.hasOwnProperty("type")||typeof t.type!="string")return i();let r=t.type,l=e.parts[r];if(l==null)return i();let n={type:"Object",properties:l},o,a=i();return a.type!=r?o=O(n):o=a,{...k(n,()=>o,t),type:r};case"Object":{if(typeof t!="object"||t==null||Object.keys(t).length==0)return i();let s={};for(let u in e.properties){let c=e.properties[u],f=t[u];f==null?s[u]=i()[u]:s[u]=k(c.typeSchema,p(()=>i()[u]),f)}return s}case"Json":return o}}function z(e,{id:i,kit:t,children:r,space:l}){let n,o=s=>{let u=K(s,c=>z(e,c));return p(()=>u())};if(t.kits==null)r==null?n=void 0:n=o(r);else if(r==null)n=o(t.kits);else{let s=o(t.kits),u=o(r);n=p(()=>[...s(),...u()])}let a=p(()=>{let s;if(t.components==null?s=S.empty():s=J(t.components()),n!=null){let u=n();for(let c of u){let f=c.localAabb(),y=c.space();f.forEachCorner((m,g,b)=>{let w=v.create(m,g,b),B=y.pointFromThisSpace(w);s.includePoint(B)})}}return s});return{id:()=>i,space:l??(()=>M.identity),localAabb:a,rayCollisionTime:t.rayCollision,properties:()=>[],propertiesForm:()=>{let s=C({displayName:t.type.componentType.displayName,propertiesSchema:t.type.componentType.propertiesSchema,values:p(()=>[t.state]),setValue:(u,c)=>{t.setState(c)}});return q({get fieldGroups(){return[s()]}})},delete:()=>{e.setKitsUserEdits(i,R({type:"Delete"}))},subKitObjects:n}}function ge(e){let i=e,t;if(e.kits==null)t=p(()=>[]);else{let r=e.kits,l=K(r,n=>z(i,n));t=p(()=>l())}return p(()=>[...e.subObjects?.call(void 0)??[],...t()])}function ne(e,i,t){if(e.layers!=null){let l=e.layers();if(l!=null&&!l.some(n=>i(n)))return}if(e.rayCollision!=null)return e.rayCollision()(t);let r;if(e.kits!=null)for(let l of e.kits()){let n=ne(l.kit,i,t.toSpace(l.space?.call(l)??M.identity));n!=null&&(r==null||n<r)&&(r=n)}if(r==null&&e.components!=null)for(let l of e.components()){let n=t.toSpace(l.transform?.call(l)??M.identity),o=J([l]).rayCollisionTime(n);o==null||o<0||(r==null||o<r)&&(r=o)}return r}class Oe{constructor(i){this.typeName=i.typeName,this.displayName=i.displayName,this.propertiesSchema=i.propertiesSchema}create(i){let[t,r]=P(i);return new se({type:this,state:t,setState:r})}}class se{constructor(i){this.type=i.type,this.state=i.state,this.setState=i.setState}}export{Oe as C,ie as S,be as a,ge as b,J as c,fe as d,d as e,ne as f,me as g,te as h,ce as i,de as j,he as k,Se as l,j as m,C as n,h as o,Y as p,ye as r,ve as u,Z as w};
