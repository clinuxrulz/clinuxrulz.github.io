import{a as p,c as G,A as Y,B as H,ak as J,g as ee,i as V,e as te,m as se,b as W,t as oe,N as ne,S as fe}from"./index.5aba22ff.js";import{Q as E,T as ce}from"./Component.6024a649.js";import{a as h}from"./Vec3.ce1f4f7a.js";import{P as $}from"./Plane3D.472a05fa.js";import{L as j}from"./Line3D.2b8117f1.js";import{o as K}from"./PanelUtils.894b6d74.js";import{R as z}from"./Ray3D.5e4c723f.js";const ie=.001,ae=ie*ie;function ve(C){let r=[],a=[...C].sort(({line:y},{line:m})=>Math.min(y.v1.x,y.v2.x)-Math.min(m.v1.x,m.v2.x));for(let y=0;y<a.length-1;++y){let m=a[y],O=Math.max(m.line.v1.x,m.line.v2.x),I=[m];for(let M=y+1;M<a.length;++M){let A=a[M],x=Math.min(A.line.v1.x,A.line.v2.x);if(O<x)break;I.push(A)}I.sort(({line:M},{line:A})=>Math.min(M.v1.y,M.v2.y)-Math.min(A.v1.y,A.v2.y));for(let M=0;M<I.length-1;++M){m=I[M];let A=Math.max(m.line.v1.y,m.line.v2.y),x=[m];for(let S=M+1;S<I.length;++S){let T=I[S],w=Math.min(T.line.v1.y,T.line.v2.y);if(A<w)break;x.push(T)}x.sort(({line:S},{line:T})=>Math.min(S.v1.z,S.v2.z)-Math.min(T.v1.z,T.v2.z));for(let S=0;S<x.length-1;++S){m=x[S];let T=Math.max(m.line.v1.z,m.line.v2.z),w=z.create(m.line.v1,m.line.v2.sub(m.line.v1));for(let _=S+1;_<x.length;++_){let t=x[_],l=Math.min(t.line.v1.z,t.line.v2.z);if(T<l)break;let s=z.create(t.line.v1,t.line.v2.sub(t.line.v1)),f=w.closestTimeOnThisRayWithOtherRay(s);if(f==null||f<0||f>1)continue;let d=w.positionFromTime(f),e=s.closestTimeToPoint(d);if(e<0||e>1)continue;let o=s.positionFromTime(e);d.distanceSquared(o)>ae||r.push({line1Id:m.id,line2Id:t.id,intersectionPoint:d})}}}}return r}const re=10,U=re*re,N=.001,X=N*N;class pe{constructor(r){let a=p(()=>{let t=r.mousePos();if(t==null)return;let l,s;for(let f of r.otherSnapPoints()){let d=r.projectPtToScreen(f);if(d==null)continue;let e=t.distanceSquared(d);e>U||(l==null||e<l)&&(l=e,s=f)}return s}),y=p(()=>{let t=r.mouseRay();if(t==null)return[];let l=t,s=r.mousePos();if(s==null)return[];let f=s;return r.lines().filter(({line:d})=>{let e=z.create(d.v1,d.v2.sub(d.v1)),o=e.closestTimeOnThisRayWithOtherRay(l);if(o==null||o<0||o>1)return!1;let i=e.positionFromTime(o),n=r.projectPtToScreen(i);return n==null?!1:f.distanceSquared(n)<U})}),m=p(()=>{let t=r.currentFromPt();if(t==null)return[];let l=t;return r.lines().filter(({line:s})=>{let f=z.create(s.v1,s.v2.sub(s.v1)),d=f.closestTimeToPoint(l);return d<-N||d>1+N?!1:f.positionFromTime(d).distanceSquared(l)<=X})}),O=p(()=>ve(y().map(({line:l},s)=>({id:s.toString(),line:l}))).map(({intersectionPoint:l})=>l)),I=p(()=>{let t=r.mousePos();if(t==null)return;let l=O(),s,f;for(let d of l){let e=r.projectPtToScreen(d);if(e==null)continue;let o=t.distanceSquared(e);o>U||(s==null||o<s)&&(s=o,f=d)}return f}),M=p(()=>{let t=r.mousePos();if(t==null)return;let l=r.currentFromPt();if(l==null)return;{let d=r.projectPtToScreen(l);if(d!=null&&t.distanceSquared(d)<U)return}let s,f;for(let{line:d}of y()){let o=z.create(d.v1,d.v2.sub(d.v1)).closestPoint(l),i=r.projectPtToScreen(o);if(i==null)continue;let n=t.distanceSquared(i);n>U||(s==null||n<s)&&(s=n,f=o)}return f}),A=p(()=>{let t=r.mousePos();if(t==null)return;let l=r.currentFromPt();if(l==null)return;let s=r.currentToPt();if(s==null)return;let f,d;for(let{id:e,line:o}of m()){let i=o.v2.sub(o.v1),n=i.dot(s.sub(l))/i.dot(i),u=s.sub(i.scale(n)),v=r.projectPtToScreen(u);if(v==null)continue;let c=t.distanceSquared(v);c>U||(f==null||c<f)&&(f=c,d={pt:u,fromLineId:e})}return d}),x=p(()=>{let t=r.mousePos();if(t==null)return;let l,s,f,d=[h.zero,h.zero,h.zero];for(let{line:e}of r.lines()){d[0]=e.v1,d[1]=e.v2,d[2]=e.v1.add(e.v2).scale(.5);for(let o=0;o<d.length;++o){let i=o==2?"Mid":"End",n=d[o],u=r.projectPtToScreen(n);if(u==null)continue;let v=t.distanceSquared(u);v>U||(l==null||v<l)&&(l=v,s=i,f=n)}}if(s!=null&&f!=null)return{type:s,pt:f}}),S=p(()=>{let t=r.mousePos();if(t==null)return;let l=r.currentFromPt();if(l==null)return;let s=r.currentToPt();if(s==null)return;{let i=r.projectPtToScreen(l);if(i!=null&&t.distanceSquared(i)<U)return}let f=s.sub(l),d=[{type:"X Axis",pt:l.add(h.create(f.x,0,0))},{type:"Y Axis",pt:l.add(h.create(0,f.y,0))},{type:"Z Axis",pt:l.add(h.create(0,0,f.z))}],e,o;for(let{type:i,pt:n}of d){switch(i){case"X Axis":if(!r.allowXAxisSnap())continue;break;case"Y Axis":if(!r.allowYAxisSnap())continue;break;case"Z Axis":if(!r.allowZAxisSnap())continue;break}let u=r.projectPtToScreen(n);if(u==null)continue;let v=t.distanceSquared(u);if(!(v>U)&&(e==null||v<e)){let c=n.sub(l),k=l.add(h.create(Math.round(c.x),Math.round(c.y),Math.round(c.z)));e=v,o={type:i,pt:k}}}return o}),T=p(()=>{let t=r.mousePos();if(t==null)return;let l=r.currentFromPt();if(l==null)return;let s=A(),f=S(),d=s?.pt??f?.pt;if(d==null)return;let e=d.sub(l),o=z.create(l,e),i=e.normalize(),n=r.lines(),u,v;for(let c of n){let k=[c.line.v1,c.line.v2],D=c.line.v2.sub(c.line.v1).normalize();if(!Number.isFinite(D.x))continue;let P=[];for(let g of k)r.allowXAxisSnap()&&P.push({type:"Align X",plane:$.fromKnownPtAndNormal(g,h.unitX),toLinePt:g}),r.allowYAxisSnap()&&P.push({type:"Align Y",plane:$.fromKnownPtAndNormal(g,h.unitY),toLinePt:g}),r.allowZAxisSnap()&&P.push({type:"Align Z",plane:$.fromKnownPtAndNormal(g,h.unitZ),toLinePt:g}),P.push({type:"Align Perpendicular",plane:$.fromKnownPtAndNormal(g,D),toLinePt:g}),P.push({type:"Align Perpendicular From",plane:$.fromKnownPtAndNormal(g,i),toLinePt:g});let L,b;for(let g of P){let F=o.collisionWithPlane(g.plane);if(F==null)continue;let q=r.projectPtToScreen(F);if(q==null)continue;let R=t.distanceSquared(q);R>U||u!=null&&R>=u||(L==null||R<L)&&(L=R,b={type:g.type,pt:F,toLinePt:g.toLinePt})}if(L!=null&&b!=null){let g=!1;if(!r.allowAlignAll()){for(let F of n)if(F!=c){if(F.line.v1.distanceSquared(b.toLinePt)<X){g=!0;break}if(F.line.v2.distanceSquared(b.toLinePt)<X){g=!0;break}}}g||(u=L,v={...b,toLineId:c.id})}}if(v!=null)return{...v,fromLineId:s?.fromLineId}}),w=p(()=>{let t=r.mousePos();if(t==null)return;let l=r.currentFromPt();if(l==null)return;let s=A(),f=S(),d=s?.pt??f?.pt;if(d==null)return;let e=d.sub(l),o=z.create(l,e),i,n;for(let u of r.lines()){let v=z.create(u.line.v1,u.line.v2.sub(u.line.v1)),c=v.closestTimeOnThisRayWithOtherRay(o);if(c==null||c<-N||c>1+N)continue;let k=v.positionFromTime(c),D=o.closestPoint(k);if(k.distanceSquared(D)>X)continue;let P=r.projectPtToScreen(k);if(P==null)continue;let L=t.distanceSquared(P);L>U||(i==null||L<i)&&(i=L,n=k)}if(n!=null)return{pt:n,fromLineId:s?.fromLineId}}),_=p(()=>{{let t=a();if(t!=null)return{type:"Other",pt:t}}{let t=I();if(t!=null)return{type:"Intersection",pt:t}}{let t=M();if(t!=null)return{type:"Perpendicular",pt:t}}{let t=x();if(t!=null)return{type:t.type,pt:t.pt}}{let t=T();if(t!=null)return t}{let t=w();if(t!=null)return{type:"Intersection To",pt:t.pt,fromLineId:t.fromLineId}}{let t=S();if(t!=null)return t}{let t=A();if(t!=null)return{type:"Perpendicular From",pt:t.pt,fromLineId:t.fromLineId}}});this.snapUnderMouse=_}}const Pe=oe('<div><table class="table-no-borders"><thead></thead><tbody><tr><td>Length:</td><td></td></tr><tr><td>Angle:</td><td></td></tr></tbody></table></div>'),he=oe("<div></div>"),ge=.001;class Te{constructor(r){let[a,y]=G({currentLine:void 0,userLengthAngle:void 0,lastLine:void 0,makeFaces:!1}),m=p(()=>{let e=r.cameraLookDir(),o=Math.abs(e.x),i=Math.abs(e.y),n=Math.abs(e.z);return o>i&&o>n?e.x>0?E.fromVW(h.unitZ,h.negUnitX):E.fromVW(h.unitZ,h.unitX):i>o&&i>n?e.y>0?E.fromVW(h.unitZ,h.negUnitY):E.fromVW(h.unitZ,h.unitY):e.z>0?E.fromVW(h.unitY,h.negUnitZ):E.fromVW(h.unitY,h.unitZ)}),O=p(()=>{if(a.currentLine==null)return r.existingLines();let e=a.currentLine.id;return r.existingLines().filter(({id:o})=>o!=e)},void 0,{equals:(e,o)=>{if(e.length!=o.length)return!1;for(let i=0;i<e.length;++i){if(e[i]==o[i])continue;let n=e[i],u=o[i];if(n.id!=u.id||n.line.v1.x!=u.line.v1.x||n.line.v1.y!=u.line.v1.y||n.line.v1.z!=u.line.v1.z||n.line.v2.x!=u.line.v2.x||n.line.v2.y!=u.line.v2.y||n.line.v2.z!=u.line.v2.z)return!1}return!0}}),I=p(()=>{let e=m(),o=a.currentLine?.fromPt??h.zero;return ce.create(o,e)}),M=p(()=>$.fromKnownPtAndNormal(I().o,I().w)),A=p(()=>{let e=r.mouseRay();if(e!=null){if(a.currentLine==null){let o=$.xyPlane,i=e.collisionTimeWithPlane(o);if(i!=null&&i>=0){let n=e.positionFromTime(i);return o.closestPoint(n)}}return e.collisionWithPlane(M())}}),x=new pe({projectPtToScreen:r.projectPtToScreen,mousePos:r.mousePos,mouseRay:r.mouseRay,lines:O,currentFromPt:()=>a.currentLine?.fromPt,currentToPt:A,otherSnapPoints:r.otherSnapPoints,allowAlignAll:r.allowAlignAll,allowXAxisSnap:()=>!0,allowYAxisSnap:()=>!0,allowZAxisSnap:()=>!0});Y(()=>{A(),H(()=>a.userLengthAngle)!=null&&y("userLengthAngle",void 0)});let S=p(()=>{if(a.userLengthAngle!=null)return a.userLengthAngle;let e=a.currentLine?.fromPt;if(e==null)return;e=I().pointToThisSpace(e);let o=x.snapUnderMouse()?.pt,i=o??A();if(i==null||(i=I().pointToThisSpace(i),Math.abs(e.z-i.z)>ge))return;let n=e.distance(i);if(!Number.isFinite(n))return;let u=i.x-e.x,v=i.y-e.y,c=Math.atan2(v,u)*180/Math.PI;return o==null&&(n=Math.round(n),c=Math.round(c)),{length:n,angle:c}}),T=p(()=>{let e=x.snapUnderMouse()?.pt;if(e&&a.userLengthAngle==null)return e;let o=a.currentLine?.fromPt;if(o!=null){let i=S();if(i==null)return;let n=i.length,u=i.angle*Math.PI/180,v=I().vectorFromThisSpace(h.create(n*Math.cos(u),n*Math.sin(u),0));return o.add(v)}else{let i=A();return i==null?void 0:h.create(Math.round(i.x),Math.round(i.y),Math.round(i.z))}}),w=T,_=p(()=>{if(a.currentLine==null)return;let e=a.currentLine.fromPt,o=w();if(o!=null)return j.create(e,o)});Y(()=>{if(a.currentLine==null)return;let e=_();e!=null&&r.updateLine({id:a.currentLine.id,line:e})});let t=()=>{if(a.currentLine==null)return;let e=a.currentLine.id;_()!=null&&r.undoManager.performUndoableAction(()=>{let i=!0,n;return{displayName:"Line",undo:()=>{i?(n=r.destroyLine(e).undelete,i=!1):(n?.(),i=!0)}}})};this.instructions=p(()=>"Click points to insert line. Press Escape when done.");let l=J(r.mousePos),s=J(S),f=p(()=>{let e=l();if(e==null)return;let o=s();if(o==null)return;let i=o,n=document.createElement("input");n.type="text";let u=document.createElement("input");u.type="text";let v=()=>{let P=Number.parseFloat(n.value),L=Number.parseFloat(u.value);y("userLengthAngle",{length:P,angle:L})},[c,k]=G({focusedInput:"Length"});n.addEventListener("input",()=>v()),u.addEventListener("input",()=>v());let D=()=>{switch(c.focusedInput){case"Length":k("focusedInput","Angle");break;case"Angle":k("focusedInput","Length");break}};return n.addEventListener("keydown",P=>{if(P.key=="Tab")D(),P.preventDefault();else if(P.key=="Enter"){let L=T(),b=w();if(L==null||b==null)return;t();let{id:g}=r.createLine(j.create(b,b));ee(()=>{y("currentLine",{id:g,fromPt:L}),y("userLengthAngle",void 0)})}}),u.addEventListener("keydown",P=>{if(P.key=="Tab")D(),P.preventDefault();else if(P.key=="Enter"){let L=T(),b=w();if(L==null||b==null)return;t();let{id:g}=r.createLine(j.create(b,b));ee(()=>{y("currentLine",{id:g,fromPt:L}),y("userLengthAngle",void 0)})}}),n.addEventListener("focusout",()=>{c.focusedInput=="Length"&&setTimeout(()=>{n.focus(),n.select()})}),u.addEventListener("focusout",()=>{c.focusedInput=="Angle"&&setTimeout(()=>{n.focus(),n.select()})}),Y(()=>{if(a.userLengthAngle==null)switch(n.value=i().length.toString(),u.value=i().angle.toString(),H(()=>c.focusedInput)){case"Length":n.select();break;case"Angle":u.select();break}}),Y(()=>{switch(c.focusedInput){case"Length":setTimeout(()=>{n.focus(),n.select()});break;case"Angle":setTimeout(()=>{u.focus(),u.select()});break}}),(()=>{const P=Pe.cloneNode(!0),L=P.firstChild,b=L.firstChild,g=b.nextSibling,F=g.firstChild,q=F.firstChild,R=q.nextSibling,le=F.nextSibling,ue=le.firstChild,de=ue.nextSibling;return P.style.setProperty("position","absolute"),V(R,n),V(de,u),te(Z=>{const Q=e().x+50+"px",B=e().y+50+"px";return Q!==Z._v$&&P.style.setProperty("left",Z._v$=Q),B!==Z._v$2&&P.style.setProperty("top",Z._v$2=B),Z},{_v$:void 0,_v$2:void 0}),P})()}),d=()=>W(ne,{get when(){return x.snapUnderMouse()},children:e=>{let o=p(()=>r.projectPtToScreen(e().pt));return W(ne,{get when(){return o()},children:i=>W(fe,{get when(){return e().type!="Other"},get children(){const n=he.cloneNode(!0);return n.style.setProperty("position","absolute"),n.style.setProperty("white-space","nowrap"),n.style.setProperty("background-color","yellow"),n.style.setProperty("border","black 1px solid"),V(n,()=>e().type),te(u=>{const v=i().x+10+"px",c=i().y+10+"px";return v!==u._v$3&&n.style.setProperty("left",u._v$3=v),c!==u._v$4&&n.style.setProperty("top",u._v$4=c),u},{_v$3:void 0,_v$4:void 0}),n}})})}});this.overlayUI=p(()=>[se(f),W(d,{})]),this.snapPoints=p(()=>[...K(x.snapUnderMouse()?.pt).map(e=>({pt:()=>e,highlighted:()=>!0}))]),this.dottedWorkingLines=p(()=>{let e=x.snapUnderMouse();switch(e?.type){case"Align X":case"Align Y":case"Align Z":case"Align Perpendicular":case"Align Perpendicular From":return[j.create(e.pt,e.toLinePt)];default:return[]}}),this.highlightedObjectsById=p(()=>{let e=x.snapUnderMouse();switch(e?.type){case"Perpendicular From":return[e.fromLineId];case"Align X":case"Align Y":case"Align Z":case"Align Perpendicular":case"Align Perpendicular From":return[...K(e.fromLineId),e.toLineId];case"Intersection To":return K(e.fromLineId);default:return[]}}),this.click=()=>{let e=T(),o=w();if(e==null||o==null)return;a.currentLine!=null&&t(),y("currentLine",void 0);let{id:i}=r.createLine(j.create(o,o));y("currentLine",{id:i,fromPt:e})},this.cancel=()=>{a.currentLine!=null&&r.destroyLine(a.currentLine.id)}}}export{Te as D};
