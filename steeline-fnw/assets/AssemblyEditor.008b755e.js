import{c as Q,a as s,z as ce,o as De,A as R,a6 as Ie,i as V,b as _,e as C,s as x,u as pe,$ as se,M as pt,d as ct,t as z,g as Y,N as X,B as $e,l as K,m as fe,y as ft,f as Pe,ab as de,ad as re,ac as ie,D as le,H as yt,as as mt,w as ht,x as gt,p as vt,q as Nt,a4 as It,at as St,au as xt}from"./index.5aba22ff.js";import{m as Pt,a as Tt,S as $t}from"./SvgWithPanZoomState.e2089103.js";import{V as A}from"./Vec3.ce1f4f7a.js";import{o as Oe}from"./PanelUtils.894b6d74.js";import{n as Be,C as ee,g as Le,m as bt,d as wt}from"./Component.fa73bdbc.js";import{P as _e,e as _t}from"./PropertiesForm.c69fa44e.js";import{U as Mt}from"./UndoManager.be70fe9a.js";import{D as kt}from"./Dialog.aed5b9f2.js";import{Y as me,s as ge,R as Ye,c as At,X as Ct,a as zt,p as Ft,a0 as Ae}from"./OrderIndexComponent.f19bd260.js";import"./LineKit.f6b732de.js";import{v as Vt}from"./utils.6e3ab489.js";import"./Line2D.139781b3.js";import"./Ray2D.01cdc921.js";import"./Component.6024a649.js";import"./Gutter.196a297e.js";import"./StandardBorderLandscapeDoc.be2b9e86.js";import"./Labeler.42ece7e8.js";import"./LockerShed.98091ec0.js";import"./MezzanineFloor.5f8c35cf.js";import"./Transform2D.200bb15c.js";import"./Plane3D.472a05fa.js";import"./Ray3D.5e4c723f.js";import"./GableTruss.fea81d7b.js";import"./HexagonalFirePit.41ea653b.js";import"./OpenWebColumnRafterSection.d2fefac8.js";import"./Fascia.ecb69f90.js";import"./Line3D.2b8117f1.js";import"./WeldedUBColumnRafterSection.79a51e85.js";const Et=z('<svg><g><rect x="0" y="0" stroke="black" stroke-width="2" rx="10"></rect><rect y="0" stroke="black" stroke-width="2" pointer-events="none"></rect></g></svg>',8,!0),Ce=z('<svg><circle r="2" fill="black" pointer-events="none"></circle></svg>',4,!0),ze=z('<svg><text dominant-baseline="middle" pointer-events="none"></text></svg>',4,!0),Wt=z('<svg><text style="font-weight: bold;" text-anchor="middle" dominant-baseline="middle" pointer-events="none"></text></svg>',4,!0),Ht=z('<svg><text y="2" style="pointer-events: none; font-weight: bold;" text-anchor="middle" dominant-baseline="hanging"></text></svg>',4,!0),Dt=z('<svg><rect stroke="black" stroke-width="2" fill="white"></rect></svg>',4,!0),Ot=z("<svg><foreignObject></foreignObject></svg>",4,!0),Bt=r=>{let e=2,n=6,[d,p]=Q({nodeWidth:100,nodeHeight:50,labelWidth:30,labelHeight:10,internalValueWidth:0,internalValueHeight:0,inputLabelHeights:[],totalInputsHeight:50,maxInputLabelWidth:50,outputLabelHeights:[],maxOutputLabelWidth:50,totalOutputsHeight:50}),a,h=[],l=[],c=s(()=>{ce(()=>{h.splice(0,h.length)});let i=[.5*(r.fixedSize?.y??d.nodeHeight)+.5*d.totalInputsHeight-.5*(d.inputLabelHeights[0]??0)];for(let y of d.inputLabelHeights)i.push(i[i.length-1]-y);return r.inputs.map((y,t)=>i[t]??0)}),o=s(()=>{ce(()=>{l.splice(0,l.length)});let i=[.5*(r.fixedSize?.y??d.nodeHeight)+.5*d.totalOutputsHeight-.5*(d.outputLabelHeights[0]??0)];for(let y of d.outputLabelHeights)i.push(i[i.length-1]-y);return r.outputs.map((y,t)=>i[t]??0)}),u=s(()=>c().map((S,i)=>({nodeArg:r.inputs[i],pos:A.create(n,S)}))),N=s(()=>o().map((S,i)=>({nodeArg:r.outputs[i],pos:A.create((r.fixedSize?.x??d.nodeWidth)-n,S)}))),P=()=>{let S=a.getBBox(),i=0,y=0,t=[];for(let k of h){let T=k.getBBox();i+=T.height,t.push(T.height),y=Math.max(y,T.width)}let f=0,g=0,v=[];for(let k of l){let T=k.getBBox();f+=T.height,v.push(T.height),g=Math.max(g,T.width)}let m,$;m=r.initInternalComponentSize?.x??0,$=r.initInternalComponentSize?.y??0;let b=Math.max(S.height+(r.internalComponent==null?0:4*e+$),i,f);Y(()=>{r.fixedSize!=null?(p("nodeWidth",r.fixedSize.x),p("nodeHeight",r.fixedSize.y)):(p("nodeWidth",4*n+y+Math.max(S.width,m)+g+4*e),p("nodeHeight",b)),p("labelWidth",S.width),p("labelHeight",S.height),p("internalValueWidth",m),p("internalValueHeight",$),p("inputLabelHeights",t),p("maxInputLabelWidth",y),p("totalInputsHeight",i),p("outputLabelHeights",v),p("maxOutputLabelWidth",g),p("totalOutputsHeight",f)})};De(()=>{P(),r.onInit!=null&&r.onInit({get width(){return r.fixedSize?.x??d.nodeWidth},get height(){return r.fixedSize?.y??d.nodeHeight},get inputArgs(){return u()},get outputArgs(){return N()}})});{let S=!0;R(Ie([()=>r.nodeName,()=>r.inputs,()=>r.outputs],()=>{if(S){S=!1;return}P()}))}return(()=>{const S=Et.cloneNode(!0),i=S.firstChild,y=i.nextSibling;return V(S,_(se,{get each(){return u()},children:t=>[(()=>{const f=Ce.cloneNode(!0);return C(g=>{const v=t.pos.x+"px",m=(r.fixedSize?.y??d.nodeHeight)-t.pos.y+"px";return v!==g._v$9&&x(f,"cx",g._v$9=v),m!==g._v$10&&x(f,"cy",g._v$10=m),g},{_v$9:void 0,_v$10:void 0}),f})(),(()=>{const f=ze.cloneNode(!0);return pe(g=>h.push(g),f),V(f,()=>t.nodeArg.name),C(g=>{const v=t.pos.x+n+"px",m=(r.fixedSize?.y??d.nodeHeight)-t.pos.y+"px";return v!==g._v$11&&x(f,"x",g._v$11=v),m!==g._v$12&&x(f,"y",g._v$12=m),g},{_v$11:void 0,_v$12:void 0}),f})()]}),y),V(S,_(se,{get each(){return N()},children:t=>[(()=>{const f=ze.cloneNode(!0);return pe(g=>l.push(g),f),V(f,()=>t.nodeArg.name),C(g=>{const v=t.pos.x-n-d.maxOutputLabelWidth,m=(r.fixedSize?.y??d.nodeHeight)-t.pos.y;return v!==g._v$13&&x(f,"x",g._v$13=v),m!==g._v$14&&x(f,"y",g._v$14=m),g},{_v$13:void 0,_v$14:void 0}),f})(),(()=>{const f=Ce.cloneNode(!0);return C(g=>{const v=t.pos.x+"px",m=(r.fixedSize?.y??d.nodeHeight)-t.pos.y+"px";return v!==g._v$15&&x(f,"cx",g._v$15=v),m!==g._v$16&&x(f,"cy",g._v$16=m),g},{_v$15:void 0,_v$16:void 0}),f})()]}),y),V(S,_(ct,{get fallback(){return(()=>{const t=Wt.cloneNode(!0),f=a;return typeof f=="function"?pe(f,t):a=t,V(t,()=>r.nodeName),C(g=>{const v=2*n+d.maxInputLabelWidth+.5*d.labelWidth+2*e,m=.5*d.nodeHeight;return v!==g._v$17&&x(t,"x",g._v$17=v),m!==g._v$18&&x(t,"y",g._v$18=m),g},{_v$17:void 0,_v$18:void 0}),t})()},get children(){return _(pt,{get when(){return r.internalComponent},keyed:!0,children:t=>{let f=s(()=>(r.fixedSize?.x??d.nodeWidth)-4*n-d.maxInputLabelWidth-d.maxOutputLabelWidth-2*e),g=s(()=>(r.fixedSize?.y??d.nodeHeight)-4*e-d.labelHeight);return[(()=>{const v=Ht.cloneNode(!0),m=a;return typeof m=="function"?pe(m,v):a=v,V(v,()=>r.nodeName),C(()=>x(v,"x",2*n+d.maxInputLabelWidth+.5*d.labelWidth+2*e)),v})(),(()=>{const v=Dt.cloneNode(!0);return C(m=>{const $=2*n+d.maxInputLabelWidth+e,b=2*e+d.labelHeight,k=f(),T=g();return $!==m._v$19&&x(v,"x",m._v$19=$),b!==m._v$20&&x(v,"y",m._v$20=b),k!==m._v$21&&x(v,"width",m._v$21=k),T!==m._v$22&&x(v,"height",m._v$22=T),m},{_v$19:void 0,_v$20:void 0,_v$21:void 0,_v$22:void 0}),v})(),(()=>{const v=Ot.cloneNode(!0);return V(v,()=>t({})),C(m=>{const $=2*n+d.maxInputLabelWidth+e,b=2*e+d.labelHeight,k=f(),T=g();return $!==m._v$23&&x(v,"x",m._v$23=$),b!==m._v$24&&x(v,"y",m._v$24=b),k!==m._v$25&&x(v,"width",m._v$25=k),T!==m._v$26&&x(v,"height",m._v$26=T),m},{_v$23:void 0,_v$24:void 0,_v$25:void 0,_v$26:void 0}),v})()]}})}}),null),C(t=>{const f=`translate(${r.pos.x}, ${-r.pos.y-(r?.fixedSize?.y??d.nodeHeight)})`,g=r?.fixedSize?.x??d.nodeWidth,v=r?.fixedSize?.y??d.nodeHeight,m=r.highlighted?"blue":r.selected?"green":"lightgrey",$=2*n+d.maxInputLabelWidth+e,b=(r.fixedSize?.x??d.nodeWidth)-4*n-d.maxInputLabelWidth-d.maxOutputLabelWidth-2*e,k=r.fixedSize?.y??d.nodeHeight,T=r.highlighted?"blue":r.selected?"green":"lightyellow";return f!==t._v$&&x(S,"transform",t._v$=f),g!==t._v$2&&x(i,"width",t._v$2=g),v!==t._v$3&&x(i,"height",t._v$3=v),m!==t._v$4&&x(i,"fill",t._v$4=m),$!==t._v$5&&x(y,"x",t._v$5=$),b!==t._v$6&&x(y,"width",t._v$6=b),k!==t._v$7&&x(y,"height",t._v$7=k),T!==t._v$8&&x(y,"fill",t._v$8=T),t},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0}),S})()},Lt=z('<svg><circle r="5" fill="red"></circle></svg>',4,!0),Yt=z('<svg><path fill="none" stroke="black" stroke-width="2" pointer-events="none"></path></svg>',4,!0),Fe=10,Ut=Fe*Fe;class Ve{disablePan=()=>!0;constructor(e){let n=e.modeParams,d=s(()=>{for(let l of n.nodes())if(l.id==e.startPin.nodeId){let c;switch(e.startPin.pinType){case"Input":{c=l.inputPins;break}case"Output":{c=l.outputPins;break}}for(let o of c)if(o.nodeArg.name==e.startPin.pinId)return l.pos.add(o.pos);break}}),p=s(()=>{let l=n.mousePos();if(l==null)return;let c,o,u=n.nodes();for(let N of u)for(let P of[{pins:N.inputPins,type:"Input"},{pins:N.outputPins,type:"Output"}])if(P.type!=e.startPin.pinType)for(let S of P.pins){let i=N.pos.add(S.pos),y=n.worldPtToScreenPt(i);if(y==null)continue;let t=y.distanceSquared(l);t>Ut||(o==null||t<o)&&(o=t,c={nodeId:N.id,pinType:P.type,pinId:S.nodeArg.name,worldPos:i})}return c}),a=()=>_(X,{get when(){return p()?.worldPos},children:l=>(()=>{const c=Lt.cloneNode(!0);return C(o=>{const u=l().x,N=-l().y;return u!==o._v$&&x(c,"cx",o._v$=u),N!==o._v$2&&x(c,"cy",o._v$2=N),o},{_v$:void 0,_v$2:void 0}),c})()}),h=()=>{let l=s(()=>{let o=n.mousePos();if(o!=null)return n.screenPtToWorldPt(o)}),c=s(()=>{let o=d(),u=l();if(!(o==null||u==null))return{startPos:o,endPos:u}});return _(X,{get when(){return c()},children:o=>{let u=s(()=>o().startPos),N=s(()=>o().endPos),P=s(()=>{let S=u(),i=N(),y=A.create(.5*(S.x+i.x),S.y),t=A.create(.5*(S.x+i.x),i.y);return`M${S.x} ${-S.y} C${y.x} ${-y.y} ${t.x} ${-t.y} ${i.x} ${-i.y}`});return(()=>{const S=Yt.cloneNode(!0);return C(()=>x(S,"d",P())),S})()}})};this.overlaySvg=()=>[_(h,{}),_(a,{})],this.mouseUp=()=>{let l=p();l!=null&&(e.startPin.pinType=="Output"?n.addGraphEdge({fromNodeId:e.startPin.nodeId,fromPinId:e.startPin.pinId,toNodeId:l.nodeId,toPinId:l.pinId}):n.addGraphEdge({fromNodeId:l.nodeId,fromPinId:l.pinId,toNodeId:e.startPin.nodeId,toPinId:e.startPin.pinId})),n.onDone()}}}class Rt{disablePan=()=>!0;constructor(e){let n=e.modeParams,d=s(()=>new Map(n.nodes().map(a=>[a.id,a]))),p=$e(()=>{let a=d();return e.movingNodesById.flatMap(h=>{let l=a.get(h);return l==null?[]:{node:l,startPos:l.pos}})});R(()=>{let a=n.mousePos();if(a==null)return;let h=n.screenPtToWorldPt(a);if(h==null)return;let l=h.sub(e.pickupWorldPt);Y(()=>{for(let c of p)c.node.setPos(c.startPos.add(l))})}),this.propertiesForm=e.propertiesForm,this.mouseUp=()=>{n.onDone(e.movingNodesById)},this.selectedNodesById=()=>e.movingNodesById}}const L={type:"Unknown"};function Te(r){return{type:"Type",ident:r}}const q={type:"Union",parts:{Unknown:{},TypeVar:{ident:{displayName:"Ident",typeSchema:{type:"String"},defaultValue:""}},Type:{ident:{displayName:"Ident",typeSchema:{type:"String"},defaultValue:""}},TypeApp:{genericType:{displayName:"Generic Type",typeSchema:{type:"Recursive",typeSchema:()=>q},defaultValue:L},typeParams:{displayName:"Type Params",typeSchema:{type:"Array",elemTypeSchema:{type:"Recursive",typeSchema:()=>q}},defaultValue:[]}},ForAll:{typeVarIdent:{displayName:"Type Var Ident",typeSchema:{type:"String"},defaultValue:""},type1:{displayName:"Type",typeSchema:{type:"Recursive",typeSchema:()=>q},defaultValue:L}},Object:{fields:{displayName:"Fields",typeSchema:{type:"Array",elemTypeSchema:{type:"Object",properties:{fieldName:{displayName:"Field Name",typeSchema:{type:"String"},defaultValue:""},fieldType:{displayName:"Field Type",typeSchema:{type:"Recursive",typeSchema:()=>q},defaultValue:L}}}},defaultValue:[]}}}};function ve(r){switch(r.type){case"Unknown":return"Unknown";case"TypeVar":return r.ident;case"Type":return r.ident;case"TypeApp":return ve(r.genericType)+"<"+r.typeParams.map(e=>ve(e)).join(", ")+">";case"ForAll":return"<"+r.typeVarIdent+">"+ve(r.type1);case"Object":return`{\r
`+r.fields.map(e=>e.fieldName+": "+e.fieldType).join(`,\r
`)+"}"}}function Xt(r){switch(r.type){case"Boolean":return Te("boolean");case"Number":return Te("number");case"String":return Te("string");default:return L}}class jt{disablePan=()=>!0;constructor(e){let n=e.modeParams,d=$e(()=>e.resizingNode.pos),p=$e(()=>A.create(e.resizingNode.width,e.resizingNode.height));R(()=>{let a=n.mousePos();if(a==null)return;let h=n.screenPtToWorldPt(a);if(h==null)return;h=h.sub(e.grabOffset);let l,c;e.resizeX=="MinX"?(l=h.x,c=d.x+p.x-h.x):e.resizeX=="MaxX"?(l=void 0,c=h.x-d.x):c=p.x;let o,u;e.resizeY=="MinY"?(o=h.y,u=d.y+p.y-h.y):e.resizeY=="MaxY"?(o=void 0,u=h.y-d.y):u=p.y,Y(()=>{(l!=null||o!=null)&&(e.resizingNode.pos=A.create(l??d.x,o??d.y)),e.resizingNode.params.setSize(A.create(c,u))})}),this.mouseUp=()=>{n.onDone([e.resizingNode.id])},this.selectedNodesById=s(()=>[e.resizingNode.id]),this.propertiesForm=e.propertiesForm}}const Gt=z('<svg><circle r="5" fill="red"></circle></svg>',4,!0),qt=z("<svg><text></text></svg>",4,!0),Kt=z('<svg><rect fill="yellow"></rect></svg>',4,!0),Ee=10,he=Ee*Ee;class We{constructor(e){let[n,d]=Q({selectedNodesById:e.initSelectedNodesById??[]}),p=s(()=>new Set(n.selectedNodesById)),a=s(()=>[...e.nodes()].reverse()),h=s(()=>{let i=e.mousePos();if(i==null)return;let y=e.screenPtToWorldPt(i);if(y!=null)for(let t of a()){let f=e.nodeLayoutInfo()[t.id];if(f==null)continue;let g=f.width,v=f.height;if(t.pos.x<=y.x&&y.x<=t.pos.x+g&&t.pos.y<=y.y&&y.y<=t.pos.y+v)return t}}),l=s(()=>{let i=e.mousePos();if(i==null)return;let y=h();if(y==null)return;let t,f;for(let g of[{pins:y.inputPins,type:"Input"},{pins:y.outputPins,type:"Output"}])for(let v of g.pins){let m=y.pos.add(v.pos),$=e.worldPtToScreenPt(m);if($==null)continue;let b=$.distanceSquared(i);b>he||(f==null||b<f)&&(f=b,t={nodeId:y.id,pinType:g.type,pinId:v.nodeArg.name,valueType:v.nodeArg.type,worldPos:m})}return t}),c=s(()=>new Map(e.nodes().map(i=>[i.id,i]))),o=s(()=>{if(l())return;let i=e.mousePos();if(i==null)return;let y=n.selectedNodesById;if(y.length!=1)return;let t=c().get(y[0]);if(t==null)return;let f=e.screenPtToWorldPt(i);if(f==null)return;let g=f,v,m=0;if(t.resizeableX??!1){let k=A.create(t.pos.x,Math.max(t.pos.y,Math.min(t.pos.y+t.height,f.y))),T=A.create(t.pos.x+t.width,Math.max(t.pos.y,Math.min(t.pos.y+t.height,f.y))),Z=[{pt:k,type:"MinX"},{pt:T,type:"MaxX"}],W;for(let{pt:te,type:ae}of Z){let O=e.worldPtToScreenPt(te);if(O==null)continue;let j=i.distanceSquared(O);j>he||(W==null||j<W)&&(v=ae,m=g.x-te.x,W=j)}}let $,b=0;if(t.resizeableY??!1){let k=A.create(Math.max(t.pos.x,Math.min(t.pos.x+t.width,f.x)),t.pos.y),T=A.create(Math.max(t.pos.x,Math.min(t.pos.x+t.width,f.x)),t.pos.y+t.height),Z=[{pt:k,type:"MinY"},{pt:T,type:"MaxY"}],W;for(let{pt:te,type:ae}of Z){let O=e.worldPtToScreenPt(te);if(O==null)continue;let j=i.distanceSquared(O);j>he||(W==null||j<W)&&($=ae,b=g.y-te.y,W=j)}}if(!(v==null&&$==null))return{resizeX:v,resizeY:$,grabOffset:A.create(m,b),node:t}}),u=s(()=>{if(l()==null&&o()==null)return h()}),N=()=>_(X,{get when(){return l()},children:i=>{let y=s(()=>i().worldPos);return[(()=>{const t=Gt.cloneNode(!0);return C(f=>{const g=y().x,v=-y().y;return g!==f._v$&&x(t,"cx",f._v$=g),v!==f._v$2&&x(t,"cy",f._v$2=v),f},{_v$:void 0,_v$2:void 0}),t})(),_(X,{get when(){return fe(()=>i().valueType==L,!0)()?void 0:i().valueType},children:t=>{let f,[g,v]=K(void 0);return R(Ie(y,()=>{let m=f.getBBox();v({x:m.x,y:m.y,width:m.width,height:m.height})})),[_(X,{get when(){return g()},children:m=>(()=>{const $=Kt.cloneNode(!0);return C(b=>{const k=m().x,T=m().y,Z=m().width,W=m().height;return k!==b._v$5&&x($,"x",b._v$5=k),T!==b._v$6&&x($,"y",b._v$6=T),Z!==b._v$7&&x($,"width",b._v$7=Z),W!==b._v$8&&x($,"height",b._v$8=W),b},{_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0}),$})()}),(()=>{const m=qt.cloneNode(!0),$=f;return typeof $=="function"?pe($,m):f=m,V(m,()=>ve(t())),C(b=>{const k=y().x+10,T=-y().y+10;return k!==b._v$3&&x(m,"x",b._v$3=k),T!==b._v$4&&x(m,"y",b._v$4=T),b},{_v$3:void 0,_v$4:void 0}),m})()]}})]}}),[P,S]=K(void 0);R(()=>{if(n.selectedNodesById.length==0)return;let i=u();if(i==null||!p().has(i.id))return;let y=P();if(y==null)return;let t=e.worldPtToScreenPt(y);if(t==null)return;let f=e.mousePos();f!=null&&(f.distanceSquared(t)<he||e.setMode(()=>new Rt({modeParams:e,pickupWorldPt:y,movingNodesById:n.selectedNodesById,propertiesForm:this.propertiesForm})))}),this.overlaySvg=()=>_(N,{}),this.propertiesForm=s(()=>{if(n.selectedNodesById.length==0)return;let i=c(),y=new Map;for(let t of n.selectedNodesById){let f=i.get(t);f!=null&&(f.type.propertiesForm==null&&!(f.type.generateDefaultPropertiesForm??!1)||(y.has(f.type.componentType.typeName)?y.get(f.type.componentType.typeName).push(f):y.set(f.type.componentType.typeName,[f])))}if(y.size!=0)return()=>_(se,{get each(){return[...y.values()]},children:t=>{if(t.length==0)return;let f=t[0].type;if(f.propertiesForm)return fe(()=>f.propertiesForm({nodes:t.map(g=>({state:g.params.state,setState:g.params.setState}))}));{let g=Be({displayName:"Params",propertiesSchema:f.componentType.propertiesSchema,values:s(()=>t.map(m=>m.params.state)),setValue:(m,$)=>{t[m].params.setState($)}}),v=s(()=>[{...g(),fields:g().fields.filter(m=>m($=>$.displayName()!="Code"))}]);return _(_e,{get fieldGroups(){return v()}})}}})}),this.mouseDown=()=>{{let i=l();if(i!=null){if(i.pinType=="Input"){for(let y of e.edges())if(y.toNodeId==i.nodeId&&y.toPinId==i.pinId){e.removeGraphEdge(y),e.setMode(()=>new Ve({modeParams:e,startPin:{nodeId:y.fromNodeId,pinType:"Output",pinId:y.fromPinId}}));return}}e.setMode(()=>new Ve({modeParams:e,startPin:i}));return}}{let i=u();if(i!=null&&p().has(i.id)){let y=e.mousePos();if(y==null)return;let t=e.screenPtToWorldPt(y);if(t==null)return;S(t);return}}{let i=o();if(i!=null){e.setMode(()=>new jt({modeParams:e,resizingNode:i.node,resizeX:i.resizeX,resizeY:i.resizeY,grabOffset:i.grabOffset,propertiesForm:this.propertiesForm}));return}}},this.mouseUp=()=>{S(void 0)},this.click=i=>{if(i){let y=u();if(y!=null){let t=p();t.has(y.id)?d("selectedNodesById",[...t].filter(f=>f!=y.id)):d("selectedNodesById",[...t,y.id])}}else{let y=u();d("selectedNodesById",Oe(y?.id))}},this.disablePan=()=>P()!=null,this.highlightedNodesById=()=>{let i=u();return i!=null?[i.id]:[]},this.selectedNodesById=()=>n.selectedNodesById,this.deselectNodes=()=>{d("selectedNodesById",[])},this.cursor=s(()=>{{let i=o();if(i!=null){if(i.resizeX=="MinX")return i.resizeY=="MinY"?"nesw-resize":i.resizeY=="MaxY"?"nwse-resize":"ew-resize";if(i.resizeX=="MaxX")return i.resizeY=="MinY"?"nwse-resize":i.resizeY=="MaxY"?"nesw-resize":"ew-resize";if(i.resizeY=="MinY")return"ns-resize";if(i.resizeY=="MaxY")return"ns-resize"}}{let i=u();if(i!=null&&p().has(i.id))return"move"}})}}const Zt=z('<svg><path fill="none" stroke="black" stroke-width="2" pointer-events="none"></path></svg>',4,!0),Jt=r=>{let e=s(()=>r.nodeIdNodeMap.get(r.edge.fromNodeId)),n=s(()=>r.nodeIdNodeMap.get(r.edge.toNodeId)),d=s(()=>{let p=e(),a=n();if(!(p==null||a==null))return{fromNode:p,toNode:a}});return _(X,{get when(){return d()},children:p=>{let a=s(()=>p().fromNode),h=s(()=>p().toNode),l=s(()=>{let u=r.nodeLayoutInfo[r.edge.fromNodeId];if(u==null)return;let N=u.outputPins.find(P=>P.nodeArg.name==r.edge.fromPinId);if(N!=null)return a().pos.add(N.pos)}),c=s(()=>{let u=r.nodeLayoutInfo[r.edge.toNodeId];if(u==null)return;let N=u.inputPins.find(P=>P.nodeArg.name==r.edge.toPinId);if(N!=null)return h().pos.add(N.pos)}),o=s(()=>{let u=l(),N=c();if(!(u==null||N==null))return{fromNodePinPos:u,toNodePinPos:N}});return _(X,{get when(){return o()},children:u=>{let N=s(()=>u().fromNodePinPos),P=s(()=>u().toNodePinPos),S=s(()=>{let i=N(),y=P(),t=A.create(.5*(i.x+y.x),i.y),f=A.create(.5*(i.x+y.x),y.y);return`M${i.x} ${-i.y} C${t.x} ${-t.y} ${f.x} ${-f.y} ${y.x} ${-y.y}`});return(()=>{const i=Zt.cloneNode(!0);return C(()=>x(i,"d",S())),i})()}})}})};function Qt(r){let e=new Map,n=[...r.nodes.map(o=>o.id)],d=new Map,p=new Map;for(let o of r.edges){{let u;d.has(o.toNodeId)?u=d.get(o.toNodeId):(u=[],d.set(o.toNodeId,u)),u.push(o.fromNodeId)}{let u;p.has(o.fromNodeId)?u=p.get(o.fromNodeId):(u=[],p.set(o.fromNodeId,u)),u.push(o.toNodeId)}}for(;;){let o=n.pop();if(o==null)break;let u=d.get(o)??[];if(u.some(S=>!e.has(S)))continue;let N=0;for(let S of u)N=Math.max(N,e.get(S)+1);e.set(o,N);let P=p.get(o)??[];n.push(...P)}let a=[...r.nodes].sort((o,u)=>e.get(o.id)-e.get(u.id)),h=new Map;for(let o=0;o<a.length;++o)h.set(a[o].id,"x"+o);let l=new Map;for(let o of r.edges)l.set(o.toNodeId+"::"+o.toPinId,[o.fromNodeId,o.fromPinId]);let c="";for(let o of a)c+="let "+h.get(o.id)+" = "+o.nodeName+`({\r
`,c+=o.inputs.map(u=>{let N;{let P=l.get(o.id+"::"+u.name);P==null?N="undefined":N=h.get(P[0])+"."+P[1]}return"    "+u.name+": "+N}).join(`,\r
`),c+=`\r
});\r
`;return c}class en{constructor(e){this.assemblyNodeTypes=e,this.typeNameToAssemblyNodeType=new Map;for(let n of e)this.typeNameToAssemblyNodeType.set(n.componentType.typeName,n);this.aliasTypeNameMap=new Map}lookupAssemblyNodeType(e){let n=this.typeNameToAssemblyNodeType.get(e);if(n!=null)return n;let d=this.aliasTypeNameMap.get(e);if(d!=null)return this.typeNameToAssemblyNodeType.get(d)}addAlias(e,n){this.aliasTypeNameMap.set(e,n)}}const tn={kitType:{displayName:"Kit Type",typeSchema:{type:"String"},defaultValue:""}},nn=new ee({typeName:"Assembly",displayName:"Assembly",propertiesSchema:tn}),Ue=nn;class ue{get id(){return this.params.id}get nodeName(){return this.type.componentType.displayName}get pos(){return this.params.pos()}set pos(e){this.params.setPos(e)}get fixedSize(){return this.params.fixedSize()}constructor(e,n){this.type=e,this.params=n}}class on{componentType=Ue;create(e){return new rn(e)}propertiesForm=e=>{let n=Le(),d=new Map(n.map(c=>[c.componentType.typeName,c.componentType.displayName])),p=n.map(c=>c.componentType.typeName),a=s(()=>{if(e.nodes.length==0)return;let c=e.nodes[0].state.kitType;for(let o=1;o<e.nodes.length;++o)if(e.nodes[o].state.kitType!=c)return;return c}),h=c=>{Y(()=>{for(let o=0;o<e.nodes.length;++o)e.nodes[o].setState("kitType",c)})},l=s(()=>[{displayName:"Assembly",fields:[_t({displayName:()=>"Kit Type",value:a,setValue:h,possibleValues:()=>p,valueToDisplayValue:c=>d.get(c)??c})],expanded:()=>!0}]);return _(_e,{get fieldGroups(){return l()}})}}const Re=new on,dn=Re;let Xe=new Map;for(let r of Le())Xe.set(r.componentType.typeName,r);class rn extends ue{constructor(e){super(Re,e),this.kitType=s(()=>Xe.get(e.state.kitType)),this.inputs_=s(()=>{let n=this.kitType()?.componentType?.propertiesSchema;return n==null?[]:Object.keys(n).map(d=>({name:d,type:Xt(n[d].typeSchema)}))})}get nodeName(){return this.kitType()?.componentType?.typeName??"?"}get inputs(){return this.inputs_()}outputs=[{name:"Output",type:{type:"Unknown"}}];get internalValue(){}hookupEval(e){}}let sn={params:{displayName:"Params",typeSchema:{type:"Array",elemTypeSchema:{type:"Object",properties:{name:{displayName:"Name",typeSchema:{type:"String"},defaultValue:""},type:{displayName:"Type",typeSchema:q,defaultValue:L}}}},defaultValue:[]}},ln=new ee({typeName:"Params",displayName:"Params",propertiesSchema:sn}),je=ln;class un{componentType=je;create(e){return new pn(e)}generateDefaultPropertiesForm=!0}let an=new un;const Ge=an;class pn extends ue{constructor(e){super(Ge,e)}inputs=[];get outputs(){return this.params.state.params}get internalValue(){}hookupEval(e){}}const He={type:"Array",elemTypeSchema:{type:"Object",properties:{name:{displayName:"Name",typeSchema:{type:"String"},defaultValue:""},type:{displayName:"Type",typeSchema:q,defaultValue:L}}}},cn={inputArgs:{displayName:"Input Args",typeSchema:He,defaultValue:[]},outputArgs:{displayName:"Output Args",typeSchema:He,defaultValue:[]},code:{displayName:"Code",typeSchema:{type:"String"},defaultValue:""}},fn=new ee({typeName:"Code",displayName:"Code",propertiesSchema:cn}),qe=fn;function yn(){return new Worker(""+new URL("code_exection_worker.3ea60e7f.js",import.meta.url).href)}let be=new Map,Ke=new yn;Ke.addEventListener("message",r=>{let e=r.data,n=e.requestId,d=be.get(n);d!=null&&(be.delete(n),d(e.result))});function Me(r){return new Promise(e=>{let n=ft();be.set(n,d=>e(d)),Ke.postMessage({...r,requestId:n})})}function Ze(r){return Me({type:"createFunction",params:{code:r.code}})}function Se(r){return Me({type:"destroyFunction",params:{functionId:r.functionId}})}function Je(r){return Me({type:"executeFunction",params:{functionId:r.functionId,params:r.params}})}const mn=z('<div style="width: 100%; height: 100%; display: flex; flex-direction: column;"><textarea style="flex-grow: 1; resize: none;"></textarea><div><input type="button" class="btn btn-primary" value="Apply"></div></div>');class hn{componentType=qe;create(e){return new vn(e)}generateDefaultPropertiesForm=!0}const Qe=new hn,gn=Qe;class vn extends ue{constructor(e){super(Qe,e);let[n,d]=K(de()),p=0,a=!1;ce(()=>{a=!0;let h=n();h.type=="Success"&&Se({functionId:h.value})}),s(()=>{p++;let h=p,c=this.inputs.map(o=>`let ${o.name} = params.${o.name};\r
`).join("")+e.state.code;(async()=>{let o=await Ze({code:c});if(h!=p||a){o.type=="Ok"&&Se({functionId:o.value.functionId});return}if(o.type=="Err"){d(re(o.message));return}let u=o.value;d(ie(u.functionId))})()}),this.functionId=n}resizeableX=!0;resizeableY=!0;get inputs(){return this.params.state.inputArgs}get outputs(){return this.params.state.outputArgs}initInternalComponentSize=A.create(200,100);internalComponent=()=>{let[e,n]=Q({unsavedCode:void 0});const d=this;return(()=>{const p=mn.cloneNode(!0),a=p.firstChild,h=a.nextSibling,l=h.firstChild;return a.$$input=c=>{n("unsavedCode",c.currentTarget.value)},l.$$click=()=>{e.unsavedCode!=null&&(d.params.setState("code",e.unsavedCode),n("unsavedCode",void 0))},C(()=>l.disabled=e.unsavedCode==null),C(()=>a.value=d.params.state.code),p})()};hookupEval(e){let n=s(le(()=>this.inputs,p=>{let a=e.hookupFromNodeIdPinIdForToNodeIdPinId({toNodeId:this.params.id,toPinId:p.name}),h=s(()=>{let c=a();if(c!=null)return e.hookupValue({nodeId:c.fromNodeId,pinId:c.fromPinId})}),l=s(()=>h()?.());return{param:p.name,value:l}})),d=s(()=>{let p={};for(let{param:a,value:h}of n()){let l=h();if(l==null)return re("Inputs not all connected");if(l.type=="Error")return re("Errored input");if(l.type=="Pending")return de();p[a]=l.value}return ie(p)});R(()=>{let p=d();if(p.type!="Success")return;let a=p.value,h=this.functionId();if(h.type!="Success")return;let l=h.value,c={};Y(()=>{for(let o of this.outputs){let[u,N]=K(de());c[o.name]={get:u,set:N};let P={};P[o.name]={value:u},e.setState("nodeStates",this.params.id,P)}}),(async()=>{let o=await Je({functionId:l,params:a});if(o.type=="Err"){console.log(o.message);return}let u=o.value;Y(()=>{for(let N in c)c[N].set(ie(u[N]))})})()})}}Pe(["input","click"]);let Nn={outParams:{displayName:"Out Params",typeSchema:{type:"Array",elemTypeSchema:{type:"Object",properties:{name:{displayName:"Name",typeSchema:{type:"String"},defaultValue:""},type:{displayName:"Type",typeSchema:q,defaultValue:L}}}},defaultValue:[]}};const In=new ee({typeName:"Result",displayName:"Result",propertiesSchema:Nn}),et=In;class Sn{constructor(){this.componentType=et,this.generateDefaultPropertiesForm=!0}create(e){return new Pn(e)}}const tt=new Sn,xn=tt;class Pn extends ue{constructor(e){super(tt,e),this.outputs=[]}get inputs(){return this.params.state.outParams}get internalValue(){}hookupEval(e){}}const Tn={type:"Array",elemTypeSchema:{type:"Object",properties:{name:{displayName:"Name",typeSchema:{type:"String"},defaultValue:""},type:{displayName:"Type",typeSchema:q,defaultValue:L}}}},$n={inputArgs:{displayName:"Input Args",typeSchema:Tn,defaultValue:[]},outputType:{displayName:"Output Type",typeSchema:q,defaultValue:L},expression:{displayName:"Expression",typeSchema:{type:"String"},defaultValue:""}},bn=new ee({typeName:"Expression",displayName:"Expression",propertiesSchema:$n}),nt=bn,wn=z('<div style="width: 100%; height: 100%; display: flex; flex-direction: column;"><textarea style="flex-grow: 1; resize: none;"></textarea><div><input type="button" class="btn btn-primary" value="Apply"></div></div>');class _n{componentType=nt;create(e){return new kn(e)}generateDefaultPropertiesForm=!0}const ot=new _n,Mn=ot;class kn extends ue{constructor(e){super(ot,e);let[n,d]=K(de()),p=0,a=!1;ce(()=>{a=!0;let h=n();h.type=="Success"&&Se({functionId:h.value})}),s(()=>{p++;let h=p,l=this.inputs.map(u=>`let ${u.name} = params.${u.name};\r
`).join(""),c=e.state.expression,o=l+`return { output: ${c}, };`;(async()=>{let u=await Ze({code:o});if(h!=p||a){u.type=="Ok"&&Se({functionId:u.value.functionId});return}if(u.type=="Err"){d(re(u.message));return}let N=u.value;d(ie(N.functionId))})()}),this.functionId=n}resizeableX=!0;resizeableY=!0;get inputs(){return this.params.state.inputArgs}outputs=[{name:"output",type:this.params.state.outputType}];initInternalComponentSize=A.create(200,100);internalComponent=()=>{let[e,n]=Q({unsavedCode:void 0});const d=this;return(()=>{const p=wn.cloneNode(!0),a=p.firstChild,h=a.nextSibling,l=h.firstChild;return a.$$input=c=>{n("unsavedCode",c.currentTarget.value)},l.$$click=()=>{e.unsavedCode!=null&&(d.params.setState("expression",e.unsavedCode),n("unsavedCode",void 0))},C(()=>l.disabled=e.unsavedCode==null),C(()=>a.value=d.params.state.expression),p})()};hookupEval(e){let n=s(le(()=>this.inputs,p=>{let a=e.hookupFromNodeIdPinIdForToNodeIdPinId({toNodeId:this.params.id,toPinId:p.name}),h=s(()=>{let c=a();if(c!=null)return e.hookupValue({nodeId:c.fromNodeId,pinId:c.fromPinId})}),l=s(()=>h()?.());return{param:p.name,value:l}})),d=s(()=>{let p={};for(let{param:a,value:h}of n()){let l=h();if(l==null)return re("Inputs not all connected");if(l.type=="Error")return re("Errored input");if(l.type=="Pending")return de();p[a]=l.value}return ie(p)});R(()=>{let p=d();if(p.type!="Success")return;let a=p.value,h=this.functionId();if(h.type!="Success")return;let l=h.value,c={};Y(()=>{for(let o of this.outputs){let[u,N]=K(de());c[o.name]={get:u,set:N};let P={};P[o.name]={value:u},e.setState("nodeStates",this.params.id,P)}}),(async()=>{let o=await Je({functionId:l,params:a});if(o.type=="Err"){console.log(o.message);return}let u=o.value;Y(()=>{for(let N in c)c[N].set(ie(u[N]))})})()})}}Pe(["input","click"]);const An={},Cn=new ee({typeName:"ShowValue",displayName:"Show Value",propertiesSchema:An}),dt=Cn,zn=z('<div style="width: 100%; height: 100%;"></div>');class Fn{componentType=dt;create(e){return new En(e)}}const rt=new Fn,Vn=rt;class En extends ue{constructor(e){super(rt,e);let[n,d]=K(void 0),p=s(()=>n?.()?.());this.setValueAccessor=d,this.displayValue=s(()=>{let a=p();return a?.type!="Success"?"":`${a.value}`})}resizeableX=!0;resizeableY=!0;inputs=[{name:"value",type:L}];outputs=[];initInternalComponentSize=A.create(200,100);internalComponent=()=>{const e=this;return(()=>{const n=zn.cloneNode(!0);return V(n,()=>e.displayValue()),n})()};hookupEval(e){let n=e.hookupFromNodeIdPinIdForToNodeIdPinId({toNodeId:this.params.id,toPinId:"value"}),d=s(()=>{let a=n();if(a!=null)return e.hookupValue({nodeId:a.fromNodeId,pinId:a.fromPinId})}),p=s(()=>d()?.());this.setValueAccessor(()=>p)}}const we=new en([dn,gn,Mn,Ge,xn,Vn]),Wn={position:{displayName:"Position",typeSchema:Vt,defaultValue:A.zero}},Hn=new ee({typeName:"Position",displayName:"Position",propertiesSchema:Wn}),Ne=Hn,Dn={fromNodeId:{displayName:"From Node Id",typeSchema:{type:"String"},defaultValue:""},fromPinId:{displayName:"From Pin Id",typeSchema:{type:"String"},defaultValue:""},toNodeId:{displayName:"To Node Id",typeSchema:{type:"String"},defaultValue:""},toPinId:{displayName:"To Pin Id",typeSchema:{type:"String"},defaultValue:""}},On=new ee({typeName:"Edge",displayName:"Edge",propertiesSchema:Dn}),xe=On;class Bn{constructor(e){let n;{let a=s(()=>e.world().hookupAllEntities());n=s(()=>a()())}let d;{let a=s(le(n,h=>{let l;{let u=s(()=>e.world().hookupEntityComponentSet(h));l=s(()=>u()()??{})}let c=s(()=>Object.values(l())),o=s(()=>{for(let u of c()){let N=we.lookupAssemblyNodeType(u.type.typeName);if(N!=null)return N}});return s(()=>{let u=o();if(u==null)return;let N=s(()=>me(l(),Ne)?.state.position??A.zero),P=t=>{let f=me(l(),Ne);f==null?e.world().setComponents(h,[Ne.create({position:t})]):f.setState("position",t)},S=s(()=>{let t=me(l(),ge);if(t!=null)return A.create(t.state.width,t.state.height)}),i=t=>{let f=me(l(),ge);f==null?e.world().setComponents(h,[ge.create({width:t.x,height:t.y})]):Y(()=>{f.setState("width",t.x),f.setState("height",t.y)})},y=s(()=>c().find(t=>t.type.typeName==u.componentType.typeName));return s(()=>u.create({id:h,state:y().state,setState:y().setState,pos:N,setPos:P,fixedSize:S,setSize:i}))})}));d=s(()=>a().flatMap(h=>Oe(h()).map(l=>l())))}let p;{let a=s(()=>e.world().hookupEntitiesWithComponentTypes([xe])),h=s(()=>a()()),l=s(le(h,c=>({id:c,edge:e.world().hookupEntityComponent(c,xe)})));p=s(()=>l().flatMap(({id:c,edge:o})=>{let u=o();return u==null?[]:[{id:c,...u.state,destroy:()=>{e.world().destroyEntity(c)}}]}))}this.nodes=d,this.edges=p}}const Ln=z('<div style="display: flex; flex-direction: column; overflow: hidden;"><div style="overflow-y: auto;"></div></div>'),Yn=z("<div></div>"),Un=r=>{let e=new Map(we.assemblyNodeTypes.map(a=>[a.componentType.typeName,a])),n=s(()=>{if(r.selectedNodeType!=null)return e.get(r.selectedNodeType)}),d=s(()=>{let a=n();if(a!=null)return a.componentType.create(bt(a.componentType.propertiesSchema))}),p=s(()=>{let a=n();if(a!=null)return a.propertiesForm==null?a.generateDefaultPropertiesForm??!1?h=>{let l=Be({displayName:"Params",propertiesSchema:a.componentType.propertiesSchema,values:s(()=>h.nodes.map(o=>o.state)),setValue:(o,u)=>{h.nodes[o].setState(u)}}),c=s(()=>[l()]);return _(_e,{get fieldGroups(){return c()}})}:void 0:a.propertiesForm});return De(()=>{r.onInit?.({currentNodeComponent:d})}),(()=>{const a=Ln.cloneNode(!0),h=a.firstChild;return V(a,_(X,{get when(){return p()},children:l=>{if(n()==null)return;let o=s(()=>{let u=d();return u==null?[]:[{state:u.state,setState:u.setState}]});return fe(()=>l()({get nodes(){return o()}}))}}),h),V(h,_(se,{get each(){return we.assemblyNodeTypes},children:l=>(()=>{const c=Yn.cloneNode(!0);return c.$$click=o=>{if(o.ctrlKey&&r.selectedNodeType==l.componentType.typeName){r.setSelectedNodeType(void 0);return}r.setSelectedNodeType(l.componentType.typeName)},c.style.setProperty("border","black solid 1px"),c.style.setProperty("margin-top","5px"),c.style.setProperty("border-radius","5px"),c.style.setProperty("text-align","center"),V(c,()=>l.componentType.displayName),C(o=>{const u=r.selectedNodeType==l.componentType.typeName,N=r.selectedNodeType==l.componentType.typeName?"green":"yellow",P=r.selectedNodeType==l.componentType.typeName?"move":"pointer";return u!==o._v$&&x(c,"draggable",o._v$=u),N!==o._v$2&&c.style.setProperty("background-color",o._v$2=N),P!==o._v$3&&c.style.setProperty("cursor",o._v$3=P),o},{_v$:void 0,_v$2:void 0,_v$3:void 0}),c})()})),a})()};Pe(["click"]);class Rn{constructor(e){let[n,d]=Q({nodeStates:{}}),p=s(()=>new Map(e.edges().map(a=>[a.toNodeId+":"+a.toPinId,{fromNodeId:a.fromNodeId,fromPinId:a.fromPinId}])));this.state=n,this.setState=d,this.outputNodePinToNodeIdMap=p}hookupFromNodeIdPinIdForToNodeIdPinId(e){return s(()=>this.outputNodePinToNodeIdMap().get(e.toNodeId+":"+e.toPinId))}hookupValue(e){let n=s(()=>this.state.nodeStates[e.nodeId]),d=s(()=>{let p=n();return p?.[e.pinId]});return s(()=>{let p=d();if(p!=null)return p.value()})}insertNodeState(e){let n={};for(let d in e.pins)n[d]={value:e.pins[d].value};this.setState("nodeStates",e.nodeId,yt(n))}deleteNodeState(e){this.setState("nodeStates",e.nodeId,void 0)}}const Xn=new Ye([At,Ct,zt]),jn=new Ye([...Xn.componentTypes,Ue,qe,xe,nt,je,Ft,et,dt,ge]),Gn=z('<div><div style="display: flex; align-items: center; justify-content: centre;"><input type="button" class="btn btn-primary" style="margin-left: 5px;" value="Save"><input type="button" class="btn btn-primary" style="margin-left: 5px;" value="Show Code"><h4 style="display: inline; margin-left: 10px;">Assembly Editor</h4></div><div style="flex-grow: 1; display: flex; flex-direction: row; overflow: hidden;"><div style="display: flex; flex-direction: column; overflow: hidden;"></div></div></div>'),qn=z('<div style="flex: 1; overflow: auto; font-family: monospace;"><pre style="overflow: visible;"></pre></div>'),Kn=z('<input type="button" class="btn btn-primary" style="margin-left: 5px;" value="Close">'),bo=r=>{let e=new Mt,[n,d]=Q({mkMode:void 0,mousePos:void 0,world:Ae.mkEmpty(),selectedNodeTypeForInsertion:void 0,showCode:void 0,assemblyFile:void 0});if(r.initAssembly!=null){let I=r.initAssembly;(async()=>{let w=await mt({objectId:I.assemblyId}),H=ht(w),U=gt(H),ne=new TextDecoder().decode(U),oe=Ae.fromJSON(jn,JSON.parse(ne));if(oe.type=="Err"){alert(oe.message);return}let M=oe.value;Y(()=>{d("world",M),d("assemblyFile",{assemblyId:I.assemblyId,assemblyName:I.assemblyName})})})()}let[p,a]=K(void 0),h=s(()=>p()?.()),[l,c]=Q({...Pt(),panX:-200,panY:-500}),[o,u]=K(()=>!1),N=s(()=>o()()),P=new Tt({state:l,setState:c,disablePan:N}),S=I=>P.screenPtToWorldPt(I.x,I.y),i=I=>P.worldPtToScreenPt(I),y=()=>n.mousePos,t=new Bn({world:()=>n.world}),f=t.nodes,g=t.edges,v=new Rn({edges:g});R(le(f,I=>{I.hookupEval(v)}));let[m,$]=Q(),b=s(le(f,I=>{let w=I.id;return new Proxy(I,{get:(H,U)=>U=="width"?m[w]?.width??0:U=="height"?m[w]?.height??0:U=="inputPins"?m[w]?.inputPins??[]:U=="outputPins"?m[w]?.outputPins??[]:U=="setPos"?ne=>{I.pos=ne}:H[U]})})),k={undoManager:e,screenPtToWorldPt:S,worldPtToScreenPt:i,mousePos:y,nodes:b,edges:g,nodeLayoutInfo:()=>m,onDone:I=>{setTimeout(()=>{I==null?d("mkMode",void 0):d("mkMode",()=>()=>new We({...k,initSelectedNodesById:I}))})},setMode:I=>d("mkMode",()=>I),addGraphEdge:I=>{if(!g().some(w=>w.fromNodeId==I.fromNodeId&&w.toNodeId==I.toNodeId&&w.fromPinId==I.fromPinId&&w.toPinId==I.toPinId)){for(let w of g())w.toNodeId==I.toNodeId&&w.toPinId==I.toPinId&&n.world.destroyEntity(w.id);n.world.createEntity([xe.create({...I})])}},removeGraphEdge:I=>{n.world.destroyEntity(I.id)}},T=s(()=>n.mkMode==null?new We(k):n.mkMode()),Z=()=>{let I=s(()=>{let w=T();return w.overlaySvg?.call(w,{})});return fe(I)},W=()=>{let I=s(()=>T().propertiesForm?.()?.({}));return fe(I)},te=s(()=>T().disablePan?.()??!1),ae=s(()=>T().highlightedNodesById?.()??[]),O=s(()=>T().selectedNodesById?.()??[]),j=s(()=>T().cursor?.()),it=s(()=>new Set(ae())),st=s(()=>new Set(O())),lt=j;s(()=>{u(()=>te)}),R(Ie(O,()=>{O().length!=0&&n.selectedNodeTypeForInsertion!=null&&d("selectedNodeTypeForInsertion",void 0)})),R(Ie(()=>n.selectedNodeTypeForInsertion,()=>{n.selectedNodeTypeForInsertion!=null&&O().length!=0&&T().deselectNodes?.()}));let G,ke;{let I=P.mouseAndTouchEventHandlers();ke={...I,onMouseDown:w=>{T().mouseDown?.(),I.onMouseDown(w)},onMouseUp:w=>{T().mouseUp?.(),I.onMouseUp(w)},onMouseMove:w=>{let H=G.getBoundingClientRect();d("mousePos",A.create(w.clientX-H.left,w.clientY-H.top)),I.onMouseMove(w)}}}let ut=s(()=>new Map(f().map(I=>[I.id,I])));return(()=>{const I=Gn.cloneNode(!0),w=I.firstChild,H=w.firstChild,U=H.nextSibling,ne=w.nextSibling,oe=ne.firstChild;return I.style.setProperty("flex-grow","1"),I.style.setProperty("display","flex"),I.style.setProperty("flex-direction","column"),I.style.setProperty("overflow","hidden"),V(I,_(X,{get when(){return n.showCode},children:M=>_(kt,{get rootDiv(){return r.rootDiv},onLostFocus:()=>d("showCode",void 0),get children(){const F=qn.cloneNode(!0),E=F.firstChild;return V(E,M),F}})}),w),V(w,_(X,{get when(){return r.onClose},children:M=>(()=>{const F=Kn.cloneNode(!0);return F.$$click=()=>{M()()},F})()}),H),H.$$click=()=>{let M=JSON.stringify(n.world.toJSON()),F=new TextEncoder().encode(M),E=vt(F),D=Nt(E),J;if(n.assemblyFile==null){let B;if(B=window.prompt("Enter file name:")){if(B==null)return;let ye=B;J=async()=>{let{objectId:at}=await St({name:ye,data:D});return d("assemblyFile",{assemblyId:at,assemblyName:ye}),{type:"success"}}}else return}else{let B=n.assemblyFile;J=async()=>await xt({objectId:B.assemblyId,data:D})}J().then(B=>{B.type=="failed"?alert(`Failed to save: ${B.message}`):alert("Save successful.")})},U.$$click=()=>d("showCode",Qt({nodes:f(),edges:g()})),V(oe,_(W,{}),null),V(oe,_(Un,{get selectedNodeType(){return n.selectedNodeTypeForInsertion},setSelectedNodeType:M=>{d("selectedNodeTypeForInsertion",M)},onInit:M=>{a(()=>M.currentNodeComponent)}}),null),V(ne,_($t,It({style:{"flex-grow":"1"},showGrid:!0,fontSize:12,state:l,onRefSvg:M=>{G=M,G.tabIndex=0,G.addEventListener("click",F=>{T().click?.(F.ctrlKey)}),G.addEventListener("dragover",F=>{F.preventDefault()}),G.addEventListener("drop",F=>{let E=h();if(E==null)return;let D=G.getBoundingClientRect(),J=A.create(F.clientX-D.left,F.clientY-D.top),B=k.screenPtToWorldPt(J);if(B==null)return;let ye=wt(E.type.propertiesSchema,E.state);n.world.createEntity([E.type.create(ye),Ne.create({position:B})])}),G.addEventListener("keydown",F=>{if(F.target==G&&F.key=="Delete"){let E=O();if(E.length==0)return;Y(()=>{for(let D of E)n.world.destroyEntity(D)})}})}},ke,{get children(){return[_(se,{get each(){return f()},children:M=>{let F=s(()=>it().has(M.id)),E=s(()=>st().has(M.id));return _(Bt,{onInit:D=>{$(M.id,{get height(){return D.height},get width(){return D.width},get inputPins(){return D.inputArgs},get outputPins(){return D.outputArgs}}),ce(()=>{let J={...m};delete J[M.id],$(J)})},get highlighted(){return F()},get selected(){return E()},get inputs(){return M.inputs},get outputs(){return M.outputs},get initInternalComponentSize(){return M.initInternalComponentSize},get internalComponent(){return M.internalComponent},get pos(){return M.pos},get fixedSize(){return M.fixedSize},get nodeName(){return M.nodeName}})}}),_(se,{get each(){return g()},children:M=>_(Jt,{get nodeIdNodeMap(){return ut()},nodeLayoutInfo:m,edge:M})}),_(Z,{})]}})),null),C(()=>I.style.setProperty("cursor",lt()??"default")),I})()};Pe(["click"]);export{bo as default};
