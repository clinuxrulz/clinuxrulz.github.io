import{f as Ut,c as Ne,a as v,l as st,A as re,y as Dt,s as K,i as ie,b as U,e as ce,I as On,t as Z,z as Ce,g as $e,H as Jn,a2 as Ot,B as ve,K as ao,o as Rt,u as At,N as je,$ as kt,S as tt,m as Nt,C as an,a3 as ko,a4 as tr,a5 as Io,d as yi,M as qt,_ as nr,D as gt,a6 as pl,a7 as ir,a8 as or,G as di,F as Oi,a9 as lr,h as rr}from"./index.5aba22ff.js";import{T as he,Q as we,G as jt,J as ei,K as ti,a4 as wt,l as Ze,$ as Pt,a3 as vi,e as Vt,a5 as Ki,a6 as sr,V as me,c as Hn,R as Di,O as ml,B as gl,_ as yl,D as vl,S as Xi,P as Gi,j as Hi,g as Zt,a7 as bl,a8 as xl,a9 as bi,A as _l,W as wl,C as ar,aa as Wi,b as Qi,H as ui,z as Tn,X as dr,Y as ur,Z as cr,ab as fr,ac as hr,i as pr,a1 as mr,ad as gr,ae as yr,r as vr,af as br}from"./Component.6024a649.js";import{P as xr,p as rn,s as xi,c as Rn,a as qi,R as _r,b as wr,d as Sr,e as Pr,f as kr,g as Ir,h as Tr,i as Mr,j as Ar,k as $r,l as Cr,m as Er,n as Or,o as Dr,q as Rr,r as Nr,t as Br,u as Fr,v as Lr,w as zr,x as jr,y as Vr,z as Ur,A as Yr,B as Kr,C as Xr,D as Gr,E as Hr,F as Wr,G as Qr,H as qr,I as Zr,J as Jr,K as es,L as ts,M as ns,N as is,O as os,Q as ls,S as rs,T as ss,U as as,V as ds,W as us,X as To,Y as cs,Z as fs,_ as hs,$ as ps,a0 as Ri,a1 as Ni,a2 as Mn,a3 as ms,a4 as gs,a5 as Mo,a6 as ys,a7 as vs,a8 as bs}from"./OrderIndexComponent.f19bd260.js";import{P as Re}from"./Plane3D.472a05fa.js";import{R as Xe}from"./Ray3D.5e4c723f.js";import{g as Sl,k as xs,d as Pl,a as kl,c as uo,i as bn,w as _s,p as Zi,b as co,C as xn,e as yn,o as ws,f as Ss,m as Ao,u as Ps}from"./Component.fa73bdbc.js";import{P as ni,p as Bi,j as ks,m as un}from"./PropertiesForm.c69fa44e.js";import{h as Is,a as Il,b as Ts,T as Ms}from"./three_js_component_renderer.95a2237b.js";import{a as C,V as ae}from"./Vec3.ce1f4f7a.js";import{O as As}from"./LockerShed.98091ec0.js";import{i as en,o as Fi,v as _i}from"./utils.6e3ab489.js";import{o as nt,p as $s}from"./PanelUtils.894b6d74.js";import{L as et}from"./Line3D.2b8117f1.js";import{l as Cs,L as ln,a as Es}from"./LineKit.f6b732de.js";import{v as Ji,f as Tl,c as Os,a as Ds,t as Rs,O as Ns,b as Bs}from"./components_to_order_lines.80e80e01.js";import{R as Qn,g as $o,a as Co}from"./Gutter.196a297e.js";import{m as Nn,S as Pi,a as Ml}from"./SvgWithPanZoomState.e2089103.js";import{f as Fs}from"./ad_components.dbddf843.js";import{L as Li}from"./Labeler.42ece7e8.js";import{D as Ls}from"./DocumentsView.ab8d138b.js";import{D as Al}from"./DrawLinesMode.1925dcb4.js";import{F as zs}from"./FrameDrawingDoc.c2479e9b.js";import{L as fo}from"./Line2D.139781b3.js";import{G as js}from"./GLTFExporter.c7bd8ba1.js";import{S as $l}from"./StandardBorderLandscapeDoc.be2b9e86.js";import{R as Cl}from"./Ray2D.01cdc921.js";import{D as Vs}from"./Dialog.aed5b9f2.js";import{D as Us}from"./DocumentView.3a121409.js";import{U as El}from"./UndoManager.be70fe9a.js";import"./MezzanineFloor.5f8c35cf.js";import"./Transform2D.200bb15c.js";import"./GableTruss.fea81d7b.js";import"./HexagonalFirePit.41ea653b.js";import"./OpenWebColumnRafterSection.d2fefac8.js";import"./Fascia.ecb69f90.js";import"./WeldedUBColumnRafterSection.79a51e85.js";function Ys(){let n=document.createElement("canvas");n.width=128,n.height=128;let e=n.getContext("2d");if(e==null)return;let t=e;const i=(x,k)=>{let I=t;I.save(),I.fillStyle=k?"#070":"#777",I.fillRect(0,0,n.width,n.height),I.fillStyle="#000",I.textAlign="center",I.textBaseline="middle",I.font="bold 30px serif",I.fillText(x,.5*n.width,.5*n.height,n.width),I.strokeStyle="#222",I.strokeRect(10,10,n.width-20,n.height-20),I.strokeRect(0,0,n.width,n.height),I.restore()};let c="Left",m="Right",g="Bottom",h="Top",l="Front",a="Back";i(c,!1);let f=n.toDataURL();i(m,!1);let d=n.toDataURL();i(g,!1);let o=n.toDataURL();i(h,!1);let u=n.toDataURL();i(a,!1);let s=n.toDataURL();i(l,!1);let r=n.toDataURL();i(c,!0);let p=n.toDataURL();i(m,!0);let y=n.toDataURL();i(g,!0);let _=n.toDataURL();i(h,!0);let w=n.toDataURL();i(a,!0);let S=n.toDataURL();i(l,!0);let b=n.toDataURL();return{nx:f,px:d,ny:o,py:u,nz:s,pz:r,hnx:p,hpx:y,hny:_,hpy:w,hnz:S,hpz:b}}let Bt=Ys(),Ks=Bt?.nx??"",Xs=Bt?.px??"",Gs=Bt?.ny??"",Hs=Bt?.py??"",Ws=Bt?.nz??"",Qs=Bt?.pz??"",qs=Bt?.hnx??"",Zs=Bt?.hpx??"",Js=Bt?.hny??"",ea=Bt?.hpy??"",ta=Bt?.hnz??"",na=Bt?.hpz??"";const ia=Z('<div style="min-width: 200px; display: flex; flex-direction: column;"><div style="overflow-y: auto; flex-grow: 1;"><input type="checkbox"><label>Show Tests?</label><br><b>Type:</b><br><ul class="list-group"></ul></div><b>Properties:</b><div style="text-align: right; margin-top: 10px;"><button class="btn btn-primary">Insert</button></div></div>'),oa=Z('<li class="list-group-item" style="cursor: pointer;"></li>'),Eo=10,la=Eo*Eo;class ra{constructor(e){let[t,i]=Ne({placingKit:!1,showTestTypes:!1}),c=v(()=>{let d=Sl().filter(u=>u.useStandardKitInsert==null||u.useStandardKitInsert),o;return t.showTestTypes?o=d:o=d.filter(u=>u.isForTesting==null||!u.isForTesting),t.selectedKitType!=null&&!o.some(u=>u==t.selectedKitType)&&i("selectedKitType",void 0),o}),[m,g]=st(void 0);re(()=>{if(t.selectedKitType==null)g(void 0);else{let d=t.selectedKitType;(async()=>{let o=await xs(d,Dt());g({x:()=>o()})})()}}),re(()=>{let d=m();if(d==null){i("currentKit",void 0);return}let o=d.x();o.setVisualProperties?.call(void 0,{previewOpening:()=>{},sheetingLowPoly:e.sheetingLowPoly,textures:e.textures}),i("currentKit",o)});const h=()=>{i("placingKit",!0)};let l=v(()=>{let d=e.mouseRay();if(d!=null)return d.collisionWithPlane(Re.xyPlane)?.xy()}),a=v(()=>{if(!t.placingKit)return;let d=e.mousePos();if(d==null)return;let o=e.mouseRay();if(o==null)return;let u,s;for(let{id:r,line:p}of e.existingLines()){if(p.v1.z!=0||p.v2.z!=0)continue;let y=Xe.create(p.v1,p.v2.sub(p.v1)),_=y.closestTimeOnThisRayWithOtherRay(o);if(_==null)continue;let w=Math.max(0,Math.min(1,_)),S=y.positionFromTime(w),b=e.projectPtToScreen(S);if(b==null)continue;let x=d.distanceSquared(b);if(!(x>la)&&(u==null||x<u)){let k=p.v2.sub(p.v1).normalize();if(!Number.isFinite(k.x)||k.z!=0)continue;let I;_<1/3?I=p.v1:_>2/3?I=p.v2:I=p.v1.add(p.v2).scale(.5),u=x,s={space:he.create(I,we.fromWU(C.unitZ,k)),lineId:r}}}return s}),f=v(()=>{let d=a();if(d!=null)return d.space;let o=l();if(o!=null)return he.create(o.toVec3(),we.identity)});this.highlightedObjectsById=v(()=>{let d=a();return d==null?[]:[d.lineId]}),this.snapPoints=v(()=>{let d=a();if(d==null)return[];let o=d;return[{pt:()=>o.space.o,highlighted:()=>!0}]}),this.click=()=>{if(!t.placingKit)return;let d=f();if(d==null)return;let o=t.currentKit;o!=null&&e.insertKit(o.type,Pl(o.type.componentType.propertiesSchema,o.state),d)},this.instructions=v(()=>t.placingKit?"Click where you would like to insert your kit.":"Select your kit type and fill out the form, then press the insert button below the form."),this.sideForm=v(()=>{if(t.placingKit)return;let d=Dt(),o=v(()=>[...t.currentKit==null?[]:kl(t.currentKit)()]);return(()=>{const u=ia.cloneNode(!0),s=u.firstChild,r=s.firstChild,p=r.nextSibling,y=p.nextSibling,_=y.nextSibling,w=_.nextSibling,S=w.nextSibling,b=s.nextSibling,x=b.nextSibling,k=x.firstChild;return r.addEventListener("change",I=>{i("showTestTypes",I.currentTarget.checked)}),K(r,"id",d),K(p,"for",d),ie(S,U(On,{get each(){return c()},children:I=>(()=>{const D=oa.cloneNode(!0);return D.$$click=Y=>{Y.ctrlKey&&t.selectedKitType===I()?i("selectedKitType",void 0):i("selectedKitType",I())},ie(D,()=>I().componentType.displayName),ce(()=>D.classList.toggle("active",t.selectedKitType===I())),D})()})),ie(u,U(ni,{style:"border: black; border-width: 1px; width: 100%;",get fieldGroups(){return o()}}),x),k.$$click=()=>h(),ce(()=>k.disabled=t.currentKit==null),ce(()=>r.checked=t.showTestTypes),u})()}),this.overlayObject3d=v(()=>{if(!t.placingKit||t.currentKit==null)return;let d=t.currentKit,o=v(()=>d.components?.call(t.currentKit)??[]),u=new jt;return re(()=>{let s=f();if(s==null)return;let r=.001,p=s.o,y=s.orientation;u.position.set(p.x*r,p.y*r,p.z*r),u.quaternion.set(y.x,y.y,y.z,y.w),u.updateMatrix(),e.render()}),Is({group:u,components:o}),u})}}Ut(["click"]);const sa=Z('<div style="min-width: 200px; display: flex; flex-direction: column;"><button class="btn btn-primary">Insert</button></div>'),aa=Z("<div></div>");class da{constructor(e){let[t,i]=Ne({openingType:void 0,height:void 0,width:void 0,headHeight:void 0,mode:{type:"FormInput"}}),c=o=>ks({displayName:o.displayName,value:()=>o.value()??"Unset",setValue:u=>{u=="Unset"?o.setValue(void 0):o.setValue(u)},possibleValues:v(()=>["Unset",...o.possibleValues()])}),m=v(()=>[{displayName:"Opening Properties",fields:[c({displayName:()=>"Type",value:()=>t.openingType,setValue:o=>{$e(()=>{let u=o;if(i("openingType",u),u!=null)switch(u){case"Barn PA Door":i("height",2040),i("width",920),i("headHeight",2040);break;case"PA Door":i("height",2040),i("width",920),i("headHeight",2040);break;case"Window":i("height",900),i("width",1200),i("headHeight",2e3);break;case"Glass Sliding Door":i("height",2040),i("width",1800),i("headHeight",2040);break;case"Roller Door":i("height",2e3),i("width",2e3),i("headHeight",2e3);break}})},possibleValues:()=>As}),Bi({displayName:()=>"Height",value:()=>t.height,setValue:o=>i("height",o)}),Bi({displayName:()=>"Width",value:()=>t.width,setValue:o=>i("width",o)}),Bi({displayName:()=>"Head Height",value:()=>t.headHeight,setValue:o=>i("headHeight",o)})],expanded:()=>!0}]),g=v(()=>{if(t.openingType!=null&&t.height!=null&&t.width!=null&&t.headHeight!=null)return{openingType:t.openingType,height:t.height,width:t.width,headHeight:t.headHeight}}),h=()=>{let o=g();o!=null&&i("mode",Jn({type:"Inserting",opening:o}))},l=v(()=>{if(t.mode.type!="Inserting")return;let o=e.mouseRay();if(o==null)return;let u,s;for(let r of e.walls()){let p=Re.fromKnownPtAndNormal(r.space.o,r.space.v),y=o.collisionTimeWithPlane(p);if(y==null)continue;let _=o.positionFromTime(y),w=r.space.pointToThisSpace(_),S=ae.create(w.x,w.z);!en(S,r.outline)||(s==null||y<s)&&(s=y,u={wall:r,ptOnWall:S})}return u}),a=v(()=>{let o=g();if(o==null)return;let u=l();if(u==null)return;let s,r,p;{let N=0,oe=0;for(let ue of u.wall.bays){let J=oe+ue.size;if(J>u.ptOnWall.x){s=N,r=oe,p=J;break}oe=J,++N}}if(s==null||r==null||p==null)return;let{minLeftDist:y,minRightDist:_}=u.wall.bays[s],w=.5*(r+p),S=r+y+.5*o.width,b=p-_-.5*o.width,x=Math.abs(w-u.ptOnWall.x),k=Math.abs(S-u.ptOnWall.x),I=Math.abs(b-u.ptOnWall.x),D=[{posType:"Left",dist:k,openingCentreX:S},{posType:"Right",dist:I,openingCentreX:b}],Y="Centre",Q=w;if(b-S>100){let N=x;for(let oe of D)oe.dist<N&&(N=oe.dist,Y=oe.posType,Q=oe.openingCentreX)}return{bayIdx:s,posType:Y,openingCentreX:Q}});this.instructions=v(()=>{switch(t.mode.type){case"FormInput":return"Fill out the form for opening type and size, then click the `Insert` button.";case"Inserting":return"Click where you would like in insert the opening, press escape when done."}}),this.sideForm=v(()=>{if(t.mode.type=="FormInput")return(()=>{const o=sa.cloneNode(!0),u=o.firstChild;return ie(o,U(ni,{get fieldGroups(){return m()}}),u),u.$$click=()=>h(),ce(()=>u.disabled=g()==null),o})()});let f=v(()=>{let o=l();if(o==null)return;let u=o,s=u.wall.outline;if(s.length<3)return;let r=.001,p=new ei;p.moveTo(s[0].x*r,s[0].y*r);for(let b=1;b<s.length;++b)p.lineTo(s[b].x*r,s[b].y*r);p.closePath();let y=new ti(p,{depth:200*r,bevelEnabled:!1});y.translate(0,0,-100*r),y.rotateX(.5*Math.PI);let _=new wt({color:"green",opacity:.5,transparent:!0});Ce(()=>{y.dispose(),_.dispose()});let w=new Ze(y,_),S=u.wall.space;return w.position.set(S.o.x*r,S.o.y*r,S.o.z*r),w.quaternion.set(S.orientation.x,S.orientation.y,S.orientation.z,S.orientation.w),w}),d=v(()=>{let o=g();if(o==null)return;let u=l();if(u==null)return;let s=a();if(s==null)return;let r=.001,p=new Pt(o.width*r,500*r,o.height*r),y=new wt({color:"gray"});Ce(()=>{p.dispose(),y.dispose()});let _=new Ze(p,y),w=u.wall.space.fromThisSpace(he.create(C.create(s.openingCentreX,0,o.headHeight-.5*o.height),we.identity));return _.position.set(w.o.x*r,w.o.y*r,w.o.z*r),_.quaternion.set(w.orientation.x,w.orientation.y,w.orientation.z,w.orientation.w),_});this.overlayObject3d=v(()=>{let o=new jt;return re(()=>{let u=f();if(u!=null){let s=u;o.add(s),Ce(()=>o.remove(s)),e.render()}}),re(()=>{let u=d();if(u!=null){let s=u;o.add(s),Ce(()=>o.remove(s)),e.render()}}),o}),this.overlayUI=v(()=>{let o=l();if(o==null)return;let u=a();if(u==null)return;let s=g();if(s==null)return;let r=0;for(let I=0;I<u.bayIdx;++I)r+=o.wall.bays[I].size;let p=r+o.wall.bays[u.bayIdx].size,{minLeftDist:y,minRightDist:_}=o.wall.bays[u.bayIdx],w;switch(u.posType){case"Centre":w=.5*(r+p);break;case"Left":w=r+y+.5*s.width;break;case"Right":w=p-_-.5*s.width;break}let S=s.headHeight-.5*s.height,b=C.create(w,0,S),x=o.wall.space.pointFromThisSpace(b),k=e.projectPtToScreen(x);if(k!=null)return(()=>{const I=aa.cloneNode(!0);return I.style.setProperty("position","absolute"),I.style.setProperty("pointer-events","none"),ie(I,()=>u.posType),ce(D=>{const Y=k.x+"px",Q=k.y+"px";return Y!==D._v$&&I.style.setProperty("left",D._v$=Y),Q!==D._v$2&&I.style.setProperty("top",D._v$2=Q),D},{_v$:void 0,_v$2:void 0}),I})()}),this.click=()=>{if(t.mode.type!="Inserting")return;let o=l();if(o==null)return;let u=a();if(u==null)return;let s=t.mode.opening,r;switch(u.posType){case"Centre":r={type:"Centre"};break;case"Left":r={type:"Left",dist:o.wall.bays[u.bayIdx].minLeftDist};break;case"Right":r={type:"Right",dist:o.wall.bays[u.bayIdx].minRightDist};break}let p;o.wall.reverseBayIndices?p=(o.wall.bays.length-1-u.bayIdx).toString():p=u.bayIdx.toString(),e.insertOpening({location:xr.fromArray([...o.wall.location.toArray(),"Bay",p]),id:Dt(),type:s.openingType,height:s.height,width:s.width,headHeight:s.headHeight,posX:r})}}}Ut(["click"]);class ua{constructor(e){let t=100,i=v(()=>e.walls().map(m=>{let g=vi.empty();for(let h of m.outline)g.includePoint({x:h.x,y:-.5*t,z:h.y}),g.includePoint({x:h.x,y:.5*t,z:h.y});return{wall:m,aabb:g}})),c=v(()=>{let m=e.mouseRay();if(m==null)return;let g=i(),h,l,a=Re.fromKnownPtAndNormal(C.create(0,-.5*t,0),C.negUnitY),f=Re.fromKnownPtAndNormal(C.create(0,.5*t,0),C.unitY);for(let{wall:d,aabb:o}of g){let u=m.toSpace(d.space),s=o.rayCollisionTime(u);if(s==null||h!=null&&s>h)continue;s=void 0;let r=u.collisionTimeWithPlane(a);if(r!=null){let p=u.positionFromTime(r);en(ae.create(p.x,p.z),d.outline)&&(s=r)}if(r=u.collisionTimeWithPlane(f),r!=null){let p=u.positionFromTime(r);en(ae.create(p.x,p.z),d.outline)&&(s==null||r<s)&&(s=r)}for(let p=0;p<d.outline.length;++p){let y=(p+1)%d.outline.length,_=d.outline[p],S=d.outline[y].sub(_),b=S.normalize(),x=ae.create(-b.y,b.x),k=Re.fromKnownPtAndNormal(C.create(_.x,0,_.y),C.create(x.x,0,x.y));if(r=u.collisionTimeWithPlane(k),r!=null){let I=u.positionFromTime(r);if(Math.abs(I.y)<.5*t){let D=ae.create(I.x,I.z).sub(_).dot(S)/S.dot(S);Number.isFinite(D)&&0<=D&&D<=1&&(s==null||r<s)&&(s=r)}}}s!=null&&(h==null||s<h)&&(h=s,l=d)}return l});this.instructions=()=>"Click where you would like to insert partition walls. Then press Escape when finished.",this.overlayObject3d=v(()=>{let m=new jt;return re(()=>{m.children.length!=0&&m.clear();let g=.001,h=new wt({color:"blue",opacity:.5,transparent:!0}),l=new wt({color:"green",opacity:.5,transparent:!0});Ce(()=>{h.dispose(),l.dispose()});for(let a of e.walls()){if(a.outline.length<3)continue;let f=new ei;f.moveTo(a.outline[0].x*g,a.outline[0].y*g);for(let s=1;s<a.outline.length;++s)f.lineTo(a.outline[s].x*g,a.outline[s].y*g);f.closePath();let d=new ti(f,{bevelEnabled:!1,depth:100*g});d.translate(0,0,-50*g),d.rotateX(.5*Math.PI),Ce(()=>{d.dispose()});let o=new Ze(d),u=!0;re(()=>{c()==a?o.material=l:o.material=h,u?u=!1:e.render()}),o.position.set(a.space.o.x*g,a.space.o.y*g,a.space.o.z*g),o.quaternion.set(a.space.orientation.x,a.space.orientation.y,a.space.orientation.z,a.space.orientation.w),o.renderOrder=1,m.add(o)}}),m}),this.click=()=>{let m=c();m!=null&&e.insertPartitionWall(m.location)}}}const Oo=10,ci=Oo*Oo,eo=.001,zi=eo*eo;class ca{constructor(e){let[t,i]=Ne({firstSelected:void 0}),c=v(()=>e.roofPlanes().flatMap(b=>{let x=[],k=b.space(),I=b.vertices();for(let D=0;D<I.length;++D){let Y=I[D],Q=I[(D+1)%I.length];x.push({roofPlane:b,edgeIndex:D,edgeLine:et.create(k.pointFromThisSpace(Y.toVec3()),k.pointFromThisSpace(Q.toVec3()))})}return x})),m=v(()=>{if(t.firstSelected==null||t.firstSelected.value.type!="Edge")return c();let b=t.firstSelected;return c().filter(({roofPlane:x})=>x!==b.value.roofPlane)}),g=v(()=>{if(t.firstSelected==null||t.firstSelected.value.type!="Edge")return;let b=t.firstSelected.value;return c().find(({roofPlane:x,edgeIndex:k})=>x===b.roofPlane&&k==b.edgeIndex)}),h=v(()=>{let b=e.mousePos();if(b==null||e.mouseRay()==null)return;let k,I;for(let D of e.roofPlanes()){let Y=D.vertices();{let Q=-1;for(let N of Y){Q++;let oe=D.space().pointFromThisSpace(N.toVec3()),ue=e.projectPtToScreen(oe);if(ue==null)continue;let J=b.distanceSquared(ue);J>ci||(k==null||J<k)&&(k=J,I={type:"End",roofPlane:D,index:Q})}}}if(t.firstSelected?.value.type=="Edge"){let D=t.firstSelected.value.roofPlane,Y=t.firstSelected.value.edgeIndex,Q=D.vertices(),N=Y,oe=(N+1)%Q.length,ue=Q[N].add(Q[oe]).scale(.5),J=D.space().pointFromThisSpace(ue.toVec3()),_e=e.projectPtToScreen(J);if(_e!=null){let Te=b.distanceSquared(_e);Te<=ci&&(k==null||Te<k)&&(k=Te,I={type:"Mid",roofPlane:D,index:Y})}}return I}),l=v(()=>{let b=h();if(!(b==null||b.type!="End"))return{roofPlane:b.roofPlane,vertexIndex:b.index}}),a=v(()=>{let b=h();if(!(b==null||b.type!="Mid"))return{roofPlane:b.roofPlane,edgeIndex:b.index}}),f=v(()=>{if(l()!=null||a()!=null)return;let b=e.mousePos();if(b==null)return;let x=e.mouseRay();if(x==null)return;m();let k,I;for(let D of m()){let Y=D.edgeLine,Q=Xe.create(Y.v1,Y.v2.sub(Y.v1)),N=Q.closestTimeOnThisRayWithOtherRay(x);if(N==null)continue;let oe=Math.max(0,Math.min(1,N)),ue=Q.positionFromTime(oe),J=e.projectPtToScreen(ue);if(J==null)continue;let _e=b.distanceSquared(J);_e>ci||(k==null||_e<k)&&(k=_e,I=D)}return I}),d=v(()=>{if(e.mousePos()==null)return;let x=e.mouseRay();if(x==null||g()==null||f()!=null)return;let k,I;for(let D of e.roofPlanes()){let Y=Re.fromKnownPtAndNormal(D.space().o,D.space().w),Q=x.collisionTimeWithPlane(Y);if(Q==null||Q<0)continue;let N=x.positionFromTime(Q),oe=D.space().pointToThisSpace(N).xy();if(!en(oe,D.vertices()))continue;let ue=Q;(k==null||ue<k)&&(k=ue,I=D)}return I}),o=v(()=>{if(g()==null||l()!=null||f()!=null)return;let b=e.mousePos();if(b==null)return;let x=e.mouseRay();if(x==null)return;let k,I;for(let D of e.groundLines()){let Y=D.line,Q=Xe.create(Y.v1.toVec3(),Y.v2.sub(Y.v1).toVec3()),N=Q.closestTimeOnThisRayWithOtherRay(x);if(N==null)continue;let oe=Math.max(0,Math.min(1,N)),ue=Q.positionFromTime(oe),J=e.projectPtToScreen(ue);if(J==null||b.distanceSquared(J)>ci)continue;let Te=x.closestTimeToPoint(ue);Te<0||(k==null||Te<k)&&(k=Te,I=D)}return I});this.instructions=()=>`Do one of the following:
 - Select two roof plane edges to join them.
 - Select one roof plane edge, then select a roof plane to run it into.
 - Select a point, then select another point to move it to.
 - Select a roof plane edge and a ground line to run the edge upto the line.
 - Press escape when done.
Note:
  If more points are required, you can select a roof plane edge then press split.
  All oversplitting gets healed at the end of this mode. (After pressing escape.)`;let u=v(()=>{let b=d();if(b==null)return;let x=b.vertices();if(x.length<3)return;let k=.001,I=new ei;I.moveTo(x[0].x*k,x[0].y*k);for(let J=1;J<x.length;++J)I.lineTo(x[J].x*k,x[J].y*k);I.closePath();let D=200,Y=new ti(I,{bevelEnabled:!1,depth:D*k});Y.translate(0,0,-.5*D*k);let Q=new wt({color:"green",transparent:!0,opacity:.5});Ce(()=>{Y.dispose(),Q.dispose()});let N=b.space().origin,oe=b.space().orientation,ue=new Ze(Y,Q);return ue.position.set(N.x*k,N.y*k,N.z*k),ue.setRotationFromQuaternion(new Vt(oe.x,oe.y,oe.z,oe.w)),ue}),s=(b,x)=>{r(b,x),r(x,b)},r=(b,x)=>{let k=b.roofPlane.vertices(),I=b.roofPlane.space(),D=(b.edgeIndex+(k.length-1))%k.length,Y=b.edgeIndex,Q=(b.edgeIndex+1)%k.length,N=(b.edgeIndex+2)%k.length,oe=I.pointFromThisSpace(k[D].toVec3()),ue=I.pointFromThisSpace(k[Y].toVec3()),J=I.pointFromThisSpace(k[Q].toVec3()),_e=I.pointFromThisSpace(k[N].toVec3()),Te=Xe.create(oe,ue.sub(oe)),se=Xe.create(_e,_e.sub(J)),ee=x.roofPlane.space(),F=Re.fromKnownPtAndNormal(ee.o,ee.w);if(Math.abs(Te.direction.dot(F.n))<=zi||Math.abs(se.direction.dot(F.n))<=zi)return;let L=Te.collisionWithPlane(F);if(L==null)return;let $=se.collisionWithPlane(F);if($==null)return;let W=I.pointToThisSpace(L).xy(),te=I.pointToThisSpace($).xy(),xe=[...k];xe[Y]=W,xe[Q]=te,b.roofPlane.updateVertices(xe)},p=(b,x)=>{let k=x.roofPlane.space().pointFromThisSpace(x.roofPlane.vertices()[x.vertexIndex].toVec3()),I=b.roofPlane.space().pointToThisSpace(k).xy(),D=[...b.roofPlane.vertices()];D[b.vertexIndex]=I,b.roofPlane.updateVertices(D)},y=b=>{let x=b.roofPlane.vertices(),k=b.edgeIndex,I=(b.edgeIndex+1)%x.length,D=x[k].add(x[I]).scale(.5),Y=[...x.slice(0,k+1),D,...x.slice(k+1)];b.roofPlane.updateVertices(Y)},_=(b,x)=>{let k=b.roofPlane.vertices(),I=b.roofPlane.space(),D=(b.edgeIndex+(k.length-1))%k.length,Y=b.edgeIndex,Q=(b.edgeIndex+1)%k.length,N=(b.edgeIndex+2)%k.length,oe=I.pointFromThisSpace(k[D].toVec3()),ue=I.pointFromThisSpace(k[Y].toVec3()),J=I.pointFromThisSpace(k[Q].toVec3()),_e=I.pointFromThisSpace(k[N].toVec3()),Te=Xe.create(oe,ue.sub(oe)),se=Xe.create(_e,_e.sub(J)),ee=Re.fromKnownPtAndNormal(x.v1.toVec3(),C.unitZ.cross(x.v2.sub(x.v1).toVec3()).normalize()),F=Te.collisionWithPlane(ee);if(F==null)return;let L=se.collisionWithPlane(ee);if(L==null)return;let $=I.pointToThisSpace(F).xy(),W=I.pointToThisSpace(L).xy(),te=[...k];te[Y]=$,te[Q]=W,b.roofPlane.updateVertices(te)},w=(b,x)=>{let k=b.roofPlane.vertices(),I=b.roofPlane.space(),D=(b.edgeIndex+(k.length-1))%k.length,Y=b.edgeIndex,Q=(b.edgeIndex+1)%k.length,N=(b.edgeIndex+2)%k.length,oe=I.pointFromThisSpace(k[D].toVec3()),ue=I.pointFromThisSpace(k[Y].toVec3()),J=I.pointFromThisSpace(k[Q].toVec3()),_e=I.pointFromThisSpace(k[N].toVec3()),Te=Xe.create(oe,ue.sub(oe)),se=Xe.create(_e,_e.sub(J)),ee=Te.collisionWithPlane(x);if(ee==null)return;let F=se.collisionWithPlane(x);if(F==null)return;let L=I.pointToThisSpace(ee).xy(),$=I.pointToThisSpace(F).xy(),W=[...k];W[Y]=L,W[Q]=$,b.roofPlane.updateVertices(W)},S=b=>{for(let x of b){let k=!1,I=[...x.vertices()];for(;;){let D=!1;for(let Y=0;Y<I.length;++Y){let Q=(Y+1)%I.length,N=I[Y],oe=I[Q];if(N.distanceSquared(oe)<zi){I.splice(Y,1),k=!0,D=!0;break}}if(!D)break}for(;;){let D=!1;for(let Y=0;Y<I.length;++Y){let Q=(Y+1)%I.length,N=(Y+2)%I.length,oe=I[Y],ue=I[Q],J=I[N],_e=ue.sub(oe).normalize(),Te=J.sub(ue).normalize();if(Math.abs(Math.asin(_e.cross(Te))*180)<eo){I.splice(Q,1),k=!0,D=!0;break}}if(!D)break}k&&x.updateVertices(I)}};this.overlayObject3d=v(()=>u()),this.highlightedObjectsById=v(()=>nt(o()?.id)),this.snapPoints=v(()=>{let b=[],x=l();if(x!=null){let I=x,D=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[I.vertexIndex].toVec3());b.push({pt:()=>D,highlighted:()=>!1})}let k=a();if(k!=null){let I=k,D=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[I.edgeIndex].toVec3()),Y=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[(I.edgeIndex+1)%I.roofPlane.vertices().length].toVec3()),Q=D.add(Y).scale(.5);b.push({pt:()=>Q,highlighted:()=>!0})}else if(t.firstSelected!=null&&t.firstSelected.value.type=="Edge"){let I=t.firstSelected.value,D=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[I.edgeIndex].toVec3()),Y=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[(I.edgeIndex+1)%I.roofPlane.vertices().length].toVec3()),Q=D.add(Y).scale(.5);b.push({pt:()=>Q,highlighted:()=>!1})}if(t.firstSelected!=null&&t.firstSelected.value.type=="Vertex"){let I=t.firstSelected.value,D=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[I.vertexIndex].toVec3());b.push({pt:()=>D,highlighted:()=>!0})}if(t.firstSelected!=null&&t.firstSelected.value.type=="Edge Mid Vertex"){let I=t.firstSelected.value,D=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[I.edgeIndex].toVec3()),Y=I.roofPlane.space().pointFromThisSpace(I.roofPlane.vertices()[(I.edgeIndex+1)%I.roofPlane.vertices().length].toVec3()),Q=D.add(Y).scale(.5);b.push({pt:()=>Q,highlighted:()=>!0})}return b}),this.snapLines=v(()=>{let b=[],x=f();if(x!=null){let k=x;b.push({line:()=>k.edgeLine,highlighted:()=>!1})}if(t.firstSelected!=null&&t.firstSelected.value.type=="Edge"&&a()==null){let k=t.firstSelected.value.edgeIndex,I=t.firstSelected.value.roofPlane.vertices(),D=I[k],Y=I[(k+1)%I.length],Q=t.firstSelected.value.roofPlane,N=et.create(Q.space().pointFromThisSpace(D.toVec3()),Q.space().pointFromThisSpace(Y.toVec3()));b.push({line:()=>N,highlighted:()=>!0})}return b}),this.click=()=>{{let b=f();if(b!=null){if(t.firstSelected==null||t.firstSelected.value.type!="Edge"){let x=b;i("firstSelected",new Ot({type:"Edge",roofPlane:x.roofPlane,edgeIndex:x.edgeIndex}))}else s(t.firstSelected.value,{roofPlane:b.roofPlane,edgeIndex:b.edgeIndex}),i("firstSelected",void 0);return}}{let b=a();if(b!=null){if(t.firstSelected==null||t.firstSelected.value.type!="Edge Mid Vertex"){let x=b;i("firstSelected",new Ot({type:"Edge Mid Vertex",roofPlane:x.roofPlane,edgeIndex:x.edgeIndex}))}return}}{let b=l();if(t.firstSelected?.value.type=="Edge Mid Vertex"&&b!=null){y({roofPlane:t.firstSelected.value.roofPlane,edgeIndex:t.firstSelected.value.edgeIndex}),p({roofPlane:t.firstSelected.value.roofPlane,vertexIndex:(t.firstSelected.value.edgeIndex+1)%t.firstSelected.value.roofPlane.vertices().length},{roofPlane:b.roofPlane,vertexIndex:b.vertexIndex}),i("firstSelected",void 0);return}}{let b=l();if(b!=null){if(t.firstSelected==null||t.firstSelected.value.type!="Vertex"){let x=b;i("firstSelected",new Ot({type:"Vertex",roofPlane:x.roofPlane,vertexIndex:x.vertexIndex}))}else p(t.firstSelected.value,{roofPlane:b.roofPlane,vertexIndex:b.vertexIndex}),i("firstSelected",void 0);return}}{let b=o();if(b!=null){if(t.firstSelected!=null&&t.firstSelected.value.type=="Edge"){let x=t.firstSelected.value,k=b.line;$e(()=>{_(x,k),i("firstSelected",void 0)})}return}}{let b=d();if(b!=null){if(t.firstSelected!=null&&t.firstSelected.value.type=="Edge"){let x=b.space(),k=t.firstSelected.value,I=Re.fromKnownPtAndNormal(x.o,x.w);$e(()=>{w(k,I),i("firstSelected",void 0)})}return}}i("firstSelected",void 0)},this.cancel=()=>{S(e.roofPlanes())}}}class fa{constructor(e){this.instructions=()=>"Click a start point for the wall, or press Escape when done.";let[t,i]=Ne({}),c=v(()=>{let a=e.mouseRay();if(a!=null)return a.collisionWithPlane(Re.xyPlane)?.xy()}),m=new Pt(80/1e3,80/1e3,80/1e3),g=new Pt(80/1e3,80/1e3,1),h=new Ki;Ce(()=>{m.dispose(),g.dispose(),h.dispose()});let l=new Ze(m,h);this.overlayObject3d=v(()=>{let a=new jt;{let f=!1;re(()=>{let d=c();d==null?f&&(a.remove(l),f=!1):(f||(a.add(l),f=!0),l.position.set(d.x/1e3,d.y/1e3,0),l.updateMatrix()),e.render()})}{let f,d,o=new Ki;re(()=>{if(f!=null&&(a.remove(f),f=void 0),d!=null&&(d.dispose(),d=void 0),t.startGroundPoint!=null){let u=c();if(u!=null){let s=t.startGroundPoint,r=s.distance(u),p=u.sub(s).normalize().toVec3(),y=C.unitZ,_=s.add(u).scale(.5).toVec3();d=new Pt(r/1e3,80/1e3,1e3/1e3);let w=we.fromWU(y,p);f=new Ze(d,o),f.position.set(_.x/1e3,_.y/1e3,_.z/1e3),f.quaternion.set(w.x,w.y,w.z,w.w),f.updateMatrix(),a.add(f)}}e.render()}),Ce(()=>{d?.dispose(),o.dispose()})}return a}),this.click=()=>{let a=c();a!=null&&(t.startGroundPoint==null?i("startGroundPoint",a):(e.insertWall(t.startGroundPoint,a),i("startGroundPoint",void 0)))}}}function ha(n){let e,t,i,c;{let m=new sr,g=new Vt;e=v(()=>{let h=n.value().orientation;return g.set(h.x,h.y,h.z,h.w),m.setFromQuaternion(g),m},m,{equals:(h,l)=>!1}),t=h=>{m.set(h,m.y,m.z),g.setFromEuler(m),n.setValue(he.create(n.value().origin,new we(g.w,g.x,g.y,g.z)))},i=h=>{m.set(m.x,h,m.z),g.setFromEuler(m),n.setValue(he.create(n.value().origin,new we(g.w,g.x,g.y,g.z)))},c=h=>{m.set(m.x,m.y,h),g.setFromEuler(m),n.setValue(he.create(n.value().origin,new we(g.w,g.x,g.y,g.z)))}}return{displayName:n.displayName(),fields:[un({displayName:()=>"Pos X",value:()=>n.value().o.x,setValue:m=>n.setValue(he.create(C.create(m,n.value().o.y,n.value().o.z),n.value().orientation))}),un({displayName:()=>"Pos Y",value:()=>n.value().o.y,setValue:m=>n.setValue(he.create(C.create(n.value().o.x,m,n.value().o.z),n.value().orientation))}),un({displayName:()=>"Pos Z",value:()=>n.value().o.z,setValue:m=>n.setValue(he.create(C.create(n.value().o.x,n.value().o.y,m),n.value().orientation))}),un({displayName:()=>"Rot X",value:()=>Math.round(e().x*180/Math.PI),setValue:m=>t(m*Math.PI/180)}),un({displayName:()=>"Rot Y",value:()=>Math.round(e().y*180/Math.PI),setValue:m=>i(m*Math.PI/180)}),un({displayName:()=>"Rot Z",value:()=>Math.round(e().z*180/Math.PI),setValue:m=>c(m*Math.PI/180)})],expanded:()=>!0}}function pa(n,e){let t={vertices:[],edges:[],faces:[]},i=0,c=()=>i++,m=(()=>{let h={};return l=>{let a=l.toString(),f=h[a],d=n[l];return f!=null||(f={id:c(),pos:d},h[a]=f,t.vertices.push(f)),f}})(),g=(()=>{let h={};return(l,a,f)=>{let d=l.id+"_"+a.id,o=h[d];return o!=null?(o.incidentFace==null&&f!=null&&(o.incidentFace=f),o):(o={id:c(),origin:l,incidentFace:f},h[d]=o,t.edges.push(o),o)}})();for(let h of e){let l={id:c()};t.faces.push(l);let a=m(h.v1),f=m(h.v2),d=m(h.v3),o=g(a,f,l),u=g(f,d,l),s=g(d,a,l),r=g(f,a);o.twin=r,r.twin=o;let p=g(d,f);u.twin=p,p.twin=u;let y=g(a,d);s.twin=y,y.twin=s,o.next=u,u.next=s,s.next=o,o.prev=s,s.prev=u,u.prev=o,l.edge=o}for(let h of t.edges)h.next==null;return t}function ma(n){const e=n.attributes.position;let t;if(n.index)t=n.index.array;else{t=new Array(e.array.length/e.itemSize|0);for(let l=0;l<t.length;l++)t[l]=l}const i=t.length/3|0;let c=new Array(e.count);for(let l=0;l<e.count;++l){const f=l*3,d=e.array[f],o=e.array[f+1],u=e.array[f+2];c[l]={x:d,y:o,z:u}}let m,g=new Array(c.length);{let l=0,a={},f=0;for(let d of c){let o=Math.round(d.x*1e3)+"_"+Math.round(d.y*1e3)+"_"+Math.round(d.z*1e3),u=a[o];if(u==null){let s=l++;a[o]={v:C.create(d.x,d.y,d.z),idx:s},g[f]=s}else g[f]=u.idx;++f}m=new Array(l);for(let d in a){let o=a[d];m[o.idx]=o.v}}let h=new Array(i);for(let l=0,a=0;a<t.length;++l,a+=3)h[l]={v1:g[t[a]],v2:g[t[a+1]],v3:g[t[a+2]]};return pa(m,h)}function Do(n){let e=n.edge,t=e.origin,i=e.next?.origin,c=e.next?.next?.origin;return i.pos.sub(t.pos).cross(c.pos.sub(t.pos)).normalize()}function ji(n,e){let i=n.normal.dot(e)+n.constant;return i<=-1e-5?"Inside":i>=1e-5?"Outside":"Coinside"}class ga{constructor(e){this.triangleBoxIntersects=(()=>{let c=new me,m=new me,g=new me,h=(l,a)=>{c.set(l.v1.x,l.v1.y,0);let f=g.dot(c);c.set(l.v2.x,l.v2.y,0);let d=g.dot(c);c.set(l.v3.x,l.v3.y,0);let o=g.dot(c),u=Math.min(Math.min(f,d),o),s=Math.max(Math.max(f,d),o);c.set(a.minX,a.minY,0);let r=g.dot(c);c.set(a.maxX,a.minY,0);let p=g.dot(c);c.set(a.maxX,a.maxY,0);let y=g.dot(c);c.set(a.minX,a.maxY,0);let _=g.dot(c),w=Math.min(Math.min(r,p),Math.min(y,_)),S=Math.max(Math.max(r,p),Math.max(y,_));return u>=S||s<=w};return(l,a)=>(m.set(0,0,-1),c.set(l.v2.x-l.v1.x,l.v2.y-l.v1.y,0),c.cross(m),g.copy(c),!(h(l,a)||(m.set(0,0,-1),c.set(l.v3.x-l.v2.x,l.v3.y-l.v2.y,0),c.cross(m),g.copy(c),h(l,a))||(m.set(0,0,-1),c.set(l.v1.x-l.v3.x,l.v1.y-l.v3.y,0),c.cross(m),g.copy(c),h(l,a))||(g.set(1,0,0),h(l,a))||(g.set(0,1,0),h(l,a))))})(),this.lineBoxIntersects=(()=>{let c=new me,m=new me,g=(h,l)=>{c.set(h.v1.x,h.v1.y,0);let a=m.dot(c);c.set(h.v2.x,h.v2.y,0);let f=m.dot(c),d=Math.min(a,f),o=Math.max(a,f);c.set(l.minX,l.minY,0);let u=m.dot(c);c.set(l.maxX,l.minY,0);let s=m.dot(c);c.set(l.maxX,l.maxY,0);let r=m.dot(c);c.set(l.minX,l.maxY,0);let p=m.dot(c),y=Math.min(Math.min(u,s),Math.min(r,p)),_=Math.max(Math.max(u,s),Math.max(r,p));return d>=_||o<=y};return(h,l)=>(m.set(h.v2.x-h.v1.x,h.v2.y-h.v1.y,0),!(g(h,l)||(m.set(1,0,0),g(h,l))||(m.set(0,1,0),g(h,l))))})(),this.numRows=e.numRows,this.numCols=e.numCols,this.buckets=Array(this.numRows*this.numCols).fill(void 0).map(()=>({triangles:[]})),this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY;let t=[C.zero,C.zero,C.zero];for(let c of e.triangles){t[0]=c.v1,t[1]=c.v2,t[2]=c.v3;for(let m of t)this.minX=Math.min(this.minX,m.x),this.maxX=Math.max(this.maxX,m.x),this.minY=Math.min(this.minY,m.y),this.maxY=Math.max(this.maxY,m.y)}this.bucketWidth=(this.maxX-this.minX)/e.numCols,this.bucketHeight=(this.maxY-this.minY)/e.numRows;let i={minX:0,maxX:0,minY:0,maxY:0};for(let c of e.triangles){let m=Math.max(0,Math.min(e.numCols-1,Math.floor((Math.min(Math.min(c.v1.x,c.v2.x),c.v3.x)-this.minX)/this.bucketWidth))),g=Math.max(0,Math.min(e.numCols-1,Math.ceil((Math.max(Math.max(c.v1.x,c.v2.x),c.v3.x)-this.minX)/this.bucketWidth))),h=Math.min(m,g),l=Math.max(m,g),a=Math.max(0,Math.min(e.numRows-1,Math.floor((Math.min(Math.min(c.v1.y,c.v2.y),c.v3.y)-this.minY)/this.bucketHeight))),f=Math.max(0,Math.min(e.numRows-1,Math.ceil((Math.max(Math.max(c.v1.y,c.v2.y),c.v3.y)-this.minY)/this.bucketHeight))),d=Math.min(a,f),o=Math.max(a,f);for(let u=d;u<=o;++u)for(let s=h;s<=l;++s)this.bucketRange(u,s,i),this.triangleBoxIntersects(c,i)&&this.buckets[u*this.numRows+s].triangles.push(c)}}bucketRange(e,t,i){i.minX=this.minX+t*this.bucketWidth,i.maxX=i.minX+this.bucketWidth,i.minY=this.minY+e*this.bucketHeight,i.maxY=i.minY+this.bucketHeight}traverseTriangles(e,t){let i=new Set,c=Math.max(0,Math.min(this.numCols-1,Math.floor((Math.min(e.v1.x,e.v2.x)-this.minX)/this.bucketWidth))),m=Math.max(0,Math.min(this.numCols-1,Math.ceil((Math.max(e.v1.x,e.v2.x)-this.minX)/this.bucketWidth))),g=Math.min(c,m),h=Math.max(c,m),l=Math.max(0,Math.min(this.numRows-1,Math.floor((Math.min(e.v1.y,e.v2.y)-this.minY)/this.bucketHeight))),a=Math.max(0,Math.min(this.numRows-1,Math.ceil((Math.max(e.v1.y,e.v2.y)-this.minY)/this.bucketHeight))),f=Math.min(l,a),d=Math.max(l,a),o={minX:0,maxX:0,minY:0,maxY:0};for(let u=f;u<=d;++u)for(let s=g;s<=h;++s)if(this.bucketRange(u,s,o),this.lineBoxIntersects(e,o))for(let r of this.buckets[u*this.numRows+s].triangles)i.has(r)||(i.add(r),t(r))}}class ya{constructor(e){let t=[];for(let i of e){let c=i.v2.sub(i.v1),m=i.v3.sub(i.v1),g=c.cross(m).normalize();!Number.isFinite(g.x)||t.push({...i,n:g})}t.sort((i,c)=>i.v1.z+i.v2.z+i.v3.z-(c.v1.z+c.v2.z+c.v3.z)),this.triangleBuckets=new ga({numRows:10,numCols:10,triangles:t})}apply(e){let t=C.negUnitZ,i=[],c=[...e].reverse(),m=[],g;{let k=new Hn;g=(I,D)=>{this.triangleBuckets.traverseTriangles(I,Y=>{m.length==0?m.push(Y):m[0]=Y,k.setComponents(Y.n.x,Y.n.y,Y.n.z,-Y.n.dot(Y.v1)),D(k,m)})}}let h=new me(t.x,t.y,t.z),l=new me,a=new me,f=new me,d=new me,o=new me,u=new me,s=new Di,r=new Hn,p=new Hn,y=new Hn,_=new Di,w=new Di,S=(k,I)=>{let D=_.distanceToPlane(k);if(D==null){if(D=w.distanceToPlane(k),D==null)return;D=-D}return D/I},b=(k,I,D)=>_.at(k*I,D),x=[];for(;;){let k=c.pop();if(k==null)break;let I=Qn.single(0,1);o.set(k.v1.x,k.v1.y,k.v1.z),u.set(k.v2.x-k.v1.x,k.v2.y-k.v1.y,k.v2.z-k.v1.z);let D=u.length();u.multiplyScalar(1/D),_.set(o,u),u.multiplyScalar(-1),w.set(o,u);let Y=k;g(k,(Q,N)=>{if(I.ranges.length!=0)for(let oe of N){if(!va(Y,oe))continue;let ue=oe.v1,J=oe.v2,_e=oe.v3,Te=oe.n;if(l.set(Te.x,Te.y,Te.z),h.dot(l)>=-.01||(o.set(J.x-ue.x,J.y-ue.y,J.z-ue.z),a.crossVectors(h,o).normalize(),!Number.isFinite(a.x))||(o.set(_e.x-J.x,_e.y-J.y,_e.z-J.z),f.crossVectors(h,o).normalize(),!Number.isFinite(f.x))||(o.set(ue.x-_e.x,ue.y-_e.y,ue.z-_e.z),d.crossVectors(h,o).normalize(),!Number.isFinite(d.x)))continue;o.set(ue.x,ue.y,ue.z),r.setFromNormalAndCoplanarPoint(a,o),o.set(J.x,J.y,J.z),p.setFromNormalAndCoplanarPoint(f,o),o.set(_e.x,_e.y,_e.z),y.setFromNormalAndCoplanarPoint(d,o);let se=S(r,D),ee=S(p,D),F=S(y,D);x.splice(0,x.length),se!=null&&x.push(Math.min(1,Math.max(0,se))),ee!=null&&x.push(Math.min(1,Math.max(0,ee))),F!=null&&x.push(Math.min(1,Math.max(0,F))),x.sort((L,$)=>L-$);for(let L=x.length-1;L>=0;--L)x[L]==x[L-1]&&x.splice(L,1);if(x.length!=0){x[0]!=0&&x.unshift(0),x[x.length-1]!=1&&x.push(1);for(let L=0;L<x.length-1;++L){let $=x[L],W=x[L+1],te=_.at(.5*($+W)*D,o);u.copy(h).multiplyScalar(-1);let Pe=s.set(te,u).distanceToPlane(Q);if(Pe==null||Pe<=.001)continue;let z=ji(r,te),q=ji(p,te),ge=ji(y,te);z!="Outside"&&q!="Outside"&&ge!="Outside"&&(I=I.subtract(Qn.single($,W)))}if(I.ranges.length==0)return}}});for(let Q of I.ranges){b(Q.from,D,o);let N=C.create(o.x,o.y,o.z);b(Q.to,D,o);let oe=C.create(o.x,o.y,o.z);i.push({v1:N,v2:oe})}}return i}}let va=(()=>{let n=new me,e=new me,t=(i,c)=>{let m,g,h;e.set(i.v1.x,i.v1.y,0),m=n.dot(e),e.set(i.v2.x,i.v2.y,0),g=n.dot(e);let l=Math.min(m,g),a=Math.max(m,g);e.set(c.v1.x,c.v1.y,0),m=n.dot(e),e.set(c.v2.x,c.v2.y,0),g=n.dot(e),e.set(c.v3.x,c.v3.y,0),h=n.dot(e);let f=Math.min(Math.min(m,g),h),d=Math.max(Math.max(m,g),h);return a<=f||l>=d};return(i,c)=>(n.set(i.v2.x-i.v1.x,i.v2.y-i.v1.y,0),!(t(i,c)||(n.set(-(c.v2.y-c.v1.y),c.v2.x-c.v1.x,0),t(i,c))||(n.set(-(c.v3.y-c.v2.y),c.v3.x-c.v2.x,0),t(i,c))||(n.set(-(c.v1.y-c.v3.y),c.v1.x-c.v3.x,0),t(i,c))))})();function ba(n,e){let t=[];e.traverse(a=>{if(a instanceof Ze){let f=a,d=f.geometry,o=ma(d);t.push({mesh:f,halfEdgeModel:o})}});const i=new me,c=new Vt,m=new me;let g=new ya(t.flatMap(({mesh:a,halfEdgeModel:f})=>f.faces.flatMap(d=>{let o=d.edge.origin.pos;if(d.edge.next==null)return[];let u=d.edge.next.origin.pos;if(d.edge.next.next==null)return[];let s=d.edge.next.next.origin.pos;i.set(o.x,o.y,o.z),i.applyMatrix4(a.matrixWorld),i.applyMatrix4(n.matrixWorldInverse);let r=C.create(i.x,i.y,i.z);i.set(u.x,u.y,u.z),i.applyMatrix4(a.matrixWorld),i.applyMatrix4(n.matrixWorldInverse);let p=C.create(i.x,i.y,i.z);i.set(s.x,s.y,s.z),i.applyMatrix4(a.matrixWorld),i.applyMatrix4(n.matrixWorldInverse);let y=C.create(i.x,i.y,i.z);return[{v1:r,v2:p,v3:y}]}))),h=new me(0,0,-1);h.applyQuaternion(n.quaternion),C.create(h.x,h.y,h.z);let l=[];for(let{mesh:a,halfEdgeModel:f}of t){let d={},o=new me;for(let u of f.edges){{let x=u.origin.id;if(u.next==null)continue;let k=u.next.origin.id,I=Math.min(x,k)+"_"+Math.max(x,k);if(d[I]??!1)continue;d[I]=!0}o.set(u.origin.pos.x,u.origin.pos.y,u.origin.pos.z),o.applyMatrix4(a.matrixWorld),o.applyMatrix4(n.matrixWorldInverse);let s=C.create(o.x,o.y,o.z);o.set(u.next.origin.pos.x,u.next.origin.pos.y,u.next.origin.pos.z),o.applyMatrix4(a.matrixWorld),o.applyMatrix4(n.matrixWorldInverse);let r=C.create(o.x,o.y,o.z),p=u.incidentFace,y=u.twin.incidentFace;if(p==null||y==null)continue;let _=Do(p),w=Do(y);if(!Number.isFinite(_.x)||!Number.isFinite(w.x))continue;let S=new me(_.x,_.y,_.z),b=new me(w.x,w.y,w.z);a.matrixWorld.decompose(i,c,m),S.applyQuaternion(c),b.applyQuaternion(c),!(_.cross(w).lengthSquared()<=.001*.001)&&(Math.abs(_.dot(w))>Math.cos(20*Math.PI/180)&&h.dot(S)<=-.001&&h.dot(b)<=-.001||h.dot(S)>=.001&&h.dot(b)>=.001||l.push({v1:s,v2:r}))}}return g.apply(l)}class vn{constructor(e){let[t,i]=Ne({selectedObjectIds:[],selectedSnapPoints:[]}),c=v(()=>{let g=e.mouseRay();if(g==null)return;let h,l;for(let a of e.objects()){let f=a.rayCollisionTime(g);f!=null&&(h==null||f<h)&&(h=f,l=a)}return l}),m=g=>{let h=c();if(g)if(h==null)i("selectedObjectIds",[]);else{let l=h,a=t.selectedObjectIds.findIndex(f=>l.id()==f);a!=-1?i("selectedObjectIds",[...t.selectedObjectIds.slice(0,a),...t.selectedObjectIds.slice(a)]):i("selectedObjectIds",[...t.selectedObjectIds,l.id()])}else h==null?i("selectedObjectIds",[]):i("selectedObjectIds",[h.id()])};this.hoveredObjectById=v(()=>(c()?.id??(()=>{}))()),this.selectedObjectsById=()=>t.selectedObjectIds,this.click=m}}const xa=Z('<input type="text">');class _a{constructor(e){let t=f=>{let d=v(()=>e.objects().map(({transform:u,localSnapPoints:s})=>v(()=>s().map(r=>u().pointFromThisSpace(r)))).flatMap(u=>u())),o=new vn({mouseRay:e.mouseRay,objects:v(()=>d().map((u,s)=>({id:()=>s,rayCollisionTime:r=>{let p=ve(()=>e.mousePos());if(p==null)return;let y=e.projectPtToScreen(u);if(y==null||p.distanceSquared(y)>=5*5)return;let _=r.closestTimeToPoint(u);if(!(_<=0))return _}})))});return{type:"SelectMoveFromPt",movingObjectsById:f,fromPts:d,selector:o}},[i,c]=Ne({mode:()=>e.initSelectedObjectIds==null?{type:"SelectingObjects",selector:new vn({mouseRay:e.mouseRay,objects:e.objects})}:t(e.initSelectedObjectIds)}),m=v(()=>i.mode());re(()=>{let f=m();if(f.type=="SelectMoveFromPt"&&f.selector.selectedObjectsById().length!=0){let d=f.fromPts()[f.selector.selectedObjectsById()[0]],o=f.movingObjectsById;c("mode",u=>()=>{let s=v(()=>e.objects().filter(({id:y})=>!o.some(_=>y()==_))),r=v(()=>{let y=[];for(let _ of s()){let w=_.transform();for(let S of _.localSnapPoints()){let b=w.pointFromThisSpace(S);y.push(b)}}return y}),p=new vn({mouseRay:e.mouseRay,objects:v(()=>r().map((y,_)=>({id:()=>_,rayCollisionTime:w=>{let S=ve(()=>e.mousePos());if(S==null)return;let b=e.projectPtToScreen(y);if(b==null||S.distanceSquared(b)>=5*5)return;let x=w.closestTimeToPoint(y);if(!(x<=0))return x}})))});return{type:"Moving",movingObjectsById:o,fromPt:d,toPts:r,selector:p}})}});let[g,h]=st(void 0),l=v(()=>{let f=m();if(f.type!="Moving")return[];let d=f.movingObjectsById;return e.objects().flatMap(o=>{let u=o.id();if(!d.some(r=>r==u))return[];let s=ve(()=>o.transform());return[{object:o,initTransform:s}]})});re(()=>{let f=m();if(f.type=="Moving"){let d=f.fromPt,o=Xe.create(d,C.unitX),u=Xe.create(d,C.unitY),s=Xe.create(d,C.unitZ),r=[o,u,s],p=l(),y=f;re(()=>{{let x=y.selector.hoveredObjectById();if(x!=null){let k=y.toPts()[x];for(let{object:I,initTransform:D}of p)I.setTransform(he.create(D.origin.add(k.sub(y.fromPt)),D.orientation));h(k);return}}if(e.mousePos()==null){h(void 0);return}let w=e.mouseRay();if(w==null){h(void 0);return}let S,b;for(let x of r){let k=w.closestTimeOnThisRayWithOtherRay(x);if(k==null||k<=0)continue;let I=w.positionFromTime(k),D=x.closestPoint(I),Y=I.distanceSquared(D);(S==null||Y<S)&&(S=Y,b=D)}if(b!=null){for(let{object:x,initTransform:k}of p)x.setTransform(he.create(k.origin.add(b.sub(y.fromPt)),k.orientation));h(b)}else h(void 0)})}}),this.instructions=v(()=>{let f=m();return f.type=="SelectingObjects"?"Select objects to move. Then press enter when finished.":f.type=="SelectMoveFromPt"?"Select point to pick up object from. "+f.selector.hoveredObjectById():"Move to another point to snap to OR move along axis direction and type distance."});let a=v(()=>e.mousePos()!=null);this.overlayUI=v(()=>{let f=m();if(f.type!="Moving")return;let d=f;if(!a())return;let o=document.createElement("div");o.style.position="absolute",re(()=>{let s=e.mousePos();s!=null&&(o.style.left=s.x+20+"px",o.style.top=s.y+20+"px")});let u=ao(()=>{let s;Rt(()=>{s?.focus()});let r=v(()=>{let p=g();if(p!=null)return d.fromPt.distance(p)});return re(()=>{if(s==null)return;let p=r();s.value=p==null?"":p.toString(),s.select()}),["Dist:",(()=>{const p=xa.cloneNode(!0);p.addEventListener("change",_=>{let w=Number.parseFloat(_.currentTarget.value);if(!Number.isFinite(w))return;let S=g();if(S==null)return;let b=d.fromPt,x=S.sub(b).normalize();if(!Number.isFinite(x.x))return;let k=x.scale(w),I=l();for(let{object:D,initTransform:Y}of I)D.setTransform(he.create(Y.origin.add(k),Y.orientation));e.onDone()});const y=s;return typeof y=="function"?At(y,p):s=p,p})()]},o);return Ce(()=>{u()}),o}),this.highlightedObjectsById=v(()=>{let f=m();switch(f.type){case"SelectingObjects":let d=f.selector.hoveredObjectById();return d==null?[]:[d];default:return[]}}),this.selectedObjectsById=v(()=>{let f=m();switch(f.type){case"SelectingObjects":return f.selector.selectedObjectsById();case"SelectMoveFromPt":return f.movingObjectsById;case"Moving":return f.movingObjectsById}}),this.snapPoints=v(()=>{let f=m();switch(f.type){case"SelectMoveFromPt":{let d=f;return f.fromPts().map((o,u)=>({pt:()=>o,highlighted:v(()=>d.selector.hoveredObjectById()==u)}))}case"Moving":{let d=f;return d.toPts().map((o,u)=>({pt:()=>o,highlighted:v(()=>d.selector.hoveredObjectById()==u)}))}default:return[]}}),this.arrows=v(()=>{let f=m();switch(f.type){case"Moving":{let d=f,o=g();if(o==null)return[];let u=o;return[{from:()=>d.fromPt,to:()=>u}]}default:return[]}}),this.click=f=>{let d=m();switch(d.type){case"SelectingObjects":{d.selector.click(f);break}case"SelectMoveFromPt":{d.selector.click(f);break}case"Moving":{e.onDone();break}}},this.keyDown=f=>{let d=m();switch(d.type){case"SelectingObjects":{if(f=="Enter"&&d.selector.selectedObjectsById().length!=0){let o=d.selector.selectedObjectsById();c("mode",u=>()=>t(o))}break}}},this.cancel=()=>{let f=l();for(let{object:d,initTransform:o}of f)d.setTransform(o)}}}const wa=Z('<div>Angle: <input type="text"></div>'),Ro=10,Sa=Ro*Ro;class Pa{constructor(e){let t=o=>{let u=ve(()=>e.objects().flatMap(({transform:p,localEdges:y})=>{let _=p();return y().map(w=>et.create(_.pointFromThisSpace(w.v1),_.pointFromThisSpace(w.v2)))})).map((p,y)=>({id:y,edge:p})),s=u.map(({id:p,edge:y})=>{let _=Xe.create(y.v1,y.v2.sub(y.v1));return{id:()=>p,rayCollisionTime:w=>{let S=e.mousePos();if(S==null)return;let b=_.closestTimeOnThisRayWithOtherRay(w);if(b==null||b<0||b>1)return;let x=_.positionFromTime(b),k=e.projectPtToScreen(x);if(k==null||S.distanceSquared(k)>=10*10)return;let I=w.closestTimeToPoint(x);if(!(I<0))return I}}}),r=new vn({mouseRay:e.mouseRay,objects:()=>s});return{type:"Selecting Edge",selectedObjects:o,edges:u,selector:r}},i=(o,u)=>{let s=ve(()=>e.objects().flatMap(({transform:r,localSnapPoints:p})=>{let y=r();return p().map(_=>y.pointFromThisSpace(_))}));return{type:"Selecting Rotate From",selectedObjects:o,rotationEdge:u,rotatingFromPoints:s}},c=(o,u)=>({type:"Rotating",selectedObjects:o,rotationPlane:u}),[m,g]=Ne({mkMode:()=>e.initSelectedObjectIds==null?{type:"Selecting Objects",selector:new vn({mouseRay:e.mouseRay,objects:e.objects})}:t(e.initSelectedObjectIds.map(o=>({id:o,originalTransform:e.objects().find(({id:u})=>u()==o)?.transform.call(void 0)??he.identity}))),isKeyedInAngle:!1}),h=v(()=>m.mkMode()),l=v(()=>{let o=h();if(o.type!="Rotating")return;let u=e.mouseRay();if(u==null)return;let s;if(m.isKeyedInAngle&&m.angle!=null)s=m.angle;else{let r=Re.fromKnownPtAndNormal(o.rotationPlane.o,o.rotationPlane.w),p=u.collisionWithPlane(r);if(p==null)return;let y=o.rotationPlane.pointToThisSpace(p);s=Math.atan2(y.y,y.x)*180/Math.PI}return s}),a=v(()=>{let o=h();if(o.type!="Rotating")return[];if(e.mouseRay()==null)return[];let s=l();if(s==null)return[];let r=o,p=we.fromAxisAngle(C.unitZ,s),y=he.create(C.zero,p);return o.selectedObjects.flatMap(({id:_,originalTransform:w})=>{let S=e.objects().find(({id:b})=>b()==_);return S==null?[]:[{id:_,initTransform:w,finalTransform:r.rotationPlane.fromThisSpace(y.fromThisSpace(r.rotationPlane.toThisSpace(w))),setTransform:S.setTransform}]})});re(()=>{if(h().type!="Rotating"||e.mouseRay()==null)return;let s=l();if(s!=null){for(let r of a())r.setTransform(r.finalTransform);m.isKeyedInAngle||g("angle",s)}}),re(()=>{e.mousePos(),g("isKeyedInAngle",!1)});let f=o=>{g("mkMode",u=>o)},d=v(()=>{let o=h();if(o.type!="Selecting Rotate From")return;let u=e.mousePos();if(u==null)return;let s=e.mouseRay();if(s==null)return;let r,p;for(let y of o.rotatingFromPoints){let _=s.closestTimeToPoint(y);if(_==null||_<0)continue;let w=e.projectPtToScreen(y);if(w==null||u.distanceSquared(w)>Sa)continue;let S=_;(r==null||S<r)&&(r=S,p=y)}return p});this.instructions=v(()=>{switch(h().type){case"Selecting Objects":return"Selected objects to rotate. Then press enter.";case"Selecting Edge":return"Select an edge to rotate about.";case"Selecting Rotate From":return"Select a point to rotate from.";case"Rotating":return"Move mouse and/or key in rotation angle."}}),this.overlayObject3d=v(()=>{let o=h();if(o.type!="Selecting Edge")return;let u=o.selector.hoveredObjectById();if(u==null)return;let s=o.edges.find(({id:I})=>I==u);if(s==null)return;let r=s.edge.length(),p=.001,y=new Pt(r*p,50*p,50*p),_=new wt({color:"green",transparent:!0,opacity:.5}),w=s.edge.v1.add(s.edge.v2).scale(.5),S=s.edge.v2.sub(s.edge.v1).normalize(),b;Math.abs(S.y)<Math.abs(S.z)?b=S.cross(C.unitY).normalize():b=S.cross(C.unitZ).normalize();let x=we.fromUV(S,b);Ce(()=>{y.dispose(),_.dispose()});let k=new Ze(y,_);return k.position.set(w.x*p,w.y*p,w.z*p),k.setRotationFromQuaternion(new Vt(x.x,x.y,x.z,x.w)),k}),this.overlayUI=o=>{if(h().type!="Rotating")return;let s=v(()=>e.mousePos()?.add(ae.create(20,20)));return U(je,{get when(){return s()},children:r=>{let p;return re(()=>{p!=null&&m.angle!=null&&(m.isKeyedInAngle||(p.value=m.angle.toFixed(1),p.select(),p.focus()))}),(()=>{const y=wa.cloneNode(!0),_=y.firstChild,w=_.nextSibling;y.style.setProperty("position","absolute"),w.$$input=b=>{let x=Number.parseFloat(b.currentTarget.value);!Number.isFinite(x)||$e(()=>{g("angle",x),g("isKeyedInAngle",!0)})};const S=p;return typeof S=="function"?At(S,w):p=w,ce(b=>{const x=r().x+"px",k=r().y+"px";return x!==b._v$&&y.style.setProperty("left",b._v$=x),k!==b._v$2&&y.style.setProperty("top",b._v$2=k),b},{_v$:void 0,_v$2:void 0}),y})()}})},this.highlightedObjectsById=v(()=>{let o=h();switch(o.type){case"Selecting Objects":{let u=o.selector.hoveredObjectById();return nt(u)}default:return[]}}),this.selectedObjectsById=v(()=>{let o=h();switch(o.type){case"Selecting Objects":return o.selector.selectedObjectsById();default:return[]}}),this.snapPoints=v(()=>{let o=h();return o.type!="Selecting Rotate From"?[]:o.rotatingFromPoints.map(u=>({pt:()=>u,highlighted:v(()=>u==d())}))}),this.click=o=>{let u=h();switch(u.type){case"Selecting Objects":u.selector.click(o);break;case"Selecting Edge":{let s=u.selector.hoveredObjectById();if(s==null)return;let r=u.edges.find(({id:_})=>_==s);if(r==null)return;let p=r,y=u;f(()=>i(y.selectedObjects,p.edge));break}case"Selecting Rotate From":{let s=d();if(s==null)return;let p=Xe.create(u.rotationEdge.v1,u.rotationEdge.v2.sub(u.rotationEdge.v1)).closestPoint(s),y=s.sub(p).normalize(),_=u.rotationEdge.v2.sub(u.rotationEdge.v1).normalize(),w=y.cross(_),S=he.create(p,we.fromUV(y,w)),b=u;f(()=>c(b.selectedObjects,S));break}case"Rotating":{e.onDone();break}}},this.keyDown=o=>{let u=h();switch(u.type){case"Selecting Objects":if(o=="Enter"){let s=u.selector.selectedObjectsById().map(r=>({id:r,originalTransform:e.objects().find(({id:p})=>p()==r)?.transform.call(void 0)??he.identity}));s.length!=0&&f(()=>t(s))}break;case"Rotating":{o=="Enter"&&e.onDone();break}}},this.cancel=()=>{let o=h();if(o.type=="Rotating")for(let u of o.selectedObjects){let s=e.objects().find(({id:r})=>r()===u.id);s?.setTransform(u.originalTransform)}}}}Ut(["input"]);function ka(n){if(!!n&&!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=n,document.head.appendChild(e),n}}function Dn(n,e){var t=n.__state.conversionName.toString(),i=Math.round(n.r),c=Math.round(n.g),m=Math.round(n.b),g=n.a,h=Math.round(n.h),l=n.s.toFixed(1),a=n.v.toFixed(1);if(e||t==="THREE_CHAR_HEX"||t==="SIX_CHAR_HEX"){for(var f=n.hex.toString(16);f.length<6;)f="0"+f;return"#"+f}else{if(t==="CSS_RGB")return"rgb("+i+","+c+","+m+")";if(t==="CSS_RGBA")return"rgba("+i+","+c+","+m+","+g+")";if(t==="HEX")return"0x"+n.hex.toString(16);if(t==="RGB_ARRAY")return"["+i+","+c+","+m+"]";if(t==="RGBA_ARRAY")return"["+i+","+c+","+m+","+g+"]";if(t==="RGB_OBJ")return"{r:"+i+",g:"+c+",b:"+m+"}";if(t==="RGBA_OBJ")return"{r:"+i+",g:"+c+",b:"+m+",a:"+g+"}";if(t==="HSV_OBJ")return"{h:"+h+",s:"+l+",v:"+a+"}";if(t==="HSVA_OBJ")return"{h:"+h+",s:"+l+",v:"+a+",a:"+g+"}"}return"unknown format"}var No=Array.prototype.forEach,Kn=Array.prototype.slice,G={BREAK:{},extend:function(e){return this.each(Kn.call(arguments,1),function(t){var i=this.isObject(t)?Object.keys(t):[];i.forEach(function(c){this.isUndefined(t[c])||(e[c]=t[c])}.bind(this))},this),e},defaults:function(e){return this.each(Kn.call(arguments,1),function(t){var i=this.isObject(t)?Object.keys(t):[];i.forEach(function(c){this.isUndefined(e[c])&&(e[c]=t[c])}.bind(this))},this),e},compose:function(){var e=Kn.call(arguments);return function(){for(var t=Kn.call(arguments),i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},each:function(e,t,i){if(!!e){if(No&&e.forEach&&e.forEach===No)e.forEach(t,i);else if(e.length===e.length+0){var c=void 0,m=void 0;for(c=0,m=e.length;c<m;c++)if(c in e&&t.call(i,e[c],c)===this.BREAK)return}else for(var g in e)if(t.call(i,e[g],g)===this.BREAK)return}},defer:function(e){setTimeout(e,0)},debounce:function(e,t,i){var c=void 0;return function(){var m=this,g=arguments;function h(){c=null,i||e.apply(m,g)}var l=i||!c;clearTimeout(c),c=setTimeout(h,t),l&&e.apply(m,g)}},toArray:function(e){return e.toArray?e.toArray():Kn.call(e)},isUndefined:function(e){return e===void 0},isNull:function(e){return e===null},isNaN:function(n){function e(t){return n.apply(this,arguments)}return e.toString=function(){return n.toString()},e}(function(n){return isNaN(n)}),isArray:Array.isArray||function(n){return n.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return e===!1||e===!0},isFunction:function(e){return e instanceof Function}},Ia=[{litmus:G.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:Dn},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:Dn},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:Dn},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:Dn}}},{litmus:G.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:G.isArray,conversions:{RGB_ARRAY:{read:function(e){return e.length!==3?!1:{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return e.length!==4?!1:{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:G.isObject,conversions:{RGBA_OBJ:{read:function(e){return G.isNumber(e.r)&&G.isNumber(e.g)&&G.isNumber(e.b)&&G.isNumber(e.a)?{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return G.isNumber(e.r)&&G.isNumber(e.g)&&G.isNumber(e.b)?{space:"RGB",r:e.r,g:e.g,b:e.b}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return G.isNumber(e.h)&&G.isNumber(e.s)&&G.isNumber(e.v)&&G.isNumber(e.a)?{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return G.isNumber(e.h)&&G.isNumber(e.s)&&G.isNumber(e.v)?{space:"HSV",h:e.h,s:e.s,v:e.v}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],Xn=void 0,fi=void 0,to=function(){fi=!1;var e=arguments.length>1?G.toArray(arguments):arguments[0];return G.each(Ia,function(t){if(t.litmus(e))return G.each(t.conversions,function(i,c){if(Xn=i.read(e),fi===!1&&Xn!==!1)return fi=Xn,Xn.conversionName=c,Xn.conversion=i,G.BREAK}),G.BREAK}),fi},Bo=void 0,wi={hsv_to_rgb:function(e,t,i){var c=Math.floor(e/60)%6,m=e/60-Math.floor(e/60),g=i*(1-t),h=i*(1-m*t),l=i*(1-(1-m)*t),a=[[i,l,g],[h,i,g],[g,i,l],[g,h,i],[l,g,i],[i,g,h]][c];return{r:a[0]*255,g:a[1]*255,b:a[2]*255}},rgb_to_hsv:function(e,t,i){var c=Math.min(e,t,i),m=Math.max(e,t,i),g=m-c,h=void 0,l=void 0;if(m!==0)l=g/m;else return{h:NaN,s:0,v:0};return e===m?h=(t-i)/g:t===m?h=2+(i-e)/g:h=4+(e-t)/g,h/=6,h<0&&(h+=1),{h:h*360,s:l,v:m/255}},rgb_to_hex:function(e,t,i){var c=this.hex_with_component(0,2,e);return c=this.hex_with_component(c,1,t),c=this.hex_with_component(c,0,i),c},component_from_hex:function(e,t){return e>>t*8&255},hex_with_component:function(e,t,i){return i<<(Bo=t*8)|e&~(255<<Bo)}},Ta=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},Yt=function(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")},Kt=function(){function n(e,t){for(var i=0;i<t.length;i++){var c=t[i];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(e,c.key,c)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),fn=function n(e,t,i){e===null&&(e=Function.prototype);var c=Object.getOwnPropertyDescriptor(e,t);if(c===void 0){var m=Object.getPrototypeOf(e);return m===null?void 0:n(m,t,i)}else{if("value"in c)return c.value;var g=c.get;return g===void 0?void 0:g.call(i)}},hn=function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(n,e):n.__proto__=e)},pn=function(n,e){if(!n)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:n},yt=function(){function n(){if(Yt(this,n),this.__state=to.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return Kt(n,[{key:"toString",value:function(){return Dn(this)}},{key:"toHexString",value:function(){return Dn(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),n}();function ho(n,e,t){Object.defineProperty(n,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(yt.recalculateRGB(this,e,t),this.__state[e])},set:function(c){this.__state.space!=="RGB"&&(yt.recalculateRGB(this,e,t),this.__state.space="RGB"),this.__state[e]=c}})}function po(n,e){Object.defineProperty(n,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(yt.recalculateHSV(this),this.__state[e])},set:function(i){this.__state.space!=="HSV"&&(yt.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=i}})}yt.recalculateRGB=function(n,e,t){if(n.__state.space==="HEX")n.__state[e]=wi.component_from_hex(n.__state.hex,t);else if(n.__state.space==="HSV")G.extend(n.__state,wi.hsv_to_rgb(n.__state.h,n.__state.s,n.__state.v));else throw new Error("Corrupted color state")};yt.recalculateHSV=function(n){var e=wi.rgb_to_hsv(n.r,n.g,n.b);G.extend(n.__state,{s:e.s,v:e.v}),G.isNaN(e.h)?G.isUndefined(n.__state.h)&&(n.__state.h=0):n.__state.h=e.h};yt.COMPONENTS=["r","g","b","h","s","v","hex","a"];ho(yt.prototype,"r",2);ho(yt.prototype,"g",1);ho(yt.prototype,"b",0);po(yt.prototype,"h");po(yt.prototype,"s");po(yt.prototype,"v");Object.defineProperty(yt.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}});Object.defineProperty(yt.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=wi.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var _n=function(){function n(e,t){Yt(this,n),this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onChange=void 0,this.__onFinishChange=void 0}return Kt(n,[{key:"onChange",value:function(t){return this.__onChange=t,this}},{key:"onFinishChange",value:function(t){return this.__onFinishChange=t,this}},{key:"setValue",value:function(t){return this.object[this.property]=t,this.__onChange&&this.__onChange.call(this,t),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),n}(),Ma={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},Ol={};G.each(Ma,function(n,e){G.each(n,function(t){Ol[t]=e})});var Aa=/(\d+(\.\d+)?)px/;function Qt(n){if(n==="0"||G.isUndefined(n))return 0;var e=n.match(Aa);return G.isNull(e)?0:parseFloat(e[1])}var R={makeSelectable:function(e,t){e===void 0||e.style===void 0||(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,i){var c=i,m=t;G.isUndefined(m)&&(m=!0),G.isUndefined(c)&&(c=!0),e.style.position="absolute",m&&(e.style.left=0,e.style.right=0),c&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,i,c){var m=i||{},g=Ol[t];if(!g)throw new Error("Event type "+t+" not supported.");var h=document.createEvent(g);switch(g){case"MouseEvents":{var l=m.x||m.clientX||0,a=m.y||m.clientY||0;h.initMouseEvent(t,m.bubbles||!1,m.cancelable||!0,window,m.clickCount||1,0,0,l,a,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var f=h.initKeyboardEvent||h.initKeyEvent;G.defaults(m,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),f(t,m.bubbles||!1,m.cancelable,window,m.ctrlKey,m.altKey,m.shiftKey,m.metaKey,m.keyCode,m.charCode);break}default:{h.initEvent(t,m.bubbles||!1,m.cancelable||!0);break}}G.defaults(h,c),e.dispatchEvent(h)},bind:function(e,t,i,c){var m=c||!1;return e.addEventListener?e.addEventListener(t,i,m):e.attachEvent&&e.attachEvent("on"+t,i),R},unbind:function(e,t,i,c){var m=c||!1;return e.removeEventListener?e.removeEventListener(t,i,m):e.detachEvent&&e.detachEvent("on"+t,i),R},addClass:function(e,t){if(e.className===void 0)e.className=t;else if(e.className!==t){var i=e.className.split(/ +/);i.indexOf(t)===-1&&(i.push(t),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return R},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var i=e.className.split(/ +/),c=i.indexOf(t);c!==-1&&(i.splice(c,1),e.className=i.join(" "))}else e.className=void 0;return R},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return Qt(t["border-left-width"])+Qt(t["border-right-width"])+Qt(t["padding-left"])+Qt(t["padding-right"])+Qt(t.width)},getHeight:function(e){var t=getComputedStyle(e);return Qt(t["border-top-width"])+Qt(t["border-bottom-width"])+Qt(t["padding-top"])+Qt(t["padding-bottom"])+Qt(t.height)},getOffset:function(e){var t=e,i={left:0,top:0};if(t.offsetParent)do i.left+=t.offsetLeft,i.top+=t.offsetTop,t=t.offsetParent;while(t);return i},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},Dl=function(n){hn(e,n);function e(t,i){Yt(this,e);var c=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),m=c;c.__prev=c.getValue(),c.__checkbox=document.createElement("input"),c.__checkbox.setAttribute("type","checkbox");function g(){m.setValue(!m.__prev)}return R.bind(c.__checkbox,"change",g,!1),c.domElement.appendChild(c.__checkbox),c.updateDisplay(),c}return Kt(e,[{key:"setValue",value:function(i){var c=fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,i);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),c}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(_n),$a=function(n){hn(e,n);function e(t,i,c){Yt(this,e);var m=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),g=c,h=m;if(m.__select=document.createElement("select"),G.isArray(g)){var l={};G.each(g,function(a){l[a]=a}),g=l}return G.each(g,function(a,f){var d=document.createElement("option");d.innerHTML=f,d.setAttribute("value",a),h.__select.appendChild(d)}),m.updateDisplay(),R.bind(m.__select,"change",function(){var a=this.options[this.selectedIndex].value;h.setValue(a)}),m.domElement.appendChild(m.__select),m}return Kt(e,[{key:"setValue",value:function(i){var c=fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,i);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),c}},{key:"updateDisplay",value:function(){return R.isActive(this.__select)?this:(this.__select.value=this.getValue(),fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(_n),Ca=function(n){hn(e,n);function e(t,i){Yt(this,e);var c=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),m=c;function g(){m.setValue(m.__input.value)}function h(){m.__onFinishChange&&m.__onFinishChange.call(m,m.getValue())}return c.__input=document.createElement("input"),c.__input.setAttribute("type","text"),R.bind(c.__input,"keyup",g),R.bind(c.__input,"change",g),R.bind(c.__input,"blur",h),R.bind(c.__input,"keydown",function(l){l.keyCode===13&&this.blur()}),c.updateDisplay(),c.domElement.appendChild(c.__input),c}return Kt(e,[{key:"updateDisplay",value:function(){return R.isActive(this.__input)||(this.__input.value=this.getValue()),fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(_n);function Fo(n){var e=n.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var Rl=function(n){hn(e,n);function e(t,i,c){Yt(this,e);var m=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),g=c||{};return m.__min=g.min,m.__max=g.max,m.__step=g.step,G.isUndefined(m.__step)?m.initialValue===0?m.__impliedStep=1:m.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(m.initialValue))/Math.LN10))/10:m.__impliedStep=m.__step,m.__precision=Fo(m.__impliedStep),m}return Kt(e,[{key:"setValue",value:function(i){var c=i;return this.__min!==void 0&&c<this.__min?c=this.__min:this.__max!==void 0&&c>this.__max&&(c=this.__max),this.__step!==void 0&&c%this.__step!==0&&(c=Math.round(c/this.__step)*this.__step),fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,c)}},{key:"min",value:function(i){return this.__min=i,this}},{key:"max",value:function(i){return this.__max=i,this}},{key:"step",value:function(i){return this.__step=i,this.__impliedStep=i,this.__precision=Fo(i),this}}]),e}(_n);function Ea(n,e){var t=Math.pow(10,e);return Math.round(n*t)/t}var Si=function(n){hn(e,n);function e(t,i,c){Yt(this,e);var m=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,c));m.__truncationSuspended=!1;var g=m,h=void 0;function l(){var s=parseFloat(g.__input.value);G.isNaN(s)||g.setValue(s)}function a(){g.__onFinishChange&&g.__onFinishChange.call(g,g.getValue())}function f(){a()}function d(s){var r=h-s.clientY;g.setValue(g.getValue()+r*g.__impliedStep),h=s.clientY}function o(){R.unbind(window,"mousemove",d),R.unbind(window,"mouseup",o),a()}function u(s){R.bind(window,"mousemove",d),R.bind(window,"mouseup",o),h=s.clientY}return m.__input=document.createElement("input"),m.__input.setAttribute("type","text"),R.bind(m.__input,"change",l),R.bind(m.__input,"blur",f),R.bind(m.__input,"mousedown",u),R.bind(m.__input,"keydown",function(s){s.keyCode===13&&(g.__truncationSuspended=!0,this.blur(),g.__truncationSuspended=!1,a())}),m.updateDisplay(),m.domElement.appendChild(m.__input),m}return Kt(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():Ea(this.getValue(),this.__precision),fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Rl);function Lo(n,e,t,i,c){return i+(c-i)*((n-e)/(t-e))}var no=function(n){hn(e,n);function e(t,i,c,m,g){Yt(this,e);var h=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,{min:c,max:m,step:g})),l=h;h.__background=document.createElement("div"),h.__foreground=document.createElement("div"),R.bind(h.__background,"mousedown",a),R.bind(h.__background,"touchstart",o),R.addClass(h.__background,"slider"),R.addClass(h.__foreground,"slider-fg");function a(r){document.activeElement.blur(),R.bind(window,"mousemove",f),R.bind(window,"mouseup",d),f(r)}function f(r){r.preventDefault();var p=l.__background.getBoundingClientRect();return l.setValue(Lo(r.clientX,p.left,p.right,l.__min,l.__max)),!1}function d(){R.unbind(window,"mousemove",f),R.unbind(window,"mouseup",d),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}function o(r){r.touches.length===1&&(R.bind(window,"touchmove",u),R.bind(window,"touchend",s),u(r))}function u(r){var p=r.touches[0].clientX,y=l.__background.getBoundingClientRect();l.setValue(Lo(p,y.left,y.right,l.__min,l.__max))}function s(){R.unbind(window,"touchmove",u),R.unbind(window,"touchend",s),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}return h.updateDisplay(),h.__background.appendChild(h.__foreground),h.domElement.appendChild(h.__background),h}return Kt(e,[{key:"updateDisplay",value:function(){var i=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=i*100+"%",fn(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Rl),Nl=function(n){hn(e,n);function e(t,i,c){Yt(this,e);var m=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i)),g=m;return m.__button=document.createElement("div"),m.__button.innerHTML=c===void 0?"Fire":c,R.bind(m.__button,"click",function(h){return h.preventDefault(),g.fire(),!1}),R.addClass(m.__button,"button"),m.domElement.appendChild(m.__button),m}return Kt(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(_n),io=function(n){hn(e,n);function e(t,i){Yt(this,e);var c=pn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i));c.__color=new yt(c.getValue()),c.__temp=new yt(0);var m=c;c.domElement=document.createElement("div"),R.makeSelectable(c.domElement,!1),c.__selector=document.createElement("div"),c.__selector.className="selector",c.__saturation_field=document.createElement("div"),c.__saturation_field.className="saturation-field",c.__field_knob=document.createElement("div"),c.__field_knob.className="field-knob",c.__field_knob_border="2px solid ",c.__hue_knob=document.createElement("div"),c.__hue_knob.className="hue-knob",c.__hue_field=document.createElement("div"),c.__hue_field.className="hue-field",c.__input=document.createElement("input"),c.__input.type="text",c.__input_textShadow="0 1px 1px ",R.bind(c.__input,"keydown",function(r){r.keyCode===13&&d.call(this)}),R.bind(c.__input,"blur",d),R.bind(c.__selector,"mousedown",function(){R.addClass(this,"drag").bind(window,"mouseup",function(){R.removeClass(m.__selector,"drag")})}),R.bind(c.__selector,"touchstart",function(){R.addClass(this,"drag").bind(window,"touchend",function(){R.removeClass(m.__selector,"drag")})});var g=document.createElement("div");G.extend(c.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),G.extend(c.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:c.__field_knob_border+(c.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),G.extend(c.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),G.extend(c.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),G.extend(g.style,{width:"100%",height:"100%",background:"none"}),zo(g,"top","rgba(0,0,0,0)","#000"),G.extend(c.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),Da(c.__hue_field),G.extend(c.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:c.__input_textShadow+"rgba(0,0,0,0.7)"}),R.bind(c.__saturation_field,"mousedown",h),R.bind(c.__saturation_field,"touchstart",h),R.bind(c.__field_knob,"mousedown",h),R.bind(c.__field_knob,"touchstart",h),R.bind(c.__hue_field,"mousedown",l),R.bind(c.__hue_field,"touchstart",l);function h(r){u(r),R.bind(window,"mousemove",u),R.bind(window,"touchmove",u),R.bind(window,"mouseup",a),R.bind(window,"touchend",a)}function l(r){s(r),R.bind(window,"mousemove",s),R.bind(window,"touchmove",s),R.bind(window,"mouseup",f),R.bind(window,"touchend",f)}function a(){R.unbind(window,"mousemove",u),R.unbind(window,"touchmove",u),R.unbind(window,"mouseup",a),R.unbind(window,"touchend",a),o()}function f(){R.unbind(window,"mousemove",s),R.unbind(window,"touchmove",s),R.unbind(window,"mouseup",f),R.unbind(window,"touchend",f),o()}function d(){var r=to(this.value);r!==!1?(m.__color.__state=r,m.setValue(m.__color.toOriginal())):this.value=m.__color.toString()}function o(){m.__onFinishChange&&m.__onFinishChange.call(m,m.__color.toOriginal())}c.__saturation_field.appendChild(g),c.__selector.appendChild(c.__field_knob),c.__selector.appendChild(c.__saturation_field),c.__selector.appendChild(c.__hue_field),c.__hue_field.appendChild(c.__hue_knob),c.domElement.appendChild(c.__input),c.domElement.appendChild(c.__selector),c.updateDisplay();function u(r){r.type.indexOf("touch")===-1&&r.preventDefault();var p=m.__saturation_field.getBoundingClientRect(),y=r.touches&&r.touches[0]||r,_=y.clientX,w=y.clientY,S=(_-p.left)/(p.right-p.left),b=1-(w-p.top)/(p.bottom-p.top);return b>1?b=1:b<0&&(b=0),S>1?S=1:S<0&&(S=0),m.__color.v=b,m.__color.s=S,m.setValue(m.__color.toOriginal()),!1}function s(r){r.type.indexOf("touch")===-1&&r.preventDefault();var p=m.__hue_field.getBoundingClientRect(),y=r.touches&&r.touches[0]||r,_=y.clientY,w=1-(_-p.top)/(p.bottom-p.top);return w>1?w=1:w<0&&(w=0),m.__color.h=w*360,m.setValue(m.__color.toOriginal()),!1}return c}return Kt(e,[{key:"updateDisplay",value:function(){var i=to(this.getValue());if(i!==!1){var c=!1;G.each(yt.COMPONENTS,function(h){if(!G.isUndefined(i[h])&&!G.isUndefined(this.__color.__state[h])&&i[h]!==this.__color.__state[h])return c=!0,{}},this),c&&G.extend(this.__color.__state,i)}G.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var m=this.__color.v<.5||this.__color.s>.5?255:0,g=255-m;G.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+m+","+m+","+m+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,zo(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),G.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+m+","+m+","+m+")",textShadow:this.__input_textShadow+"rgba("+g+","+g+","+g+",.7)"})}}]),e}(_n),Oa=["-moz-","-o-","-webkit-","-ms-",""];function zo(n,e,t,i){n.style.background="",G.each(Oa,function(c){n.style.cssText+="background: "+c+"linear-gradient("+e+", "+t+" 0%, "+i+" 100%); "})}function Da(n){n.style.background="",n.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",n.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",n.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",n.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",n.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var Ra={load:function(e,t){var i=t||document,c=i.createElement("link");c.type="text/css",c.rel="stylesheet",c.href=e,i.getElementsByTagName("head")[0].appendChild(c)},inject:function(e,t){var i=t||document,c=document.createElement("style");c.type="text/css",c.innerHTML=e;var m=i.getElementsByTagName("head")[0];try{m.appendChild(c)}catch{}}},Na=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,Ba=function(e,t){var i=e[t];return G.isArray(arguments[2])||G.isObject(arguments[2])?new $a(e,t,arguments[2]):G.isNumber(i)?G.isNumber(arguments[2])&&G.isNumber(arguments[3])?G.isNumber(arguments[4])?new no(e,t,arguments[2],arguments[3],arguments[4]):new no(e,t,arguments[2],arguments[3]):G.isNumber(arguments[4])?new Si(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new Si(e,t,{min:arguments[2],max:arguments[3]}):G.isString(i)?new Ca(e,t):G.isFunction(i)?new Nl(e,t,""):G.isBoolean(i)?new Dl(e,t):null};function Fa(n){setTimeout(n,1e3/60)}var La=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Fa,za=function(){function n(){Yt(this,n),this.backgroundElement=document.createElement("div"),G.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),R.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),G.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;R.bind(this.backgroundElement,"click",function(){e.hide()})}return Kt(n,[{key:"show",value:function(){var t=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),G.defer(function(){t.backgroundElement.style.opacity=1,t.domElement.style.opacity=1,t.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var t=this,i=function c(){t.domElement.style.display="none",t.backgroundElement.style.display="none",R.unbind(t.domElement,"webkitTransitionEnd",c),R.unbind(t.domElement,"transitionend",c),R.unbind(t.domElement,"oTransitionEnd",c)};R.bind(this.domElement,"webkitTransitionEnd",i),R.bind(this.domElement,"transitionend",i),R.bind(this.domElement,"oTransitionEnd",i),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-R.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-R.getHeight(this.domElement)/2+"px"}}]),n}(),ja=ka(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);Ra.inject(ja);var jo="dg",Vo=72,Uo=20,ii="Default",Wn=function(){try{return!!window.localStorage}catch{return!1}}(),qn=void 0,Yo=!0,$n=void 0,Vi=!1,Bl=[],He=function n(e){var t=this,i=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),R.addClass(this.domElement,jo),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],i=G.defaults(i,{closeOnTop:!1,autoPlace:!0,width:n.DEFAULT_WIDTH}),i=G.defaults(i,{resizable:i.autoPlace,hideable:i.autoPlace}),G.isUndefined(i.load)?i.load={preset:ii}:i.preset&&(i.load.preset=i.preset),G.isUndefined(i.parent)&&i.hideable&&Bl.push(this),i.resizable=G.isUndefined(i.parent)&&i.resizable,i.autoPlace&&G.isUndefined(i.scrollable)&&(i.scrollable=!0);var c=Wn&&localStorage.getItem(Cn(this,"isLocal"))==="true",m=void 0,g=void 0;if(Object.defineProperties(this,{parent:{get:function(){return i.parent}},scrollable:{get:function(){return i.scrollable}},autoPlace:{get:function(){return i.autoPlace}},closeOnTop:{get:function(){return i.closeOnTop}},preset:{get:function(){return t.parent?t.getRoot().preset:i.load.preset},set:function(o){t.parent?t.getRoot().preset=o:i.load.preset=o,Ka(this),t.revert()}},width:{get:function(){return i.width},set:function(o){i.width=o,ro(t,o)}},name:{get:function(){return i.name},set:function(o){i.name=o,g&&(g.innerHTML=i.name)}},closed:{get:function(){return i.closed},set:function(o){i.closed=o,i.closed?R.addClass(t.__ul,n.CLASS_CLOSED):R.removeClass(t.__ul,n.CLASS_CLOSED),this.onResize(),t.__closeButton&&(t.__closeButton.innerHTML=o?n.TEXT_OPEN:n.TEXT_CLOSED)}},load:{get:function(){return i.load}},useLocalStorage:{get:function(){return c},set:function(o){Wn&&(c=o,o?R.bind(window,"unload",m):R.unbind(window,"unload",m),localStorage.setItem(Cn(t,"isLocal"),o))}}}),G.isUndefined(i.parent)){if(this.closed=i.closed||!1,R.addClass(this.domElement,n.CLASS_MAIN),R.makeSelectable(this.domElement,!1),Wn&&c){t.useLocalStorage=!0;var h=localStorage.getItem(Cn(this,"gui"));h&&(i.load=JSON.parse(h))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=n.TEXT_CLOSED,R.addClass(this.__closeButton,n.CLASS_CLOSE_BUTTON),i.closeOnTop?(R.addClass(this.__closeButton,n.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(R.addClass(this.__closeButton,n.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),R.bind(this.__closeButton,"click",function(){t.closed=!t.closed})}else{i.closed===void 0&&(i.closed=!0);var l=document.createTextNode(i.name);R.addClass(l,"controller-name"),g=mo(t,l);var a=function(o){return o.preventDefault(),t.closed=!t.closed,!1};R.addClass(this.__ul,n.CLASS_CLOSED),R.addClass(g,"title"),R.bind(g,"click",a),i.closed||(this.closed=!1)}i.autoPlace&&(G.isUndefined(i.parent)&&(Yo&&($n=document.createElement("div"),R.addClass($n,jo),R.addClass($n,n.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild($n),Yo=!1),$n.appendChild(this.domElement),R.addClass(this.domElement,n.CLASS_AUTO_PLACE)),this.parent||ro(t,i.width)),this.__resizeHandler=function(){t.onResizeDebounced()},R.bind(window,"resize",this.__resizeHandler),R.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),R.bind(this.__ul,"transitionend",this.__resizeHandler),R.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),i.resizable&&Ya(this),m=function(){Wn&&localStorage.getItem(Cn(t,"isLocal"))==="true"&&localStorage.setItem(Cn(t,"gui"),JSON.stringify(t.getSaveObject()))},this.saveToLocalStorageIfPossible=m;function f(){var d=t.getRoot();d.width+=1,G.defer(function(){d.width-=1})}i.parent||f()};He.toggleHide=function(){Vi=!Vi,G.each(Bl,function(n){n.domElement.style.display=Vi?"none":""})};He.CLASS_AUTO_PLACE="a";He.CLASS_AUTO_PLACE_CONTAINER="ac";He.CLASS_MAIN="main";He.CLASS_CONTROLLER_ROW="cr";He.CLASS_TOO_TALL="taller-than-window";He.CLASS_CLOSED="closed";He.CLASS_CLOSE_BUTTON="close-button";He.CLASS_CLOSE_TOP="close-top";He.CLASS_CLOSE_BOTTOM="close-bottom";He.CLASS_DRAG="drag";He.DEFAULT_WIDTH=245;He.TEXT_CLOSED="Close Controls";He.TEXT_OPEN="Open Controls";He._keydownHandler=function(n){document.activeElement.type!=="text"&&(n.which===Vo||n.keyCode===Vo)&&He.toggleHide()};R.bind(window,"keydown",He._keydownHandler,!1);G.extend(He.prototype,{add:function(e,t){return Zn(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return Zn(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;G.defer(function(){t.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&$n.removeChild(this.domElement);var e=this;G.each(this.__folders,function(t){e.removeFolder(t)}),R.unbind(window,"keydown",He._keydownHandler,!1),Ko(this)},addFolder:function(e){if(this.__folders[e]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var i=new He(t);this.__folders[e]=i;var c=mo(this,i.domElement);return R.addClass(c,"folder"),i},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],Ko(e);var t=this;G.each(e.__folders,function(i){e.removeFolder(i)}),G.defer(function(){t.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=R.getOffset(e.__ul).top,i=0;G.each(e.__ul.childNodes,function(c){e.autoPlace&&c===e.__save_row||(i+=R.getHeight(c))}),window.innerHeight-t-Uo<i?(R.addClass(e.domElement,He.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-Uo+"px"):(R.removeClass(e.domElement,He.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&G.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:G.debounce(function(){this.onResize()},50),remember:function(){if(G.isUndefined(qn)&&(qn=new za,qn.domElement.innerHTML=Na),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;G.each(Array.prototype.slice.call(arguments),function(t){e.__rememberedObjects.length===0&&Ua(e),e.__rememberedObjects.indexOf(t)===-1&&e.__rememberedObjects.push(t)}),this.autoPlace&&ro(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=hi(this)),e.folders={},G.each(this.__folders,function(t,i){e.folders[i]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=hi(this),oo(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[ii]=hi(this,!0)),this.load.remembered[e]=hi(this),this.preset=e,lo(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){G.each(this.__controllers,function(t){this.getRoot().load.remembered?Fl(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())},this),G.each(this.__folders,function(t){t.revert(t)}),e||oo(this.getRoot(),!1)},listen:function(e){var t=this.__listening.length===0;this.__listening.push(e),t&&Ll(this.__listening)},updateDisplay:function(){G.each(this.__controllers,function(e){e.updateDisplay()}),G.each(this.__folders,function(e){e.updateDisplay()})}});function mo(n,e,t){var i=document.createElement("li");return e&&i.appendChild(e),t?n.__ul.insertBefore(i,t):n.__ul.appendChild(i),n.onResize(),i}function Ko(n){R.unbind(window,"resize",n.__resizeHandler),n.saveToLocalStorageIfPossible&&R.unbind(window,"unload",n.saveToLocalStorageIfPossible)}function oo(n,e){var t=n.__preset_select[n.__preset_select.selectedIndex];e?t.innerHTML=t.value+"*":t.innerHTML=t.value}function Va(n,e,t){if(t.__li=e,t.__gui=n,G.extend(t,{options:function(g){if(arguments.length>1){var h=t.__li.nextElementSibling;return t.remove(),Zn(n,t.object,t.property,{before:h,factoryArgs:[G.toArray(arguments)]})}if(G.isArray(g)||G.isObject(g)){var l=t.__li.nextElementSibling;return t.remove(),Zn(n,t.object,t.property,{before:l,factoryArgs:[g]})}},name:function(g){return t.__li.firstElementChild.firstElementChild.innerHTML=g,t},listen:function(){return t.__gui.listen(t),t},remove:function(){return t.__gui.remove(t),t}}),t instanceof no){var i=new Si(t.object,t.property,{min:t.__min,max:t.__max,step:t.__step});G.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(m){var g=t[m],h=i[m];t[m]=i[m]=function(){var l=Array.prototype.slice.call(arguments);return h.apply(i,l),g.apply(t,l)}}),R.addClass(e,"has-slider"),t.domElement.insertBefore(i.domElement,t.domElement.firstElementChild)}else if(t instanceof Si){var c=function(g){if(G.isNumber(t.__min)&&G.isNumber(t.__max)){var h=t.__li.firstElementChild.firstElementChild.innerHTML,l=t.__gui.__listening.indexOf(t)>-1;t.remove();var a=Zn(n,t.object,t.property,{before:t.__li.nextElementSibling,factoryArgs:[t.__min,t.__max,t.__step]});return a.name(h),l&&a.listen(),a}return g};t.min=G.compose(c,t.min),t.max=G.compose(c,t.max)}else t instanceof Dl?(R.bind(e,"click",function(){R.fakeEvent(t.__checkbox,"click")}),R.bind(t.__checkbox,"click",function(m){m.stopPropagation()})):t instanceof Nl?(R.bind(e,"click",function(){R.fakeEvent(t.__button,"click")}),R.bind(e,"mouseover",function(){R.addClass(t.__button,"hover")}),R.bind(e,"mouseout",function(){R.removeClass(t.__button,"hover")})):t instanceof io&&(R.addClass(e,"color"),t.updateDisplay=G.compose(function(m){return e.style.borderLeftColor=t.__color.toString(),m},t.updateDisplay),t.updateDisplay());t.setValue=G.compose(function(m){return n.getRoot().__preset_select&&t.isModified()&&oo(n.getRoot(),!0),m},t.setValue)}function Fl(n,e){var t=n.getRoot(),i=t.__rememberedObjects.indexOf(e.object);if(i!==-1){var c=t.__rememberedObjectIndecesToControllers[i];if(c===void 0&&(c={},t.__rememberedObjectIndecesToControllers[i]=c),c[e.property]=e,t.load&&t.load.remembered){var m=t.load.remembered,g=void 0;if(m[n.preset])g=m[n.preset];else if(m[ii])g=m[ii];else return;if(g[i]&&g[i][e.property]!==void 0){var h=g[i][e.property];e.initialValue=h,e.setValue(h)}}}}function Zn(n,e,t,i){if(e[t]===void 0)throw new Error('Object "'+e+'" has no property "'+t+'"');var c=void 0;if(i.color)c=new io(e,t);else{var m=[e,t].concat(i.factoryArgs);c=Ba.apply(n,m)}i.before instanceof _n&&(i.before=i.before.__li),Fl(n,c),R.addClass(c.domElement,"c");var g=document.createElement("span");R.addClass(g,"property-name"),g.innerHTML=c.property;var h=document.createElement("div");h.appendChild(g),h.appendChild(c.domElement);var l=mo(n,h,i.before);return R.addClass(l,He.CLASS_CONTROLLER_ROW),c instanceof io?R.addClass(l,"color"):R.addClass(l,Ta(c.getValue())),Va(n,l,c),n.__controllers.push(c),c}function Cn(n,e){return document.location.href+"."+e}function lo(n,e,t){var i=document.createElement("option");i.innerHTML=e,i.value=e,n.__preset_select.appendChild(i),t&&(n.__preset_select.selectedIndex=n.__preset_select.length-1)}function Xo(n,e){e.style.display=n.useLocalStorage?"block":"none"}function Ua(n){var e=n.__save_row=document.createElement("li");R.addClass(n.domElement,"has-save"),n.__ul.insertBefore(e,n.__ul.firstChild),R.addClass(e,"save-row");var t=document.createElement("span");t.innerHTML="&nbsp;",R.addClass(t,"button gears");var i=document.createElement("span");i.innerHTML="Save",R.addClass(i,"button"),R.addClass(i,"save");var c=document.createElement("span");c.innerHTML="New",R.addClass(c,"button"),R.addClass(c,"save-as");var m=document.createElement("span");m.innerHTML="Revert",R.addClass(m,"button"),R.addClass(m,"revert");var g=n.__preset_select=document.createElement("select");if(n.load&&n.load.remembered?G.each(n.load.remembered,function(d,o){lo(n,o,o===n.preset)}):lo(n,ii,!1),R.bind(g,"change",function(){for(var d=0;d<n.__preset_select.length;d++)n.__preset_select[d].innerHTML=n.__preset_select[d].value;n.preset=this.value}),e.appendChild(g),e.appendChild(t),e.appendChild(i),e.appendChild(c),e.appendChild(m),Wn){var h=document.getElementById("dg-local-explain"),l=document.getElementById("dg-local-storage"),a=document.getElementById("dg-save-locally");a.style.display="block",localStorage.getItem(Cn(n,"isLocal"))==="true"&&l.setAttribute("checked","checked"),Xo(n,h),R.bind(l,"change",function(){n.useLocalStorage=!n.useLocalStorage,Xo(n,h)})}var f=document.getElementById("dg-new-constructor");R.bind(f,"keydown",function(d){d.metaKey&&(d.which===67||d.keyCode===67)&&qn.hide()}),R.bind(t,"click",function(){f.innerHTML=JSON.stringify(n.getSaveObject(),void 0,2),qn.show(),f.focus(),f.select()}),R.bind(i,"click",function(){n.save()}),R.bind(c,"click",function(){var d=prompt("Enter a new preset name.");d&&n.saveAs(d)}),R.bind(m,"click",function(){n.revert()})}function Ya(n){var e=void 0;n.__resize_handle=document.createElement("div"),G.extend(n.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function t(m){return m.preventDefault(),n.width+=e-m.clientX,n.onResize(),e=m.clientX,!1}function i(){R.removeClass(n.__closeButton,He.CLASS_DRAG),R.unbind(window,"mousemove",t),R.unbind(window,"mouseup",i)}function c(m){return m.preventDefault(),e=m.clientX,R.addClass(n.__closeButton,He.CLASS_DRAG),R.bind(window,"mousemove",t),R.bind(window,"mouseup",i),!1}R.bind(n.__resize_handle,"mousedown",c),R.bind(n.__closeButton,"mousedown",c),n.domElement.insertBefore(n.__resize_handle,n.domElement.firstElementChild)}function ro(n,e){n.domElement.style.width=e+"px",n.__save_row&&n.autoPlace&&(n.__save_row.style.width=e+"px"),n.__closeButton&&(n.__closeButton.style.width=e+"px")}function hi(n,e){var t={};return G.each(n.__rememberedObjects,function(i,c){var m={},g=n.__rememberedObjectIndecesToControllers[c];G.each(g,function(h,l){m[l]=e?h.initialValue:h.getValue()}),t[c]=m}),t}function Ka(n){for(var e=0;e<n.__preset_select.length;e++)n.__preset_select[e].value===n.preset&&(n.__preset_select.selectedIndex=e)}function Ll(n){n.length!==0&&La.call(window,function(){Ll(n)}),G.each(n,function(e){e.updateDisplay()})}var Xa=He;const zl=n=>{let e={projection:ve(()=>n.projection),showCladding:ve(()=>n.showCladding),showBackground:ve(()=>n.showBackground),hideBelowGround:ve(()=>n.hideBelowGround),showDebugMarkings:ve(()=>n.showDebugMarkings),textured:ve(()=>n.textured),...(()=>{if(n.sceneGraph==null)return{};let f=n.sceneGraph;return{showSceneGraph:ve(()=>f.showSceneGraph)}})()},t=new Xa({autoPlace:!1}),i=t.add(e,"projection",["Perspective","Orthographic"]).name("Projection").onChange(f=>{n.setProjection(f)}),c=t.add(e,"showCladding").name("Show Cladding").onChange(f=>{n.setShowCladding(f)}),m=t.add(e,"showBackground").name("Show Background").onChange(f=>{n.setShowBackground(f)}),g=t.add(e,"hideBelowGround").name("Hide Underground").onChange(f=>{n.setHideBelowGround(f)}),h=t.add(e,"showDebugMarkings").name("Show Debug Markings").onChange(f=>{n.setShowDebugMarkings(f)}),l=t.add(e,"textured").name("Textured").onChange(f=>{n.setTextured(f)}),a;if(n.sceneGraph==null)a=void 0;else{let f=n.sceneGraph;a=t.add(e,"showSceneGraph").name("Scene Graph").onChange(d=>{f.setShowSceneGraph(d)})}t.open();{let f=!0;re(()=>{let d=n.projection;if(f){f=!1;return}i.setValue(d)})}{let f=!0;re(()=>{let d=n.showCladding;if(f){f=!1;return}c.setValue(d)})}{let f=!0;re(()=>{let d=n.showBackground;if(f){f=!1;return}m.setValue(d)})}{let f=!0;re(()=>{let d=n.hideBelowGround;if(f){f=!1;return}g.setValue(d)})}{let f=!0;re(()=>{let d=n.showDebugMarkings;if(f){f=!1;return}h.setValue(d)})}{let f=!0;re(()=>{let d=n.textured;if(f){f=!1;return}l.setValue(d)})}if(n.sceneGraph!=null){let f=n.sceneGraph,d=!0;re(()=>{let o=f.showSceneGraph;if(d){d=!1;return}a?.setValue(o)})}return Ce(()=>{t.destroy()}),t.domElement},Go=10,Ga=Go*Go;class Ha{constructor(e){let[t,i]=Ne({firstSelectedPoint:void 0,secondSelectedPoint:void 0,currentDimensionId:void 0}),c=v(()=>t.firstSelectedPoint==null&&t.secondSelectedPoint==null?e.snapPoints():t.firstSelectedPoint!=null&&t.secondSelectedPoint!=null?[]:e.snapPoints().filter(g=>g!==t.firstSelectedPoint&&g!==t.secondSelectedPoint)),m=v(()=>{let g=e.mousePos();if(g==null)return;let h=e.mouseRay();if(h==null)return;let l,a;for(let f of c()){let d=e.projectPtToScreen(f);if(d==null||g.distanceSquared(d)>Ga)continue;let u=h.closestTimeToPoint(f);u<0||(l==null||u<l)&&(l=u,a=f)}return a});re(()=>{if(t.firstSelectedPoint==null||t.secondSelectedPoint==null||t.currentDimensionId==null)return;let g=e.mousePos();if(g==null)return;let h=e.mouseRay();if(h==null)return;let l=t.secondSelectedPoint.sub(t.firstSelectedPoint).normalize(),a=l.cross(C.unitZ).cross(l),f=l.cross(a),d,o;for(let u of[a,f]){let s=Xe.create(t.secondSelectedPoint,u),r=s.closestTimeOnThisRayWithOtherRay(h);if(r==null)continue;let p=s.positionFromTime(r),y=e.projectPtToScreen(p);if(y==null)continue;let _=g.distanceSquared(y);(d==null||_<d)&&(d=_,o=p)}if(o!=null){let u=o.sub(t.secondSelectedPoint);e.updateDimension({id:t.currentDimensionId,line:et.create(t.firstSelectedPoint,t.secondSelectedPoint),offset:u})}}),this.instructions=v(()=>"Click a pair of points to dimension."),this.snapPoints=v(()=>[...[...nt(m()),...nt(t.firstSelectedPoint),...nt(t.secondSelectedPoint)].map(g=>({pt:()=>g,highlighted:()=>!0}))]),this.click=()=>{if(t.firstSelectedPoint==null){let g=m();if(g==null)return;i("firstSelectedPoint",g)}else if(t.secondSelectedPoint==null){let g=m();if(g==null)return;let h=t.firstSelectedPoint,l=g;$e(()=>{i("secondSelectedPoint",g);let{id:a}=e.createDimension({line:et.create(h,l),offset:C.create(0,0,100)});i("currentDimensionId",a)})}else $e(()=>{i("firstSelectedPoint",void 0),i("secondSelectedPoint",void 0),i("currentDimensionId",void 0)})},this.cancel=()=>{t.currentDimensionId!=null&&e.destroyDimension(t.currentDimensionId)}}}const Mt=.001,Gn=762,Ho=20;function Wa(n){let e={};for(let h of n.roofPlanes){let l=h.vertices.reduce((u,s)=>Math.min(u,s.y),Number.POSITIVE_INFINITY),a=h.vertices.reduce((u,s)=>Math.max(u,s.y),Number.NEGATIVE_INFINITY),f=h.vertices.map((u,s)=>({x:u.x,idx:s})).sort((u,s)=>u.x-s.x);if(f.length<2)continue;let d;{let u=h.vertices[f[0].idx],s=h.vertices[f[1].idx];(Math.abs(u.y-l)<=Mt||Math.abs(u.y-a)<=Mt)&&(Math.abs(s.y-l)<=Mt||Math.abs(s.y-a)<=Mt)&&Math.abs(u.x-s.x)>Mt?d={pt1:u,pt2:s}:d=void 0}let o;{let u=h.vertices[f[f.length-1].idx],s=h.vertices[f[f.length-2].idx];(Math.abs(u.y-l)<=Mt||Math.abs(u.y-a)<=Mt)&&(Math.abs(s.y-l)<=Mt||Math.abs(s.y-a)<=Mt)&&Math.abs(u.x-s.x)>Mt?o={pt1:u,pt2:s}:o=void 0}e[h.id]={leftSlant:d,rightSlant:o}}let t={},i={};for(let h of n.roofPlanes){let l=t[h.id]||!1;t[h.id]=l;let{leftSlant:a,rightSlant:f}=e[h.id],d=h.id+"_slant_Left",o=h.id+"_slant_Right",u=i[d]==null,s=i[o]==null;if(!(u||s)||a==null&&f==null)continue;let r=!1,p=!1;for(let y of n.roofPlanes){let _=t[y.id];if(y===h)continue;let{leftSlant:w,rightSlant:S}=e[y.id],b=y.id+"_slant_Left",x=y.id+"_slant_Right",k=i[b]==null,I=i[x]==null;if(!!(k||I)&&!(w==null&&S==null)){if(!r&&f!=null&&w!=null&&s&&k)switch(pi(f,w)){case"Match":{if(_!=null&&_!=l)break;_==null&&(t[y.id]=l),i[o]={roofPlaneId:y.id,slant:"Left"},i[b]={roofPlaneId:h.id,slant:"Right"},r=!0;break}}if(!r&&f!=null&&S!=null&&s&&I)switch(pi(f,S)){case"Match":{if(_!=null&&_!=!l)break;_==null&&(t[y.id]=!l),r=!0,i[o]={roofPlaneId:y.id,slant:"Right"},i[x]={roofPlaneId:h.id,slant:"Right"};break}}if(!p&&a!=null&&S!=null&&u&&I)switch(pi(a,S)){case"Match":{if(_!=null&&_!=l)break;_==null&&(t[y.id]=l),p=!0,i[d]={roofPlaneId:y.id,slant:"Right"},i[x]={roofPlaneId:h.id,slant:"Left"};break}}if(!p&&a!=null&&w!=null&&u&&k)switch(pi(a,w)){case"Match":{if(_!=null&&_!=!l)break;_==null&&(t[y.id]=!l),p=!0,i[d]={roofPlaneId:y.id,slant:"Left"},i[b]={roofPlaneId:h.id,slant:"Left"};break}}if(p&&r)break}}}let c=n.roofPlanes,m=0,g=[];for(;;){let h=c.pop();if(h==null)break;let l=h.vertices.reduce((d,o)=>Math.min(d,o.x),Number.POSITIVE_INFINITY),a=h.vertices.reduce((d,o)=>Math.max(d,o.x),Number.NEGATIVE_INFINITY),f=[l,...h.vertices.map(d=>d.x).sort((d,o)=>d-o),a];for(let d=f.length-1;d>=1;--d){let o=f[d-1];f[d]-o<=Mt&&f.splice(d,1)}for(let d=0;d<f.length-1;++d){let o=f[d],u=f[d+1],s=o+.5*Gn,r=Math.abs(u-o);if(r<=Mt)continue;let p=Math.ceil(r/Gn),y=1,_=m++;for(let w=0;w<p;++w){let b=s+w*Gn*y-.5*Gn*y,x=Qa(b,b+Gn*y,h.vertices);if(x==null)continue;let{minY:k,maxY:I}=x;g.push({roofPlaneId:h.id,sectionId:_,pos:ae.create(b,k-Ho),length:I-k+Ho})}}}return{sheetPositions:g}}function pi(n,e){let t=n.pt2.x-n.pt1.x,i=n.pt2.y-n.pt1.y,c=e.pt2.x-e.pt1.x,m=e.pt2.y-e.pt1.y;return Math.sign(i)!=Math.sign(m)&&(t=-t,i=-i),Math.abs(t-c)<=Mt&&Math.abs(i-m)<=Mt?"Match":"No Match"}function Qa(n,e,t){let i=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY;{let h=Wo(n,t);h!=null&&(i=Math.min(i,h.minY),c=Math.max(c,h.maxY))}{let h=Wo(e,t);h!=null&&(i=Math.min(i,h.minY),c=Math.max(c,h.maxY))}let m=Math.min(n,e),g=Math.max(n,e);for(let h of t)m<h.x&&h.x<g&&(i=Math.min(i,h.y),c=Math.max(c,h.y));if(!!Number.isFinite(i))return{minY:i,maxY:c}}function Wo(n,e){let t=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;for(let c=0;c<e.length;++c){let m=(c+1)%e.length,g=e[c],h=e[m];if(Math.min(g.x,h.x)<=n&&n<Math.max(g.x,h.x)){let l=h.x-g.x,a=h.y-g.y,f=g.y+(n-g.x)*a/l;Number.isFinite(f)&&(t=Math.min(t,f),i=Math.max(i,f))}}if(!!Number.isFinite(t))return{minY:t,maxY:i}}async function qa(){let n=new Image;await new Promise(i=>{n.src="./img/steeline-logo.png",n.addEventListener("load",()=>{i()})});let e=document.createElement("canvas");e.width=n.width,e.height=n.height;let t=e.getContext("2d");if(t!=null)return t.drawImage(n,0,0),e.toDataURL("image/png")}const jl=await qa(),Za=Z('<img style="max-width: 3cm;">'),Ja=Z('<svg><polygon style="fill: none; stroke: black; strock-width: 1;"></polygon></svg>',4,!0),ed=Z('<svg><text text-anchor="middle" font-weight="bold">QTY: </text></svg>',4,!0),Qo=Z('<svg><line stroke="black" stroke-width="1" vector-effect="non-scaling-stroke"></line></svg>',4,!0),td=Z('<svg><text fill="black" text-anchor="middle" font-weight="bold"></text></svg>',4,!0),nd=Z('<svg><text text-anchor="middle" dominant-baseline="central"></text></svg>',4,!0),id=Z('<svg><path fill="none" stroke="blue" style="stroke-width: 2; vector-effect: non-scaling-stroke;"></path></svg>',4,!0),od=n=>{let[e,t]=st(void 0);const[i,c]=Ne({...Nn(),scale:.2,panX:-1e3,panY:-3e3});let m=v(()=>{let l=[];for(let a=0;a<n.plate.outline.length;++a){let f=(a+1)%n.plate.outline.length,d=n.plate.outline[a],u=n.plate.outline[f].sub(d),s=u.length(),r=u.scale(1/s),p=ae.create(-r.y,r.x),y=d.add(p.scale(-20));l.push({space:he.create(C.create(y.x,y.y,0),we.fromWU(C.unitZ,C.create(r.x,r.y,0))),markers:[0,s]})}return l}),g=v(()=>[{label:n.plate.label,outline:n.plate.outline,quantity:n.plate.quantity}]);const h=v(()=>{let l=[],a=n.plate.outline;for(let f=0;f<a.length;++f){let d=a[(f+a.length-1)%a.length],o=a[f],u=a[(f+1)%a.length],s=o.x-d.x,r=o.y-d.y,p=u.x-o.x,y=u.y-o.y,_=Math.sqrt(s*s+r*r),w=Math.sqrt(p*p+y*y),S=s/_,b=r/_,x=p/w,k=y/w,I=180-Math.acos(S*x+b*k)*180/Math.PI,D=Math.round(I)+"\xB0",Y=.5*(-S+x),Q=.5*(-b+k),N=Math.sqrt(Y*Y+Q*Q),oe=Y/N,ue=Q/N,J=o.x+oe*20,_e=-(o.y+ue*20),Te=o.x,se=-o.y,ee=10,F=-Math.atan2(-b,-S)*180/Math.PI,L=-Math.atan2(k,x)*180/Math.PI,$=b*x-S*k<=0;l.push({textX:J,textY:_e,text:D,arcX:Te,arcY:se,arcRadius:ee,arcStartAngle:F,arcEndAngle:L,arcOtherSide:$,angle:I})}return l});return re(()=>{let l=e();if(l==null)return;let a=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,d=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(let x of n.plate.outline)a=Math.min(a,x.x),f=Math.max(f,x.x),d=Math.min(d,-x.y),o=Math.max(o,-x.y);for(let x of m()){let k,I;for(let J of x.markers)(k==null||J<k)&&(k=J),(I==null||J>I)&&(I=J);if(k==null||I==null)continue;let D=x.space.pointFromThisSpace(C.create(k,0,0)),Y=x.space.pointFromThisSpace(C.create(I,0,0)),Q=x.space.pointFromThisSpace(C.create(k,-10,0)),N=x.space.pointFromThisSpace(C.create(I,10,0)),oe=x.space.pointFromThisSpace(C.create(k,0,-10)),ue=x.space.pointFromThisSpace(C.create(I,0,10));for(let J of[D,Y,Q,N,oe,ue])a=Math.min(a,J.x),f=Math.max(f,J.x),d=Math.min(d,-J.y),o=Math.max(o,-J.y)}if(!Number.isFinite(a))return;let u=l.clientWidth,s=l.clientHeight,r=f-a,p=o-d,y=u/r,_=s/p,w=Math.min(y,_)*.9,S=a-.5*u/w+.5*r,b=d-.5*(s/w-p);$e(()=>{c("panX",S),c("panY",b),c("scale",w)})}),U($l,{get logo(){return(()=>{const l=Za.cloneNode(!0);return K(l,"src",jl),l})()},companyDetails:{name:"Steeline FNW",abn:"12345678",address1:"300 Anzac Avenue",address2:"Harristown QLD 4350",phone:"(07) 4580 4244",fax:"(07) 4304 8012",email:"info@fnw.com.au",website:"fnw.au"},get title(){return n.title},projectNumber:"12-3456",customerName:"Customer Name",clientName:"Client Name",siteAddress1:"Site Address 1",siteAddress2:"Site Address 2",lot:"12345",rpsp:"12345",date:"00/00/0000",ultWindSpeed:"N/A",drawingNo:"12-3456;A",get children(){return U(Pi,{onRefSvg:l=>{t(l)},showGrid:!1,fontSize:12,state:i,style:{"flex-grow":"1",border:"none"},get children(){return[U(kt,{get each(){return g()},children:l=>{if(l.outline.length==0)return;let a=0,f=0;for(let o of l.outline)a+=o.x,f+=o.y;a/=l.outline.length,f/=l.outline.length;let d=l.outline[0].x+","+-l.outline[0].y;for(let o=1;o<l.outline.length;++o)d+=" "+l.outline[o].x+","+-l.outline[o].y;return[(()=>{const o=Ja.cloneNode(!0);return K(o,"points",d),o})(),(()=>{const o=ed.cloneNode(!0),u=o.firstChild;return K(o,"x",a),K(o,"y",-f),ie(o,()=>l.label+" ",u),ie(o,()=>l.quantity,null),ce(()=>K(o,"font-size",(20/i.scale).toString())),o})()]}}),U(On,{get each(){return m()},children:l=>{if(l().markers.length==0)return[];let a=[...l().markers].sort((p,y)=>p-y),f=a[0],d=a[a.length-1],o=l().space.pointFromThisSpace(C.create(f,0,0)),u=l().space.pointFromThisSpace(C.create(d,0,0)),s=l().space.v,r=Math.atan(-l().space.u.y/l().space.u.x)*180/Math.PI;return[(()=>{const p=Qo.cloneNode(!0);return ce(y=>{const _=o.x,w=-o.y,S=u.x,b=-u.y;return _!==y._v$&&K(p,"x1",y._v$=_),w!==y._v$2&&K(p,"y1",y._v$2=w),S!==y._v$3&&K(p,"x2",y._v$3=S),b!==y._v$4&&K(p,"y2",y._v$4=b),y},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0}),p})(),U(On,{each:a,children:p=>{let y=l().space.pointFromThisSpace(C.create(p(),0,0)),_=y.sub(s.scale(5)),w=y.add(s.scale(5));return(()=>{const S=Qo.cloneNode(!0);return ce(b=>{const x=_.x,k=-_.y,I=w.x,D=-w.y;return x!==b._v$5&&K(S,"x1",b._v$5=x),k!==b._v$6&&K(S,"y1",b._v$6=k),I!==b._v$7&&K(S,"x2",b._v$7=I),D!==b._v$8&&K(S,"y2",b._v$8=D),b},{_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0}),S})()}}),U(On,{get each(){return[...Array(a.length-1).keys()]},children:p=>{let y=a[p()],_=a[p()+1],w=l().space.pointFromThisSpace(C.create(.5*(y+_),-8,0)),S="translate("+w.x+","+-w.y+") rotate("+r+")";return(()=>{const b=td.cloneNode(!0);return K(b,"transform",S),ie(b,()=>Math.round(_-y)+" mm"),ce(()=>K(b,"font-size",(14/i.scale).toString())),b})()}}),U(On,{get each(){return h()},children:p=>{let y=v(()=>{let S=p().arcX,b=p().arcY,x=p().arcStartAngle,k=p().arcEndAngle,I=p().arcRadius,D=S+Math.cos(x*Math.PI/180)*I,Y=b+Math.sin(x*Math.PI/180)*I,Q=S+Math.cos(k*Math.PI/180)*I,N=b+Math.sin(k*Math.PI/180)*I,oe=p().arcOtherSide?1:0;return{arcRadius:I,arcStartX:D,arcStartY:Y,arcEndX:Q,arcEndY:N,arcSide:oe}}),_=v(()=>({x:0,y:0})),w=v(()=>{let S;return(()=>{const b=nd.cloneNode(!0),x=S;return typeof x=="function"?At(x,b):S=b,ie(b,()=>p().text),ce(k=>{const I=p().textX+_().x,D=p().textY+_().y,Y=(16/i.scale).toString();return I!==k._v$9&&K(b,"x",k._v$9=I),D!==k._v$10&&K(b,"y",k._v$10=D),Y!==k._v$11&&K(b,"font-size",k._v$11=Y),k},{_v$9:void 0,_v$10:void 0,_v$11:void 0}),b})()});return[U(tt,{get when(){return p().angle!=0},get children(){const S=id.cloneNode(!0);return ce(()=>K(S,"d","M"+y().arcStartX+" "+y().arcStartY+" A"+y().arcRadius+" "+y().arcRadius+" 0 0 "+y().arcSide+" "+y().arcEndX+" "+y().arcEndY)),S}}),Nt(w)]}})]}})]}})}})};class Vl{constructor(e){let[t,i]=Ne({space:he.identity,orbitTarget:C.zero,rotatingByDrag:!1,rotatingByDragLastPos:void 0,panningByDrag:!1,panningSpace:void 0,panningStartPos:void 0,panningCameraStartPos:void 0,panningStartOrbitTarget:void 0,multiTouchLast:void 0});this.space=()=>t.space,this.setSpace=g=>{i("space",g)},this.orbitTarget=()=>t.orbitTarget,this.lookAtTarget=()=>{let g=ve(()=>this.space()),h=ve(()=>this.orbitTarget()),l=ld(g.o,h);l!=null&&this.setSpace(l)},this.hookupEventListeners=g=>{let h=r=>this.onMouseDown(r),l=r=>this.onMouseMove(r),a=r=>this.onMouseUp(r),f=r=>this.onWheel(r),d=r=>this.onTouchStart(r),o=r=>this.onTouchMove(r),u=r=>this.onTouchEnd(r),s=r=>{r.preventDefault()};g.addEventListener("mousedown",h),g.addEventListener("mousemove",l),g.addEventListener("mouseup",a),g.addEventListener("wheel",f),g.addEventListener("touchstart",d),g.addEventListener("touchmove",o),g.addEventListener("touchend",u),g.addEventListener("contextmenu",s),Ce(()=>{g.removeEventListener("mousedown",h),g.removeEventListener("mousemove",l),g.removeEventListener("mouseup",a),g.removeEventListener("wheel",f),g.removeEventListener("touchstart",d),g.removeEventListener("touchmove",o),g.removeEventListener("touchend",u),g.removeEventListener("contextmenu",s)})};let c=g=>Xe.create(C.create(g.origin.x,g.origin.z,-g.origin.y),C.create(g.direction.x,g.direction.z,-g.direction.y)),m=g=>C.create(g.x,g.z,-g.y);this.onMouseDown=g=>{if(g.button==0)$e(()=>{i("rotatingByDrag",!0),i("rotatingByDragLastPos",ae.create(g.clientX,g.clientY))});else if(g.button==2){let h=he.create(t.orbitTarget,t.space.orientation),l=Re.fromKnownPtAndNormal(h.o,h.w),a=e.mouseRay();if(a!=null){let f=c(a),d=f.collisionWithPlane(l);if(d!=null){let o=h.pointToThisSpace(d).xy();$e(()=>{i("panningByDrag",!0),i("panningSpace",h),i("panningStartPos",o),i("panningCameraStartPos",f.origin),i("panningStartOrbitTarget",t.orbitTarget)})}}}},this.onMouseMove=g=>{if(t.rotatingByDrag&&t.rotatingByDragLastPos!=null){let h=ae.create(g.clientX,g.clientY),l=h.sub(t.rotatingByDragLastPos),a=qo(t.space.o,t.orbitTarget,l.scale(.6),t.space);if(a!=null){let f=a;$e(()=>{i("rotatingByDragLastPos",h),i("space",f)})}}else if(t.panningByDrag&&t.panningStartPos&&t.panningSpace!=null&&t.panningCameraStartPos!=null&&t.panningStartOrbitTarget!=null){let h=t.panningSpace,l=Re.fromKnownPtAndNormal(h.o,h.w),a=e.mouseRay();if(a!=null){let f=c(a),o=Xe.create(t.panningCameraStartPos,f.direction).collisionWithPlane(l);if(o!=null){let u=h.pointToThisSpace(o).xy(),r=h.vectorFromThisSpace(t.panningStartPos.sub(u).toVec3()).add(t.panningCameraStartPos);i("space",he.create(r,t.space.orientation)),i("orbitTarget",r.add(h.w.scale(t.panningStartOrbitTarget.sub(t.panningCameraStartPos).dot(h.w))))}}}},this.onMouseUp=g=>{g.button==0?(i("rotatingByDrag",!1),i("rotatingByDragLastPos",void 0)):g.button==2&&(i("panningByDrag",!1),i("panningSpace",void 0),i("panningStartPos",void 0),i("panningCameraStartPos",void 0),i("panningStartOrbitTarget",void 0))},this.onWheel=g=>{{let h=e.mouseRay();if(h!=null){let l=e.rayObjectCollision(h);if(l!=null){let a=h.positionFromTime(l.t),f=m(a);i("orbitTarget",f)}}}$e(()=>{if(g.deltaY>0){let h=t.space.o.sub(t.orbitTarget).scale(1.1).add(t.orbitTarget);if(i("space",he.create(h,t.space.orientation)),t.panningByDrag&&t.panningCameraStartPos!=null&&t.panningStartPos!=null){let l=t.panningCameraStartPos.sub(t.orbitTarget).scale(1.1).add(t.orbitTarget);i("panningCameraStartPos",l);let a=t.panningStartPos.scale(1.1);i("panningStartPos",a)}}else if(g.deltaY<0){let h=t.space.o.sub(t.orbitTarget).scale(.9090909090909091).add(t.orbitTarget);if(i("space",he.create(h,t.space.orientation)),t.panningByDrag&&t.panningCameraStartPos!=null&&t.panningStartPos!=null){let l=t.panningCameraStartPos.sub(t.orbitTarget).scale(.9090909090909091).add(t.orbitTarget);i("panningCameraStartPos",l);let a=t.panningStartPos.scale(1/1.1);i("panningStartPos",a)}}})},this.onTouchStart=g=>{if(g.touches.length==1){let h=g.touches[0];$e(()=>{i("rotatingByDrag",!0),i("rotatingByDragLastPos",ae.create(h.clientX,h.clientY))})}else g.touches.length==2&&$e(()=>{t.rotatingByDrag&&(i("rotatingByDrag",!1),i("rotatingByDragLastPos",void 0)),i("multiTouchLast",{touch1:ae.create(g.touches[0].clientX,g.touches[0].clientY),touch2:ae.create(g.touches[1].clientX,g.touches[1].clientY)})})},this.onTouchMove=g=>{if(t.rotatingByDrag&&t.rotatingByDragLastPos!=null&&g.touches.length==1){let h=g.touches[0],l=ae.create(h.clientX,h.clientY),a=l.sub(t.rotatingByDragLastPos),f=qo(t.space.o,t.orbitTarget,a.scale(.6),t.space);if(f!=null){let d=f;$e(()=>{i("rotatingByDragLastPos",l),i("space",d)})}}else if(t.multiTouchLast!=null&&g.touches.length==2){let h=t.multiTouchLast.touch1.distance(t.multiTouchLast.touch2),l={touch1:ae.create(g.touches[0].clientX,g.touches[0].clientY),touch2:ae.create(g.touches[1].clientX,g.touches[1].clientY)},a=l.touch1.distance(l.touch2),f=l.touch1.add(l.touch2).scale(.5).sub(t.multiTouchLast.touch1.add(t.multiTouchLast.touch2).scale(.5)),d,o=g.currentTarget;if(o instanceof HTMLCanvasElement){let r=45,p=o.height,y=.5*p/Math.tan(.5*r*Math.PI/180);d=2*t.space.o.distance(t.orbitTarget)/y}else d=100;let u=t.space.u.scale(-f.x).add(t.space.v.scale(f.y)).scale(d),s=t.space.o.sub(t.orbitTarget).scale(h/a).add(t.orbitTarget).add(u);$e(()=>{i("multiTouchLast",l),i("space",he.create(s,t.space.orientation)),i("orbitTarget",t.orbitTarget.add(u))})}g.preventDefault()},this.onTouchEnd=g=>{t.rotatingByDrag&&(i("rotatingByDrag",!1),i("rotatingByDragLastPos",void 0)),i("multiTouchLast",void 0)}}}function ld(n,e){let t=n.sub(e).normalize();if(!Number.isFinite(t.x))return;let i=t.cross(C.unitY.cross(t)).normalize();if(!!Number.isFinite(i.x))return he.create(n,we.fromVW(i,t))}function qo(n,e,t,i){let c=we.fromAxisAngle(C.unitY,-t.x),m=c.rotate$Vec3(n.sub(e)).add(e),g=c.rotate$Vec3(i.u),h=we.fromAxisAngle(g,-t.y),l=h.rotate$Vec3(m.sub(e)).add(e),a=h.rotate$Vec3(c.rotate$Vec3(i.u));a=C.create(a.x,0,a.z).normalize();let f=h.rotate$Vec3(c.rotate$Vec3(i.w));f=a.cross(f.cross(a)).normalize();let d=he.create(l,we.fromWU(f,a));if(d!=null){if(d.v.dot(i.v)<0&&(d=he.create(d.o,we.fromUV(d.u.scale(-1),d.v.scale(-1)))),d.v.y<0){let o=C.create(d.v.x,0,d.v.z),u=d.u.cross(o).normalize(),s=o.cross(u);d=he.create(n,we.fromUV(s,o))}return d}}function rd(n){let e=n.flatMap(({roofPlane:l,space:a})=>{let f=[],d=l.state.pitch*Math.PI/180,o=Math.cos(d),u=Math.sin(d),s=a.fromThisSpace(he.create(C.create(0,0,l.state.heightOffGround),we.fromWU(C.create(0,-u,o),C.unitX)));for(let r=0;r<l.state.vertices.length;++r){let p=(r+1)%l.state.vertices.length,y=s.pointFromThisSpace(l.state.vertices[r].toVec3()),_=s.pointFromThisSpace(l.state.vertices[p].toVec3());f.push({line:et.create(y,_),ray:Xe.create(y,_.sub(y))})}return{normal:s.w,lines:f}}),t=.001,i={},c={},m={},g=(l,a)=>{let f=m[l]??Qn.empty;f=f.union(Qn.single(a.from,a.to)),m[l]=f},h=[];for(let l=0;l<e.length;++l){let a=e[l];for(let f=0;f<a.lines.length;++f)c[l+"_"+f]=a.lines[f]}for(let l=0;l<e.length-1;++l){let a=e[l];for(let f=l+1;f<e.length;++f){let d=e[f];for(let o=0;o<a.lines.length;++o){let u=a.lines[o];for(let s=0;s<d.lines.length;++s){let r=d.lines[s],p=u.ray.closestTimeToPoint(r.line.v1),y=u.ray.closestTimeToPoint(r.line.v2),_=Math.max(0,Math.min(p,y)),w=Math.min(1,Math.max(p,y)),S=u.ray.positionFromTime(_),b=u.ray.positionFromTime(w),x=r.ray.closestPoint(S),k=r.ray.closestPoint(b);if(S.distanceSquared(x)>t*t||b.distanceSquared(k)>t*t||w-_<t)continue;let I=l+"_"+o,D=f+"_"+s;i[I]=!0,i[D]=!0;{g(I,{from:_,to:w});let Q=r.ray.closestTimeToPoint(S),N=r.ray.closestTimeToPoint(b),oe=Math.min(Q,N),ue=Math.max(Q,N);g(D,{from:oe,to:ue})}let Y;if(Math.abs(S.z-b.z)<=t)Y="Ridge";else{let Q=u.line.v2.sub(u.line.v1);ae.create(-Q.y,Q.x).normalize().toVec3().dot(d.normal)<=0?Y="Hip":Y="Valley"}h.push({lineType:Y,line:et.create(S,b)})}}}}for(let l in m){let a=c[l];if(a==null)continue;let f=m[l],d=Qn.single(0,1).subtract(f);for(let o of d.ranges)if(Math.abs(o.to-o.from)>t){let u=et.create(a.ray.positionFromTime(o.from),a.ray.positionFromTime(o.to));h.push({lineType:"Step",line:u})}}for(let l=0;l<e.length;++l){let a=e[l],f=Number.POSITIVE_INFINITY;for(let d of a.lines)f=Math.min(f,Math.min(d.line.v1.z,d.line.v2.z));for(let d=0;d<a.lines.length;++d){if(i[l+"_"+d])continue;let o=a.lines[d],u;Math.abs(o.line.v1.z-o.line.v2.z)<=t?Math.abs(o.line.v1.z-f)<=t?u="Eave":u="Apron":u="Gable",h.push({lineType:u,line:o.line})}}return h}const sd=Z('<div style="flex-grow: 1; display: flex; flex-direction: row;"><div style="font-size: 10pt"><table><thead><tr><th style="white-space: nowrap;" colspan="2">Total Lengths</th></tr></thead><tbody><tr><td>Ridges:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr><tr><td>Hips:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr><tr><td>Valleys:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr><tr><td>Gables:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr><tr><td>Eaves:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr><tr><td>Steps:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr><tr><td>Aprons:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr><tr><td>Cappings:</td><td style="font-weight: bold; white-space: nowrap;"></td></tr></tbody></table><br><b style="white-space: nowrap;">Total Area: </b></div></div>'),ad=Z('<img style="max-width: 3cm;">'),dd=Z('<svg><line stroke-width="1.2pt" fill="none" vector-effect="non-scaling-stroke"></line></svg>',4,!0),ud=Z('<svg><text text-anchor="middle" stroke="none" fill="black" font-size="12pt"></text></svg>',4,!0),cd=Z('<svg><text text-anchor="middle" stroke="none" fill="black" font-size="12pt"><tspan x="0" dy="0"></tspan><tspan x="0" dy="14pt"></tspan></text></svg>',8,!0),fd={Ridge:{r:118,g:236,b:80},Hip:{r:9,g:6,b:205},Valley:{r:204,g:47,b:201},Gable:{r:212,g:128,b:20},Eave:{r:112,g:38,b:164},Step:{r:27,g:121,b:172},Apron:{r:124,g:121,b:122},Capping:{r:191,g:143,b:0}};function Ul(n){return fd[n]??{r:0,g:0,b:0}}function dn(n){let e=Ul(n);return"rgb("+e.r+","+e.g+","+e.b+")"}const hd=n=>{let[e,t]=st(void 0),i=v(()=>{let h=e();if(h==null)return Nn();let l,a,f,d,o=x=>{let k=x.x,I=-x.y;(l==null||k<l)&&(l=k),(a==null||k>a)&&(a=k),(f==null||I<f)&&(f=I),(d==null||I>d)&&(d=I)};for(let x of n.roofingLines)o(x.line.v1),o(x.line.v2);if(l==null||a==null||f==null||d==null)return Nn();let u=h.clientWidth,s=h.clientHeight,r=a-l,p=d-f,y=u/r,_=s/p,w=Math.min(y,_)*.9,S=l-.5*(u/w-r),b=f-.5*(s/w-p);return{...Nn(),panX:S,panY:b,scale:w}}),c=v(()=>n.roofPlaneKits.flatMap(({roofPlane:h,space:l})=>{let a=h.state.pitch*Math.PI/180,f=Math.cos(a),d=Math.sin(a),o=l.fromThisSpace(he.create(C.create(0,0,h.state.heightOffGround),we.fromWU(C.create(0,-d,f),C.unitX))),u=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,p=Number.NEGATIVE_INFINITY;for(let _ of h.state.vertices){let w=o.pointFromThisSpace(_.toVec3());u=Math.min(u,w.x),s=Math.min(s,w.y),r=Math.max(r,w.x),p=Math.max(p,w.y)}return Number.isFinite(u)?[{pos:ae.create(.5*(u+r),.5*(s+p)),pitch:h.state.pitch,area:h.area()}]:[]})),m=v(()=>{let h=0,l=0,a=0,f=0,d=0,o=0,u=0,s=0;for(let r of n.roofingLines){let p=Math.round(r.line.length());switch(r.lineType){case"Ridge":h+=p;break;case"Hip":l+=p;break;case"Valley":a+=p;break;case"Gable":f+=p;break;case"Eave":d+=p;break;case"Step":o+=p;break;case"Apron":u+=p;break;case"Capping":s+=p;break}}return{ridgeTotal:h,hipTotal:l,valleyTotal:a,gableTotal:f,eaveTotal:d,stepTotal:o,apronTotal:u,cappingTotal:s}}),g=v(()=>n.roofPlaneKits.reduce((h,l)=>h+l.roofPlane.area(),0));return U($l,{get logo(){return(()=>{const h=ad.cloneNode(!0);return K(h,"src",jl),h})()},companyDetails:{name:"Steeline FNW",abn:"12345678",address1:"300 Anzac Avenue",address2:"Harristown QLD 4350",phone:"(07) 4580 4244",fax:"(07) 4304 8012",email:"info@fnw.com.au",website:"fnw.au"},title:"Dimensioned Plan",projectNumber:"12-3456",customerName:"Customer Name",clientName:"Client Name",siteAddress1:"Site Address 1",siteAddress2:"Site Address 2",lot:"12345",rpsp:"12345",date:"00/00/0000",ultWindSpeed:"N/A",drawingNo:"12-3456;A",get children(){const h=sd.cloneNode(!0),l=h.firstChild,a=l.firstChild,f=a.firstChild,d=f.nextSibling,o=d.firstChild,u=o.firstChild,s=u.nextSibling,r=o.nextSibling,p=r.firstChild,y=p.nextSibling,_=r.nextSibling,w=_.firstChild,S=w.nextSibling,b=_.nextSibling,x=b.firstChild,k=x.nextSibling,I=b.nextSibling,D=I.firstChild,Y=D.nextSibling,Q=I.nextSibling,N=Q.firstChild,oe=N.nextSibling,ue=Q.nextSibling,J=ue.firstChild,_e=J.nextSibling,Te=ue.nextSibling,se=Te.firstChild,ee=se.nextSibling,F=a.nextSibling,L=F.nextSibling;return L.firstChild,ie(h,U(Pi,{onRefSvg:$=>{t($)},showGrid:!1,fontSize:12,get state(){return i()},style:{width:"100%",height:"100%",border:"none"},get children(){return[U(kt,{get each(){return n.roofingLines},children:$=>{let W=Ul($.lineType),te=$.line.v2.sub($.line.v1).xy(),xe=ae.create(-te.y,te.x).normalize(),Pe=Math.atan2(-te.y,te.x)*180/Math.PI,z=$.line.v1.add($.line.v2).scale(.5).xy(),q;for(xe.y<0?(Pe+=180,q=-100):q=100;Pe<0;)Pe+=360;for(;Pe>=360;)Pe-=360;z=z.add(xe.scale(q));let ge=$.line.length();return[(()=>{const ne=dd.cloneNode(!0);return ce(be=>{const Be=$.line.v1.x,ke=-$.line.v1.y,Oe=$.line.v2.x,Je=-$.line.v2.y,De="rgb("+W.r+","+W.g+","+W.b+")",We=$.lineType=="Valley"?"10,10":void 0;return Be!==be._v$9&&K(ne,"x1",be._v$9=Be),ke!==be._v$10&&K(ne,"y1",be._v$10=ke),Oe!==be._v$11&&K(ne,"x2",be._v$11=Oe),Je!==be._v$12&&K(ne,"y2",be._v$12=Je),De!==be._v$13&&K(ne,"stroke",be._v$13=De),We!==be._v$14&&K(ne,"stroke-dasharray",be._v$14=We),be},{_v$9:void 0,_v$10:void 0,_v$11:void 0,_v$12:void 0,_v$13:void 0,_v$14:void 0}),ne})(),(()=>{const ne=ud.cloneNode(!0);return ie(ne,()=>Math.round(ge)+"mm"),ce(()=>K(ne,"transform","translate("+z.x+","+-z.y+") rotate("+Pe+") scale(20)")),ne})()]}}),U(kt,{get each(){return c()},children:({pos:$,pitch:W,area:te})=>(()=>{const xe=cd.cloneNode(!0),Pe=xe.firstChild,z=Pe.nextSibling;return ie(Pe,W+" deg."),ie(z,()=>te.toFixed(2)+" m\xB2"),ce(()=>K(xe,"transform","translate("+$.x+","+-$.y+") scale(20)")),xe})()})]}}),l),ie(s,()=>(m().ridgeTotal/1e3).toFixed(2)+" m"),ie(y,()=>(m().hipTotal/1e3).toFixed(2)+" m"),ie(S,()=>(m().valleyTotal/1e3).toFixed(2)+" m"),ie(k,()=>(m().gableTotal/1e3).toFixed(2)+" m"),ie(Y,()=>(m().eaveTotal/1e3).toFixed(2)+" m"),ie(oe,()=>(m().stepTotal/1e3).toFixed(2)+" m"),ie(_e,()=>(m().apronTotal/1e3).toFixed(2)+" m"),ie(ee,()=>(m().cappingTotal/1e3).toFixed(2)+" m"),ie(L,()=>g().toFixed(2)+"m\xB2",null),ce($=>{const W="font-weight: bold; color: "+dn("Ridge"),te="font-weight: bold; color: "+dn("Hip"),xe="font-weight: bold; color: "+dn("Valley"),Pe="font-weight: bold; color: "+dn("Gable"),z="font-weight: bold; color: "+dn("Eave"),q="font-weight: bold; color: "+dn("Step"),ge="font-weight: bold; color: "+dn("Apron"),ne="font-weight: bold; color: "+dn("Capping");return $._v$=an(u,W,$._v$),$._v$2=an(p,te,$._v$2),$._v$3=an(w,xe,$._v$3),$._v$4=an(x,Pe,$._v$4),$._v$5=an(D,z,$._v$5),$._v$6=an(N,q,$._v$6),$._v$7=an(J,ge,$._v$7),$._v$8=an(se,ne,$._v$8),$},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0}),h}})},pd=Z('<div>Dist:<input type="text"></div>');class md{constructor(e){let[t,i]=Ne({selectedImage:e.initSelectedImage,point1:void 0,point2:void 0}),c=v(()=>{let g=e.mouseRay();if(g==null)return;let h,l;for(let a of e.images()){let f=g.toSpace(a.space),d=a.kit.rayCollision()(f);d==null||d<=0||(d=h,l=a)}return l}),m=v(()=>{let g=e.mouseRay();if(g==null||t.selectedImage==null)return;let h=t.selectedImage.space,l=Re.fromKnownPtAndNormal(h.origin,h.w),a=g.collisionTimeWithPlane(l);return a==null||a<=0?void 0:g.positionFromTime(a)});this.instructions=v(()=>t.selectedImage==null?"Select Image":t.point1==null?"Select first point on image":t.point2==null?"Select second point on image":"Enter actual distance and press enter."),this.overlayObject3d=v(()=>{if(t.selectedImage==null){let g=c();if(g==null)return;let h=uo(g.kit.components()),l=.001,a=new Pt((h.maxX-h.minX)*l,(h.maxY-h.minY)*l,100*l);a.translate(.5*(h.minX+h.maxX)*l,.5*(h.minY+h.maxY)*l,0);let f=new wt({color:"green",transparent:!0,opacity:.5});Ce(()=>{a.dispose(),f.dispose()});let d=new Ze(a,f),o=g.space;return d.position.set(o.o.x*l,o.o.y*l,o.o.z*l),d.setRotationFromQuaternion(new Vt(o.orientation.x,o.orientation.y,o.orientation.z,o.orientation.w)),d}else return}),this.overlayUI=v(()=>{let g=v(()=>t.point2==null?void 0:e.projectPtToScreen(t.point2));return U(je,{get when(){return g()},children:h=>(()=>{const l=pd.cloneNode(!0),a=l.firstChild,f=a.nextSibling;return l.style.setProperty("position","absolute"),f.addEventListener("change",d=>{if(t.selectedImage==null||t.point1==null||t.point2==null)return;let o=t.point1.distance(t.point2),u=Number.parseFloat(d.currentTarget.value);if(!Number.isFinite(u))return;let s=t.selectedImage.kit.state.scale,r=u/o*s;t.selectedImage.kit.setState("scale",r),e.onDone()}),ce(d=>{const o=h().x+"px",u=h().y+"px";return o!==d._v$&&l.style.setProperty("left",d._v$=o),u!==d._v$2&&l.style.setProperty("top",d._v$2=u),d},{_v$:void 0,_v$2:void 0}),l})()})}),this.snapPoints=v(()=>[...nt(t.point1),...nt(t.point2)].map(g=>({pt:()=>g,highlighted:()=>!0}))),this.snapLines=v(()=>{if(t.point1==null)return[];let g=t.point1,h=t.point2??m();if(h==null)return[];let l=et.create(g,h);return[{line:()=>l,highlighted:()=>t.point2!=null}]}),this.click=()=>{if(t.selectedImage==null){let g=c();i("selectedImage",g)}else if(t.point1==null){let g=m();if(g==null)return;i("point1",g)}else if(t.point2==null){let g=m();if(g==null)return;i("point2",g)}}}}class gd{constructor(e){let[t,i]=Ne({movingBlock:void 0}),c=v(()=>{let f=e.mouseRay();if(f!=null)return f.collisionWithPlane(Re.xyPlane)}),m=v(()=>{let f=e.mouseRay();if(f==null)return;let d,o;for(let u of e.blocks()){let s=Re.fromKnownPtAndNormal(u.space.o,u.space.w),r=f.collisionTimeWithPlane(s);if(r==null)continue;let p=f.positionFromTime(r),y=u.space.pointToThisSpace(p);y.x<0||y.x>u.length||y.y<0||y.y>u.height||(d==null||r<d)&&(d=r,o=u)}return o}),g=v(()=>{if(m()!=null)return;let f=e.mouseRay();if(f==null)return;let d,o;for(let u of e.roofPlanes()){let s=Re.fromKnownPtAndNormal(u.space.o,u.space.w),r=f.collisionTimeWithPlane(s);if(r==null)continue;let p=f.positionFromTime(r),y=u.space.pointToThisSpace(p);!en(y.xy(),u.outline)||(d==null||r<d)&&(d=r,o=u)}return o});re(()=>{if(t.movingBlock!=null){let f=c();if(f!=null){let d=f.sub(t.movingBlock.fromGroundPos),o=t.movingBlock;ve(()=>{e.setBlockPos(o.blockId,o.fromBlockPos.add(C.create(d.x,d.y,0)))})}}}),this.highlightedRoofPlanes=v(()=>nt(g()?.id).map(f=>({roofPlaneId:f}))),this.highlightedBlocksById=v(()=>nt(m()?.id));let h=!1,l=!1,a=!1;this.mouseDown=()=>{h=!1,l=!0,a=!1;let f=m(),d=c();if(f!=null&&d!=null){let o=f,u=d;setTimeout(()=>{if(h){h=!1;return}l=!1,a=!0,$e(()=>{i("movingBlock",Jn({blockId:o.id,fromBlockPos:o.space.origin,fromGroundPos:u}))})},500)}},this.mouseUp=()=>{l&&(h=!0),a||$e(()=>{e.setSelectedRoofPlaneById(g()?.id),e.setSelectedBlockById(m()?.id)}),t.movingBlock!=null&&i("movingBlock",void 0)},this.cursor=v(()=>{if(m())return"move"}),this.disablePan=v(()=>m()!==void 0)}}const yd=Z('<svg><rect stroke="black" style="vector-effect: non-scaling-stroke;" pointer-events="none"></rect></svg>',4,!0);class vd{constructor(e){let[t,i]=st(Dt()),[c,m]=st(ko()),[g,h]=Ne({selectedRoofPlaneSection:void 0}),l=v(()=>{if(g.selectedRoofPlaneSection!=null)return;let u=e.mouseRay();if(u==null)return;let s,r;for(let p of e.roofPlanes()){let y=Re.fromKnownPtAndNormal(p.space.o,p.space.w),_=u.collisionTimeWithPlane(y);if(_==null)continue;let w=u.positionFromTime(_),S=p.space.pointToThisSpace(w),b;for(let x=0;x<p.splitOutlines.length;++x){let k=p.splitOutlines[x];if(en(S.xy(),k)){b=x;break}}b!=null&&(s==null||_<s)&&(s=_,r={roofPlane:p,splitIndex:b})}return r}),a=v(()=>{let u=e.mouseRay();if(u!=null)return u.collisionWithPlane(Re.xyPlane)}),f=v(()=>{if(g.selectedRoofPlaneSection==null)return;let u=g.selectedRoofPlaneSection.roofPlaneId,s=e.roofPlanes().find(r=>r.id===u);if(s!=null)return{roofPlane:s,splitIndex:g.selectedRoofPlaneSection.splitIndex}}),d=v(()=>{let u=f();if(u==null)return;let s=u.roofPlane.splitOutlines[u.splitIndex],r=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,y=Number.POSITIVE_INFINITY,_=Number.NEGATIVE_INFINITY;for(let w of s)r=Math.min(r,w.x),p=Math.max(p,w.x),y=Math.min(y,w.y),_=Math.max(_,w.y);if(!!Number.isFinite(r))return{length:p-r,height:_-y}}),o=v(()=>{if(f()==null)return;let s=d();if(s==null)return;let r=a();if(r!=null)return{id:t(),length:s.length,height:s.height,space:he.create(r,we.identity),colour:c()}});this.instructions=v(()=>g.selectedRoofPlaneSection==null?"Select a roof plane to make a block from. Or press escape, if finished.":"Move the mouse and click where to place the block."),this.highlightedRoofPlanes=v(()=>{if(g.selectedRoofPlaneSection!=null)return[{roofPlaneId:g.selectedRoofPlaneSection.roofPlaneId,splitIndices:[g.selectedRoofPlaneSection.splitIndex]}];let u=l();return u!=null?[{roofPlaneId:u.roofPlane.id,splitIndices:[u.splitIndex]}]:[]}),this.overlay=v(()=>{let u=o();if(u!=null)return(()=>{const s=yd.cloneNode(!0);return ce(r=>{const p=u.space.o.x,y=-u.space.o.y-u.height,_=u.length,w=u.height,S=u.colour;return p!==r._v$&&K(s,"x",r._v$=p),y!==r._v$2&&K(s,"y",r._v$2=y),_!==r._v$3&&K(s,"width",r._v$3=_),w!==r._v$4&&K(s,"height",r._v$4=w),S!==r._v$5&&K(s,"fill",r._v$5=S),r},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),s})()}),this.click=()=>{if(g.selectedRoofPlaneSection==null){let u=l();u!=null&&h("selectedRoofPlaneSection",{roofPlaneId:u.roofPlane.id,splitIndex:u.splitIndex})}else{let u=o();u!=null&&(e.addBlock(u),$e(()=>{i(Dt()),m(ko()),h("selectedRoofPlaneSection",void 0)}))}}}}const bd=Z('<svg><path fill="transparent" stroke-width="3" style="vector-effect: non-scaling-stroke;" pointer-events="none"></path></svg>',4,!0),xd=Z('<svg><circle pointer-events="none"></circle></svg>',4,!0),Zo=10,_d=Zo*Zo,Jo=.001,wd=Jo*Jo;class Sd{constructor(e){let[t,i]=Ne({selectedRoofPlaneSection:void 0}),c=v(()=>{let s=e.mouseRay();if(s!=null)return s.collisionWithPlane(Re.xyPlane)}),m=v(()=>{if(t.selectedRoofPlaneSection!=null)return;let s=e.mouseRay();if(s==null)return;let r,p;for(let y of e.roofPlanes()){let _=Re.fromKnownPtAndNormal(y.space.o,y.space.w),w=s.collisionTimeWithPlane(_);if(w==null)continue;let S=s.positionFromTime(w),b=y.space.pointToThisSpace(S),x;for(let k=0;k<y.splitOutlines.length;++k){let I=y.splitOutlines[k];if(en(b.xy(),I)){x=k;break}}x!=null&&(r==null||w<r)&&(r=w,p={roofPlane:y,splitIndex:x})}return p}),g=v(()=>{let s=e.roofPlaneBlockAssignments(),r={},p=e.roofPlanes();for(let y of p){let _=y.id,w=s.filter(S=>S.roofPlaneId==_);for(let S of w){if(S.splitIndex>=y.splitOutlines.length)continue;let b={roofPlaneId:_,splitIndex:S.splitIndex,offset:S.offset,outline:y.splitOutlines[S.splitIndex]},x=r[S.blockId];x==null?(x=[b],r[S.blockId]=x):x.push(b)}}return r}),h=v(()=>{let s=e.blocks(),r=g();return s.flatMap(p=>{let y=[];y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.zero).xy()}),y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.create(p.length,0,0)).xy()}),y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.create(p.length,p.height,0)).xy()}),y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.create(0,p.height,0)).xy()});let _=r[p.id];if(_!=null)for(let w of _){let S=e.roofPlanes().find(x=>x.id==w.roofPlaneId),b;S==null||S.stackSheetDirection=="Right"?b=w.outline:b=w.outline.map(x=>ae.create(-x.x,-x.y));for(let x of b)y.push({blockId:p.id,pt:p.space.pointFromThisSpace(x.add(w.offset).toVec3()).xy()})}return y})}),l=v(()=>{if(t.selectedRoofPlaneSection==null)return;let s=t.selectedRoofPlaneSection.roofPlaneId,r=e.roofPlanes().find(p=>p.id==s);if(r!=null)return{roofPlane:r,splitIndex:t.selectedRoofPlaneSection.splitIndex,pickUpOffset:t.selectedRoofPlaneSection.pickUpOffset}}),a=v(()=>{let s=l();if(s==null)return;let r=c();if(r==null)return;let p=[];return s.roofPlane.stackSheetDirection=="Right"?p=s.roofPlane.splitOutlines[s.splitIndex]:p=s.roofPlane.splitOutlines[s.splitIndex].map(y=>ae.create(-y.x,-y.y)),{roofPlaneOutline:{id:s.roofPlane.id,splitIndex:s.splitIndex,outline:p},pos:r.sub(s.pickUpOffset)}}),f=v(()=>{let s=a();if(s==null)return;let r=h();if(r.length==0)return;let p,y;for(let _ of s.roofPlaneOutline.outline){let w=_.toVec3().add(s.pos),S=e.projectPointToScreen(w);if(S!=null)for(let b=0;b<r.length;++b){let x=r[b],k=e.projectPointToScreen(x.pt.toVec3());if(k==null)continue;let I=S.distanceSquared(k);I>_d||(p==null||I<p)&&(p=I,y={pos:s.pos.add(x.pt.toVec3().sub(w)),highlightedSnap:{blockId:x.blockId,pointIdx:b}})}}if(y!=null)return{roofPlaneOutline:s.roofPlaneOutline,pos:y.pos,highlightedSnap:y.highlightedSnap}}),d=v(()=>{let s=f();if(s==null)return new Set;let r=new Set,p=h();for(let y of s.roofPlaneOutline.outline){let _=y.add(s.pos.xy());for(let w=0;w<p.length;++w){let S=p[w];if(S.blockId!=s.highlightedSnap.blockId)continue;let b=S.pt;_.distanceSquared(b)>wd||r.add(w)}}return r}),o=v(()=>(f()??a())?.roofPlaneOutline),u=v(()=>(f()??a())?.pos);this.instructions=v(()=>t.selectedRoofPlaneSection==null?"Select a Roof Plane to assign to a Block.":"Position Roof Plane Outline inside a Block."),this.highlightedRoofPlanes=v(()=>{if(t.selectedRoofPlaneSection!=null)return[{roofPlaneId:t.selectedRoofPlaneSection.roofPlaneId,splitIndices:[t.selectedRoofPlaneSection.splitIndex]}];let s=m();return s!=null?[{roofPlaneId:s.roofPlane.id,splitIndices:[s.splitIndex]}]:[]}),this.overlay=v(()=>{let s=o();if(s==null)return;let r=s.outline,p="M"+r[0].x+" "+-r[0].y;for(let y=1;y<r.length;++y)p+=" L"+r[y].x+" "+-r[y].y;return p+=" Z",[U(je,{get when(){return u()},children:y=>{let _=v(()=>f()!=null?"green":"blue");return(()=>{const w=bd.cloneNode(!0);return K(w,"d",p),ce(S=>{const b="translate("+y().x+" "+-y().y+")",x=_();return b!==S._v$&&K(w,"transform",S._v$=b),x!==S._v$2&&K(w,"stroke",S._v$2=x),S},{_v$:void 0,_v$2:void 0}),w})()}}),U(tt,{get when(){return t.selectedRoofPlaneSection!=null},get children(){return U(kt,{get each(){return h()},children:(y,_)=>{let w=v(()=>d().has(_()));return(()=>{const S=xd.cloneNode(!0);return ce(b=>{const x=y.pt.x,k=-y.pt.y,I=5/e.svgScale(),D=w()?"green":"blue";return x!==b._v$3&&K(S,"cx",b._v$3=x),k!==b._v$4&&K(S,"cy",b._v$4=k),I!==b._v$5&&K(S,"r",b._v$5=I),D!==b._v$6&&K(S,"fill",b._v$6=D),b},{_v$3:void 0,_v$4:void 0,_v$5:void 0,_v$6:void 0}),S})()}})}})]}),this.click=()=>{let s=f();if(t.selectedRoofPlaneSection==null){let r=e.mouseRay();if(r==null)return;let p=r.collisionWithPlane(Re.xyPlane);if(p==null)return;let y=m();if(y!=null){let _=y.roofPlane.space.pointToThisSpace(p);y.roofPlane.stackSheetDirection=="Left"&&(_=_.scale(-1)),i("selectedRoofPlaneSection",{roofPlaneId:y.roofPlane.id,splitIndex:y.splitIndex,pickUpOffset:_})}}else if(s!=null){let r=e.blocks().find(p=>p.id===s?.highlightedSnap.blockId);if(r==null)return;e.assignRoofPlaneToBlock({roofPlaneId:s.roofPlaneOutline.id,splitIndex:s.roofPlaneOutline.splitIndex,blockId:s.highlightedSnap.blockId,offset:s.pos.sub(r.space.origin).xy()}),i("selectedRoofPlaneSection",void 0)}}}}const Pd=Z('<svg><circle fill="blue" pointer-events="none"></circle></svg>',4,!0),el=10,kd=el*el;class Id{constructor(e){let[t,i]=Ne({selectedRoofPlaneById:void 0}),c=v(()=>{if(t.selectedRoofPlaneById!=null)return;let l=e.mouseRay();if(l==null)return;let a,f;for(let d of e.roofPlanes()){let o=Re.fromKnownPtAndNormal(d.space.o,d.space.w),u=l.collisionTimeWithPlane(o);if(u==null)continue;let s=l.positionFromTime(u),r=d.space.pointToThisSpace(s);!en(r.xy(),d.outline)||(a==null||u<a)&&(a=u,f=d)}return f}),m=v(()=>t.selectedRoofPlaneById==null?[]:e.roofPlanes().flatMap(l=>l.splitOutlines.flatMap(a=>a.map(f=>l.space.pointFromThisSpace(f.toVec3()).xy())))),g=v(()=>{let l=e.mousePos();if(l==null)return;let a,f;for(let d of m()){let o=e.projectPointToScreen(d.toVec3());if(o==null)continue;let u=l.distanceSquared(o);u>kd||(a==null||u<a)&&(a=u,f=d)}return f});this.instructions=v(()=>t.selectedRoofPlaneById==null?"Selected a roof plane to divide.":"Select a point for where to cut the plane."),this.highlightedRoofPlanes=v(()=>nt(c()?.id).map(l=>({roofPlaneId:l})));let h=v(()=>{let l=g();if(l!=null)return(()=>{const a=Pd.cloneNode(!0);return ce(f=>{const d=l.x,o=-l.y,u=5/e.svgScale();return d!==f._v$&&K(a,"cx",f._v$=d),o!==f._v$2&&K(a,"cy",f._v$2=o),u!==f._v$3&&K(a,"r",f._v$3=u),f},{_v$:void 0,_v$2:void 0,_v$3:void 0}),a})()});this.overlay=v(()=>Nt(h)),this.click=()=>{if(t.selectedRoofPlaneById==null){let l=c();l!=null&&i("selectedRoofPlaneById",l.id)}else{let l=g();if(l!=null){let a=l,f=e.roofPlanes().find(u=>u.id==t.selectedRoofPlaneById);if(f==null)return;let o=f.space.pointToThisSpace(a.toVec3()).x;e.cutRoofPlane({roofPlaneId:t.selectedRoofPlaneById,splitLocation:o}),$e(()=>{i("selectedRoofPlaneById",void 0)})}}}}}function tl(n,e){return e.n.dot(n)+e.d}function Td(n,e,t,i){let c=i-e,m=-e/c;m<0?m=0:m>1&&(m=1);let g=1-m;return C.create(m*n.x+g*t.x,m*n.y+g*t.y,m*n.z+g*t.z)}function nl(n,e){for(var t=[],i=[],c=tl(n[n.length-1],e),m=n[n.length-1],g=n[0],h=0;h<n.length;++h,m=g){g=n[h];var l=tl(g,e);if(c<0&&l>0||c>0&&l<0){var a=Td(m,l,g,c);t.push(a),i.push(a)}l<0?i.push(g):l>0?t.push(g):(t.push(g),i.push(g)),c=l}let f=d=>{if(!(d.length<=3))for(let o=0;o<d.length;++o){let u=(o+d.length-1)%d.length,s=(o+1)%d.length,r=d[o],p=d[u],y=d[s],_=Math.abs(p.dot(e.n)+e.d)<=.001,w=Math.abs(r.dot(e.n)+e.d)<=.001,S=Math.abs(y.dot(e.n)+e.d)<=.001;if(_&&w&&S){d.splice(o,1),--o;continue}}};return f(t),f(i),{positive:t,negative:i}}const Md=Z('<svg><circle pointer-events="none"></circle></svg>',4,!0),Ad=Z('<div><table><thead></thead><tbody><tr><td>Dist in Ground Plane:</td><td></td><td><input class="btn btn-primary" type="button" value="Copy"></td></tr><tr><td>Horizontal Dist:</td><td></td><td><input class="btn btn-primary" type="button" value="Copy"></td></tr><tr><td>Vertical Dist:</td><td></td><td><input class="btn btn-primary" type="button" value="Copy"></td></tr><tr><td colspan="3"><input class="btn btn-primary" type="button" value="Close"></td></tr></tbody></table></div>'),il=10,$d=il*il;class Cd{constructor(e){let[t,i]=Ne({point1:void 0,point2:void 0}),c=v(()=>e.roofPlanes().flatMap(s=>s.splitOutlines.flatMap(r=>r.map(p=>s.space.pointFromThisSpace(p.toVec3()).xy())))),m=v(()=>{let s=e.roofPlaneBlockAssignments(),r={},p=e.roofPlanes();for(let y of p){let _=y.id,w=s.filter(S=>S.roofPlaneId==_);for(let S of w){if(S.splitIndex>=y.splitOutlines.length)continue;let b={roofPlaneId:_,splitIndex:S.splitIndex,offset:S.offset,outline:y.splitOutlines[S.splitIndex]},x=r[S.blockId];x==null?(x=[b],r[S.blockId]=x):x.push(b)}}return r}),g=v(()=>{let s=e.blocks(),r=m();return s.flatMap(p=>{let y=[];y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.zero).xy()}),y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.create(p.length,0,0)).xy()}),y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.create(p.length,p.height,0)).xy()}),y.push({blockId:p.id,pt:p.space.pointFromThisSpace(C.create(0,p.height,0)).xy()});let _=r[p.id];if(_!=null)for(let w of _){let S=e.roofPlanes().find(x=>x.id==w.roofPlaneId),b;S==null||S.stackSheetDirection=="Right"?b=w.outline:b=w.outline.map(x=>ae.create(-x.x,-x.y));for(let x of b)y.push({blockId:p.id,pt:p.space.pointFromThisSpace(x.add(w.offset).toVec3()).xy()})}return y})}),h=v(()=>[...c(),...g().map(({pt:s})=>s)]),l=v(()=>t.point1!=null&&t.point2!=null?[]:h()),a=v(()=>{let s=e.mousePos();if(s==null)return;let r,p;for(let y of l()){let _=e.projectPointToScreen(y.toVec3());if(_==null)continue;let w=s.distanceSquared(_);w>$d||(r==null||w<r)&&(r=w,p=y)}return p});this.instructions=v(()=>"Click two points to measure.");let f=(s,r)=>U(je,{get when(){return s()},children:p=>(()=>{const y=Md.cloneNode(!0);return K(y,"fill",r),ce(_=>{const w=p().x,S=-p().y,b=5/e.svgScale();return w!==_._v$&&K(y,"cx",_._v$=w),S!==_._v$2&&K(y,"cy",_._v$2=S),b!==_._v$3&&K(y,"r",_._v$3=b),_},{_v$:void 0,_v$2:void 0,_v$3:void 0}),y})()}),d=v(()=>f(a,"blue")),o=v(()=>[()=>t.point1,()=>t.point2].map(s=>f(s,"green"))),u=v(()=>{if(t.point1==null||t.point2==null)return;let s=t.point1.add(t.point2).scale(.5),r=t.point2.sub(t.point1),p=r.length(),y=Math.abs(r.x),_=Math.abs(r.y);Math.abs(y)<.001&&(y=0),Math.abs(_)<.001&&(_=0);let w=v(()=>e.projectPointToScreen(s.toVec3())),S=b=>{navigator.clipboard.writeText(b.toString())};return U(je,{get when(){return w()},children:b=>(()=>{const x=Ad.cloneNode(!0),k=x.firstChild,I=k.firstChild,D=I.nextSibling,Y=D.firstChild,Q=Y.firstChild,N=Q.nextSibling,oe=N.nextSibling,ue=oe.firstChild,J=Y.nextSibling,_e=J.firstChild,Te=_e.nextSibling,se=Te.nextSibling,ee=se.firstChild,F=J.nextSibling,L=F.firstChild,$=L.nextSibling,W=$.nextSibling,te=W.firstChild,xe=F.nextSibling,Pe=xe.firstChild,z=Pe.firstChild;return x.style.setProperty("background-color","white"),x.style.setProperty("position","absolute"),ie(N,p),ue.$$click=()=>S(p),ie(Te,y),ee.$$click=()=>S(y),ie($,_),te.$$click=()=>S(_),z.$$click=()=>e.onDone(),ce(q=>{const ge=b().x+"px",ne=b().y+"px";return ge!==q._v$4&&x.style.setProperty("left",q._v$4=ge),ne!==q._v$5&&x.style.setProperty("top",q._v$5=ne),q},{_v$4:void 0,_v$5:void 0}),x})()})});this.overlay=v(()=>[Nt(o),Nt(d)]),this.overlayUI=u,this.click=()=>{if(t.point1==null){let s=a();s!=null&&i("point1",s)}else if(t.point2==null){let s=a();s!=null&&i("point2",s)}}}}Ut(["click"]);const Ed=Z('<svg><circle fill="blue" pointer-events="none"></circle></svg>',4,!0),Od=Z('<svg><circle fill="green" pointer-events="none"></circle></svg>',4,!0),Dd=Z('<svg><line stroke="black" marker-end="url(#arrowhead)" style="stroke-width: 2; vector-effect: non-scaling-stroke;" pointer-events="none"></line></svg>',4,!0),Rd=Z('<div>Dist:<input type="text"></div>'),ol=10,Nd=ol*ol;class Bd{constructor(e){let[t,i]=Ne({selectedRoofPlaneById:void 0,selectedDividePoint:void 0}),c=v(()=>{if(t.selectedRoofPlaneById!=null)return;let o=e.mouseRay();if(o==null)return;let u,s;for(let r of e.roofPlanes()){let p=Re.fromKnownPtAndNormal(r.space.o,r.space.w),y=o.collisionTimeWithPlane(p);if(y==null)continue;let _=o.positionFromTime(y),w=r.space.pointToThisSpace(_);!en(w.xy(),r.outline)||(u==null||y<u)&&(u=y,s=r)}return s}),m=v(()=>t.selectedRoofPlaneById==null?[]:e.roofPlanes().flatMap(o=>o.splitOutlines.flatMap(u=>u.map(s=>o.space.pointFromThisSpace(s.toVec3()).xy())))),g=v(()=>{if(t.selectedDividePoint!=null)return;let o=e.mousePos();if(o==null)return;let u,s;for(let r of m()){let p=e.projectPointToScreen(r.toVec3());if(p==null)continue;let y=o.distanceSquared(p);y>Nd||(u==null||y<u)&&(u=y,s=r)}return s});this.instructions=v(()=>t.selectedRoofPlaneById==null?"Selected a roof plane to divide.":t.selectedDividePoint==null?"Select a point to measure distance from for the cut.":"Move mouse and type a distance to the division."),this.highlightedRoofPlanes=v(()=>nt(c()?.id).map(o=>({roofPlaneId:o})));let h=v(()=>{let o=g();if(o!=null)return(()=>{const u=Ed.cloneNode(!0);return ce(s=>{const r=o.x,p=-o.y,y=5/e.svgScale();return r!==s._v$&&K(u,"cx",s._v$=r),p!==s._v$2&&K(u,"cy",s._v$2=p),y!==s._v$3&&K(u,"r",s._v$3=y),s},{_v$:void 0,_v$2:void 0,_v$3:void 0}),u})()}),l=v(()=>{let o=t.selectedDividePoint;if(o!=null)return(()=>{const u=Od.cloneNode(!0);return ce(s=>{const r=o.x,p=-o.y,y=5/e.svgScale();return r!==s._v$4&&K(u,"cx",s._v$4=r),p!==s._v$5&&K(u,"cy",s._v$5=p),y!==s._v$6&&K(u,"r",s._v$6=y),s},{_v$4:void 0,_v$5:void 0,_v$6:void 0}),u})()}),a=v(()=>{let o=e.mouseRay();if(o==null||t.selectedRoofPlaneById==null||t.selectedDividePoint==null)return;let u=e.roofPlanes().find(_=>_.id==t.selectedRoofPlaneById);if(u==null)return;let s=o.collisionWithPlane(Re.xyPlane);if(s==null)return;let r=Cl.fromOriginDirection(t.selectedDividePoint,u.space.u.xy().normalize()),p=r.closestTimeToPoint(s.xy()),y=r.pointFromTime(p);return fo.create(t.selectedDividePoint,y)}),f=v(()=>{if(a()!=null)return U(je,{get when(){return a()},children:u=>(()=>{const s=Dd.cloneNode(!0);return ce(r=>{const p=u().v1.x,y=-u().v1.y,_=u().v2.x,w=-u().v2.y;return p!==r._v$7&&K(s,"x1",r._v$7=p),y!==r._v$8&&K(s,"y1",r._v$8=y),_!==r._v$9&&K(s,"x2",r._v$9=_),w!==r._v$10&&K(s,"y2",r._v$10=w),r},{_v$7:void 0,_v$8:void 0,_v$9:void 0,_v$10:void 0}),s})()})});this.overlay=v(()=>[Nt(h),Nt(l),Nt(f)]);let d=o=>{if(t.selectedRoofPlaneById==null||t.selectedDividePoint==null)return;let u=a();if(u==null)return;let s;o==0?s=t.selectedDividePoint:s=u.v2.sub(u.v1).normalize().scale(o).add(u.v1);let r=e.roofPlanes().find(y=>y.id==t.selectedRoofPlaneById);if(r==null)return;let p=r.space.pointToThisSpace(s.toVec3()).x;e.cutRoofPlane({roofPlaneId:t.selectedRoofPlaneById,splitLocation:p}),$e(()=>{i("selectedRoofPlaneById",void 0),i("selectedDividePoint",void 0)})};this.overlayUI=v(()=>{let o=v(()=>{let u=a();if(u==null)return;let s=e.projectPointToScreen(u.v2.toVec3());if(s!=null)return s.add(ae.create(5,5))});return U(je,{get when(){return a()},children:u=>U(je,{get when(){return o()},children:s=>{let r,p=v(()=>u().length().toString());return re(()=>{let y=p();r!=null&&(r.value=y,r.select(),r.focus())}),(()=>{const y=Rd.cloneNode(!0),_=y.firstChild,w=_.nextSibling;y.style.setProperty("position","absolute"),y.style.setProperty("background-color","white"),w.$$keyup=b=>{if(b.key=="Enter"){let x=Number.parseFloat(b.currentTarget.value);if(!Number.isFinite(x))return;d(x)}};const S=r;return typeof S=="function"?At(S,w):r=w,ce(b=>{const x=s().x+"px",k=s().y+"px";return x!==b._v$11&&y.style.setProperty("left",b._v$11=x),k!==b._v$12&&y.style.setProperty("top",b._v$12=k),b},{_v$11:void 0,_v$12:void 0}),y})()}})})}),this.click=()=>{if(t.selectedRoofPlaneById==null){let o=c();o!=null&&i("selectedRoofPlaneById",o.id)}else if(t.selectedDividePoint==null){let o=g();o!=null&&i("selectedDividePoint",o)}}}}Ut(["keyup"]);const Fd=Z('<div style="position: absolute; left: 0; top: 0; padding-left: 5px;"></div>'),Ld=Z('<div style="flex-grow: 1; display: flex; flex-direction: column;"><div><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Reset"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Make Block"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Flip Arrow"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Assign Roof Plane to Block"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Unassign Roof Plane from Block"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Divide Roof Plane"><input class="btn btn-primary" type="button" style="margin-left: 10px" value="Divide Roof Plane At Dist"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Undivide Roof Plane"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Delete"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Measure"><input class="btn btn-primary" type="button" style="margin-left: 10px;" value="Zoom Extents"></div><div style="flex-grow: 1; display: flex; flex-direction: column; position: relative;"></div></div>'),zd=Z('<svg><path stroke="none" pointer-events="none"></path></svg>',4,!0),ll=Z('<svg><path fill="transparent" stroke="black" style="vector-effect: non-scaling-stroke;" pointer-events="none"></path></svg>',4,!0),jd=Z('<svg><line stroke="black" vector-effect="non-scaling-stroke" stroke-dasharray="10,4"></line></svg>',4,!0),Vd=Z('<svg><text text-anchor="middle" dominant-baseline="middle" font-size="12" pointer-events="none"></text></svg>',4,!0),Ud=Z('<svg><rect stroke="black" style="vector-effect: non-scaling-stroke;" pointer-events="none"></rect></svg>',4,!0),Yd=Z('<svg><text font-size="12" dominant-baseline="text-top"></text></svg>',4,!0),Kd=Z('<svg><text font-size="12" text-anchor="middle" dominant-baseline="middle"></text></svg>',4,!0);function Yl(){return{roofPlanes:[],blocks:[],roofPlaneBlockAssignments:[]}}function Xd(n){let e=n;return e.roofPlanes.length==0&&e.blocks.length==0}let Gd=bn(({x:n,y:e})=>ae.create(n,e),n=>({x:n.x,y:n.y}),{type:"Object",properties:{x:{displayName:"X",typeSchema:{type:"Number"},defaultValue:0},y:{displayName:"Y",typeSchema:{type:"Number"},defaultValue:0}}}),Hd=bn(({x:n,y:e,z:t})=>C.create(n,e,t),n=>({x:n.x,y:n.y,z:n.z}),{type:"Object",properties:{x:{displayName:"X",typeSchema:{type:"Number"},defaultValue:0},y:{displayName:"Y",typeSchema:{type:"Number"},defaultValue:0},z:{displayName:"Z",typeSchema:{type:"Number"},defaultValue:0}}}),Wd=bn(({w:n,x:e,y:t,z:i})=>new we(n,e,t,i),n=>({w:n.w,x:n.x,y:n.y,z:n.z}),{type:"Object",properties:{w:{displayName:"W",typeSchema:{type:"Number"},defaultValue:1},x:{displayName:"X",typeSchema:{type:"Number"},defaultValue:0},y:{displayName:"Y",typeSchema:{type:"Number"},defaultValue:0},z:{displayName:"Z",typeSchema:{type:"Number"},defaultValue:0}}}),Qd=bn(({origin:n,orientation:e})=>he.create(n,e),n=>({origin:n.origin,orientation:n.orientation}),{type:"Object",properties:{origin:{displayName:"Origin",typeSchema:Hd,defaultValue:C.zero},orientation:{displayName:"Orientation",typeSchema:Wd,defaultValue:we.identity}}}),qd={type:"Object",properties:{id:{displayName:"Id",typeSchema:{type:"String"},defaultValue:""},stackSheetDirection:{displayName:"Stack Sheet Direction",typeSchema:{type:"String",possibleValues:["Left","Right"]},defaultValue:"Right",optional:!0},splitLocations:{displayName:"Split Locations",typeSchema:{type:"Array",elemTypeSchema:{type:"Number"}},defaultValue:[],optional:!0}}},Zd={type:"Object",properties:{id:{displayName:"Id",typeSchema:{type:"String"},defaultValue:""},length:{displayName:"Length",typeSchema:{type:"Number"},defaultValue:0},height:{displayName:"Height",typeSchema:{type:"Number"},defaultValue:0},space:{displayName:"Space",typeSchema:Qd,defaultValue:he.identity},colour:{displayName:"Colour",typeSchema:{type:"String"},defaultValue:""}}},Jd={type:"Object",properties:{roofPlaneId:{displayName:"Roof Plane Id",typeSchema:{type:"String"},defaultValue:""},splitIndex:{displayName:"Split Index",typeSchema:{type:"Number"},defaultValue:0},blockId:{displayName:"Block Id",typeSchema:{type:"String"},defaultValue:""},offset:{displayName:"Offset",typeSchema:Gd,defaultValue:ae.zero}}},Kl={roofPlanes:{displayName:"Roof Planes",typeSchema:{type:"Array",elemTypeSchema:qd},defaultValue:[]},blocks:{displayName:"Blocks",typeSchema:{type:"Array",elemTypeSchema:Zd},defaultValue:[]},roofPlaneBlockAssignments:{displayName:"Roof Plane Block Assignments",typeSchema:{type:"Array",elemTypeSchema:Jd},defaultValue:[]}};function eu(n){return _s(Kl,n)}function tu(n){return Zi(Kl,n)}const nu=n=>{let[e,t]=Ne({mousePos:void 0,selectedRoofPlaneById:void 0,selectedBlockById:void 0,mkMode:void 0}),[i,c]=Ne(Nn());Rt(()=>{let z=[];for(let ne of n.roofPlanes)n.roofBlockCutListData.roofPlanes.some(Be=>Be.id==ne.id)||z.push({id:ne.id,stackSheetDirection:"Right",splitLocations:[]});let q={},ge=!1;for(let ne of n.roofBlockCutListData.roofPlanes)n.roofPlanes.some(Be=>Be.id==ne.id)||(q[ne.id]=!0,ge=!0);(z.length!=0||ge)&&n.setRoofBlockCutListData("roofPlanes",[...n.roofBlockCutListData.roofPlanes.filter(ne=>q[ne.id]!==!0),...z])});let m=z=>{let q=z.outline;if(z.splitIndex>0){let ge=z.splitLocations[z.splitIndex-1];q=nl(q.map(ne=>ne.toVec3()),Re.fromKnownPtAndNormal(C.create(ge,0,0),C.unitX)).positive.map(ne=>ne.xy())}if(z.splitIndex<z.splitLocations.length){let ge=z.splitLocations[z.splitIndex];q=nl(q.map(ne=>ne.toVec3()),Re.fromKnownPtAndNormal(C.create(ge,0,0),C.negUnitX)).positive.map(ne=>ne.xy())}return q},g=v(()=>n.roofPlanes.map(z=>{let q=n.roofBlockCutListData.roofPlanes.find(Oe=>Oe.id==z.id),ge=z.kit.state.pitch*Math.PI/180,ne=Math.cos(ge),be=Math.sin(ge),Be=q?.splitLocations??[],ke=[];for(let Oe=0;Oe<Be.length+1;++Oe)ke.push(m({splitLocations:Be,outline:z.kit.state.vertices,splitIndex:Oe}));return{id:z.id,stackSheetDirection:q?.stackSheetDirection??"Right",splitLocations:q?.splitLocations??[],outline:z.kit.state.vertices,space:z.space.fromThisSpace(he.create(C.create(0,0,z.kit.state.heightOffGround),we.fromWU(C.create(0,-be,ne),C.unitX))),splitOutlines:ke}})),[h,l]=st(void 0),a=v(()=>{let z=e.mousePos;if(z==null)return;let q=i.panX+z.x/i.scale,ge=-i.panY-z.y/i.scale;return Xe.create(C.create(q,ge,1e5),C.negUnitZ)}),f=()=>new gd({mouseRay:a,roofPlanes:g,blocks:()=>n.roofBlockCutListData.blocks,setSelectedRoofPlaneById:z=>t("selectedRoofPlaneById",z),setSelectedBlockById:z=>t("selectedBlockById",z),setBlockPos:(z,q)=>{let ge=n.roofBlockCutListData.blocks.findIndex(ne=>ne.id===z);ge!=-1&&n.setRoofBlockCutListData("blocks",ge,"space",he.create(q,n.roofBlockCutListData.blocks[ge].space.orientation))}}),d=v(()=>e.mkMode==null?f():e.mkMode()),o=v(()=>{let z=d();return z.instructions?.call(z)}),u=v(()=>{let z=d();return z.highlightedRoofPlanes?.call(z)??[]}),s=v(()=>{let z=d();return z.highlightedBlocksById?.call(z)??[]}),r=v(()=>{let z=d();return z.overlay?.call(z)}),p=v(()=>{let z=d();return z.overlayUI?.call(z)}),y=v(()=>{let z=d();return z.cursor?.call(z)??"auto"}),_=v(()=>{let z=d();return z.disablePan?.call(z)??!1});v(()=>{if(e.selectedRoofPlaneById!=null)return n.roofBlockCutListData.roofPlanes.find(z=>z.id===e.selectedRoofPlaneById)});let w=new Ml({state:i,setState:c,disablePan:_}),S=z=>w.worldPtToScreenPt(z.xy()),b=v(()=>{let z=n.roofBlockCutListData.roofPlaneBlockAssignments,q={},ge=g();for(let ne of ge){let be=ne.id,Be=z.filter(ke=>ke.roofPlaneId==be);for(let ke of Be){if(ke.splitIndex>=ne.splitOutlines.length)continue;let Oe={roofPlaneId:be,splitIndex:ke.splitIndex,offset:ke.offset,outline:ne.splitOutlines[ke.splitIndex]},Je=q[ke.blockId];Je==null?(Je=[Oe],q[ke.blockId]=Je):Je.push(Oe)}}return q}),x=z=>{t("mkMode",()=>z)},k=()=>{t("mkMode",void 0)},I=()=>{if(window.confirm("Are you sure you wish to start again?")===!0){let z=[];for(let q of n.roofPlanes)z.push({id:q.id,stackSheetDirection:"Right",splitLocations:[]});n.setRoofBlockCutListData(Jn({...Yl(),roofPlanes:z}))}},D=()=>{x(()=>new vd({mouseRay:a,roofPlanes:g,addBlock:z=>{n.setRoofBlockCutListData("blocks",[...n.roofBlockCutListData.blocks,z])}}))},Y=v(()=>e.selectedRoofPlaneById!=null),Q=()=>{if(e.selectedRoofPlaneById==null)return;let z=n.roofBlockCutListData.roofPlanes.findIndex(q=>q.id===e.selectedRoofPlaneById);n.setRoofBlockCutListData("roofPlanes",z,"stackSheetDirection",n.roofBlockCutListData.roofPlanes[z].stackSheetDirection=="Left"?"Right":"Left")},N=()=>{$e(()=>{t("selectedRoofPlaneById",void 0),t("selectedBlockById",void 0)}),x(()=>new Sd({svgScale:()=>i.scale,projectPointToScreen:S,mouseRay:a,roofPlanes:g,blocks:()=>n.roofBlockCutListData.blocks,roofPlaneBlockAssignments:()=>n.roofBlockCutListData.roofPlaneBlockAssignments,assignRoofPlaneToBlock:({roofPlaneId:z,splitIndex:q,blockId:ge,offset:ne})=>{n.setRoofBlockCutListData("roofPlaneBlockAssignments",[...n.roofBlockCutListData.roofPlaneBlockAssignments.filter(be=>!(be.roofPlaneId==z&&be.splitIndex==q)),{roofPlaneId:z,splitIndex:q,blockId:ge,offset:ne}]);{let be=Number.POSITIVE_INFINITY,Be=Number.NEGATIVE_INFINITY,ke=Number.POSITIVE_INFINITY,Oe=Number.NEGATIVE_INFINITY,Je=b()[ge]??[];for(let De of Je){let We=n.roofBlockCutListData.roofPlanes.find(Ue=>Ue.id==De.roofPlaneId);for(let Ue of De.outline){let Ye;We?.stackSheetDirection=="Right"?Ye=Ue:Ye=ae.create(-Ue.x,-Ue.y);let at=Ye.add(De.offset);be=Math.min(be,at.x),Be=Math.max(Be,at.x),ke=Math.min(ke,at.y),Oe=Math.max(Oe,at.y)}}if(Number.isFinite(be)){let De=ae.create(-be,-ke);Math.abs(De.length())>.001&&n.setRoofBlockCutListData("roofPlaneBlockAssignments",n.roofBlockCutListData.roofPlaneBlockAssignments.map(Ue=>Ue.blockId!=ge?Ue:{...Ue,offset:Ue.offset.add(De)}));let We=n.roofBlockCutListData.blocks.findIndex(Ue=>Ue.id==ge);if(We!=-1){let Ue=Be-be,Ye=Oe-ke;$e(()=>{Math.abs(n.roofBlockCutListData.blocks[We].length-Ue)>.001&&n.setRoofBlockCutListData("blocks",We,"length",Ue),Math.abs(n.roofBlockCutListData.blocks[We].height-Ye)>.001&&n.setRoofBlockCutListData("blocks",We,"height",Ye)})}}}}}))},oe=v(()=>e.selectedRoofPlaneById==null?!1:n.roofBlockCutListData.roofPlaneBlockAssignments.some(z=>z.roofPlaneId===e.selectedRoofPlaneById)),ue=()=>{if(e.selectedRoofPlaneById==null)return;let z=new Set;for(let q of n.roofBlockCutListData.roofPlaneBlockAssignments)q.roofPlaneId===e.selectedRoofPlaneById&&z.add(q.blockId);n.setRoofBlockCutListData("roofPlaneBlockAssignments",n.roofBlockCutListData.roofPlaneBlockAssignments.filter(q=>q.roofPlaneId!==e.selectedRoofPlaneById));for(let q of z){let ge=Number.POSITIVE_INFINITY,ne=Number.NEGATIVE_INFINITY,be=Number.POSITIVE_INFINITY,Be=Number.NEGATIVE_INFINITY,ke=b()[q]??[];for(let Oe of ke){let Je=n.roofBlockCutListData.roofPlanes.find(De=>De.id==Oe.roofPlaneId);for(let De of Oe.outline){let We;Je?.stackSheetDirection=="Right"?We=De:We=ae.create(-De.x,-De.y);let Ue=We.add(Oe.offset);ge=Math.min(ge,Ue.x),ne=Math.max(ne,Ue.x),be=Math.min(be,Ue.y),Be=Math.max(Be,Ue.y)}}if(Number.isFinite(ge)){let Oe=ae.create(-ge,-be);Math.abs(Oe.length())>.001&&n.setRoofBlockCutListData("roofPlaneBlockAssignments",n.roofBlockCutListData.roofPlaneBlockAssignments.map(De=>De.blockId!=q?De:{...De,offset:De.offset.add(Oe)}));let Je=n.roofBlockCutListData.blocks.findIndex(De=>De.id==q);if(Je!=-1){let De=ne-ge,We=Be-be;$e(()=>{Math.abs(n.roofBlockCutListData.blocks[Je].length-De)>.001&&n.setRoofBlockCutListData("blocks",Je,"length",De),Math.abs(n.roofBlockCutListData.blocks[Je].height-We)>.001&&n.setRoofBlockCutListData("blocks",Je,"height",We)})}}}},J=z=>{let{roofPlaneId:q,splitLocation:ge}=z,ne=n.roofBlockCutListData.roofPlanes.findIndex(be=>be.id==q);ne!=-1&&$e(()=>{let be=[...n.roofBlockCutListData.roofPlanes[ne].splitLocations,ge].sort((ke,Oe)=>ke-Oe);n.setRoofBlockCutListData("roofPlanes",ne,"splitLocations",be);let Be=be.indexOf(ge);Be!=-1&&n.setRoofBlockCutListData("roofPlaneBlockAssignments",n.roofBlockCutListData.roofPlaneBlockAssignments.map(ke=>ke.roofPlaneId!=q||ke.splitIndex<=Be?ke:{...ke,splitIndex:ke.splitIndex+1}))})},_e=()=>{x(()=>new Id({svgScale:()=>i.scale,projectPointToScreen:S,mousePos:()=>e.mousePos,mouseRay:a,roofPlanes:g,cutRoofPlane:J}))},Te=()=>{x(()=>new Bd({svgScale:()=>i.scale,projectPointToScreen:S,mousePos:()=>e.mousePos,mouseRay:a,roofPlanes:g,cutRoofPlane:J}))},se=v(()=>{if(e.selectedRoofPlaneById==null)return!1;let z=n.roofBlockCutListData.roofPlanes.find(q=>q.id==e.selectedRoofPlaneById);return z==null?!1:z.splitLocations.length!=0}),ee=()=>{if(e.selectedRoofPlaneById==null)return;let z=n.roofBlockCutListData.roofPlanes.findIndex(q=>q.id===e.selectedRoofPlaneById);n.setRoofBlockCutListData("roofPlanes",z,"splitLocations",[])},F=v(()=>e.selectedBlockById!==void 0),L=()=>{if(e.selectedBlockById==null)return;let z=e.selectedBlockById;$e(()=>{n.setRoofBlockCutListData("blocks",n.roofBlockCutListData.blocks.filter(q=>q.id!==z)),t("selectedBlockById",void 0)})},$=()=>{x(()=>new Cd({svgScale:()=>i.scale,projectPointToScreen:S,mousePos:()=>e.mousePos,roofPlanes:g,blocks:()=>n.roofBlockCutListData.blocks,roofPlaneBlockAssignments:()=>n.roofBlockCutListData.roofPlaneBlockAssignments,onDone:()=>k()}))},W=()=>{let z=ve(()=>h());if(z==null)return;let q=z.clientWidth,ge=z.clientHeight,ne=Number.POSITIVE_INFINITY,be=Number.NEGATIVE_INFINITY,Be=Number.POSITIVE_INFINITY,ke=Number.NEGATIVE_INFINITY,Oe=Ye=>{ne=Math.min(ne,Ye.x),be=Math.max(be,Ye.x),Be=Math.min(Be,Ye.y),ke=Math.max(ke,Ye.y)},Je=g();for(let Ye of Je)for(let at of Ye.outline){let pe=Ye.space.pointFromThisSpace(at.toVec3());Oe(pe)}for(let Ye of n.roofBlockCutListData.blocks){{let at=Ye.space.pointFromThisSpace(C.zero);Oe(at)}{let at=Ye.space.pointFromThisSpace(C.create(Ye.length,0,0));Oe(at)}{let at=Ye.space.pointFromThisSpace(C.create(Ye.length,Ye.height,0));Oe(at)}{let at=Ye.space.pointFromThisSpace(C.create(0,Ye.height,0));Oe(at)}}if(!Number.isFinite(ne))return;let De=.7*Math.min(q/(be-ne),ge/(ke-Be)),We=ne-.5*(q/De-(be-ne)),Ue=-ke-.5*(ge/De-(ke-Be));$e(()=>{c("panX",We),c("panY",Ue),c("scale",De)})};re(()=>{h()!=null&&ve(()=>W())});let te=w.mouseAndTouchEventHandlers(),xe={...te,onMouseMove:z=>{t("mousePos",ae.create(z.offsetX,z.offsetY)),te.onMouseMove(z)},onMouseDown:z=>{let q=d();q.mouseDown!=null&&q.mouseDown(),te.onMouseDown(z)},onMouseUp:z=>{let q=d();q.mouseUp!=null&&q.mouseUp(),q.click!=null&&q.click(),te.onMouseUp(z)}};{let z,q=ne=>{t("mousePos",void 0)},ge=()=>{z!=null&&(z.removeEventListener("mouseout",q),z=void 0)};re(()=>{let ne=h();ge(),ne?.addEventListener("mouseout",q),z=ne}),Ce(()=>{ge()})}let Pe=z=>{z.key=="Escape"?k():z.key=="Delete"&&L()};return document.addEventListener("keydown",Pe),Ce(()=>{document.removeEventListener("keydown",Pe)}),(()=>{const z=Ld.cloneNode(!0),q=z.firstChild,ge=q.firstChild,ne=ge.nextSibling,be=ne.nextSibling,Be=be.nextSibling,ke=Be.nextSibling,Oe=ke.nextSibling,Je=Oe.nextSibling,De=Je.nextSibling,We=De.nextSibling,Ue=We.nextSibling,Ye=Ue.nextSibling,at=q.nextSibling;return ge.$$click=()=>I(),ne.$$click=()=>D(),be.$$click=()=>Q(),Be.$$click=()=>N(),ke.$$click=()=>ue(),Oe.$$click=()=>_e(),Je.$$click=()=>Te(),De.$$click=()=>ee(),We.$$click=()=>L(),Ue.$$click=()=>$(),Ye.$$click=()=>W(),ie(at,U(tt,{get when(){return o()!==void 0},get children(){const pe=Fd.cloneNode(!0);return ie(pe,o),pe}}),null),ie(at,U(Pi,tr({gridScale:1e3,showGrid:!0,fontSize:12,state:i,get style(){return{"flex-grow":"1",cursor:y()}},onRefSvg:pe=>l(pe)},xe,{get children(){return[U(kt,{get each(){return g()},children:pe=>{if(pe.outline.length<3)return;let Xt=v(()=>{let vt=[],bt=pe.splitOutlines,xt=n.roofBlockCutListData.roofPlaneBlockAssignments.filter(Qe=>Qe.roofPlaneId==pe.id);for(let Qe=0;Qe<bt.length;++Qe){let fe=bt[Qe].map(Fe=>pe.space.pointFromThisSpace(Fe.toVec3())),dt="M"+fe[0].x+" "+-fe[0].y;for(let Fe=1;Fe<fe.length;++Fe)dt+=" L"+fe[Fe].x+" "+-fe[Fe].y;dt+=" Z";let it=Qe,ot=v(()=>{let Fe=xt.find(Lt=>Lt.splitIndex==it);if(Fe==null)return"transparent";let ct=Fe.blockId;return n.roofBlockCutListData.blocks.find(Lt=>Lt.id==ct)?.colour??"transparent"}),ut=v(()=>pe.id===e.selectedRoofPlaneById),Ve=v(()=>u().some(Fe=>pe.id==Fe.roofPlaneId&&(Fe.splitIndices==null||Fe.splitIndices.includes(Qe))));vt.push((()=>{const Fe=zd.cloneNode(!0);return K(Fe,"d",dt),ce(()=>K(Fe,"fill",ut()?"green":Ve()?"blue":ot())),Fe})())}{let Qe=pe.outline.map(fe=>pe.space.pointFromThisSpace(fe.toVec3())),Me="M"+Qe[0].x+" "+-Qe[0].y;for(let fe=1;fe<Qe.length;++fe)Me+=" L"+Qe[fe].x+" "+-Qe[fe].y;Me+=" Z",vt.push((()=>{const fe=ll.cloneNode(!0);return K(fe,"d",Me),fe})())}return vt});return[Nt(Xt),U(kt,{get each(){return pe.splitLocations},children:vt=>{let bt=Fi(pe.outline,vt);if(bt==null)return;let{minY:xt,maxY:Qe}=bt,Me=pe.space.pointFromThisSpace(C.create(vt,xt,0)),fe=pe.space.pointFromThisSpace(C.create(vt,Qe,0));return(()=>{const dt=jd.cloneNode(!0);return ce(it=>{const ot=Me.x,ut=-Me.y,Ve=fe.x,Fe=-fe.y;return ot!==it._v$6&&K(dt,"x1",it._v$6=ot),ut!==it._v$7&&K(dt,"y1",it._v$7=ut),Ve!==it._v$8&&K(dt,"x2",it._v$8=Ve),Fe!==it._v$9&&K(dt,"y2",it._v$9=Fe),it},{_v$6:void 0,_v$7:void 0,_v$8:void 0,_v$9:void 0}),dt})()}})]}}),U(kt,{get each(){return g()},children:pe=>{if(pe.outline.length<3)return;let Xt=v(()=>{let vt=[],bt=n.roofBlockCutListData.roofPlaneBlockAssignments.filter(xt=>xt.roofPlaneId==pe.id);for(let xt=0;xt<pe.splitOutlines.length;++xt){let Qe=pe.splitOutlines[xt],Me,fe;{let ot=Number.POSITIVE_INFINITY,ut=Number.NEGATIVE_INFINITY,Ve=Number.POSITIVE_INFINITY,Fe=Number.NEGATIVE_INFINITY;for(let ft of Qe)ot=Math.min(ot,ft.x),ut=Math.max(ut,ft.x),Ve=Math.min(Ve,ft.y),Fe=Math.max(Fe,ft.y);let ct=.5*(ot+ut),Ft=Fi(Qe,ct),Lt=Ft!=null?.5*(Ft.minY+Ft.maxY):.5*(Ve+Fe);Me=pe.space.pointFromThisSpace(ae.create(ct,Lt).toVec3()).xy(),fe=Math.atan2(-pe.space.u.y,pe.space.u.x)*180/Math.PI}let dt=xt,it=v(()=>{let ot=bt.find(ct=>ct.splitIndex==dt);if(ot==null)return"";let ut=ot.blockId,Ve=b()[ut].findIndex(({roofPlaneId:ct,splitIndex:Ft})=>ct==pe.id&&Ft==dt);if(Ve==-1)return"";let Fe=n.roofBlockCutListData.blocks.findIndex(ct=>ct.id==ut);return Fe==-1?"":Io(Fe)+Ve});vt.push((()=>{const ot=Vd.cloneNode(!0);return ie(ot,U(yi,{get fallback(){return it()+"\u2192"},get children(){return U(qt,{get when(){return pe.stackSheetDirection=="Left"},get children(){return it()+"\u2190"}})}})),ce(()=>K(ot,"transform","translate("+Me.x+" "+-Me.y+") rotate("+fe+") scale(100.0)")),ot})())}return vt});return Nt(Xt)}}),U(kt,{get each(){return n.roofBlockCutListData.blocks},children:(pe,Xt)=>{let vt=v(()=>pe.id===e.selectedBlockById),bt=v(()=>s().some(Me=>pe.id==Me)),xt=v(()=>{let Me=b()[pe.id];return Me??[]}),Qe=v(()=>Io(Xt()));return[(()=>{const Me=Ud.cloneNode(!0);return ce(fe=>{const dt=pe.space.o.x,it=-pe.space.o.y-pe.height,ot=pe.length,ut=pe.height,Ve=vt()?"green":bt()?"blue":pe.colour;return dt!==fe._v$10&&K(Me,"x",fe._v$10=dt),it!==fe._v$11&&K(Me,"y",fe._v$11=it),ot!==fe._v$12&&K(Me,"width",fe._v$12=ot),ut!==fe._v$13&&K(Me,"height",fe._v$13=ut),Ve!==fe._v$14&&K(Me,"fill",fe._v$14=Ve),fe},{_v$10:void 0,_v$11:void 0,_v$12:void 0,_v$13:void 0,_v$14:void 0}),Me})(),(()=>{const Me=Yd.cloneNode(!0);return ie(Me,()=>Math.ceil(pe.length/762)+" @ "+Math.ceil(pe.height)+"mm"),ce(()=>K(Me,"transform","translate("+pe.space.o.x+" "+(-pe.space.o.y+1e3)+") scale(80)")),Me})(),U(kt,{get each(){return xt()},children:(Me,fe)=>{let dt=v(()=>n.roofBlockCutListData.roofPlanes.find(Ve=>Ve.id==Me.roofPlaneId)),it=v(()=>{let Ve=dt(),Fe;Ve==null||Ve.stackSheetDirection=="Right"?Fe=Me.outline:Fe=Me.outline.map(ft=>ae.create(-ft.x,-ft.y));let ct=Fe.map(ft=>ft.add(Me.offset).add(pe.space.o.xy())),Ft;{let ft=Number.POSITIVE_INFINITY,tn=Number.NEGATIVE_INFINITY,Fn=Number.POSITIVE_INFINITY,wn=Number.NEGATIVE_INFINITY;for(let Pn of ct)ft=Math.min(ft,Pn.x),tn=Math.max(tn,Pn.x),Fn=Math.min(Fn,Pn.y),wn=Math.max(wn,Pn.y);let Ln=.5*(ft+tn),mn=Fi(ct,Ln),Sn=mn!=null?.5*(mn.minY+mn.maxY):.5*(Fn+wn);Ft=ae.create(Ln,Sn)}let Lt="M"+ct[0].x+" "+-ct[0].y;for(let ft=1;ft<ct.length;++ft)Lt+=" L"+ct[ft].x+" "+-ct[ft].y;return Lt+=" Z",{pathCmdStr:Lt,labelPos:Ft}}),ot=()=>it().pathCmdStr,ut=()=>it().labelPos;return[(()=>{const Ve=ll.cloneNode(!0);return ce(()=>K(Ve,"d",ot())),Ve})(),(()=>{const Ve=Kd.cloneNode(!0);return ie(Ve,()=>Qe()+fe()),ce(()=>K(Ve,"transform","translate("+ut().x+" "+-ut().y+") scale(80)")),Ve})()]}})]}}),Nt(()=>r())]}})),null),ie(at,p,null),ce(pe=>{const Xt=!Y(),vt=n.roofBlockCutListData.blocks.length==0,bt=!oe(),xt=!se(),Qe=!F();return Xt!==pe._v$&&(be.disabled=pe._v$=Xt),vt!==pe._v$2&&(Be.disabled=pe._v$2=vt),bt!==pe._v$3&&(ke.disabled=pe._v$3=bt),xt!==pe._v$4&&(De.disabled=pe._v$4=xt),Qe!==pe._v$5&&(We.disabled=pe._v$5=Qe),pe},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),z})()};Ut(["click"]);const iu=Z('<div style="min-width: 200px; display: flex; flex-direction: column;"></div>'),rl=5,ou=rl*rl,sl=.001,Ui=sl*sl;let mi;async function lu(){return mi!=null||(mi=await nr(()=>import("./auto_roofing.f0526109.js"),["auto_roofing.f0526109.js","Vec3.ce1f4f7a.js","Component.6024a649.js","index.5aba22ff.js","index.8628b9c4.css","utils.6e3ab489.js","Plane3D.472a05fa.js","Component.fa73bdbc.js","PropertiesForm.c69fa44e.js"],import.meta.url)),mi}class ru{constructor(e){let[t,i]=Ne({heightOffGround:2400,pitch:22}),c=v(()=>{let h=[],l={};for(let a of e.existingLines()){if(l[a.id]!=null)continue;l[a.id]=!0;let f=a.line.v1,d=a.line.v2,o=[f],u=[a.id];for(;;){let s=!1;for(let r of e.existingLines())r.id!=a.id&&l[r.id]==null&&(r.line.v1.distanceSquared(d)<=Ui?(l[r.id]=!0,o.push(d),u.push(r.id),d=r.line.v2,s=!0):r.line.v2.distanceSquared(d)<=Ui&&(l[r.id]=!0,o.push(d),u.push(r.id),d=r.line.v1,s=!0));if(d.distanceSquared(f)<=Ui&&o.length>=3){let r=0;for(let p=0;p<o.length;++p){let y=(p+1)%o.length;r+=.5*o[p].xy().cross(o[y].xy())}r<0&&(o.reverse(),u.reverse()),h.push({ring:o,objectIds:u});break}if(!s)break}}return h}),m=v(()=>{let h=e.mousePos();if(h==null)return;let l=e.mouseRay();if(l==null)return;let a,f;for(let{ring:d,objectIds:o}of c())for(let u=0;u<d.length;++u){let s=(u+1)%d.length,r=et.create(d[u],d[s]),p=Xe.create(r.v1,r.v2.sub(r.v1)),y=l.closestTimeOnThisRayWithOtherRay(p);if(y==null)continue;let _=l.positionFromTime(y),w=Math.max(0,Math.min(1,p.closestTimeToPoint(_))),S=p.positionFromTime(w),b=e.projectPtToScreen(S);if(b==null)continue;let x=h.distanceSquared(b);x>ou||(a==null||x<a)&&(a=x,f={ring:d,objectIds:o})}return f});this.instructions=v(()=>"Click on the outline to create roof from.");let g=v(()=>[{displayName:"Properties",fields:[un({displayName:()=>"Height Off Ground",value:()=>t.heightOffGround,setValue:h=>i("heightOffGround",h)}),un({displayName:()=>"Pitch",value:()=>t.pitch,setValue:h=>i("pitch",h)})],expanded:()=>!0}]);this.sideForm=()=>(()=>{const h=iu.cloneNode(!0);return ie(h,U(ni,{style:"border: black; border-width: 1px; width: 100%;",get fieldGroups(){return g()}})),h})(),this.highlightedObjectsById=v(()=>nt(m()).flatMap(({objectIds:h})=>h)),this.click=async()=>{let h=m();if(h==null)return;let l=await lu(),a=h.ring.map(d=>d.xy()),f=l.computeHipRoofing([...a,a[0]],[],t.heightOffGround,t.pitch);e.insertRoofPlanes(f)}}}class su{constructor(e){let[t,i]=Ne({selectedFromPt:void 0}),c=v(()=>{if(t.selectedFromPt!=null)return[];let f=e.cameraFacingDir();if(f==null)return[];let d=f;return e.walls().flatMap(o=>o.points.flatMap(u=>{let s;return d.direction.dot(o.space.v)>0?s=o.space.pointFromThisSpace(C.create(u.location.x,0,u.location.y)):s=o.space.pointFromThisSpace(C.create(u.location.x,o.thickness,u.location.y)),[s].map(r=>({pt:r,wall:o,point:u}))}))}),m=v(()=>{if(t.selectedFromPt==null)return[];let f=e.cameraFacingDir();if(f==null)return[];let d=f,o=t.selectedFromPt.wall;return o.points.flatMap(u=>{let s;return d.direction.dot(o.space.v)>0?s=o.space.pointFromThisSpace(C.create(u.location.x,0,u.location.y)):s=o.space.pointFromThisSpace(C.create(u.location.x,o.thickness,u.location.y)),[s].map(r=>({pt:r,pointId:u.id}))})});function g(f,d){let o=e.mouseRay();if(o==null)return;let u;for(let s of d){let r=f(s),p=o.closestTimeToPoint(r);if(p<=0)continue;let y=o.positionFromTime(p),_=e.projectPtToScreen(r),w=e.projectPtToScreen(y);if(_==null||w==null||_.distanceSquared(w)>10*10)continue;let S=p;(u==null||S<u.dist)&&(u={point:s,dist:S})}return u?.point}let h=v(()=>g(f=>f.pt,c())),l=v(()=>g(f=>f.pt,m()));this.instructions=()=>{};let a=new ml({color:"green",transparent:!0,opacity:.5});Ce(()=>{a.dispose()}),this.overlayObject3d=v(()=>{if(t.selectedFromPt==null)return;let f=t.selectedFromPt.wall,d=Re.fromKnownPtAndNormal(f.space.pointFromThisSpace(C.create(0,.5*f.thickness,0)),f.space.v),o=e.mouseRay();if(o==null)return;let u=o.collisionTimeWithPlane(d);if(u==null||u<0)return;let s=o.positionFromTime(u),r=f.space.pointToThisSpace(s),p=ae.create(r.x,r.z),y=p.sub(t.selectedFromPt.point.location).normalize();if(!Number.isFinite(y.x))return;let _=p.sub(t.selectedFromPt.point.location).dot(y),w=.001,S=new Pt(_*w,30*w,80*w),b=new Ze(S,a),x=f.space.pointFromThisSpace(C.create(t.selectedFromPt.point.location.x,40,t.selectedFromPt.point.location.y)),k=f.space.vectorFromThisSpace(C.create(y.x,0,y.y)),I=x.add(k.scale(.5*_));b.position.set(I.x*w,I.y*w,I.z*w);let D=we.fromWU(f.space.v,k);return b.quaternion.set(D.x,D.y,D.z,D.w),Ce(()=>{S.dispose()}),b}),this.snapPoints=v(()=>[...c().map(f=>({pt:()=>f.pt,highlighted:v(()=>f==h())})),...m().map(f=>({pt:()=>f.pt,highlighted:v(()=>f==l())}))]),this.click=()=>{if(t.selectedFromPt==null){let f=h();f!=null&&i("selectedFromPt",f)}else{let f=l();f!=null&&(e.insertBrace({wallLocation:t.selectedFromPt.wall.location,fromId:t.selectedFromPt.point.id,toId:f.pointId}),i("selectedFromPt",void 0))}}}}const au=Z('<div><input type="button" value="Flip"><br><div>Offset:<input type="text" value="0" size="5"></div></div>');class du{constructor(e){let[t,i]=Ne({objectToMove:void 0,afterAlign:void 0,wipOffsetKit:void 0}),c=l=>{if(t.objectToMove==null)return;let a=t.objectToMove,f=t.objectToMove.normal;if(!Number.isFinite(f.x))return;let d=l.normal;if(!Number.isFinite(d.x))return;let o=d.scale(l.pt.sub(a.pt).dot(d)),u=Math.acos(Math.max(-1,Math.min(1,f.dot(d))));u>.5*Math.PI&&(u+=Math.PI,u>Math.PI&&(u-=2*Math.PI));let s=f.cross(d).normalize();Number.isFinite(s.x)||(s=C.unitX);let r=e.getKitSpace(a.kitId),p=S=>he.create(a.pt.add(o.scale(S)),we.identity).fromThisSpace(he.create(C.zero,we.fromAxisAngle(s,S*u*180/Math.PI)).fromThisSpace(he.create(a.pt.scale(-1),we.identity).fromThisSpace(r))),y=p(1),_,w=S=>{_==null&&(_=S);let b=2*(S-_)*.001;if(b>=1)e.setKitSpace(a.kitId,y),i("afterAlign",{lastRotationAxis:s,targetKitId:l.kitId,targetPt:l.pt,targetNormal:l.normal});else{let x=p(b);e.setKitSpace(a.kitId,x),requestAnimationFrame(w)}};requestAnimationFrame(w)},m=()=>{if(t.objectToMove==null||t.afterAlign==null)return;let l=t.objectToMove,a=t.afterAlign.lastRotationAxis,f=Math.PI,d=e.getKitSpace(l.kitId),o=t.afterAlign.targetPt,u=y=>he.create(o,we.identity).fromThisSpace(he.create(C.zero,we.fromAxisAngle(a,y*f*180/Math.PI)).fromThisSpace(he.create(o.scale(-1),we.identity).fromThisSpace(d))),s=u(1),r,p=y=>{r==null&&(r=y);let _=2*(y-r)*.001;if(_>=1){if(e.setKitSpace(l.kitId,s),t.wipOffsetKit!=null){let w=t.wipOffsetKit;i("wipOffsetKit",void 0),g(w.dist)}}else{let w=u(_);e.setKitSpace(l.kitId,w),requestAnimationFrame(p)}};requestAnimationFrame(p)},g=l=>{if(t.objectToMove==null||t.afterAlign==null)return;let a;t.wipOffsetKit==null?(a=e.getKitSpace(t.objectToMove.kitId),i("wipOffsetKit",{oldTransform:a,dist:l})):a=t.wipOffsetKit.oldTransform;let f=he.create(a.origin.add(t.afterAlign.targetNormal.scale(l)),a.orientation);e.setKitSpace(t.objectToMove.kitId,f)},h=()=>{t.objectToMove!=null&&t.afterAlign!=null&&t.wipOffsetKit!=null&&e.onDone()};this.instructions=v(()=>t.objectToMove==null?"Select object to align.":t.afterAlign==null?"Select object to align to.":`Flip it if was the wrong plane side.
 Type an offset to offset it from the plane followed by enter.
 Or just press escape if done.`),this.overlayObject3d=v(()=>{let l=e.kitFaceUnderMouse();if(l==null||l.kitId==t.objectToMove?.kitId||l.kitId==t.afterAlign?.targetKitId)return;let a=.001,f=new Float32Array(9*l.faces.length),d=0,o=l.normal;for(let y of l.faces)f[d++]=(y.v1.x+o.x)*a,f[d++]=(y.v1.y+o.y)*a,f[d++]=(y.v1.z+o.z)*a,f[d++]=(y.v2.x+o.x)*a,f[d++]=(y.v2.y+o.y)*a,f[d++]=(y.v2.z+o.z)*a,f[d++]=(y.v3.x+o.x)*a,f[d++]=(y.v3.y+o.y)*a,f[d++]=(y.v3.z+o.z)*a;let u=new gl(f,3),s=new yl;s.setAttribute("position",u);let r=new wt({color:"blue",side:vl});return Ce(()=>{s.dispose(),r.dispose()}),new Ze(s,r)}),this.overlayUI=()=>{if(t.afterAlign==null)return;let l=t.afterAlign,a=v(()=>{if(t.objectToMove==null)return;let o=Re.fromKnownPtAndNormal(l.targetPt,l.targetNormal).closestPoint(t.objectToMove.pt);return e.projectPtToScreen(o)}),f;return Rt(()=>{f!=null&&(f.focus(),f.select(),g(0))}),U(je,{get when(){return a()},children:d=>(()=>{const o=au.cloneNode(!0),u=o.firstChild,s=u.nextSibling,r=s.nextSibling,p=r.firstChild,y=p.nextSibling;o.style.setProperty("position","absolute"),u.$$click=()=>{m(),f?.focus()},r.style.setProperty("background","white"),r.style.setProperty("border","solid 1px black"),y.$$keyup=w=>{w.key=="Enter"&&h()},y.$$input=w=>{let S=Number.parseFloat(w.currentTarget.value);!Number.isFinite(S)||g(S)};const _=f;return typeof _=="function"?At(_,y):f=y,ce(w=>{const S=d().x+"px",b=d().y+"px";return S!==w._v$&&o.style.setProperty("left",w._v$=S),b!==w._v$2&&o.style.setProperty("top",w._v$2=b),w},{_v$:void 0,_v$2:void 0}),o})()})},this.highlightedObjectsById=v(()=>[]),this.selectedObjectsById=v(()=>[]),this.click=()=>{if(t.objectToMove==null){let l=e.kitFaceUnderMouse();l!=null&&i("objectToMove",l)}else if(t.afterAlign==null){let l=e.kitFaceUnderMouse();l!=null&&l.kitId!=t.objectToMove.kitId&&c(l)}},this.cancel=()=>{t.wipOffsetKit!=null&&t.objectToMove!=null&&e.setKitSpace(t.objectToMove.kitId,t.wipOffsetKit.oldTransform)}}}Ut(["click","input","keyup"]);const uu=Z('<input type="text">');class cu{constructor(e){let t=()=>{let d=new vn({mouseRay:e.mouseRay,objects:v(()=>e.objects().map(o=>({id:o.id,rayCollisionTime:o.rayCollisionTime})))});return{type:"SelectingObjects",selector:d}},i=d=>{let o=new Set(d),u=C.zero,s=0,r=[];for(let p of ve(e.objects)){let y=p.id();if(o.has(y)){let _=ve(()=>e.cloneObject(y));_!=null&&(r.push({copyOfId:y,id:_.id(),initPosition:ve(()=>p.transform().origin)}),u=u.add(ve(()=>p.transform().origin)),++s)}}return s>0&&(u=u.scale(1/s)),{type:"Moving",movingObjectsById:r,fromPt:u}},[c,m]=Ne({mkMode:()=>e.initSelectedObjectIds!=null&&e.initSelectedObjectIds.length!=0?i(e.initSelectedObjectIds):t()}),g=v(()=>c.mkMode()),h=v(()=>{let d=g();return d.type!="Moving"?[]:[Xe.create(d.fromPt,C.unitX),Xe.create(d.fromPt,C.unitY),Xe.create(d.fromPt,C.unitZ)]}),l=v(()=>{let d=g();if(d.type!="Moving")return;let o=h();if(o.length==0)return;let u=e.mousePos();if(u==null)return;let s=e.mouseRay();if(s==null)return;let r;for(let p of o){let y=s.closestTimeOnThisRayWithOtherRay(p);if(y==null||y<0)continue;let _=s.positionFromTime(y),w=p.closestPoint(_),S=e.projectPtToScreen(w);if(S==null)continue;let b=S.distanceSquared(u);if(r==null||b<r.dist){let x=w.sub(d.fromPt),k=x.length(),I=d.fromPt.add(x.scale(Math.round(k)/k));r={dist:b,pt:I}}}return r?.pt});v(()=>{let d=g();if(d==null||d.type!="Moving")return[];let o=new Map;for(let u of ve(()=>e.objects()))o.set(u.id(),u);return d.movingObjectsById.flatMap(({copyOfId:u,id:s,initPosition:r})=>{let p=o.get(s);if(p==null)return[];let y=p;return[{copyOfId:u,id:s,finalTransform:y.transform(),setTransform:y.setTransform}]})}),re(()=>{let d=g();if(d==null||d.type!="Moving")return;let o=d,u=new Map;for(let s of ve(()=>e.objects()))u.set(s.id(),s);re(()=>{let s=l();if(s==null)return;let r=s.sub(o.fromPt);$e(()=>{for(let{id:p,initPosition:y}of o.movingObjectsById){let _=u.get(p);if(_==null)continue;let w=_;ve(()=>{w.setTransform(he.create(y.add(r),w.transform().orientation))})}})})}),this.instructions=v(()=>{switch(g().type){case"SelectingObjects":return"Select the objects you want to copy, then press Enter.";case"Moving":return"Move the mouse and click the position of the object copies."}});let a=v(()=>e.mousePos!=null);this.overlayUI=v(()=>{let d=g();if(d.type!="Moving")return;let o=d,u=new Map;for(let p of ve(()=>e.objects()))u.set(p.id(),p);if(!a())return;let s=document.createElement("div");s.style.position="absolute",re(()=>{let p=e.mousePos();p!=null&&(s.style.left=p.x+20+"px",s.style.top=p.y+20+"px")});let r=ao(()=>{let p;Rt(()=>{p?.focus()});let y=v(()=>{let _=l();if(_!=null)return o.fromPt.distance(_)});return re(()=>{if(p==null)return;let _=y();p.value=_==null?"":_.toFixed(0),p.select()}),["Dist:",(()=>{const _=uu.cloneNode(!0);_.addEventListener("change",S=>{let b=Number.parseFloat(S.currentTarget.value);if(!Number.isFinite(b))return;let x=l();if(x==null)return;let k=o.fromPt,I=x.sub(k).normalize();if(!Number.isFinite(I.x))return;let D=I.scale(b);$e(()=>{for(let{id:Y,initPosition:Q}of o.movingObjectsById){let N=u.get(Y);if(N==null)continue;let oe=N;ve(()=>{oe.setTransform(he.create(Q.add(D),oe.transform().orientation))})}}),e.onDone()});const w=p;return typeof w=="function"?At(w,_):p=_,_})()]},s);return Ce(()=>{r()}),s}),this.highlightedObjectsById=v(()=>{let d=g();switch(d.type){case"SelectingObjects":return nt(d.selector.hoveredObjectById());case"Moving":return[]}}),this.selectedObjectsById=v(()=>{let d=g();switch(d.type){case"SelectingObjects":return d.selector.selectedObjectsById();case"Moving":return d.movingObjectsById.map(({id:o})=>o)}});let f=v(()=>l()!=null);this.arrows=v(()=>{let d=g();if(d.type!="Moving")return[];if(!f())return[];let o=()=>l(),u=d.fromPt;return[{from:()=>u,to:o}]}),this.click=d=>{let o=g();switch(o.type){case"SelectingObjects":o.selector.click(d);break;case"Moving":e.onDone();break}},this.keyDown=d=>{let o=g();switch(o.type){case"SelectingObjects":let u=o.selector.selectedObjectsById();d=="Enter"&&u.length!=0&&m("mkMode",s=>()=>i(u));break}},this.cancel=()=>{let d=g();switch(d.type){case"SelectingObjects":break;case"Moving":for(let{id:o}of d.movingObjectsById)e.destroyObject(o);break}}}}const al=10,dl=al*al;class fu{constructor(e){let[t,i]=Ne({selectedOutlinePt:void 0,selectedFace:void 0}),c=v(()=>t.selectedOutlinePt!=null?[]:e.objects().flatMap(({extendable:s})=>{if(s==null)return[];let r=s(),p=r.outlinePts;return p==null?[]:p().map((_,w)=>({pt:r.transform().pointFromThisSpace(_.toVec3()),extendable:r,ptIdx:w}))})),m=v(()=>t.selectedOutlinePt!=null?[]:e.objects().flatMap(({extendable:s})=>{if(s==null)return[];let r=s(),p=r.outlinePts;if(p==null)return[];let y=p,_=r.outlineEdges;return _==null?[]:_().map(({pt1Idx:S,pt2Idx:b},x)=>({line:et.create(r.transform().pointFromThisSpace(y()[S].toVec3()),r.transform().pointFromThisSpace(y()[b].toVec3())),extendable:r,edgeIdx:x}))})),g=v(()=>t.selectedOutlinePt!=null?[]:m().map(s=>({pt:s.line.v1.add(s.line.v2).scale(.5),extendable:s.extendable,edgeIdx:s.edgeIdx}))),h=v(()=>{if(t.selectedOutlinePt!=null)return;let s=e.mousePos();if(s==null)return;let r=e.mouseRay();if(r==null)return;let p,y;for(let _ of c()){let w=_.pt,S=r.closestTimeToPoint(w);if(S<0)continue;let b=e.projectPtToScreen(w);b==null||b.distanceSquared(s)>dl||(p==null||S<p)&&(p=S,y=_)}return y}),l=v(()=>{if(h()!=null)return;let s=e.mousePos();if(s==null)return;let r=e.mouseRay();if(r==null)return;let p,y;for(let _ of g()){let w=_.pt,S=r.closestTimeToPoint(w);if(S<0)continue;let b=e.projectPtToScreen(w);b==null||b.distanceSquared(s)>dl||(p==null||S<p)&&(p=S,y=_)}return y}),a=v(()=>t.selectedOutlinePt!=null?[]:e.objects().flatMap(({extendable:s})=>s==null?[]:s().faces().map(r=>{let p=v(()=>s().transform().fromThisSpace(r.localTransform));return{...r,transform:p}}))),f=v(()=>{if(h()!=null||l()!=null)return;let s=e.mouseRay();if(s==null)return;let r,p;for(let y of a()){let _=Re.fromKnownPtAndNormal(y.transform().o,y.transform().w),w=s.collisionTimeWithPlane(_);if(w==null||w<0)continue;let S=s.positionFromTime(w),b=y.transform().pointToThisSpace(S).xy();if(!en(b,y.outline))continue;let x=w;(r==null||x<r)&&(r=x,p=y)}return p});re(()=>{if(t.selectedOutlinePt==null)return;let s=t.selectedOutlinePt,r=ve(()=>s.extendable.value.transform()),p=e.mouseRay();if(p==null)return;let y=Re.fromKnownPtAndNormal(r.o,r.w),_=p.collisionWithPlane(y);if(_==null)return;let w=r.pointToThisSpace(_).xy();ve(()=>s.extendable.value.moveOutlinePoint(s.ptIdx,w))}),this.instructions=()=>{};let d=v(()=>{let s=f();if(s==null)return;let r=s;if(r.outline.length<3)return;let p=r.outline,y=.001,_=new ei;_.moveTo(p[0].x*y,p[0].y*y);for(let x=1;x<p.length;++x)_.lineTo(p[x].x*y,p[x].y*y);_.closePath();let w=new ti(_,{depth:1*y,bevelEnabled:!1}),S=new wt({color:"blue",transparent:!0,opacity:.8}),b=new Ze(w,S);return re(()=>{let x=r.transform();b.position.set(x.o.x*y,x.o.y*y,x.o.z*y),b.setRotationFromQuaternion(new Vt(x.orientation.x,x.orientation.y,x.orientation.z,x.orientation.w))}),Ce(()=>{w.dispose(),S.dispose()}),b}),o=v(()=>{let s=t.selectedFace;if(s==null)return;let r=s.value;if(r.outline.length<3)return;let p=r.outline,y=.001,_=new ei;_.moveTo(p[0].x*y,p[0].y*y);for(let x=1;x<p.length;++x)_.lineTo(p[x].x*y,p[x].y*y);_.closePath();let w=new ti(_,{depth:1*y,bevelEnabled:!1}),S=new wt({color:"green",transparent:!0,opacity:.8}),b=new Ze(w,S);return re(()=>{let x=r.transform();b.position.set(x.o.x*y,x.o.y*y,x.o.z*y),b.setRotationFromQuaternion(new Vt(x.orientation.x,x.orientation.y,x.orientation.z,x.orientation.w))}),Ce(()=>{w.dispose(),S.dispose()}),b}),u=v(()=>{let s=e.kitFaceUnderMouse();if(s==null||t.selectedFace==null)return;let r=.001,p=new Float32Array(9*s.faces.length),y=0,_=s.normal;for(let k of s.faces)p[y++]=(k.v1.x+_.x)*r,p[y++]=(k.v1.y+_.y)*r,p[y++]=(k.v1.z+_.z)*r,p[y++]=(k.v2.x+_.x)*r,p[y++]=(k.v2.y+_.y)*r,p[y++]=(k.v2.z+_.z)*r,p[y++]=(k.v3.x+_.x)*r,p[y++]=(k.v3.y+_.y)*r,p[y++]=(k.v3.z+_.z)*r;let w=new gl(p,3),S=new yl;S.setAttribute("position",w);let b=new wt({color:"blue",side:vl});return Ce(()=>{S.dispose(),b.dispose()}),new Ze(S,b)});this.overlayObject3d=v(()=>{let s=d(),r=o(),p=u(),y=new jt;return s!=null&&y.add(s),r!=null&&y.add(r),p!=null&&y.add(p),y}),this.snapPoints=v(()=>[...c().map(s=>({pt:()=>s.pt,highlighted:v(()=>s===h())})),...g().map(s=>({pt:()=>s.pt,highlighted:v(()=>s===l()),unselectedColour:()=>"yellow"})),...nt(t.selectedOutlinePt).map(s=>({pt:v(()=>s.extendable.value.transform().pointFromThisSpace(s.extendable.value.outlinePts()[s.ptIdx].toVec3())),highlighted:()=>!0}))]),this.snapLines=v(()=>[...m().map(({line:s})=>({line:()=>s,highlighted:()=>!1}))]),this.click=()=>{{let s=h();if(s!=null){i("selectedOutlinePt",{ptIdx:s.ptIdx,extendable:new Ot(s.extendable)});return}else if(t.selectedOutlinePt!=null){i("selectedOutlinePt",void 0);return}}{let s=l();if(s!=null){let{ptIdx:r}=s.extendable.splitOutlineEdge(s.edgeIdx);i("selectedOutlinePt",{ptIdx:r,extendable:new Ot(s.extendable)});return}}{let s=f();if(s!=null){i("selectedFace",new Ot(s));return}let r=e.kitFaceUnderMouse();if(r!=null&&t.selectedFace!=null){let p=Re.fromKnownPtAndNormal(r.pt,r.normal);t.selectedFace.value.extendToPlane(p),$e(()=>{i("selectedOutlinePt",void 0),i("selectedFace",void 0)})}}},this.keyDown=s=>{t.selectedOutlinePt!=null&&s=="Delete"&&(t.selectedOutlinePt.extendable.value.deleteOutlinePt(t.selectedOutlinePt.ptIdx),$e(()=>{i("selectedOutlinePt",void 0),i("selectedFace",void 0)}))}}}class hu{constructor(e){let t=c=>{if(c.length==0)return;let m=e.createGroupObject();$e(()=>{for(let g of c)e.setObjectParent(g,m)})};if(e.initSelectedObjectIds!=null&&e.initSelectedObjectIds.length!=0){t(e.initSelectedObjectIds),e.onDone();return}let i=new vn({mouseRay:e.mouseRay,objects:e.objects});this.instructions=v(()=>"Select objects you wish to group, then press enter when you are done."),this.keyDown=c=>{c=="Enter"&&(t(i.selectedObjectsById()),e.onDone())}}}class pu{constructor(e){let t=(a,f,d)=>gt(f,o=>{let u=v(()=>d().fromThisSpace(o.space())),s={parent:a,kit:{type:"SubKitObject",value:o},localAabb:o.localAabb,localSpace:o.space,worldSpace:u,subKits:()=>[]};return s.subKits=t(s,()=>o.subKitObjects?.call(void 0)??[],u),s}),i=gt(e.rootKits,({kit:a,localAabb:f,space:d})=>{let o={parent:void 0,kit:{type:"Kit",value:a},localAabb:f,localSpace:d,worldSpace:d,subKits:()=>[]};return o.subKits=t(o,co(a),d),o}),[c,m]=Ne({focusedParentKit:void 0}),g=(a,f)=>{let d=f.toSpace(a.worldSpace()),o=a.localAabb().rayCollisionTime(d);if(!(o==null||o<0)){switch(a.kit.type){case"Kit":{let u=a.kit.value;if(u.rayCollision!=null&&(o=u.rayCollision()(d),o==null||o<0))return;break}case"SubKitObject":{let u=a.kit.value;if(u.rayCollisionTime&&(o=u.rayCollisionTime()(d),o==null||o<0))return;break}}return o}},h=v(()=>c.focusedParentKit==null?i():c.focusedParentKit.value.subKits()),l=v(()=>{let a=e.mouseRay();if(a==null)return;let f,d;for(let o of h()){let u=g(o,a);u==null||u<0||(f==null||u<f)&&(f=u,d=o)}return d});this.focusInwards=()=>{let a=l();a!=null&&a.subKits().length!=0&&m("focusedParentKit",new Ot(a))},this.focusOutwards=()=>{let a=c.focusedParentKit;if(a==null)return;let f=a.value.parent;f==null?m("focusedParentKit",void 0):m("focusedParentKit",new Ot(f))},this.unfocus=()=>{m("focusedParentKit",void 0)},this.focusedKit=l}}class mu{constructor(e){let[t,i]=Ne({selectedEntities:[]}),c=e.pickingSystem.mkEntityUnderMouse();this.click=m=>{if(m){let g=c();g!=null&&(t.selectedEntities.some(l=>l==g)||i("selectedEntities",[...t.selectedEntities,g]))}else i("selectedEntities",nt(c()))},this.keyDown=m=>{if(m=="Delete"&&t.selectedEntities.length!=0)for(let g of t.selectedEntities)e.destroyEntityRecursive(g)},this.highlightedEntities=v(()=>nt(c())),this.selectedEntities=v(()=>t.selectedEntities)}}let gu={from:{displayName:"From",typeSchema:_i,defaultValue:ae.zero},to:{displayName:"To",typeSchema:_i,defaultValue:ae.create(1,0)}};const yu=new xn({typeName:"Line",displayName:"Line",propertiesSchema:gu}),cn=yu,vu=Z('<svg><line stroke-dasharray="20,10" stroke="black"></line></svg>',4,!0),bu=Z('<svg><circle r="5"></circle></svg>',4,!0);class xu{constructor(e){const t=new Al({undoManager:e.undoManager,cameraLookDir:()=>C.negUnitZ,projectPtToScreen:i=>e.modelPtToScreenPt(i.xy()),mousePos:()=>e.mousePos,mouseRay:()=>{let i=e.mousePos;if(i==null)return;let c=e.screenPtToModelPt(i);if(c!=null)return Xe.create(C.create(c.x,c.y,100),C.negUnitZ)},otherSnapPoints:v(()=>[]),existingLines:v(()=>e.getEntitiesWithComponentTypes([cn]).flatMap(i=>{let c=e.getComponent(i,cn);return c==null?[]:{id:i,line:et.create(c.state.from.toVec3(),c.state.to.toVec3())}})),createLine:i=>({id:e.createEntity([cn.create({from:i.v1.xy(),to:i.v2.xy()})])}),updateLine:({id:i,line:c})=>{let m=e.getComponent(i,cn);m?.setState({from:c.v1.xy(),to:c.v2.xy()})},destroyLine:i=>{let c=e.getComponent(i,cn)?.state;return e.destroyEntity(i),{undelete:()=>{c!=null&&e.createEntityWithId(i,[cn.create(c)])}}},allowAlignAll:()=>!0});this.instructions=()=>t.instructions.call(t,{}),this.overlaySvg=i=>()=>U(kt,{get each(){return t.dottedWorkingLines()},children:c=>{let m=v(()=>{let g=i.modelPtToPagePt(c.v1.xy());if(g==null)return;let h=i.modelPtToPagePt(c.v2.xy());if(h!=null)return fo.create(g,h)});return U(je,{get when(){return m()},children:g=>(()=>{const h=vu.cloneNode(!0);return ce(l=>{const a=g().v1.x+"mm",f=g().v1.y+"mm",d=g().v2.x+"mm",o=g().v2.y+"mm";return a!==l._v$&&K(h,"x1",l._v$=a),f!==l._v$2&&K(h,"y1",l._v$2=f),d!==l._v$3&&K(h,"x2",l._v$3=d),o!==l._v$4&&K(h,"y2",l._v$4=o),l},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0}),h})()})}}),this.overlayUiHtml=i=>()=>t.overlayUI({}),this.overlayUiSvg=i=>()=>U(kt,{get each(){return t.snapPoints()},children:c=>{let m=v(()=>i.modelPtToScreenPt(c.pt().xy()));return U(je,{get when(){return m()},children:g=>(()=>{const h=bu.cloneNode(!0);return ce(l=>{const a=g().x,f=g().y,d=c.highlighted()?"green":"blue";return a!==l._v$5&&K(h,"cx",l._v$5=a),f!==l._v$6&&K(h,"cy",l._v$6=f),d!==l._v$7&&K(h,"fill",l._v$7=d),l},{_v$5:void 0,_v$6:void 0,_v$7:void 0}),h})()})}}),this.click=()=>{t.click()},this.cancel=()=>{t.cancel()}}}const _u=Z('<svg><rect width="8" height="8" stroke="black" fill="none"></rect></svg>',4,!0),ul=10,wu=ul*ul;class Su{constructor(e){let[t,i]=Ne({resizing:void 0,moving:void 0}),c=v(()=>{let h=[];for(let l=0;l<3;++l){let a=e.rect.pos.y+l*e.rect.size.y/2;for(let f=0;f<3;++f){if(l==1&&f==1)continue;let d=e.rect.pos.x+f*e.rect.size.x/2;h.push({cornerXType:f-1,cornerYType:l-1,pos:ae.create(d,a)})}}return h}),m=v(()=>{let h=e.modeParams.mousePos;if(h==null)return;let l,a;for(let f of c()){let d=e.modeParams.modelPtToScreenPt(f.pos);if(d==null)continue;let o=h.distanceSquared(d);o>wu||(l==null||o<l)&&(l=o,a=f)}return a}),g=v(()=>{if(m()!=null)return!1;let h=e.modeParams.mousePos;if(h==null)return!1;let l=e.modeParams.screenPtToModelPt(h);return l==null?!1:l.x>e.rect.pos.x&&l.x<e.rect.pos.x+e.rect.size.x&&l.y>e.rect.pos.y&&l.y<e.rect.pos.y+e.rect.size.y});re(()=>{if(t.resizing==null)return;let h=t.resizing.value,l=e.modeParams.mousePos;if(l==null)return;let a=e.modeParams.screenPtToModelPt(l);if(a==null)return;let f=h.stillPoint,d,o;h.cornerXType!=0?(d=Math.min(a.x,f.x),o=Math.abs(a.x-f.x)):(d=ve(()=>e.rect.pos.x),o=ve(()=>e.rect.size.x));let u,s;h.cornerYType!=0?(u=Math.min(a.y,f.y),s=Math.abs(a.y-f.y)):(u=ve(()=>e.rect.pos.y),s=ve(()=>e.rect.size.y));let r={pos:ae.create(d,u),size:ae.create(o,s)};ve(()=>e.updateRect(r))}),re(()=>{if(t.moving==null)return;let h=t.moving.value,l=e.modeParams.mousePos;if(l==null)return;let a=e.modeParams.screenPtToModelPt(l);if(a==null)return;let f=h.rectStartPos.add(a.sub(h.pickupPos));ve(()=>e.updateRect({...e.rect,pos:f}))}),this.overlayUiSvg=h=>U(kt,{get each(){return c()},children:l=>{let a=v(()=>h.modelPtToScreenPt(l.pos));return U(je,{get when(){return a()},children:f=>(()=>{const d=_u.cloneNode(!0);return ce(o=>{const u=f().x-4,s=f().y-4;return u!==o._v$&&K(d,"x",o._v$=u),s!==o._v$2&&K(d,"y",o._v$2=s),o},{_v$:void 0,_v$2:void 0}),d})()})}}),this.mouseDown=()=>{let h=m();if(h!=null){let l;switch(h.cornerXType){case-1:switch(h.cornerYType){case-1:l=ae.create(e.rect.pos.x+e.rect.size.x,e.rect.pos.y+e.rect.size.y);break;case 0:l=ae.create(e.rect.pos.x+e.rect.size.x,e.rect.pos.y+.5*e.rect.size.y);break;case 1:l=ae.create(e.rect.pos.x+e.rect.size.x,e.rect.pos.y);break;default:return}break;case 0:switch(h.cornerYType){case-1:l=ae.create(e.rect.pos.x+.5*e.rect.size.x,e.rect.pos.y+e.rect.size.y);break;case 1:l=ae.create(e.rect.pos.x+.5*e.rect.size.x,e.rect.pos.y);break;default:return}break;case 1:switch(h.cornerYType){case-1:l=ae.create(e.rect.pos.x,e.rect.pos.y+e.rect.size.y);break;case 0:l=ae.create(e.rect.pos.x,e.rect.pos.y+.5*e.rect.size.y);break;case 1:l=ae.create(e.rect.pos.x,e.rect.pos.y);break;default:return}break;default:return}i("resizing",new Ot({cornerXType:h.cornerXType,cornerYType:h.cornerYType,stillPoint:l}))}if(g()){let l=e.modeParams.mousePos;if(l==null)return;let a=e.modeParams.screenPtToModelPt(l);if(a==null)return;i("moving",new Ot({rectStartPos:e.rect.pos,pickupPos:a}))}},this.mouseUp=()=>{t.resizing!=null&&i("resizing",void 0),t.moving!=null&&i("moving",void 0)},this.cursor=v(()=>{if(g()&&t.resizing==null)return"move";let h,l,a=m();if(a!=null)h=a.cornerXType,l=a.cornerYType;else if(t.resizing!=null)h=t.resizing.value.cornerXType,l=t.resizing.value.cornerYType;else return;switch(h){case-1:{switch(l){case-1:return"nesw-resize";case 0:return"ew-resize";case 1:return"nwse-resize"}break}case 0:{switch(l){case-1:return"ns-resize";case 1:return"ns-resize"}break}case 1:{switch(l){case-1:return"nwse-resize";case 0:return"ew-resize";case 1:return"nesw-resize"}break}}})}}let Pu={mimeType:{displayName:"Mime Type",typeSchema:{type:"String"},defaultValue:"image/png"},base64Data:{displayName:"Base 64 Data",typeSchema:{type:"String"},defaultValue:"iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAAAXNSR0IArs4c6QAABlFJREFUeF7t1IERACAIAzHZf2g8XePDBk25zu7ucQQI5ATmnQHI9S4wgS9gADwCgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgIGIFy+6AQMgB8gEBYwAOHyRSdgAPwAgbCAAQiXLzoBA+AHCIQFDEC4fNEJGAA/QCAsYADC5YtOwAD4AQJhAQMQLl90AgbADxAICxiAcPmiEzAAfoBAWMAAhMsXnYAB8AMEwgJ/AML5RSeQF7hgif0uvuOdMwAAAABJRU5ErkJggg=="}};const ku=new xn({typeName:"Image",displayName:"Image",propertiesSchema:Pu}),Xl=ku,so=bn(({x:n,y:e,z:t})=>C.create(n,e,t),n=>({x:n.x,y:n.y,z:n.z}),{type:"Object",properties:{x:{displayName:"X",typeSchema:{type:"Number"},defaultValue:0},y:{displayName:"X",typeSchema:{type:"Number"},defaultValue:0},z:{displayName:"Z",typeSchema:{type:"Number"},defaultValue:0}}}),Iu=bn(({w:n,x:e,y:t,z:i})=>new we(n,e,t,i),n=>({w:n.w,x:n.x,y:n.y,z:n.z}),{type:"Object",properties:{w:{displayName:"X",typeSchema:{type:"Number"},defaultValue:1},x:{displayName:"X",typeSchema:{type:"Number"},defaultValue:0},y:{displayName:"X",typeSchema:{type:"Number"},defaultValue:0},z:{displayName:"Z",typeSchema:{type:"Number"},defaultValue:0}}}),Gl=bn(({origin:n,orientation:e})=>he.create(n,e),n=>({origin:n.origin,orientation:n.orientation}),{type:"Object",properties:{origin:{displayName:"Origin",typeSchema:so,defaultValue:C.zero},orientation:{displayName:"Orientation",typeSchema:Iu,defaultValue:we.identity}}});let Tu={cameraTransform:{displayName:"Camera Transform",typeSchema:Gl,defaultValue:he.identity}};const Mu=new xn({typeName:"Viewport",displayName:"Viewport",propertiesSchema:Tu}),Hl=Mu,Au=Z("<br>"),$u=Z('<svg><rect fill="green" fill-opacity="0.5"></rect></svg>',4,!0),Cu=Z('<svg><rect stroke="black" fill="none"></rect></svg>',4,!0),Eu=Z("<canvas></canvas>");class Ou{constructor(e){let[t,i]=Ne({corner1:void 0,corner2:void 0,rect:void 0,canvas:void 0,displayOptions:{projection:"Perspective",showCladding:!0,showBackground:!0,hideBelowGround:!1,showDebugMarkings:!1,textured:!1},cameraSpace:void 0}),c=v(()=>{let l=e.mousePos;if(l!=null)return e.screenPtToModelPt(l)}),m=v(()=>{let l=t.corner1,a=t.corner2??c();if(l==null||a==null)return;let f=Math.min(l.x,a.x),d=Math.min(l.y,a.y),o=Math.max(l.x,a.x),u=Math.max(l.y,a.y);return{minX:f,minY:d,maxX:o,maxY:u}}),g=v(()=>t.corner1!=null&&t.corner2!=null),h=v(()=>{if(!g()||t.rect!=null)return;let l=()=>t.corner1,a=()=>t.corner2;return new Su({modeParams:e,rect:{get pos(){return ae.create(Math.min(l().x,a().x),Math.min(l().y,a().y))},get size(){return ae.create(Math.max(l().x,a().x)-Math.min(l().x,a().x),Math.max(l().y,a().y)-Math.min(l().y,a().y))}},updateRect({pos:f,size:d}){let o=f,u=f.add(d);$e(()=>{i("corner1",o),i("corner2",u)})}})});this.instructions=v(()=>t.corner1==null?"Click first corner of viewport.":t.corner2==null?"Click second corner of viewport.":t.rect==null?"Resize or move viewport. Or press enter to continue.":[U(zl,{get projection(){return t.displayOptions.projection},get showCladding(){return t.displayOptions.showCladding},get showBackground(){return t.displayOptions.showBackground},get hideBelowGround(){return t.displayOptions.hideBelowGround},get showDebugMarkings(){return t.displayOptions.showDebugMarkings},get textured(){return t.displayOptions.textured},setProjection:l=>i("displayOptions","projection",l),setShowCladding:l=>i("displayOptions","showCladding",l),setShowBackground:l=>i("displayOptions","showBackground",l),setHideBelowGround:l=>i("displayOptions","hideBelowGround",l),setShowDebugMarkings:l=>i("displayOptions","showDebugMarkings",l),setTextured:l=>i("displayOptions","textured",l)}),Au.cloneNode(!0),'"Position camera, and press enter when done."']),this.overlaySvg=l=>U(je,{get when(){return m()},children:a=>{let f=v(()=>{let o=a();return l.modelPtToPagePt(ae.create(o.minX,o.maxY))}),d=v(()=>{let o=a();return{width:o.maxX-o.minX,height:o.maxY-o.minY}});return U(je,{get when(){return f()},children:o=>[(()=>{const u=$u.cloneNode(!0);return ce(s=>{const r=o().x+"mm",p=o().y+"mm",y=d().width+"mm",_=d().height+"mm";return r!==s._v$&&K(u,"x",s._v$=r),p!==s._v$2&&K(u,"y",s._v$2=p),y!==s._v$3&&K(u,"width",s._v$3=y),_!==s._v$4&&K(u,"height",s._v$4=_),s},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0}),u})(),(()=>{const u=Cu.cloneNode(!0);return ce(s=>{const r=o().x+"mm",p=o().y+"mm",y=d().width+"mm",_=d().height+"mm";return r!==s._v$5&&K(u,"x",s._v$5=r),p!==s._v$6&&K(u,"y",s._v$6=p),y!==s._v$7&&K(u,"width",s._v$7=y),_!==s._v$8&&K(u,"height",s._v$8=_),s},{_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0}),u})()]})}}),this.overlayUiSvg=l=>U(je,{get when(){return h()},children:a=>a().overlayUiSvg(l)}),this.overlayUiHtml=l=>{if(t.rect==null)return;let a=t.rect.value,f=ae.create(a.pos.x,a.pos.y+a.size.y),d=ae.create(a.pos.x+a.size.x,a.pos.y),o=v(()=>{let u=l.modelPtToScreenPt(f);if(u==null)return;let s=l.modelPtToScreenPt(d);if(s!=null)return{pt3:u,pt4:s}});return U(je,{get when(){return o()},children:u=>{let s,r=v(()=>u().pt3),p=v(()=>u().pt4),y=v(()=>r()),_=v(()=>p().x-r().x),w=v(()=>p().y-r().y);return Rt(()=>{if(s==null)return;let S=s,b=new Xi,x=new Gi(void 0,S.clientWidth/S.clientHeight),k=e.threeDModel.camera.transform.origin,I=e.threeDModel.camera.transform.orientation;x.position.set(k.x/1e3,k.y/1e3,k.z/1e3),x.quaternion.set(I.x,I.y,I.z,I.w),x.updateMatrix();{const ee=()=>{if(s==null||x==null||L==null)return;let W=new me(x.matrix.elements[4],x.matrix.elements[5],x.matrix.elements[6]),te=new me(x.matrix.elements[8],x.matrix.elements[9],x.matrix.elements[10]),xe=.5*s.height/Math.tan(.5*x.fov*Math.PI/180);L.uniforms.resolution.value=new Zt(s.width,s.height),L.uniforms.screenDistance.value=xe,L.uniforms.cameraLocation.value=new me(x.position.x,-x.position.z,x.position.y),L.uniforms.cameraForward.value=new me(-te.x,te.z,-te.y),L.uniforms.cameraUp.value=new me(W.x,-W.z,W.y),L.uniforms.depthRangeNear.value=.01,L.uniforms.depthRangeFar.value=100};let F=new Pt(-70,-70,-70),L=new Hi({uniforms:{resolution:{value:new Zt},screenDistance:{value:0},cameraLocation:{value:new me},cameraForward:{value:new me},cameraUp:{value:new me},depthRangeNear:{value:0},depthRangeFar:{value:0}},vertexShader:Ji,fragmentShader:Tl,extensions:{fragDepth:!0}}),$=new Ze(F,L);Ce(()=>{F.dispose(),L.dispose()}),$.receiveShadow=!0,$.renderOrder=-1,b.add($);{let W=!0,te=!1;re(()=>{t.displayOptions.showBackground?te||(b.add($),te=!0):te&&(b.remove($),te=!1),W?W=!1:oe.render(b,x)})}$.onBeforeRender=()=>{x!=null&&($.position.copy(x.position),$.updateMatrix()),ee()}}let D=new jt;D.rotateX(-90*Math.PI/180);let Y=new jt;D.add(Y),b.add(D);let Q;Q=gt(()=>e.threeDModel.kits,F=>({kitId:()=>F.kitId,kit:()=>F.kit,space:()=>F.space,localAabb:()=>F.localAabb})),Il({group:Y,kits:Q,rerender:()=>{oe.render(b,x)},isLayerVisible:ee=>bl.Cladding?t.displayOptions.showCladding:!0});{var N=new xl(16777215,16777215,.3);N.color.setHSL(.6,.75,.5),N.groundColor.setHSL(.095,.5,.5),N.position.set(0,500,0),b.add(N)}{let ee=new bi(16777215,.3);ee.position.set(-100,-100,100),b.add(ee)}{let ee=new _l(16777215,.4);b.add(ee)}{let ee=new bi(16777215,1.2);ee.position.set(100,100,-100),ee.castShadow=!0,ee.shadow.camera.scale.set(2,2,2),ee.shadow.mapSize.width=1024,ee.shadow.mapSize.height=1024,ee.shadow.camera.near=.5,ee.shadow.camera.far=500,b.add(ee)}let oe=new wl({canvas:S,antialias:!0,alpha:!0,preserveDrawingBuffer:!0,logarithmicDepthBuffer:!0});oe.useLegacyLights=!0,oe.setClearColor(new ar(1,1,1)),re(()=>{oe.setSize(_(),w()),oe.render(b,x)});let[ue,J]=st(0);const _e=new Wi;let Te=v(()=>{if(ue(),e.mousePos==null)return;let ee=e.mousePos;if(t.rect==null)return;let F=t.rect.value,L=e.modelPtToScreenPt(ae.create(F.pos.x,F.pos.y+F.size.y)),$=e.modelPtToScreenPt(ae.create(F.pos.x+F.size.x,F.pos.y));if(L==null||$==null||!(ee.x>L.x&&ee.x<$.x&&ee.y>L.y&&ee.y<$.y))return;_e.setFromCamera(new Zt((ee.x-L.x)/_()*2-1,-((ee.y-L.y)/w())*2+1),x);let W=_e.ray;return Xe.create(C.create(W.origin.x*1e3,-W.origin.z*1e3,W.origin.y*1e3),C.create(W.direction.x,-W.direction.z,W.direction.y))}),se=new Vl({mouseRay:()=>{if(Te!=null)return Te()},rayObjectCollision:ee=>{if(Q==null)return;let F,L;for(let $ of Q()){let W=$.kit(),te;W.rayCollision!=null?te=W.rayCollision():te=z=>$.localAabb().rayCollisionTime(z);let xe=ee.toSpace($.space()),Pe=te(xe);Pe==null||Pe<=0||(F==null||Pe<F)&&(F=Pe,L=$.kitId())}if(ee.direction.z<0){let $=Re.xyPlane,W=ee.collisionTimeWithPlane($);W!=null&&W>0&&(F==null||W<F)&&(F=W,L="Ground")}if(!(F==null||L==null))return{t:F,objectId:L}}});se.setSpace(e.threeDModel.camera.transform),se.hookupEventListeners(s),i("canvas",{scene:b,canvas:s,camera:x,renderer:oe}),i("cameraSpace",()=>se.space),re(()=>{let ee=se.space(),F=ee.origin,L=ee.orientation;x.position.set(F.x/1e3,F.y/1e3,F.z/1e3),x.quaternion.set(L.x,L.y,L.z,L.w),x.updateMatrix(),oe.render(b,x),J($=>1-$)})}),(()=>{const S=Eu.cloneNode(!0),b=s;return typeof b=="function"?At(b,S):s=S,S.style.setProperty("position","absolute"),S.style.setProperty("background-color","black"),ce(x=>{const k=_(),I=w(),D=y().x+"px",Y=y().y+"px",Q=_()+"px",N=w()+"px";return k!==x._v$9&&K(S,"width",x._v$9=k),I!==x._v$10&&K(S,"height",x._v$10=I),D!==x._v$11&&S.style.setProperty("left",x._v$11=D),Y!==x._v$12&&S.style.setProperty("top",x._v$12=Y),Q!==x._v$13&&S.style.setProperty("width",x._v$13=Q),N!==x._v$14&&S.style.setProperty("height",x._v$14=N),x},{_v$9:void 0,_v$10:void 0,_v$11:void 0,_v$12:void 0,_v$13:void 0,_v$14:void 0}),S})()}})},this.click=()=>{if(t.corner1==null){let l=c();l!=null&&i("corner1",l)}else if(t.corner2==null){let l=c();l!=null&&i("corner2",l)}},this.mouseDown=()=>{let l=h();l?.mouseDown()},this.mouseUp=()=>{let l=h();l?.mouseUp()},this.keyDown=l=>{if(l=="Enter"){if(t.rect==null){if(t.corner1==null||t.corner2==null)return;let a=ae.create(Math.min(t.corner1.x,t.corner2.x),Math.min(t.corner1.y,t.corner2.y)),f=ae.create(Math.max(t.corner1.x,t.corner2.x)-Math.min(t.corner1.x,t.corner2.x),Math.max(t.corner1.y,t.corner2.y)-Math.min(t.corner1.y,t.corner2.y));i("rect",new Ot({pos:a,size:f}))}else if(t.canvas!=null){t.canvas.canvas.width=Math.round(t.rect.value.size.x/25.4*300),t.canvas.canvas.height=Math.round(t.rect.value.size.y/25.4*300),t.canvas.renderer.setSize(t.canvas.canvas.width,t.canvas.canvas.height),t.canvas.renderer.render(t.canvas.scene,t.canvas.camera);let a=t.rect.value,f=t.canvas.canvas.toDataURL("image/jpeg"),d=t.cameraSpace?.call(void 0);e.createEntity([rn.create({position:a.pos}),Xl.create({mimeType:"image/jpeg",base64Data:f.substring(f.indexOf("base64,")+7)}),xi.create({width:a.size.x,height:a.size.y}),...d==null?[]:[Hl.create({cameraTransform:d})]]),e.onDone()}}},this.cursor=v(()=>{let l=h();if(l!=null)return l.cursor()}),this.disablePan=v(()=>{let l=h();return l==null?!1:l.cursor()!=null})}}let Du={label:{displayName:"Label",typeSchema:{type:"String"},defaultValue:""},labelOffset:{displayName:"Offset",typeSchema:_i,defaultValue:ae.zero}};const Ru=new xn({typeName:"Label",displayName:"Label",propertiesSchema:Du}),En=Ru,cl=10,Nu=cl*cl;class Bu{constructor(e,t){{ve(()=>{let p=e.getComponent(t.entity,Rn);if(p!=null){for(let y of p.state.childIds)e.destroyEntity(y);p.setState("childIds",[])}});let h=p=>y=>{if(!(y.hasLabel?.call(y)??!1))return[];let _=e.threeDModel.labeler.lookupLabelForComponent(y);if(_==null)return[];let w=p.fromThisSpace(y.transform?.call(y)??he.identity),S=uo([new Qi({...y,transform:()=>he.identity})]);return Number.isFinite(S.minX)?[{label:_,pos:w.pointFromThisSpace(C.create(.5*(S.minX+S.maxX),.5*(S.minY+S.maxY),.5*(S.minZ+S.maxZ)))}]:[]},l=p=>y=>{let _=p.fromThisSpace(y.transform?.call(y)??he.identity);return[...h(p)(y),...(y.children?.call(y)??[]).flatMap(l(_))]},a=p=>(p.kit.components?.call(p.kit)??[]).flatMap(l(p.space)),f=ve(()=>e.threeDModel.kits.flatMap(({kit:p,space:y})=>a({kit:p,space:y}))),d=50,o=.5*t.size.height/Math.tan(.5*d*Math.PI/180),u=ae.create(t.position.position.x+.5*t.size.width,t.position.position.y+.5*t.size.height),s;{let p=t.viewport.cameraTransform;s=he.create(C.zero,we.fromWU(C.negUnitY,C.unitX)).fromThisSpace(p)}let r=f.map(({label:p,pos:y})=>{let _=s.pointToThisSpace(y),w=ae.create(u.x+_.x*o/-_.z,u.y+_.y*o/-_.z);return{label:p,pos:w}});ve(()=>{$e(()=>{let p=[];for(let{label:y,pos:_}of r)p.push(e.createEntity([rn.create({position:_}),En.create({label:y,labelOffset:ae.zero}),qi.create({parentId:t.entity})]));e.setComponents(t.entity,[Rn.create({childIds:p})])})})}let[i,c]=Ne({selectedLabelByEntity:void 0}),m=v(()=>e.getEntitiesWithComponentTypes([rn,En]).flatMap(h=>{let l=e.getComponent(h,rn),a=e.getComponent(h,En);return l==null||a==null?[]:[{entity:h,position:l.state.position,labelOffset:a.state.labelOffset}]})),g=v(()=>{let h=e.mousePos;if(h==null)return;let l,a;for(let f of m()){let d=f.position.add(f.labelOffset),o=e.modelPtToScreenPt(d);if(o==null)continue;let u=h.distanceSquared(o);u>Nu||(l==null||u<l)&&(l=u,a=f)}return a});re(()=>{if(i.selectedLabelByEntity==null)return;let h=i.selectedLabelByEntity,l=ve(()=>{let u=e.getComponent(h,rn)?.state.position;if(u==null)return;let s=e.getComponent(h,En)?.state;if(s!=null)return{position:u,label:s}});if(l==null)return;let a=l,f=e.mousePos;if(f==null)return;let d=e.screenPtToModelPt(f);if(d==null)return;let o=d.sub(a.position);ve(()=>{let u=e.getComponent(h,En);u?.setState("labelOffset",o)})}),this.instructions=v(()=>`Click labels to move them to new positions.
Use delete to delete labels.
And press escape when finished.`),this.click=()=>{let h=g()?.entity;i.selectedLabelByEntity==null||h!=i.selectedLabelByEntity?c("selectedLabelByEntity",h):h==i.selectedLabelByEntity&&c("selectedLabelByEntity",void 0)},this.keyDown=h=>{if(h=="Delete"&&i.selectedLabelByEntity!=null){let l=i.selectedLabelByEntity;$e(()=>{e.destroyEntity(l),c("selectedLabelByEntity",void 0)})}},this.cursor=v(()=>{}),this.highlightedEntities=v(()=>{let h=g();return h==null?[]:[h.entity]}),this.selectedEntities=v(()=>nt(i.selectedLabelByEntity))}}const Fu=Z('<div><input class="btn btn-primary btn-sm" type="button" value="Edit"><input class="btn btn-primary btn-sm" type="button" style="margin-left: 5px;" value="Add Labels"></div>'),Lu=Z("<svg><line></line></svg>",4,!0),zu=Z('<svg><line stroke="black" stroke-width="2"></line></svg>',4,!0),ju=Z('<svg><text text-anchor="middle" dominant-baseline="central"></text></svg>',4,!0),Vu=Z('<svg><rect stroke="black"></rect></svg>',4,!0),Uu=Z("<img>"),Yu=Z("<div></div>");class Ku{constructor(e){this.renderSvg=()=>U(kt,{get each(){return Object.keys(e.entities())},children:t=>{let i=v(()=>e.selectedEntitySet().has(t)),c=v(()=>e.highlightedEntitySet().has(t)),m=[],g=e.entities()[t];for(let h in e.entities()[t]){let l=g[h];switch(h){case cn.typeName:{let a=l;m.push(U(Xu,{entity:t,get renderParams(){return e.renderParams},get state(){return a.state},get selected(){return i()},get highlighted(){return c()}}));break}case En.typeName:{let a=l,f=g[rn.typeName];if(f==null)continue;m.push(U(Gu,{get renderParams(){return e.renderParams},get position(){return f.state},get label(){return a.state},get selected(){return i()},get highlighted(){return c()}}));break}}}if(m.length!=0)return m}}),this.renderHtml=()=>U(kt,{get each(){return Object.keys(e.entities())},children:t=>{let i=v(()=>e.selectedEntitySet().has(t)),c=v(()=>e.highlightedEntitySet().has(t)),m=[],g=e.entities()[t];for(let h in e.entities()[t]){let l=g[h];switch(h){case Xl.typeName:{let a=l,f=g[rn.typeName],d=g[xi.typeName];if(d==null)continue;let o=d;m.push(U(Hu,{get renderParams(){return e.renderParams},get state(){return a.state},get position(){return f?.state.position??ae.zero},get size(){return o.state},get selected(){return i()},get highlighted(){return c()}}));break}}}if(m.length!=0)return m}}),this.overlayUiHtml=t=>U(kt,{get each(){return Object.keys(e.entities())},children:i=>{let c=v(()=>e.selectedEntitySet().has(i)),m=[],g=e.entities()[i];for(let h in e.entities()[i]){let l=g[h];switch(h){case Hl.typeName:{let a=l,f=g[xi.typeName];if(f==null)continue;let d=f,o=g[rn.typeName];if(o==null)continue;let u=o,s=o.state.position,r=v(()=>t.modelPtToScreenPt(ae.create(s.x,s.y+d.state.height)));m.push(U(tt,{get when(){return c()},get children(){return U(je,{get when(){return r()},children:p=>(()=>{const y=Fu.cloneNode(!0),_=y.firstChild,w=_.nextSibling;return y.style.setProperty("position","absolute"),w.$$click=()=>{e.setMode(()=>new Bu(e.modeParams,{entity:i,position:u.state,size:d.state,viewport:a.state}))},ce(S=>{const b=p().x+"px",x=p().y+"px";return b!==S._v$&&y.style.setProperty("left",S._v$=b),x!==S._v$2&&y.style.setProperty("top",S._v$2=x),S},{_v$:void 0,_v$2:void 0}),y})()})}}))}}}return m}})}}const Xu=n=>{let e=v(()=>n.renderParams.modelPtToPagePt(n.state.from)),t=v(()=>n.renderParams.modelPtToPagePt(n.state.to));return U(je,{get when(){return e()},children:i=>U(je,{get when(){return t()},children:c=>(()=>{const m=Lu.cloneNode(!0);return ce(g=>{const h=i().x+"mm",l=i().y+"mm",a=c().x+"mm",f=c().y+"mm",d=n.selected?"green":n.highlighted?"blue":"black",o=n.selected||n.highlighted?"2":void 0;return h!==g._v$3&&K(m,"x1",g._v$3=h),l!==g._v$4&&K(m,"y1",g._v$4=l),a!==g._v$5&&K(m,"x2",g._v$5=a),f!==g._v$6&&K(m,"y2",g._v$6=f),d!==g._v$7&&K(m,"stroke",g._v$7=d),o!==g._v$8&&K(m,"stroke-width",g._v$8=o),g},{_v$3:void 0,_v$4:void 0,_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0}),m})()})})},Gu=n=>{let e=v(()=>n.renderParams.modelPtToPagePt(n.position.position)),t=v(()=>n.renderParams.modelPtToPagePt(n.position.position.add(n.label.labelOffset)));return U(je,{get when(){return e()},children:i=>U(je,{get when(){return t()},children:c=>{let m,[g,h]=st(void 0);return Rt(()=>{m!=null&&h(m.getBBox())}),[U(tt,{get when(){return n.label.labelOffset.lengthSquared()!=0},get children(){const l=zu.cloneNode(!0);return ce(a=>{const f=i().x+"mm",d=i().y+"mm",o=c().x+"mm",u=c().y+"mm";return f!==a._v$9&&K(l,"x1",a._v$9=f),d!==a._v$10&&K(l,"y1",a._v$10=d),o!==a._v$11&&K(l,"x2",a._v$11=o),u!==a._v$12&&K(l,"y2",a._v$12=u),a},{_v$9:void 0,_v$10:void 0,_v$11:void 0,_v$12:void 0}),l}}),U(je,{get when(){return g()},children:l=>{let a=v(()=>n.selected?"green":n.highlighted?"blue":"lightyellow");return(()=>{const f=Vu.cloneNode(!0);return ce(d=>{const o=c().x-.5*l().width/3.7795275590551185-.5+"mm",u=c().y-.5*l().height/(96/25.4)+"mm",s=l().width/(96/25.4)+1.5+"mm",r=l().height/(96/25.4)+"mm",p=a();return o!==d._v$15&&K(f,"x",d._v$15=o),u!==d._v$16&&K(f,"y",d._v$16=u),s!==d._v$17&&K(f,"width",d._v$17=s),r!==d._v$18&&K(f,"height",d._v$18=r),p!==d._v$19&&K(f,"fill",d._v$19=p),d},{_v$15:void 0,_v$16:void 0,_v$17:void 0,_v$18:void 0,_v$19:void 0}),f})()}}),(()=>{const l=ju.cloneNode(!0),a=m;return typeof a=="function"?At(a,l):m=l,ie(l,()=>n.label.label),ce(f=>{const d=c().x+"mm",o=c().y+"mm";return d!==f._v$13&&K(l,"x",f._v$13=d),o!==f._v$14&&K(l,"y",f._v$14=o),f},{_v$13:void 0,_v$14:void 0}),l})()]}})})},Hu=n=>{let e=v(()=>n.renderParams.modelPtToPagePt(n.position)),t=v(()=>"data:image/"+n.state.mimeType+";base64,"+n.state.base64Data);return U(je,{get when(){return e()},children:i=>[(()=>{const c=Uu.cloneNode(!0);return c.style.setProperty("position","absolute"),ce(m=>{const g=i().x+"mm",h=i().y-n.size.height+"mm",l=n.size.width+"mm",a=n.size.height+"mm",f=t();return g!==m._v$20&&c.style.setProperty("left",m._v$20=g),h!==m._v$21&&c.style.setProperty("top",m._v$21=h),l!==m._v$22&&c.style.setProperty("width",m._v$22=l),a!==m._v$23&&c.style.setProperty("height",m._v$23=a),f!==m._v$24&&K(c,"src",m._v$24=f),m},{_v$20:void 0,_v$21:void 0,_v$22:void 0,_v$23:void 0,_v$24:void 0}),c})(),U(tt,{get when(){return n.selected||n.highlighted},get children(){const c=Yu.cloneNode(!0);return c.style.setProperty("position","absolute"),c.style.setProperty("opacity","0.5"),ce(m=>{const g=i().x+"mm",h=i().y-n.size.height+"mm",l=n.size.width+"mm",a=n.size.height+"mm",f=n.selected?"green":"blue";return g!==m._v$25&&c.style.setProperty("left",m._v$25=g),h!==m._v$26&&c.style.setProperty("top",m._v$26=h),l!==m._v$27&&c.style.setProperty("width",m._v$27=l),a!==m._v$28&&c.style.setProperty("height",m._v$28=a),f!==m._v$29&&c.style.setProperty("background-color",m._v$29=f),m},{_v$25:void 0,_v$26:void 0,_v$27:void 0,_v$28:void 0,_v$29:void 0}),c}})]})};Ut(["click"]);const fl=10,Wu=fl*fl;class Qu{constructor(e){let t=(c,m,g)=>{let h=e.screenPtToModelPt(c);if(h!=null&&h.x>m.x&&h.x<m.x+g.width&&h.y>m.y&&h.y<m.y+g.height)return 0},i=(c,m)=>{let g=e.screenPtToModelPt(c);if(g==null)return;let h=Cl.fromOriginDirection(m.from,m.to.sub(m.from)),l=Math.max(0,Math.min(1,h.closestTimeToPoint(g))),a=h.pointFromTime(l),f=e.modelPtToScreenPt(a);if(f==null)return;let d=f.distanceSquared(c);if(!(d>Wu))return d};this.mkEntityUnderMouse=()=>v(()=>{let c=e.mousePos();if(c==null)return;let m,g;for(let h of Object.keys(e.entities())){let l=e.entities()[h];for(let a of Object.keys(l)){let f=l[a],d;switch(a){case xi.typeName:{let o=l[rn.typeName]?.state.position??ae.zero,u=f.state;d=t(c,o,u);break}case cn.typeName:{let o=f.state;d=i(c,o);break}}d!=null&&(m==null||d<m)&&(m=d,g=h)}}return g})}}const qu=Z('<div class="page"></div>'),Zu=`body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #FAFAFA;
    font: 12pt "Tahoma";
}
* {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
}
.page {
    overflow: none;
    width: 297mm;
    height: 209mm; /* 210mm */
    padding: 5mm;
    margin: 10mm auto;
    border: 1px #D3D3D3 solid;
    border-radius: 5px;
    background: white;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
}
.subpage {
    padding: 1cm;
    border: 5px red solid;
    height: 257mm;
    outline: 2cm #FFEAEA solid;
}

@page {
    size: A4 landscape;
    margin: 0;
}
@media print {
    html, body {
        width: 297mm;
        height: 209mm; /* 210mm */
    }
    .page {
        overflow: none;
        margin: 0;
        border: initial;
        border-radius: initial;
        width: initial;
        min-height: initial;
        box-shadow: initial;
        background: initial;
        page-break-after: always;
    }
}`;function Ju(n){let e=document.createElement("div");e.style.backgroundColor="white",e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.right="0px",e.style.bottom="0px",e.style.overflow="hidden",e.style.zIndex="99999",document.body.appendChild(e);const t=e.attachShadow({mode:"closed"});let i=document.createElement("style");i.appendChild(document.createTextNode(Zu)),t.append(i);let c=document.createElement("div");c.className="book",t.append(c);let m=()=>{};window.setTimeout(()=>{let l=window.open();l!=null&&(l.document.body.innerHTML=t.innerHTML,l.print(),m())});let h=ao(()=>U(On,{get each(){return n.pages()},children:l=>(()=>{const a=qu.cloneNode(!0);return ie(a,()=>l()({})),a})()}),c);m=()=>{h(),document.body.removeChild(e)}}const ec=Z('<div style="width: 100%; height: 100%; position: relative;"><div style="position: absolute; left: 0; top: 0;"></div><svg style="position: absolute; left: 0; top: 0; width: 100%; height: 100%;"></svg></div>'),tc=Z('<div style="flex-grow: 1; display: flex; flex-direction: column;"><div></div></div>'),nc=Z('<div style="position: absolute; left: 0; top: 0"><svg style="width: 100%; height: 100%;"></svg></div>'),ic=Z('<div style="position: absolute; left: 0; top: 0"></div>'),oc=Z('<div style="overflow-x: auto;"><table class="table-no-borders" style="white-space: nowrap;"><thead></thead><thead><tr><td colspan="5" style="text-align: center; border-left: 1px solid; border-right: 1px solid;">General</td><td colspan="8" style="text-align: center; border-right: 1px solid;">Add</td><td colspan="2" style="text-align: center; border-right: 1px solid;">Draw</td><td colspan="11" style="text-align: center; border-right: 1px solid;">Edit</td></tr><tr><td style="border-left: 1px solid;"><input class="btn btn-primary btn-sm" type="button" value="Undo"></td><td><input class="btn btn-primary btn-sm" type="button" value="Redo"></td><td><input class="btn btn-primary btn-sm" type="button" value="Select" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Print"></td><td style="border-right: 1px solid;"><input class="btn btn-primary btn-sm" type="button" value="Save to PDF" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Viewport"></td><td><input class="btn btn-primary btn-sm" type="button" value="Detail" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Section" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Dimension" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Angular Dim" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Text" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Text Area" disabled></td><td style="border-right: 1px solid;"><input class="btn btn-primary btn-sm" type="button" value="Image" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Line"></td><td style="border-right: 1px solid;"><input class="btn btn-primary btn-sm" type="button" value="Circle" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Copy" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Move" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Mirror" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Rotate" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Offset" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Trim" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Extend" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Fillet" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="Scale" disabled></td><td><input class="btn btn-primary btn-sm" type="button" value="To Front" disabled></td><td style="border-right: 1px solid;"><input class="btn btn-primary btn-sm" type="button" value="To Back" disabled></td></tr></thead></table></div>');function lc(){let n=Dt(),e=Dt();return{documents:[{id:n,name:"Untitled",pages:[{id:e,entities:{}}]}],currentDocumentId:n,currentPageId:e,mkMode:void 0,mousePos:void 0,screenPtToModelPt:void 0,modelPtToScreenPt:void 0,scale:void 0}}const rc=n=>{let e=new El,t=n.state,i=n.setState,c=v(()=>t.documents.find(({id:F})=>F==t.currentDocumentId)),m=v(()=>{let F=c();if(F!=null)return F.pages.find(({id:L})=>L==t.currentPageId)});const g=287,h=200,l=25.4,a=96,f=F=>{let L=t.screenPtToModelPt;if(L==null)return;let $=L(F);if($!=null)return ae.create(-5+$.x*l/a,5+h+$.y*l/a)},d=F=>{let L=t.modelPtToScreenPt;if(L!=null)return L(ae.create((F.x+5)*a/l,(F.y-5-h)*a/l))},o=F=>ae.create(F.x,h-F.y);let u=v(()=>m()?.entities??{}),s={width:g,height:h,get scale(){return t.scale==null?1:t.scale()},modelPtToScreenPt:d,modelPtToPagePt:o},r=new Qu({mousePos:()=>t.mousePos,screenPtToModelPt:f,modelPtToScreenPt:d,entities:u}),p={undoManager:e,width:g,height:h,screenPtToModelPt:f,modelPtToScreenPt:d,modelPtToPagePt:o,get mousePos(){return t.mousePos},pickingSystem:r,createEntityWithId(F,L){let $=t.documents.findIndex(({id:xe})=>xe==t.currentDocumentId);if($==-1)return"";let W=t.documents[$].pages.findIndex(({id:xe})=>xe==t.currentPageId);if(W==-1)return"";let te={};for(let xe of L)te[xe.type.typeName]=xe;return i("documents",$,"pages",W,"entities",F,te),F},createEntity(F){let L=Dt();return this.createEntityWithId(L,F),L},destroyEntity(F){let L=t.documents.findIndex(({id:te})=>te==t.currentDocumentId);if(L==-1)return;let $=t.documents[L].pages.findIndex(({id:te})=>te==t.currentPageId);if($==-1)return;let W={...t.documents[L].pages[$].entities};delete W[F],i("documents",L,"pages",$,"entities",Jn(W))},destroyEntityRecursive(F){let L=$=>{let W=t.documents.findIndex(({id:q})=>q==t.currentDocumentId);if(W==-1)return;let te=t.documents[W].pages.findIndex(({id:q})=>q==t.currentPageId);if(te==-1)return;let xe=t.documents[W].pages[te].entities[$];if(xe==null)return;let Pe=xe[Rn.typeName];if(Pe!=null){let q=Pe.state.childIds;for(let ge of q)L(ge)}let z={...t.documents[W].pages[te].entities};delete z[$],i("documents",W,"pages",te,"entities",Jn(z))};L(F)},getComponent(F,L){let $=t.documents.findIndex(({id:xe})=>xe==t.currentDocumentId);if($==-1)return;let W=t.documents[$].pages.findIndex(({id:xe})=>xe==t.currentPageId);if(W==-1)return;let te=t.documents[$].pages[W].entities[F];if(te!=null)return te[L.typeName]},getEntitiesWithComponentTypes(F){let L=t.documents.findIndex(({id:xe})=>xe==t.currentDocumentId);if(L==-1)return[];let $=t.documents[L].pages.findIndex(({id:xe})=>xe==t.currentPageId);if($==-1)return[];let W=[],te=t.documents[L].pages[$].entities;for(let xe in te){let Pe=!0;for(let z of F)if(te[xe][z.typeName]==null){Pe=!1;break}Pe&&W.push(xe)}return W},setComponents(F,L){let $=t.documents.findIndex(({id:Pe})=>Pe==t.currentDocumentId);if($==-1)return;let W=t.documents[$].pages.findIndex(({id:Pe})=>Pe==t.currentPageId);if(W==-1)return;let te={};for(let Pe of L)te[Pe.type.typeName]=Pe;if(t.documents[$].pages[W].entities[F]==null){let Pe={...t.documents[$].pages[W].entities};Pe[F]=te,i("documents",$,"pages",W,"entities",Pe)}else i("documents",$,"pages",W,"entities",F,te)},onDone:()=>{_e()},threeDModel:{get camera(){return n.camera},get labeler(){return n.labeler},get kits(){return n.kits}}},y=v(()=>t.mkMode==null?new mu(p):t.mkMode());const _=F=>{i("mkMode",()=>F)},w=v(()=>y().overlaySvg),S=v(()=>y().overlayHtml),b=v(()=>y().overlayUiHtml),x=v(()=>y().overlayUiSvg),k=v(()=>y().instructions),I=v(()=>{let F=y();return F.cursor?.call(F)}),D=v(()=>{let F=y();return F.disablePan?.call(F)??!1}),Y=v(()=>{let F=y();return F.highlightedEntities?.call(F)??[]}),Q=v(()=>{let F=y();return F.selectedEntities?.call(F)??[]}),N=v(()=>new Set(Y())),oe=v(()=>new Set(Q()));let ue=new Ku({renderParams:s,entities:u,highlightedEntitySet:N,selectedEntitySet:oe,modeParams:p,setMode:_}),J=()=>(()=>{const F=ec.cloneNode(!0),L=F.firstChild,$=L.nextSibling;return ie(L,()=>ue.renderHtml({}),null),ie(L,U(je,{get when(){return S()},children:W=>W()(s)}),null),ie($,()=>ue.renderSvg({}),null),ie($,U(je,{get when(){return w()},children:W=>W()(s)}),null),F})();const _e=()=>{i("mkMode",void 0)},Te=()=>{_(()=>new Ou(p))},se=()=>{_(()=>new xu(p))};{let F=L=>{if(L.key=="Escape"){let $=y();$.cancel?.call($),_e()}else{let $=y();$.keyDown?.call($,L.key)}};document.addEventListener("keydown",F),Ce(()=>{document.removeEventListener("keydown",F)})}let ee;return(()=>{const F=tc.cloneNode(!0),L=F.firstChild;ie(F,U(sc,{get canUndo(){return e.canUndo()},undo:()=>e.undo(),get canRedo(){return e.canRedo()},redo:()=>e.redo(),addViewport:Te,drawLines:se,CurrentPage:J}),L),L.$$mouseup=()=>{let W=y();W.mouseUp?.call(W)},L.$$mousedown=()=>{let W=y();W.mouseDown?.call(W)},L.$$click=W=>{let te=y();te.click?.call(te,W.ctrlKey)},L.addEventListener("mouseleave",()=>{i("mousePos",void 0)}),L.$$mousemove=W=>{if(ee==null)return;let te=ee.getBoundingClientRect();i("mousePos",ae.create(W.clientX-te.left,W.clientY-te.top))};const $=ee;return typeof $=="function"?At($,L):ee=L,L.style.setProperty("flex-grow","1"),L.style.setProperty("display","flex"),L.style.setProperty("flex-direction","column"),L.style.setProperty("background","lightgrey"),L.style.setProperty("position","relative"),ie(L,U(Us,{init:W=>{i("screenPtToModelPt",()=>W.screenPtToWorldPt),i("modelPtToScreenPt",()=>W.worldPtToScreenPt),i("scale",()=>W.scale)},uiSvgOverlay:()=>{let W=x();if(W!=null)return W(s)},get disablePan(){return D()},get document(){return U(J,{})}}),null),ie(L,U(je,{get when(){return b()},children:W=>W()(s)}),null),ie(L,()=>ue.overlayUiHtml(s),null),ie(L,U(je,{get when(){return x()},children:W=>(()=>{const te=nc.cloneNode(!0),xe=te.firstChild;return ie(xe,()=>W()(s)),te})()}),null),ie(L,U(je,{get when(){return k()},children:W=>(()=>{const te=ic.cloneNode(!0);return ie(te,()=>W()({})),te})()}),null),ce(()=>L.style.setProperty("cursor",I()??"auto")),F})()},sc=n=>(()=>{const e=oc.cloneNode(!0),t=e.firstChild,i=t.firstChild,c=i.nextSibling,m=c.firstChild,g=m.nextSibling,h=g.firstChild,l=h.firstChild,a=h.nextSibling,f=a.firstChild,d=a.nextSibling,o=d.nextSibling,u=o.firstChild,s=o.nextSibling,r=s.nextSibling,p=r.firstChild,y=r.nextSibling,_=y.nextSibling,w=_.nextSibling,S=w.nextSibling,b=S.nextSibling,x=b.nextSibling,k=x.nextSibling,I=k.nextSibling,D=I.firstChild;return l.$$click=()=>n.undo(),f.$$click=()=>n.redo(),u.$$click=()=>{Ju({pages:v(()=>[n.CurrentPage])})},p.$$click=()=>n.addViewport(),D.$$click=()=>n.drawLines(),ce(Y=>{const Q=!n.canUndo,N=!n.canRedo;return Q!==Y._v$&&(l.disabled=Y._v$=Q),N!==Y._v$2&&(f.disabled=Y._v$2=N),Y},{_v$:void 0,_v$2:void 0}),e})();Ut(["mousemove","click","mousedown","mouseup"]);let ac={kitsUserEdits:{displayName:"Kits User Edits",typeSchema:{type:"Json"},defaultValue:{}}};const dc=new xn({typeName:"KitsUserEdits",displayName:"Kits User Edits",propertiesSchema:ac}),Bn=dc;let uc={transform:{displayName:"Transform",typeSchema:Gl,defaultValue:he.identity}};const cc=new xn({typeName:"Transform",displayName:"Transform",propertiesSchema:uc}),Jt=cc;function fc(n,e,t){for(let i of t){if(!i.hasOwnProperty("kit"))return yn("kit field is missing.");let c=i.kit,m=i.kitId??Dt();if(!i.hasOwnProperty("space"))return yn("space field is missing.");let g=i.space;if(!c.hasOwnProperty("typeName"))return yn("typeName field is missing.");let h=c.typeName;if(!c.hasOwnProperty("data"))return yn("data field is missing.");let l=c.data,a=e.lookupComponentType(h);if(a==null)return yn("could not find `"+h+"` in registry.");let f=Zi(a.propertiesSchema,l);if(f.type=="Err")return yn(f.message);let d=i.kitsUserEdits??{},o=Zi(Jt.propertiesSchema,{transform:g});if(o.type=="Err")return yn(o.message);let u=a.create(f.value),s={};s[a.typeName]=u,s[Jt.typeName]=Jt.create(o.value),s[Bn.typeName]=Bn.create(d),n.createEntityWithId(m,[u,Jt.create(o.value),Bn.create(d)])}return ws({})}let hc={vertices:{displayName:"Vertices",typeSchema:{type:"Array",elemTypeSchema:so},defaultValue:[]},faces:{displayName:"Faces",typeSchema:{type:"Array",elemTypeSchema:{type:"Array",elemTypeSchema:{type:"Number"}}},defaultValue:[]},normals:{displayName:"Normals",typeSchema:{type:"MaybeUndefined",elemTypeSchema:{type:"Array",elemTypeSchema:so}},defaultValue:[]},uvs:{displayName:"UVs",typeSchema:{type:"MaybeUndefined",elemTypeSchema:{type:"Array",elemTypeSchema:_i}},defaultValue:[]},solid:{displayName:"Solid",typeSchema:{type:"MaybeUndefined",elemTypeSchema:{type:"Boolean"}},optional:!0,defaultValue:void 0}};const pc=new xn({typeName:"Mesh3d",displayName:"Mesh3d",propertiesSchema:hc}),mc=pc,gi=new _r([wr,Sr,Pr,kr,Ir,Tr,Mr,Ar,$r,Cr,Er,Or,Dr,Rr,Nr,Br,Fr,Lr,Bn,Cs,zr,mc,jr,Vr,Ur,Yr,Kr,$s,Xr,Gr,Hr,Wr,Qr,qr,Zr,Jr,es,ts,ns,is,os,Jt,ls,rs,ss,as,ds,us]);gi.addAlias("ProfileMemberKit","ProfileMember");class gc{constructor(e){let[t,i]=st(0),c=()=>{i(r=>1-r)},m=new Map,g=v(pl(t,()=>r=>m.get(r))),h=r=>g()(r);this.lookupKitById=h;let l=Sl(),a=new Map;for(let r of l)a.set(r.componentType.typeName,r);let f=v(()=>e.world.hookupAllEntities()),d=v(()=>f()());v(()=>{let r=new Map,p=new Map;for(let y of d()){let _=e.world.hookupEntityComponent(y,Rn);ce(()=>{let S=_();if(S!=null){let b=S;ce(()=>{r.set(y,b.state.childIds)})}});let w=e.world.hookupEntityComponent(y,qi);ce(()=>{let S=w();if(S!=null){let b=S;ce(()=>{p.set(y,b.state.parentId)})}})}return{entityChildrenMap:r,entityParentMap:p}});let o=r=>{let p=e.world.hookupChildEntities(r),y=v(()=>{let S=[];for(let b of p()){let x=e.world.hookupEntityComponent(b,To),k=v(()=>x()!=null);S.push(k)}return v(()=>S.every(b=>b()))}),_=v(()=>y()()),w=v(()=>{if(!_())return p;let S=v(gt(p,x=>{let k=e.world.hookupEntityComponent(x,To);return v(()=>({childId:x,orderIndex:k()?.state.orderIndex??0}))})),b=v(()=>S().map(x=>x()));return v(()=>b().sort((x,k)=>x.orderIndex-k.orderIndex).map(x=>x.childId))});return v(()=>w()())},u=r=>{let p=e.world.hookupEntityComponentSet(r),y=v(()=>p()??{}),_=v(()=>{let se=y(),ee;for(let F in se)if(ee=a.get(F),ee!=null)break;return ee}),w=v(()=>{let se=_();if(se!=null)return y()[se.componentType.typeName]}),S=v(()=>{let se=y()[Bn.typeName];if(se==null){let ee=Bn.create({kitsUserEdits:{}});e.world.setComponents(r,[ee]),se=ee}return se}),b=v(()=>{let se=_(),ee=w();if(se==null||ee==null)return;let F=S(),[L,$]=Ne(F.state.kitsUserEdits);return se.create(r,ee.state,ee.setState,()=>L,$)}),x=v(()=>y()[Jt.typeName]),k=v(()=>x()?.state.transform??he.identity),I=se=>{let F=e.world.getComponentSet(r)[Jt.typeName];F==null?e.world.setComponents(r,[Jt.create({transform:se})]):F.setState("transform",se)},D=o(r),Y=v(gt(D,u)),Q=v(()=>Y().flatMap(se=>nt(se()))),N=v(()=>{let se=b();return se==null?[]:se.kits==null?[]:se.kits()});v(()=>{let se=[...N()];for(;;){let ee=se.pop();if(ee==null)break;if(ee.kit.components!=null){let F=ee.kit.components();for(let L of F)L.localAabbFromMkObject3d()}}});let oe=v(()=>{let se=(()=>{let ee=b();if(ee==null)return vi.empty();let F=ee.components;if(F==null)return vi.empty();for(let L of F())L.localAabbFromMkObject3d()();return uo(F())})();for(let ee of Q())ee.localAabb().forEachCorner((F,L,$)=>{let W=ee.space().pointFromThisSpace(C.create(F,L,$));se.includePoint(W)});return se}),ue=()=>{let se=y(),ee={};for(let L in se){let $=se[L],W=Pl($.type.propertiesSchema,$.state);ee[L]=$.type.create(W)}let F=Dt();return $e(()=>{e.world.createEntityWithId(F,Object.keys(ee).map($=>ee[$]));let L=cs(ee,qi)?.state?.parentId;if(L!=null){let $=e.world.getComponent(L,Rn);$==null?($=Rn.create({childIds:[F]}),e.world.setComponents(L,[$])):$.setState("childIds",[...$.state.childIds,F])}}),F},J=()=>{e.world.destroyEntity(r)},_e=v(()=>{let se=b();if(se!=null)return co(se)}),Te=v(()=>nt(_e()).flatMap(se=>se()));return v(()=>{let se=b();if(se!=null)return{kitId:r,kit:se,space:k,setSpace:I,localAabb:oe,clone:ue,destroy:J,subObjects:Te,children:Q}})},s=v(gt(d,u));this.kits=v(()=>s().flatMap(r=>nt(r()))),re(()=>{m.clear();let p=[...this.kits()];for(;p.length!=0;){let y=p.pop();if(y==null)break;m.set(y.kitId,y),y.children!=null&&p.push(...y.children())}c()}),this.createKitWithId=(r,p,y,_)=>{let w={};w[p.componentType.typeName]=p.componentType.create(y),w[Jt.typeName]=Jt.create({transform:_}),e.world.createEntityWithId(r,Object.keys(w).map(S=>w[S]))},this.createKit=(r,p,y)=>{let _=Dt();return this.createKitWithId(_,r,p,y),_}}}const yc=Z("<h6>Scene Graph</h6>"),vc=Z('<ul class="tree"></ul>'),bc=Z("<li></li>"),xc=Z("<li><details><summary><div></div></summary><ul></ul></details></li>"),_c=n=>{let e=v(gt(()=>n.kits,t=>({type:"Kit",id:t.kitId,kit:t.kit})));return[yc.cloneNode(!0),(()=>{const t=vc.cloneNode(!0);return ie(t,U(Wl,{get kits(){return e()},useKitTypeForDisplayName:!0,atPath:[],get isSelected(){return n.isSelected},get setSelected(){return n.setSelected}})),t})()]};let Wl=n=>U(kt,{get each(){return n.kits},children:e=>{let t=v(()=>[...n.atPath,e.type=="Kit"?e.id:e.kit.id()]),i=v(()=>n.useKitTypeForDisplayName?e.type=="Kit"?e.kit.type.componentType.displayName:e.kit.id():e.type=="Kit"?e.id:e.kit.id()),c=v(()=>{switch(e.type){case"Kit":return co(e.kit);case"SubKitObject":return v(()=>e.kit.subKitObjects?.call(e.kit)??[])}}),m=v(gt(c(),a=>({type:"SubKitObject",kit:a}))),g=v(()=>m().length==0),h=v(()=>n.isSelected(t())),l=a=>{n.setSelected(t(),a)};return U(yi,{get children(){return[U(qt,{get when(){return g()},get children(){const a=bc.cloneNode(!0);return a.$$click=f=>{l(!0)},a.style.setProperty("cursor","pointer"),ie(a,i),ce(()=>a.style.setProperty("background-color",h()?"green":"white")),a}}),U(qt,{get when(){return!g()},get children(){const a=xc.cloneNode(!0),f=a.firstChild,d=f.firstChild,o=d.firstChild,u=d.nextSibling;return o.$$click=s=>{l(!0),s.preventDefault()},o.style.setProperty("cursor","pointer"),ie(o,i),ie(u,U(Wl,{get kits(){return m()},useKitTypeForDisplayName:!1,get atPath(){return t()},get isSelected(){return n.isSelected},get setSelected(){return n.setSelected}})),ce(()=>o.style.setProperty("background-color",h()?"green":"white")),a}})]}})}});Ut(["click"]);async function wc(n,e){if(e.length!=1)return Yi(n,e);let t=e[0].kit;if(t.replicadShape==null)return Yi(n,e);let i=t.replicadShape();if(i==null)return Yi(n,e);i=i.clone().scale(1e3);let c=n.o,m=n.u,g=n.vectorFromThisSpace(C.unitZ),h=new ir([c.x,c.y,c.z],[g.x,g.y,g.z],[m.x,m.y,m.z]);return{svgPaths:or(i,h).visible.toSVGPaths()}}async function Yi(n,e){if(!e.every(h=>h.kit.shapeId!=null&&h.kit.shapeId()!=null))return;let t=e.flatMap(h=>{if(h.kit.shapeId==null)return[];let l=h.kit.shapeId();return l==null?[]:[{shapeId:l,transform:h.space()}]}),i=await fs(t);if(i.type=="Err"){console.log(i.message);return}let c=i.value,m=await hs({shapeId:c,cameraTransform:n});if(m.type=="Err"){console.log(m.message);return}return await ps(c),{svgPaths:m.value}}const Sc=Z('<input type="text" style="margin-left: 5px;">'),An=Z("<br>"),Pc=Z('<input class="btn btn-primary" type="button" value="Cancel">'),kc=Z('<button class="btn btn-primary" style="margin-left: 0px; margin-right: 10px;">Close</button>'),Ic=Z('<button class="btn btn-primary" style="margin-right: 10px;">Save</button>'),Tc=Z('<li><a class="dropdown-item" style="cursor: pointer;">Opening</a></li>'),Mc=Z('<li><a class="dropdown-item" style="cursor: pointer;">Panel Brace</a></li>'),Ac=Z('<li><a class="dropdown-item" style="cursor: pointer;">Partition Wall</a></li>'),$c=Z('<li class="nav-item"><a class="nav-link" style="cursor: pointer;">Join Roof Plane Edges</a></li>'),Cc=Z('<li class="nav-item"><a class="nav-link" style="cursor: pointer;">Do Sheeting Take Off</a></li>'),Ec=Z('<li class="nav-item"><a class="nav-link" style="cursor: pointer;">Scale Image</a></li>'),Oc=Z('<li class="nav-item"><a class="nav-link" style="cursor: pointer;">Align</a></li>'),Dc=Z('<li class="nav-item"><a class="nav-link" style="cursor: pointer;">Copy</a></li>'),Rc=Z('<li class="nav-item"><a class="nav-link" style="cursor: pointer;">Extend</a></li>'),Nc=Z('<a class="nav-link" style="cursor: pointer;">Block Cut List Detailer</a>'),Bc=Z('<a class="nav-link" style="cursor: pointer;">Paper Space</a>'),Fc=Z('<div style="white-space: pre-wrap; font-size: 10pt;"></div>'),Lc=Z('<div style="position: relative; flex-grow: 1;"><div></div><div style="position: absolute; top: 0; left: 0; background: rgba(255, 255, 255, 0.5); pointer-events: none;"><div style="pointer-events: auto;"></div></div></div>'),zc=Z('<div style="flex-grow: 1; display: flex; flex-direction: column; overflow: hidden;"><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-fluid"><button class="btn btn-primary" style="margin-right: 10px;">Export</button><a class="navbar-brand">General Designer</a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Insert</a><ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" style="cursor: pointer;">Wall</a></li><li><a class="dropdown-item" style="cursor: pointer;">Kit</a></li><li><a class="dropdown-item" style="cursor: pointer;">Lines</a></li><li><a class="dropdown-item" style="cursor: pointer;">Dimensions</a></li></ul></li><li><a class="nav-link" style="cursor: pointer;">Auto Roofing</a></li><li class="nav-item"><a class="nav-link" style="cursor: pointer;">Move</a></li><li class="nav-item"><a class="nav-link" style="cursor: pointer;">Rotate</a></li><li class="nav-item"><a class="nav-link" style="cursor: pointer;">Group</a></li><li class="nav-item"></li><li class="nav-item"><a class="nav-link" style="cursor: pointer;">Screenshot (File)</a></li></ul></div><button class="btn btn-primary" style="margin-left: 0px; margin-right: 10px;">Load Pricing</button><i class="fa-solid" style="color: rgb(240,240,240);"></i></div></nav><div style="flex-grow: 1; display: flex; flex-direction: row; overflow: hidden;"><div style="overflow-y: auto;"></div><div style="flex-grow: 1; display: flex; flex-direction: column; overflow: hidden;"><div class="nav nav-tabs"><a class="nav-link" style="cursor: pointer;">Model</a><a class="nav-link" style="cursor: pointer;">BOM</a><a class="nav-link" style="cursor: pointer;">Documents</a><a class="nav-link" style="cursor: pointer;">HLR Drawing Test</a></div></div></div></div>'),jc=Z("<div><b>Filename:</b> </div>"),Vc=Z('<a class="nav-link" style="cursor: pointer;"></a>'),hl=Z('<button class="btn btn-primary" style="margin-left: 10px;">Delete</button>'),Uc=Z("<b>Fetching pricing...</b>"),Yc=Z("<b>Min Cost: </b>"),Kc=Z('<div><input id="generalDesigner_HLR_showGrid" type="checkbox" style="margin-left: 5px;"><label for="generalDesigner_HLR_showGrid" style="padding-left: 5px;">Show Grid?</label></div>'),Xc=Z('<div style="flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;"></div>'),Gc=Z('<svg><path stroke="black" fill="none" vector-effect="non-scaling-stroke"></path></svg>',4,!0),Hc=Z('<svg><line stroke="black" stroke-width="0.3" vector-effect="non-scaling-stroke"></line></svg>',4,!0),Ef=n=>{v(()=>n.signedIn??!1);let e,t,i=document.createElement("canvas"),c=document.createElement("canvas"),m,g,h=new jt,l,a,f=new Gi(45,4/3,.01,100),d=new Vl({mouseRay:()=>{if(ne!=null)return ne()},rayObjectCollision:P=>{if(N==null)return;let M,T;for(let A of N()){let V=P.toSpace(A.space()),j=Ss(A.kit,b,V);j==null||j<=0||(M==null||j<M)&&(M=j,T=A.kitId)}if(P.direction.z<0){let A=Re.xyPlane,V=P.collisionTimeWithPlane(A);V!=null&&V>0&&(M==null||V<M)&&(M=Math.min(5e4,V),T="Ground")}if(!(M==null||T==null))return{t:M,objectId:T}}});d.setSpace(he.create(C.create(6e3,3e3,6e3),we.identity)),d.lookAtTarget(),d.hookupEventListeners(i);let o=v(()=>{let P=d.space().w.scale(-1);return C.create(P.x,-P.z,P.y)}),u,s;const[r,p]=Ne({selectedTab:"Model",projection:"Perspective",world:Ri.mkEmpty(),selectedKitsById:[],showCladding:!0,showBackground:!0,hideBelowGround:!1,showDebugMarkings:!1,textured:!1,showSceneGraph:!1,extraFunctionality:"Locked"});re(pl(()=>r.showSceneGraph,()=>{te()}));const[y,_]=Ne(lc()),[w,S]=Ne(Yl());let b=P=>{switch(P){case bl.Cladding:return r.showCladding;default:return!0}},[x,k]=st(()=>[]),[I,D]=st(void 0),[Y,Q]=st(()=>{});(async()=>{let{kitsSystem:P,dispose:M}=di(T=>({kitsSystem:new gc({get world(){return r.world}}),dispose:T}));D(P),k(()=>P.kits),Q(()=>M)})(),Ce(()=>{Y()()});let N=v(()=>x()()),oe=(P,M,T,A)=>{let V=I();V?.createKitWithId(P,M,T,A)},ue=(P,M,T)=>{let A=Dt();return oe(A,P,M,T),A},J;{let P=new me;J=M=>{if(e==null||a==null||h==null)return;se();let T=.001;if(P.set(M.x,M.y,M.z),P.multiplyScalar(T),P.applyMatrix4(h.matrixWorld),P.project(a),P.z>1)return;let A=e.clientWidth,V=e.clientHeight;return ae.create(.5*A*(1+P.x),.5*V*(1-P.y))}}Rt(()=>{n.onInit!=null&&n.onInit({load:async P=>{let M;if(P.world==null){M=Ri.mkEmpty();let T=fc(M,gi,P.kits);if(T.type=="Err"){console.log(T.message);return}}else{let T=Ri.fromJSON(gi,P.world);if(T.type=="Err"){console.log(T.message);return}M=T.value}if(p("world",M),P.roofBlockCutList!=null){let T=tu(P.roofBlockCutList);T.type=="Err"?console.log(T.message):S(T.value)}},loadDefaultKit:async P=>{let M=gi.lookupComponentType(P);if(M==null)return;let T=M.propertiesSchema,A=M.create(Ao(T));r.world.createEntity([A])}})});const _e=()=>{if(i==null||a==null||u==null||s==null)return;let P=new me(a.matrix.elements[4],a.matrix.elements[5],a.matrix.elements[6]),M=new me(a.matrix.elements[8],a.matrix.elements[9],a.matrix.elements[10]),T=.5*i.height/Math.tan(.5*a.fov*Math.PI/180);u.uniforms.resolution.value=new Zt(i.width,i.height),u.uniforms.screenDistance.value=T,u.uniforms.cameraLocation.value=new me(a.position.x,-a.position.z,a.position.y),u.uniforms.cameraForward.value=new me(-M.x,M.z,-M.y),u.uniforms.cameraUp.value=new me(P.x,-P.z,P.y),u.uniforms.depthRangeNear.value=.01,u.uniforms.depthRangeFar.value=100,s.uniforms.resolution.value=new Zt(i.width,i.height),s.uniforms.scale.value=.01,s.uniforms.cameraLocation.value=new me(a.position.x,-a.position.z,a.position.y),s.uniforms.cameraForward.value=new me(-M.x,M.z,-M.y),s.uniforms.cameraUp.value=new me(P.x,-P.z,P.y)};let Te=v(()=>{if(r.mouseX==null||r.mouseY==null||e==null||t==null)return;let P=e.getBoundingClientRect(),M=t.getBoundingClientRect(),T=r.mouseX+P.left-M.left,A=r.mouseY+P.top-M.top;if(T<0||T>=M.width||A<0||A>=M.height)return;let O=new me(T/M.width*2-1,1-A/M.height*2,0).clone().unproject(f).clone().sub(f.position),E=f.position.clone(),B=1,X=(-.5*B-E.x)/O.x,le=(.5*B-E.x)/O.x,ye=(-.5*B-E.y)/O.y,ze=(.5*B-E.y)/O.y,Ge=(-.5*B-E.z)/O.z,Ke=(.5*B-E.z)/O.z,pt=[{t:X,face:"-x"},{t:le,face:"+x"},{t:ye,face:"-y"},{t:ze,face:"+y"},{t:Ge,face:"-z"},{t:Ke,face:"+z"}],St,_t;for(let lt of pt)if(lt.t!=null&&(St==null||lt.t<St)){switch(lt.face){case"-x":case"+x":{let Le=E.y+O.y*lt.t,rt=E.z+O.z*lt.t;if(Le<-.5*B||Le>.5*B||rt<-.5*B||rt>.5*B)continue;break}case"-y":case"+y":{let Le=E.z+O.z*lt.t,rt=E.x+O.x*lt.t;if(Le<-.5*B||Le>.5*B||rt<-.5*B||rt>.5*B)continue;break}case"-z":case"+z":{let Le=E.x+O.x*lt.t,rt=E.y+O.y*lt.t;if(Le<-.5*B||Le>.5*B||rt<-.5*B||rt>.5*B)continue;break}}St=lt.t,_t=lt.face}return _t}),[se,ee]=st(0),F=()=>{ee(1-ve(()=>se()))},L=new Xi;{let P=new ui,M=[],T={px:{face:"+x",normal:P.load(Xs,()=>$()),highlighted:P.load(Zs)},nx:{face:"-x",normal:P.load(Ks,()=>$()),highlighted:P.load(qs)},py:{face:"+y",normal:P.load(Hs,()=>$()),highlighted:P.load(ea)},ny:{face:"-y",normal:P.load(Gs,()=>$()),highlighted:P.load(Js)},pz:{face:"+z",normal:P.load(Qs,()=>$()),highlighted:P.load(na)},nz:{face:"-z",normal:P.load(Ws,()=>$()),highlighted:P.load(ta)}},A=!0;for(let j of[T.px,T.nx,T.py,T.ny,T.pz,T.nz]){let O=new wt({color:"#AAAAAA"});M.push(O);let E=v(()=>Te()==j.face);re(()=>{E()?O.map=j.highlighted:O.map=j.normal,O.needsUpdate=!0,A||$()})}A=!1;let V=new Ze(new Pt(1,1,1),M);L.add(V)}let $;{let P=!1,M=[];$=T=>{T!=null&&M.push(T),!P&&(P=!0,requestAnimationFrame(()=>{P=!1,W();for(let A of M)A();M.splice(0,M.length)}))}}let W=()=>{if(e!=null&&m!=null&&g!=null&&l!=null&&a!=null){m.setScissorTest(!1),m.setScissorTest(!0);{const P=e.getBoundingClientRect();switch(m.setScissor(0,0,P.width,P.height),m.setViewport(0,0,P.width,P.height),a.aspect=P.width/P.height,a.updateProjectionMatrix(),m.clearColor(),m.clearDepth(),r.projection){case"Perspective":m.render(g,a);break;case"Orthographic":{let M=e.clientWidth/e.clientHeight,T=3;l.left=-.5*M*T,l.right=.5*M*T,l.top=.5*T,l.bottom=-.5*T,l.updateProjectionMatrix(),l.position.copy(a.position),l.quaternion.copy(a.quaternion),l.updateMatrixWorld(),m.render(g,l);break}}}if(t!=null){m.clearDepth();let P=i.getBoundingClientRect();const M=t.getBoundingClientRect();m.setScissor(M.left-P.left,P.bottom-M.bottom,M.width,M.height),m.setViewport(M.left-P.left,P.bottom-M.bottom,M.width,M.height);let T=new me(0,0,-1);T.applyQuaternion(a.quaternion),T.normalize(),T.multiplyScalar(-3.5),f.position.set(T.x,T.y,T.z),f.lookAt(new me(0,0,0)),f.aspect=M.width/M.height,f.updateProjectionMatrix();let A=m.clippingPlanes;m.clippingPlanes=[],m.render(L,f),m.clippingPlanes=A}}};Rt(()=>{if(e==null||i==null)return;i.width=e.clientWidth,i.height=e.clientHeight,m=new wl({canvas:i,antialias:!0,alpha:!0,preserveDrawingBuffer:!0,logarithmicDepthBuffer:!0}),m.useLegacyLights=!0,m.autoClear=!1,m.shadowMap.enabled=!0,m.shadowMap.type=fr,m.setPixelRatio(window.devicePixelRatio);{let O=m,E=!0;re(()=>{if(r.hideBelowGround){let B=new Hn;B.normal.set(0,1,0),O.clippingPlanes=[B]}else O.clippingPlanes=[];E?E=!1:$()})}g=new Xi;let P=new jt;P.rotateX(-90*Math.PI/180),P.add(h),g.add(P),l=new hr,a=new Gi(45,i.clientWidth/i.clientHeight,.01,100),a.position.set(6,3,6);let[M,T]=st(void 0);new ui().load("./resources/grass01.jpg",O=>{g!=null&&(O.wrapS=Tn,O.wrapT=Tn,O.repeat.set(200,200),T(O))}),re(()=>{if(g==null)return;let O=g,E=M();if(E!=null){let B=new pr(400,400,5,5);B.rotateX(-.5*Math.PI);let X=new ml({map:E}),le=new Ze(B,X);le.receiveShadow=!0,X.map=E,X.needsUpdate=!0;let ye=!1;re(()=>{r.showBackground&&r.textured?ye||(O.add(le),ye=!0,$()):ye&&(O.remove(le),ye=!1,$())}),Ce(()=>{ye&&(O.remove(le),ye=!1),B.dispose(),X.dispose(),$()})}});let[A,V]=st(void 0);new ui().load("./resources/sky.jpg",O=>{V(O)}),re(()=>{if(g==null)return;let O=g,E=A();if(E!=null){E.repeat.set(1,1.5);let B=new mr(60,25,25,0,2*Math.PI,0,Math.PI);B.translate(0,30,0),B.rotateY(.8);let X=new wt({map:E,side:gr}),le=new Ze(B,X),ye=!1;re(()=>{r.showBackground&&r.textured?ye||(re(()=>{se(),a!=null&&le.position.copy(a.position)}),a!=null&&le.position.copy(a.position),O.add(le),ye=!0,$()):ye&&(O.remove(le),ye=!1,$())}),Ce(()=>{ye&&(O.remove(le),ye=!1),B.dispose(),X.dispose(),$()})}});{let O=new ms,[E,B]=st(!1),X=new jt;O.load("./resources/grass1.gltf",ye=>{if(g==null)return;let ze=ye.scene.children[0];ze.geometry.scale(.02,.02,.02);const Ge=200;let Ke=new yr(ze.geometry,ze.material,Ge);for(let pt=0;pt<Ge;++pt){let St=new vr,_t=Math.random()*40-20,lt=Math.random()*40-20;St.makeRotationY(Math.random()*2*Math.PI),St.setPosition(_t,0,lt),Ke.setMatrixAt(pt,St)}Ke.renderOrder=-1,X.add(Ke),B(!0)});let le=!1;re(()=>{if(g==null)return!1;E()&&r.showBackground&&r.textured?le||(g.add(X),le=!0,$()):le&&(g.remove(X),le=!1,$())})}{let O=new Pt(-70,-70,-70);u=new Hi({uniforms:{resolution:{value:new Zt},screenDistance:{value:0},cameraLocation:{value:new me},cameraForward:{value:new me},cameraUp:{value:new me},depthRangeNear:{value:0},depthRangeFar:{value:0}},vertexShader:Ji,fragmentShader:Tl,transparent:!0}),s=new Hi({uniforms:{resolution:{value:new Zt},scale:{value:0},cameraLocation:{value:new me},cameraForward:{value:new me},cameraUp:{value:new me}},vertexShader:Ji,fragmentShader:Bs});let E=new Ze(O,u);E.receiveShadow=!0,E.renderOrder=-1,E.onBeforeRender=()=>{a!=null&&(E.position.copy(a.position),E.updateMatrix()),_e()};{let B=g,X=E;re(()=>{r.showBackground&&!r.textured?B.add(X):B.remove(X),$()})}{let B=!0,X=u,le=s;re(()=>{switch(r.projection){case"Perspective":E.material=X;break;case"Orthographic":E.material=le;break}B||$()}),B=!1}{let B=!0,X=new jt;P.add(X),re(()=>{if(X.clear(),!(r.mode==null||r.mode.overlayObject3d==null)){let le=r.mode.overlayObject3d();le!=null&&X.add(le)}B||$()}),B=!1}}re(()=>{let O=d.space();if(a!=null){let E=.001,B=O.o,X=O.orientation;a.position.set(B.x*E,B.y*E,B.z*E),a.quaternion.set(X.x,X.y,X.z,X.w),a.updateMatrix()}$(()=>F())});{var j=new xl(16777215,16777215,.3);j.color.setHSL(.6,.75,.5),j.groundColor.setHSL(.095,.5,.5),j.position.set(0,500,0),g.add(j)}{let O=new bi(16777215,.3);O.position.set(-100,-100,100),g.add(O)}{let O=new _l(16777215,.4);g.add(O)}{let O=new bi(16777215,1.2);O.position.set(100,100,-100),O.castShadow=!0,O.shadow.camera.scale.set(2,2,2),O.shadow.mapSize.width=1024,O.shadow.mapSize.height=1024,O.shadow.camera.near=.5,O.shadow.camera.far=500,g.add(O);let E=!1;const B=new br(O.shadow.camera);re(()=>{g!=null&&(r.showDebugMarkings?E||(g.add(B),E=!0,$()):E&&(g.remove(B),E=!1,$()))})}$()}),i.style.position="absolute",i.style.left="0",i.style.top="0",i.addEventListener("mousemove",P=>{p("mouseX",P.offsetX),p("mouseY",P.offsetY)}),i.addEventListener("wheel",P=>{P.deltaY!=0&&(P.deltaY<0?tn.focusInwards():P.deltaY>0&&tn.focusOutwards())}),c.style.position="absolute",c.style.left="0",c.style.top="0",c.style.pointerEvents="none";const te=()=>{e==null||i==null||m==null||g==null||a==null||!i.isConnected||(i.width=e.clientWidth,i.height=e.clientHeight,(e.clientWidth!=c.width||e.clientHeight!=c.height)&&(c.width=e.clientWidth,c.height=e.clientHeight),a.aspect=e.clientWidth/e.clientHeight,a.updateProjectionMatrix(),m.setSize(i.width,i.height),$())};re(()=>{let P=r.mode;if(P==null)return;let M=P.arrows,T=P.snapPoints,A=P.snapLines,V=P.dottedWorkingLines;re(()=>{Ce(()=>{let O=c.getContext("2d");O?.clearRect(0,0,c.width,c.height)});let j=c.getContext("2d");if(j!=null){if(j.clearRect(0,0,c.width,c.height),T!=null){se();let O=T();j.save();for(let E of O){j.beginPath();let B=J(E.pt());B!=null&&(j.arc(B.x,B.y,5,0,2*Math.PI),E.highlighted()?j.fillStyle="green":j.fillStyle="blue",j.fill())}j.restore()}if(M!=null){se();let O=M();j.save(),j.strokeStyle="blue",j.fillStyle="blue";let E=.5*Math.sqrt(3);for(let B of O){let X=J(B.from()),le=J(B.to());if(X==null||le==null)continue;j.beginPath(),j.moveTo(X.x,X.y),j.lineTo(le.x,le.y),j.stroke();let ye=le.sub(X).normalize();if(!Number.isFinite(ye.x))continue;let ze=ae.create(-ye.y,ye.x),Ge=le.add(ye.scale(-10*E).add(ze.scale(5))),Ke=Ge.add(ze.scale(-10));j.beginPath(),j.moveTo(le.x,le.y),j.lineTo(Ge.x,Ge.y),j.lineTo(Ke.x,Ke.y),j.closePath(),j.fill()}j.restore()}if(A!=null){se();let O=A();j.save(),j.strokeStyle="green",j.lineWidth=3;for(let E of O){let B=E.line();E.highlighted()?j.strokeStyle="green":j.strokeStyle="blue";let X=J(B.v1),le=J(B.v2);X==null||le==null||(j.beginPath(),j.moveTo(X.x,X.y),j.lineTo(le.x,le.y),j.stroke())}j.restore()}if(V!=null){se();let O=V();j.save(),j.strokeStyle="black",j.setLineDash([4,2]);for(let E of O){let B=J(E.v1),X=J(E.v2);B==null||X==null||(j.beginPath(),j.moveTo(B.x,B.y),j.lineTo(X.x,X.y),j.stroke())}j.restore()}}})});const xe=()=>{te()};Rt(()=>{window.addEventListener("resize",xe),te()}),Ce(()=>{window.removeEventListener("resize",xe)}),re(()=>{if(a!=null&&r.movingCameraToView!=null){let P,M=ve(()=>d.orbitTarget()),T=new me(M.x,M.y,M.z).multiplyScalar(.001),A=ve(()=>d.space().o.distance(d.orbitTarget())*.001),V=j=>{if(a==null||r.movingCameraToView==null)return;P==null&&(P=j);let O=j-P,E=Math.min(1,O/500);a.quaternion.slerpQuaternions(r.movingCameraToView.startOrientation,r.movingCameraToView.endOrientation,E),a.position.set(0,0,1).applyQuaternion(a.quaternion).multiplyScalar(A).add(T),a.updateMatrix(),$(),E!=1?requestAnimationFrame(V):(d.setSpace(he.create(C.create(a.position.x*1e3,a.position.y*1e3,a.position.z*1e3),new we(a.quaternion.w,a.quaternion.x,a.quaternion.y,a.quaternion.z))),p("movingCameraToView",void 0))};requestAnimationFrame(V)}});const Pe=P=>{if(a==null||r.movingCameraToView!=null)return;let M=a.position.length(),T=a.quaternion.clone(),A;switch(P){case"-x":A=we.fromUV(C.unitZ,C.unitY);break;case"+x":A=we.fromUV(C.negUnitZ,C.unitY);break;case"-y":A=we.fromUV(C.negUnitX,C.negUnitZ);break;case"+y":A=we.fromUV(C.unitX,C.negUnitZ);break;case"-z":A=we.fromUV(C.negUnitX,C.unitY);break;case"+z":A=we.fromUV(C.unitX,C.unitY);break}let V=new Vt(A.x,A.y,A.z,A.w);p("movingCameraToView",{camDistFromOrigin:M,startOrientation:T,endOrientation:V})};let z;{let P,M;i.addEventListener("mousedown",T=>{P=T.clientX,M=T.clientY}),i.addEventListener("click",T=>{if(P!=null&&M!=null){let A=T.clientX-P,V=T.clientY-M;A*A+V*V<5*5&&z(T)}else z(T);P=void 0,M=void 0})}z=P=>{let M=Te();if(M!=null){Pe(M);return}let T=r.mode;if(T!=null)T.click!=null&&T.click(P.ctrlKey);else{let A,V=mn();if(V==null?(p("selectedSubKitObject",void 0),A=!1):(p("selectedSubKitObject",new Ot(V)),A=!0),!A){let j=Ln();if(j!=null){let O=j;P.ctrlKey?r.selectedKitsById.some(B=>B==O.kitId)?p("selectedKitsById",r.selectedKitsById.filter(B=>B!=O.kitId)):p("selectedKitsById",[...r.selectedKitsById,O.kitId]):p("selectedKitsById",[O.kitId])}else p("selectedKitsById",[])}te()}};let q=v(()=>{if(r.mouseX!=null&&r.mouseY!=null)return ae.create(r.mouseX,r.mouseY)});const ge=new Wi;let ne=v(()=>{if(se(),r.mouseX==null||r.mouseY==null||i==null||a==null)return;ge.setFromCamera(new Zt(r.mouseX/i.clientWidth*2-1,-(r.mouseY/i.clientHeight)*2+1),a);let P=ge.ray;return Xe.create(C.create(P.origin.x*1e3,-P.origin.z*1e3,P.origin.y*1e3),C.create(P.direction.x,-P.direction.z,P.direction.y))}),be=v(()=>{if(se(),i==null||a==null)return;ge.setFromCamera(new Zt(0,0),a);let P=ge.ray;return Xe.create(C.create(P.origin.x*1e3,-P.origin.z*1e3,P.origin.y*1e3),C.create(P.direction.x,-P.direction.z,P.direction.y))}),Be=v(()=>{let P=d.space();return he.create(C.zero,we.fromVW(C.unitZ,C.negUnitY)).fromThisSpace(P)});const ke=()=>{if(h==null)return;new js().parse(h,M=>{if(M instanceof ArrayBuffer){let T=new Blob([M],{type:"model/gltf-binary"});Oi.saveAs(T,"export.glb")}else{let T=new Blob([JSON.stringify(M)],{type:"model/gltf+json"});Oi.saveAs(T,"export.gltf")}},M=>{console.log(M)},{})},Oe=()=>{fe(()=>new du({projectPtToScreen:P=>(se(),J(P)),kitFaceUnderMouse:ut(),getKitSpace(P){let M=N().find(({kitId:T})=>T==P);return M==null?he.identity:M.space()},setKitSpace(P,M){let T=N().find(({kitId:A})=>A==P);T?.setSpace(M)},onDone:()=>{fe(void 0)}}))},Je=()=>{fe(()=>new cu({projectPtToScreen:J,mousePos:q,mouseRay:ne,initSelectedObjectIds:r.selectedKitsById,objects:v(gt(N,P=>({id:()=>P.kitId,transform:P.space,setTransform:M=>{P.setSpace(M)},rayCollisionTime:M=>{let T=M.toSpace(P.space());return P.localAabb().rayCollisionTime(T)}}))),cloneObject:(P,M)=>{let T=P,A=N().find(({kitId:j})=>j==T);if(A==null)return;let V=A.clone();return{id:()=>V}},destroyObject:P=>{let M=P,T=N().find(({kitId:A})=>A==M);T?.destroy()},onDone:()=>{fe(void 0)}}))},De=()=>{fe(()=>new da({projectPtToScreen:J,mouseRay:ne,render:$,walls:yo,insertOpening:P=>{let M=P.location;if(M.head()!="Kit")return;let T=M.tail();if(T==null)return;let A=T.head();if(A==null)return;let V=Number.parseInt(A);if(!Number.isFinite(V))return;let j=T.tail();if(j==null||V<0||V>=N().length)return;let O=N()[V].kit.insertOpening;if(O==null)return;let E=O,B=ve(()=>E());B?.({...P,location:j})}}))},We=()=>{fe(()=>new ua({mouseRay:ne,render:$,walls:bo,insertPartitionWall:P=>{if(P.head()!="Kit")return;let M=P.tail();if(M==null)return;let T=M.head();if(T==null)return;let A=Number.parseInt(T);if(!Number.isFinite(A))return;let V=M.tail();if(V==null||A<0||A>=N().length)return;let j=N()[A].kit.insertPartitionWall;if(j==null)return;let O=j,E=ve(()=>O());E?.(V)}}))},Ue=()=>{fe(()=>new su({projectPtToScreen:J,mouseRay:ne,cameraFacingDir:be,render:$,walls:vo,insertBrace:({wallLocation:P,fromId:M,toId:T})=>{if(P.head()!="Kit")return;let A=P.tail();if(A==null)return;let V=A.head(),j=A.tail();if(j==null)return;let O=N().find(({kitId:X})=>X==V);if(O==null)return;let E=O.kit.insertPanelBrace;if(E==null)return;let B=E();B?.({location:j,fromId:M,toId:T})}}))},Ye=()=>{fe(()=>new ca({projectPtToScreen:J,mousePos:q,mouseRay:ne,roofPlanes:Ti,groundLines:v(()=>N().flatMap(P=>{let M=P.kit;if(!(M instanceof ln))return[];let T=M.line();return T.v1.z!=0||T.v2.z!=0?[]:[{id:P.kitId,line:fo.create(T.v1.xy(),T.v2.xy())}]}))}))},at=()=>{let{sheetPositions:P}=Wa({roofPlanes:N().flatMap(E=>{let B=E.kit;if(!(B instanceof Mn))return[];let X=B.joinRoofPlaneEdgesRoofPlanes();if(X.length!=1)return[];let le=X[0];return[{id:E.kitId,vertices:le.vertices()}]})}),M={},T=0,A={};for(let E of P){let B=M[E.roofPlaneId];B==null&&(B=[],M[E.roofPlaneId]=B),B.push(E),A[E.sectionId]==null&&(A[E.sectionId]=T++)}let V=T,j=[];for(let E=0;E<V;++E)j[E]=E;for(let E=0;E<j.length-1;++E){let B=Math.floor(Math.random()*(j.length-1-E)),X=j[E];j[E]=B,j[B]=X}let O={};for(let E in A)O[E]=lr(j[A[E]],V);$e(()=>{for(let E of N()){let B=E.kit;if(B instanceof Mn){B.clearSheetingTakeOff();let X=M[E.kitId];if(X!=null){let le={};for(let ye of X){let ze=le[ye.sectionId];ze==null&&(ze=[],le[ye.sectionId]=ze),ze.push(ye)}for(let ye in le){let ze=O[ye],Ge=le[ye];B.addVerticalSheetingTakeOffPositions({sectionColour:ze,sheets:Ge.map(({pos:Ke,length:pt})=>({position:Ke,length:pt}))})}}}}})},pe=()=>{fe(()=>new fa({mouseRay:()=>ne(),render:$,insertWall:(P,M)=>{let T=P,A=M,V=T.distance(A),j=A.sub(T).normalize().toVec3(),O=C.unitZ,E=T.add(A).scale(.5).toVec3(),B=new Pt(V/1e3,80/1e3,1e3/1e3),X=we.fromWU(O,j),le=new Ki,ye=new Ze(B,le);ye.position.set(E.x/1e3,E.y/1e3,E.z/1e3),ye.quaternion.set(X.x,X.y,X.z,X.w),ye.updateMatrix(),h.add(ye)}}))},Xt=()=>{fe(()=>{let P=gt(N,M=>{let T=M.kit;if(T instanceof ln)return{id:M.kitId,line:T.line}});return new Al({undoManager:new El,cameraLookDir:o,projectPtToScreen:J,mousePos:q,mouseRay:ne,otherSnapPoints:v(()=>N().flatMap(M=>{let T=M.kit;if(T instanceof ln)return[];let A=M.space(),V=[];if(T.snapPoints!=null){let j=T.snapPoints();for(let O of j)V.push(A.pointFromThisSpace(O))}else M.localAabb().forEachCorner((j,O,E)=>{V.push(A.pointFromThisSpace(C.create(j,O,E)))});return V})),existingLines:v(()=>P().flatMap(M=>M==null?[]:[{id:M.id,line:M.line()}])),createLine:(M,T)=>{let A=T??Dt();return oe(A,Es,{from:{x:M.v1.x,y:M.v1.y,z:M.v1.z},to:{x:M.v2.x,y:M.v2.y,z:M.v2.z}},he.identity),{id:A}},updateLine:({id:M,line:T})=>{let A=N().find(V=>V.kitId==M);A!=null&&A.kit instanceof ln&&A.kit.updateLine(T)},destroyLine:M=>{let T=N().find(A=>A.kitId==M);if(T!=null){T.destroy();let A=T;return{undelete:()=>{di(j=>({kit:Ps(A.kit,A.kitId),dispose:j})),oe(A.kitId,A.kit.type,A.kit.state,A.space())}}}return{undelete:()=>{}}},allowAlignAll:()=>!0})})},vt=async()=>{await gs(),fe(()=>new Ha({projectPtToScreen:J,mousePos:q,mouseRay:ne,snapPoints:v(()=>N().flatMap(P=>{let M=P.kit;if(M instanceof Mn){let T=P.space();return M.snapPoints().map(A=>T.pointFromThisSpace(A))}else return[]})),createDimension:({line:P,offset:M})=>({id:ue(vs,{from:{x:P.v1.x,y:P.v1.y,z:P.v1.z},to:{x:P.v2.x,y:P.v2.y,z:P.v2.z},dimStringOffset:{x:M.x,y:M.y,z:M.z}},he.identity)}),updateDimension:({id:P,line:M,offset:T})=>{let A=N().find(V=>V.kitId==P);A!=null&&A.kit instanceof bs&&A.kit.updateDim({line:M,offset:T})},destroyDimension:P=>{let M=N().find(T=>T.kitId==P);M?.destroy()}}))};let bt=new ui,xt=v(()=>{let P=bt.load($o(),()=>$());P.wrapS=Tn,P.repeat.set(11,1);let M=bt.load($o(),()=>$());M.wrapS=Tn,M.repeat.set(11,1),M.rotation=.5*Math.PI;let T=bt.load(Co(),()=>$());T.wrapS=Tn,T.repeat.set(4,1);let A=bt.load(Co(),()=>$());return A.wrapS=Tn,A.repeat.set(4,1),A.rotation=.5*Math.PI,{corroNormalMap:P,horizontalCorroNormalMap:M,steelCladNormalMap:T,horizontalSteelCladNormalMap:A}});const Qe=()=>{fe(()=>new ra({projectPtToScreen:J,mousePos:q,mouseRay:ne,render:$,existingLines:v(()=>N().flatMap(P=>P.kit instanceof ln?[{id:P.kitId,line:P.kit.line()}]:[])),insertKit:(P,M,T)=>{ue(P,M,T),(P.defaultInsertMulti==null||P.defaultInsertMulti==!1)&&fe(void 0)},textures:xt,sheetingLowPoly:()=>!1}))};let Me;const fe=P=>{if(Me!=null&&(Me(),Me=void 0),P!=null){let M=di(T=>(Me=T,P()));p("mode",M)}else p("mode",void 0)};Ce(()=>{Me?.()});let dt=P=>{P.key=="Escape"?(r.mode!=null&&r.mode.cancel!=null&&r.mode.cancel(),fe(void 0)):P.key=="Delete"&&(r.selectedKitsById.length!=0||r.selectedSubKitObject!=null)&&it(),r.mode!=null&&r.mode.keyDown!=null&&r.mode.keyDown(P.key)},it=()=>{if(r.selectedSubKitObject!=null)r.selectedSubKitObject.value.delete?.call(void 0),p("selectedSubKitObject",void 0),setTimeout(()=>te());else{if(r.selectedKitsById.length==0)return;let P=new Set;for(let T of r.selectedKitsById)P.add(T);let M=N().flatMap(T=>P.has(T.kitId)?T:[]);for(let T of M)T.destroy();p("selectedKitsById",[]),setTimeout(()=>te())}};Rt(()=>document.addEventListener("keydown",dt)),Ce(()=>document.removeEventListener("keydown",dt));let ot=v(()=>[...N().map(({kit:P,space:M})=>new Qi({children:P.components,transform:M}))]);Il({group:h,kits:v(gt(N,P=>({kitId:()=>P.kitId,kit:()=>P.kit,space:P.space}))),rerender:()=>$(),isLayerVisible:b,showDebugMarkings:()=>r.showDebugMarkings,textured:()=>r.textured});let ut=()=>{let P=new Wi;return v(()=>{if(r.mouseX==null||r.mouseY==null||g==null||a==null)return;P.setFromCamera(new Zt(r.mouseX/i.clientWidth*2-1,-(r.mouseY/i.clientHeight)*2+1),a);let M=P.intersectObject(g),T,A,V,j;for(let Le of M){if(Le.face==null||Le.face==null)continue;let rt=Le.object;if(!(rt instanceof Ze))continue;let mt=rt;for(;;){if(mt.userData instanceof Ms){let $t=P.ray.at(Le.distance,new me);T=mt,A=Le.face,V=rt,j=C.create($t.x*1e3,-$t.z*1e3,$t.y*1e3);break}if(mt.parent==null)break;mt=mt.parent}if(T!=null)break}if(T==null||A==null||V==null||j==null)return;let O=V.geometry.attributes.position.array,E=new me(O[A.a*3],O[A.a*3+1],O[A.a*3+2]),B=new me(O[A.b*3],O[A.b*3+1],O[A.b*3+2]),X=new me(O[A.c*3],O[A.c*3+1],O[A.c*3+2]);E.applyMatrix4(V.matrixWorld),B.applyMatrix4(V.matrixWorld),X.applyMatrix4(V.matrixWorld),E.multiplyScalar(1e3),B.multiplyScalar(1e3),X.multiplyScalar(1e3);let le=C.create(E.x,-E.z,E.y),ye=C.create(B.x,-B.z,B.y),ze=C.create(X.x,-X.z,X.y),Ge=ye.sub(le).cross(ze.sub(le)).normalize(),Ke=Re.fromKnownPtAndNormal(le,Ge),pt=[],St=.001,_t=St*St,lt=V.geometry.index?.array;if(lt)for(let Le=0;Le<lt.length;Le+=3){let rt=lt[Le],mt=lt[Le+1],$t=lt[Le+2],It=new me(O[rt*3],O[rt*3+1],O[rt*3+2]),Ct=new me(O[mt*3],O[mt*3+1],O[mt*3+2]),Tt=new me(O[$t*3],O[$t*3+1],O[$t*3+2]);It.applyMatrix4(V.matrixWorld),Ct.applyMatrix4(V.matrixWorld),Tt.applyMatrix4(V.matrixWorld),It.multiplyScalar(1e3),Ct.multiplyScalar(1e3),Tt.multiplyScalar(1e3);let nn=C.create(It.x,-It.z,It.y),Gt=C.create(Ct.x,-Ct.z,Ct.y),on=C.create(Tt.x,-Tt.z,Tt.y);Ke.closestPoint(nn).distanceSquared(nn)<=_t&&Ke.closestPoint(Gt).distanceSquared(Gt)<=_t&&Ke.closestPoint(on).distanceSquared(on)<=_t&&pt.push({v1:nn,v2:Gt,v3:on})}else for(let Le=0;Le<O.length;Le+=9){let rt=Le,mt=Le+3,$t=Le+6,It=new me(O[rt],O[rt+1],O[rt+2]),Ct=new me(O[mt],O[mt+1],O[mt+2]),Tt=new me(O[$t],O[$t+1],O[$t+2]);It.applyMatrix4(V.matrixWorld),Ct.applyMatrix4(V.matrixWorld),Tt.applyMatrix4(V.matrixWorld),It.multiplyScalar(1e3),Ct.multiplyScalar(1e3),Tt.multiplyScalar(1e3);let nn=C.create(It.x,-It.z,It.y),Gt=C.create(Ct.x,-Ct.z,Ct.y),on=C.create(Tt.x,-Tt.z,Tt.y);Ke.closestPoint(nn).distanceSquared(nn)<=_t&&Ke.closestPoint(Gt).distanceSquared(Gt)<=_t&&Ke.closestPoint(on).distanceSquared(on)<=_t&&pt.push({v1:nn,v2:Gt,v3:on})}return{kitId:T.userData.kitId,normal:Ge,faces:pt,pt:j}})};const Ve=v(()=>N().some(({kit:P})=>P instanceof Ni)),Fe=()=>{fe(()=>new md({projectPtToScreen:J,mouseRay:ne,initSelectedImage:ve(()=>{let P=new Set;for(let A of r.selectedKitsById)P.add(A);let M=N().find(({kitId:A})=>P.has(A));if(M==null)return;let T=M.kit;if(T instanceof Ni)return{kit:T,space:M.space()}}),images:v(()=>N().flatMap(({kit:M,space:T})=>{let A=M;return A instanceof Ni?[{kit:A,space:T()}]:[]})),onDone:()=>fe(void 0)}))},ct=()=>{fe(()=>{let P=gt(N,M=>{let T=M.kit;if(T instanceof ln)return{id:M.kitId,line:T.line}});return new ru({projectPtToScreen:J,mousePos:q,mouseRay:ne,existingLines:v(()=>P().flatMap(M=>M==null?[]:[{id:M.id,line:M.line()}])),insertRoofPlanes:M=>{for(let T of M){let V={...Ao(Mo.componentType.propertiesSchema),heightOffGround:T.heightOffGround,pitch:T.pitch,vertices:T.outline};ue(Mo,V,T.space)}fe(void 0)}})})};let Ft=()=>{fe(()=>{let P=v(gt(N,({kit:M,kitId:T,space:A,localAabb:V,setSpace:j},O)=>({id:()=>T,transform:()=>A(),setTransform:E=>{j(E)},rayCollisionTime:E=>{let B=E.toSpace(A());return V().rayCollisionTime(B)},localEdges:v(()=>{let E=M;if(E instanceof ln)return[E.line()];let B=[],X=V(),le=C.create(X.minX,X.minY,X.minZ),ye=C.create(X.minX,X.minY,X.maxZ),ze=C.create(X.minX,X.maxY,X.minZ),Ge=C.create(X.minX,X.maxY,X.maxZ),Ke=C.create(X.maxX,X.minY,X.minZ),pt=C.create(X.maxX,X.minY,X.maxZ),St=C.create(X.maxX,X.maxY,X.minZ),_t=C.create(X.maxX,X.maxY,X.maxZ);return B.push(et.create(le,ye),et.create(ze,Ge),et.create(Ke,pt),et.create(St,_t),et.create(le,ze),et.create(ye,Ge),et.create(Ke,St),et.create(pt,_t),et.create(le,Ke),et.create(ye,pt),et.create(ze,St),et.create(Ge,_t)),B}),localSnapPoints:v(()=>{let E=M;if(E instanceof ln){let X=E.line();return[X.v1,X.v2]}let B=[];return V().forEachCorner((X,le,ye)=>{B.push(C.create(X,le,ye))}),B})})));return new Pa({projectPtToScreen:J,mousePos:q,mouseRay:ne,initSelectedObjectIds:r.selectedKitsById,objects:P,onDone:()=>{fe(void 0)}})})};const Lt=()=>{p("selectedKitsById",[]),fe(()=>new fu({projectPtToScreen:J,mousePos:q,mouseRay:ne,objects:v(()=>N().map(({kit:P,space:M,setSpace:T,localAabb:A})=>{let V,j=P.mkFaceToFaceExtendable;return j!=null?V=j({space:M,setSpace:T}):V=void 0,{rayCollisionTime:O=>{let E=O.toSpace(M());return A().rayCollisionTime(E)},extendable:V}})),kitFaceUnderMouse:ut()}))},ft=()=>{fe(()=>{let P=gt(N,T=>({id:()=>T.kitId,rayCollisionTime:A=>{let V=A.toSpace(T.space());return T.localAabb().rayCollisionTime(V)}})),M=v(()=>P());return new hu({projectPtToScreen:J,mousePos:q,mouseRay:ne,initSelectedObjectIds:r.selectedKitsById,objects:M,createGroupObject:()=>ue(ys,{name:""},he.identity),setObjectParent(T,A){},onDone:()=>{fe(void 0)}})})};let tn=new pu({mouseRay:ne,rootKits:gt(N,({kit:P,space:M,localAabb:T})=>({kit:P,space:M,localAabb:T}))});Ts(h,v(()=>N().map(P=>new Qi({children:v(()=>P.kit.components?.call(P.kit)??[]),transform:P.space}))),$);const Fn=v(()=>rd(N().flatMap(P=>{let M=P.kit;return M instanceof Mn?{roofPlane:M,space:P.space()}:[]})));let wn;{let P=v(()=>{let B=[];for(let X of N()){{let le=X.kit.documents;le!=null&&B.push(...le())}{let le=X.kit.documents2;le!=null&&B.push(...le(zn())())}}return B}),M=v(()=>{let B=[];for(let X of N()){let le=X.kit.mkFramesForDoc;if(le==null)continue;let ye=le(zn())();B.push(...ye)}return B}),T=v(()=>M().length==0),A=v(()=>{if(!T())return{name:()=>"Frames",pages:gt(M,B=>()=>{let X=B();return U(zs,{get title(){return"Frame "+X.frameLabel},get components(){return X.components},get labeler(){return zn()},get dimensionStrings(){return X.dimensionStrings}})})}}),V=v(()=>{let B=[];for(let X of N()){let le=X.kit.mkPlatesForDoc;le!=null&&B.push(...le(zn())())}return B}),j=v(()=>V().length==0),O=v(()=>{if(!j())return{name:()=>"Plates",pages:gt(V,B=>()=>U(od,{title:"Plates",get plate(){return B()}}))}}),E=v(()=>{let B=Fn();if(B.length==0)return;let X=v(()=>N().flatMap(({kit:le,space:ye})=>{let ze=le;return ze instanceof Mn?[{roofPlane:ze,space:ye()}]:[]}));return{name:()=>"Dimensioned Plan",pages:v(()=>[()=>U(hd,{get roofPlaneKits(){return X()},roofingLines:B})])}});wn=v(()=>[...P(),...nt(A()),...nt(O()),...nt(E())])}let Ln=v(()=>{let P=tn.focusedKit();if(P==null||P.kit.type!="Kit")return;let M=P.kit.value;return N().find(({kit:A})=>A===M)});re(()=>{if(r.mode!=null)return;let P=Ln();if(P==null){ve(()=>$());return}let M=P;re(()=>{let T=M.localAabb();if(Number.isFinite(T.minX)){let A=new Pt((T.maxX-T.minX)/1e3+.05,(T.maxY-T.minY)/1e3+.05,(T.maxZ-T.minZ)/1e3+.05),V=new wt({color:"blue",opacity:.5,transparent:!0}),j=new Ze(A,V);h.add(j),Ce(()=>{h.remove(j),A.dispose(),V.dispose()});let O=new Vt;re(()=>{let E=M.space().orientation;O.set(E.x,E.y,E.z,E.w),j.setRotationFromQuaternion(O);let B=M.space().pointFromThisSpace(C.create(.5*(T.minX+T.maxX),.5*(T.minY+T.maxY),.5*(T.minZ+T.maxZ)));j.position.set(B.x/1e3,B.y/1e3,B.z/1e3),j.updateMatrix(),ve(()=>$())})}})}),re(()=>{if(r.mode!=null||mn()!=null||Sn()!=null)return;let P=gt(()=>r.selectedKitsById,M=>{re(()=>{let T=N().find(j=>j.kitId==M);if(T==null)return;let A=T,V=A.localAabb();if(Number.isFinite(V.minX)){let j=new Pt((V.maxX-V.minX)/1e3+.05,(V.maxY-V.minY)/1e3+.05,(V.maxZ-V.minZ)/1e3+.05),O=new wt({color:65280,opacity:.5,transparent:!0}),E=new Ze(j,O);h.add(E),Ce(()=>{h.remove(E),j.dispose(),O.dispose(),ve(()=>$())});let B=new Vt;re(()=>{let X=A.space().orientation;B.set(X.x,X.y,X.z,X.w),E.setRotationFromQuaternion(B);let le=A.space().pointFromThisSpace(C.create(.5*(V.minX+V.maxX),.5*(V.minY+V.maxY),.5*(V.minZ+V.maxZ)));E.position.set(le.x/1e3,le.y/1e3,le.z/1e3),E.updateMatrix(),ve(()=>$())})}})});re(()=>P())});let mn=v(()=>{let P=tn.focusedKit();if(P!=null&&P.kit.type=="SubKitObject")return{...P.kit.value,space:P.worldSpace}}),Sn=v(()=>r.selectedSubKitObject?.value);re(()=>{let P=mn();if(P==null){$();return}if(Sn()==P){$();return}let T=P.localAabb();if(!Number.isFinite(T.minX))return;let A=.001,V=new Pt((T.maxX-T.minX)*A,(T.maxY-T.minY)*A,(T.maxZ-T.minZ)*A),j=new wt({color:"blue",transparent:!0,opacity:.5}),O=new Ze(V,j),E=P.space().fromThisSpace(he.create(C.create(.5*(T.minX+T.maxX),.5*(T.minY+T.maxY),.5*(T.minZ+T.maxZ)),we.identity));O.position.set(E.o.x*A,E.o.y*A,E.o.z*A),O.quaternion.set(E.orientation.x,E.orientation.y,E.orientation.z,E.orientation.w),O.renderOrder=1,h.add(O),Ce(()=>{h.remove(O),V.dispose(),j.dispose()}),$()}),re(()=>{let P=Sn();if(P==null){$();return}let M=P.localAabb();if(!Number.isFinite(M.minX))return;let T=.001,A=new Pt((M.maxX-M.minX)*T,(M.maxY-M.minY)*T,(M.maxZ-M.minZ)*T),V=new wt({color:"green",transparent:!0,opacity:.5}),j=new Ze(A,V),O=P.space().fromThisSpace(he.create(C.create(.5*(M.minX+M.maxX),.5*(M.minY+M.maxY),.5*(M.minZ+M.maxZ)),we.identity));j.position.set(O.o.x*T,O.o.y*T,O.o.z*T),j.quaternion.set(O.orientation.x,O.orientation.y,O.orientation.z,O.orientation.w),j.renderOrder=1,h.add(j),Ce(()=>{h.remove(j),A.dispose(),V.dispose()}),$()}),re(()=>{let P=r.mode;if(P==null||P.highlightedObjectsById==null&&P.selectedObjectsById==null)return;let M=(P.highlightedObjectsById??(()=>[]))(),T=(P.selectedObjectsById??(()=>[]))(),A=[...M.map(V=>({id:V,colour:"blue"})),...T.map(V=>({id:V,colour:"green"}))];for(let{id:V,colour:j}of A){let O;if(typeof V=="number")O=N()[V];else{let E=N().find(({kitId:B})=>B==V);if(E==null)continue;O=E}re(()=>{let E=O.localAabb();if(!Number.isFinite(E.minX))return;let B=new Pt((E.maxX-E.minX)/1e3,(E.maxY-E.minY)/1e3,(E.maxZ-E.minZ)/1e3),X=new dr({color:j}),le=new ur(B),ye=new cr(le,X);h.add(ye),Ce(()=>{h.remove(ye),B.dispose(),le.dispose(),X.dispose(),ve(()=>$())});let ze=new Vt;re(()=>{let Ge=O.space().orientation;ze.set(Ge.x,Ge.y,Ge.z,Ge.w),ye.setRotationFromQuaternion(ze);let Ke=O.space().pointFromThisSpace(C.create(.5*(E.minX+E.maxX),.5*(E.minY+E.maxY),.5*(E.minZ+E.maxZ)));ye.position.set(Ke.x/1e3,Ke.y/1e3,Ke.z/1e3),ye.updateMatrix(),ve(()=>$())})})}});let[Pn,ki]=st(!1),[Ii,go]=st([]),zn=v(()=>{let P=new Li;for(let M of N())M.kit.allocateLabels!=null&&M.kit.allocateLabels(P);return P});re(()=>{ki(!0);let P;if(N().length==1){let T=N()[0].kit.labeler;P=T==null?new Li:T()}else P=new Li;for(let T of N())T.kit.allocateLabels!=null&&T.kit.allocateLabels(P);let M=Os(ot(),P,r.adComponents);if(r.adComponents==null){go(M),ki(!1);return}(async()=>(await Ds(M),go(M),ki(!1)))()});let Ql=v(()=>{if(r.adComponents!=null)return Rs(Ii())}),ql=()=>{Fs().then(P=>{p("adComponents",P)})},yo=v(()=>N().flatMap(({kit:P,space:M},T)=>P.insertOpeningWalls==null?[]:P.insertOpeningWalls().map(A=>({...A,location:A.location.cons(T.toString()).cons("Kit"),space:M().fromThisSpace(A.space)})))),vo=v(()=>N().flatMap(({kit:P,kitId:M,space:T})=>P.insertPanelBraceWalls==null?[]:P.insertPanelBraceWalls().map(A=>({...A,location:A.location.cons(M).cons("Kit"),space:T().fromThisSpace(A.space)})))),bo=v(()=>N().flatMap(({kit:P,space:M},T)=>P.insertPartitionWalls==null?[]:P.insertPartitionWalls().map(A=>({...A,location:A.location.cons(T.toString()).cons("Kit"),space:M().fromThisSpace(A.space)})))),Ti=v(()=>N().flatMap(({kit:P,space:M})=>P.joinRoofPlaneEdgesRoofPlanes==null?[]:P.joinRoofPlaneEdgesRoofPlanes().map(T=>({...T,space:v(()=>M().fromThisSpace(T.space()))})))),Zl=()=>{const P="ClintonsToolbox_",M="ac22e937f48d5e41bba2b7e59c35bbb6cbbd0a02c11896808e4ebebcc612aff8";let T;return Rt(()=>{T?.focus()}),["Please enter unlock code:",(()=>{const A=Sc.cloneNode(!0);A.$$input=j=>{let O=j.currentTarget.value;rr.exports.SHA256(P+O).toString()==M&&p("extraFunctionality","Unlocked")};const V=T;return typeof V=="function"?At(V,A):T=A,A})(),An.cloneNode(!0),(()=>{const A=Pc.cloneNode(!0);return A.$$click=()=>{p("extraFunctionality","Locked")},A})()]},jn;return Rt(()=>{jn!=null&&(jn.addEventListener("shown.bs.collapse",()=>te()),jn.addEventListener("hidden.bs.collapse",()=>te()))}),(()=>{const P=zc.cloneNode(!0),M=P.firstChild,T=M.firstChild,A=T.firstChild,V=A.nextSibling,j=V.nextSibling,O=j.nextSibling,E=O.firstChild,B=E.firstChild,X=B.firstChild,le=X.nextSibling,ye=le.firstChild,ze=ye.firstChild,Ge=ye.nextSibling,Ke=Ge.firstChild,pt=Ge.nextSibling,St=pt.firstChild,_t=pt.nextSibling,lt=_t.firstChild,Le=B.nextSibling,rt=Le.firstChild,mt=Le.nextSibling,$t=mt.firstChild,It=mt.nextSibling,Ct=It.firstChild,Tt=It.nextSibling,nn=Tt.firstChild,Gt=Tt.nextSibling,on=Gt.nextSibling,Jl=on.firstChild,xo=O.nextSibling,Mi=xo.nextSibling,er=M.nextSibling,Vn=er.firstChild,_o=Vn.nextSibling,Ai=_o.firstChild,$i=Ai.firstChild,Ci=$i.nextSibling,Ei=Ci.nextSibling,wo=Ei.nextSibling;ie(P,U(tt,{get when(){return r.extraFunctionality=="Unlocking"},get children(){return U(Vs,{get rootDiv(){return n.rootDiv},get children(){return U(Zl,{})}})}}),M),ie(P,()=>v(()=>{if(n.filename!=null)return(()=>{const H=jc.cloneNode(!0);return H.firstChild.nextSibling,ie(H,()=>n.filename,null),H})()}),M),ie(T,U(tt,{get when(){return n.onClose!=null},get children(){const H=kc.cloneNode(!0);return H.$$click=()=>{n.onClose!=null&&n.onClose()},H}}),A),ie(T,U(tt,{get when(){return n.onSave!=null},get children(){const H=Ic.cloneNode(!0);return H.$$click=()=>{n.onSave!=null&&n.onSave({world:r.world.toJSON(),...Xd(w)?{}:{roofBlockCutList:eu(w)}})},H}}),A),A.$$click=()=>{ke()};const So=jn;return typeof So=="function"?At(So,O):jn=O,ze.$$click=()=>pe(),Ke.$$click=()=>Qe(),St.$$click=()=>Xt(),lt.$$click=()=>vt(),ie(le,U(tt,{get when(){return yo().length!=0},get children(){const H=Tc.cloneNode(!0),de=H.firstChild;return de.$$click=()=>De(),H}}),null),ie(le,U(tt,{get when(){return vo().length!=0},get children(){const H=Mc.cloneNode(!0),de=H.firstChild;return de.$$click=()=>Ue(),H}}),null),ie(le,U(tt,{get when(){return bo().length!=0},get children(){const H=Ac.cloneNode(!0),de=H.firstChild;return de.$$click=()=>We(),H}}),null),ie(E,U(tt,{get when(){return Ti().length!=0},get children(){return[(()=>{const H=$c.cloneNode(!0),de=H.firstChild;return de.$$click=()=>Ye(),H})(),(()=>{const H=Cc.cloneNode(!0),de=H.firstChild;return de.$$click=()=>at(),H})()]}}),Le),rt.$$click=()=>ct(),ie(E,U(tt,{get when(){return Ve()},get children(){const H=Ec.cloneNode(!0),de=H.firstChild;return de.$$click=()=>Fe(),H}}),mt),ie(E,U(tt,{get when(){return r.extraFunctionality=="Unlocked"},get children(){const H=Oc.cloneNode(!0),de=H.firstChild;return de.$$click=()=>Oe(),H}}),mt),$t.$$click=()=>{fe(()=>new _a({projectPtToScreen:J,mousePos:q,mouseRay:ne,initSelectedObjectIds:(()=>{if(r.selectedKitsById.length==0)return;let H=new Set;for(let Ie of r.selectedKitsById)H.add(Ie);let de=[],Se=N();for(let Ie=0;Ie<Se.length;++Ie)H.has(Se[Ie].kitId)&&de.push(Ie);return de})(),objects:v(()=>N().map(({kit:H,space:de,setSpace:Se,localAabb:Ie},Ee)=>({id:()=>Ee,transform:()=>de(),setTransform:qe=>{Se(qe)},rayCollisionTime:qe=>{let Ae=qe.toSpace(de());return Ie().rayCollisionTime(Ae)},localSnapPoints:v(()=>{let qe=H;if(qe instanceof ln){let Et=qe.line();return[Et.v1,Et.v2]}let Ae=[];return Ie().forEachCorner((Et,kn,Ht)=>{Ae.push(C.create(Et,kn,Ht))}),Ae})}))),onDone:()=>{fe(void 0)}}))},ie(E,U(tt,{get when(){return r.extraFunctionality=="Unlocked"},get children(){const H=Dc.cloneNode(!0),de=H.firstChild;return de.$$click=()=>Je(),H}}),It),Ct.$$click=()=>{Ft()},ie(E,U(tt,{get when(){return r.extraFunctionality=="Unlocked"},get children(){return U(tt,{get when(){return N().some(({kit:H})=>H.mkFaceToFaceExtendable!=null)},get children(){const H=Rc.cloneNode(!0),de=H.firstChild;return de.$$click=()=>Lt(),H}})}}),Tt),nn.$$click=()=>ft(),ie(Gt,()=>{let[H,de]=st(!1);return(()=>{const Se=Vc.cloneNode(!0);return Se.$$click=async()=>{let Ie=i.toDataURL("image/png"),Ee=await(await fetch(Ie)).blob();navigator.clipboard.write([new ClipboardItem({"image/png":Ee})]),de(!0),setTimeout(()=>de(!1),1e3)},ie(Se,U(yi,{fallback:"Screenshot (Clipboard)",get children(){return U(qt,{get when(){return H()},children:"Saved to clipboard!"})}})),Se})()}),Jl.$$click=async()=>{let H=i.toDataURL("image/png"),de=await(await fetch(H)).blob();Oi.saveAs(de,"screenshot.png")},xo.$$click=()=>{ql()},Mi.$$click=()=>{switch(r.extraFunctionality){case"Locked":{p("extraFunctionality","Unlocking");break}case"Unlocked":{p("extraFunctionality","Locked");break}}},ie(Vn,U(tt,{get when(){return r.showSceneGraph},get children(){return U(_c,{get kits(){return N()},isSelected:H=>{if(H.length==0)return!1;if(H.length==1){let de=H[0];return r.selectedKitsById.some(Se=>Se==de)}else{if(r.selectedSubKitObject==null)return!1;let de=N().find(({kitId:qe})=>qe==H[0]);if(de==null)return!1;let Se=[...H.slice(1)].reverse(),Ie,Ee=de.subObjects();for(;;){let qe=Se.pop();if(qe==null||(Ie=Ee.find(Et=>Et.id()==qe),Ie==null))break;Ee=Ie.subKitObjects?.call(Ie)??[]}return Ie==null?!1:r.selectedSubKitObject.value.id()==Ie.id()}},setSelected:H=>{if(H.length!=0)if(H.length==1)p("selectedSubKitObject",void 0),p("selectedKitsById",[H[0]]);else{let de=N().find(({kitId:Et})=>Et==H[0]);if(de==null)return!1;let Se=de.space(),Ie=[...H.slice(1)].reverse(),Ee,qe=de.subObjects();for(;;){let Et=Ie.pop();if(Et==null||(Ee=qe.find(oi=>oi.id()==Et),Ee==null))break;let kn=Ee;Se=Se.fromThisSpace(kn.space()),qe=Ee.subKitObjects?.call(Ee)??[]}if(Ee==null)return;let Ae={...Ee,space:()=>Se};p("selectedKitsById",[]),p("selectedSubKitObject",new Ot(Ae))}}})}}),null),ie(Vn,U(tt,{when:()=>{r.mode?.sideForm==null||r.mode.sideForm()!=null},children:()=>(setTimeout(()=>te()),r.mode?.sideForm==null?void 0:r.mode.sideForm())}),null),ie(Vn,()=>v(()=>{let H=Sn();if(H==null)return;let de=H;return[U(ni,{get fieldGroups(){return de.properties()}}),U(je,{get when(){return de.propertiesForm},children:Se=>Se()()}),An.cloneNode(!0),Nt(()=>v(()=>{if(de.delete==null)return;let Se=de.delete,Ie=()=>{Se(),p("selectedSubKitObject",void 0),tn.unfocus(),setTimeout(()=>te())};return(()=>{const Ee=hl.cloneNode(!0);return Ee.$$click=()=>Ie(),Ee})()}))]}),null),ie(Vn,()=>{if(r.selectedSubKitObject!=null||r.selectedKitsById.length==0)return;let H=N().find(({kitId:Ee})=>Ee==r.selectedKitsById[0]);if(H==null)return;let de=H,Se=kl(de.kit),Ie=v(()=>[...Se(),ha({displayName:()=>"Transform 3D",value:()=>de.space(),setValue:Ee=>{de.setSpace(Ee)}})]);return[U(ni,{get fieldGroups(){return Ie()}}),An.cloneNode(!0),(()=>{const Ee=hl.cloneNode(!0);return Ee.$$click=()=>{$e(()=>{de.destroy(),p("selectedKitsById",[])}),te(),$()},Ee})()]},null),$i.$$click=()=>{p("selectedTab","Model")},Ci.$$click=()=>{p("selectedTab","BOM")},Ei.$$click=()=>{p("selectedTab","Documents")},wo.$$click=()=>{p("selectedTab","HLR Drawing Test")},ie(Ai,U(tt,{get when(){return Ti().length!=0},get children(){const H=Nc.cloneNode(!0);return H.$$click=()=>{p("selectedTab","Block Cut List Detailer")},ce(()=>H.classList.toggle("active",r.selectedTab=="Block Cut List Detailer")),H}}),null),ie(Ai,U(tt,{get when(){return r.extraFunctionality=="Unlocked"},get children(){const H=Bc.cloneNode(!0);return H.$$click=()=>{p("selectedTab","Paper Space")},ce(()=>H.classList.toggle("active",r.selectedTab=="Paper Space")),H}}),null),ie(_o,U(yi,{get children(){return[U(qt,{get when(){return r.selectedTab=="Model"},get children(){const H=Lc.cloneNode(!0),de=H.firstChild,Se=de.nextSibling,Ie=Se.firstChild,Ee=e;typeof Ee=="function"?At(Ee,H):e=H;const qe=t;return typeof qe=="function"?At(qe,de):t=de,de.style.setProperty("position","absolute"),de.style.setProperty("right","0"),de.style.setProperty("top","0"),de.style.setProperty("width","200px"),de.style.setProperty("height","200px"),ie(H,i,Se),ie(H,c,Se),ie(Ie,U(zl,{get projection(){return r.projection},get showCladding(){return r.showCladding},get showBackground(){return r.showBackground},get hideBelowGround(){return r.hideBelowGround},get showDebugMarkings(){return r.showDebugMarkings},get textured(){return r.textured},setProjection:Ae=>p("projection",Ae),setShowCladding:Ae=>p("showCladding",Ae),setShowBackground:Ae=>p("showBackground",Ae),setHideBelowGround:Ae=>p("hideBelowGround",Ae),setShowDebugMarkings:Ae=>p("showDebugMarkings",Ae),setTextured:Ae=>p("textured",Ae),sceneGraph:{get showSceneGraph(){return r.showSceneGraph},setShowSceneGraph:Ae=>{p("showSceneGraph",Ae)}}})),ie(Se,()=>{let Ae=Ql();if(!(Ae==null||Ae==0||Ii().length==0))return Pn()?[An.cloneNode(!0),Uc.cloneNode(!0)]:[An.cloneNode(!0),Yc.cloneNode(!0),Nt(()=>"$"+Ae.toFixed(2))]},null),ie(Se,U(tt,{get when(){return r.mode!=null},get children(){return[An.cloneNode(!0),(()=>{const Ae=Fc.cloneNode(!0);return ie(Ae,()=>r.mode?.instructions?.call(r.mode,{})),Ae})()]}}),null),ie(H,()=>{let Ae=r.mode?.overlayUI;return Ae==null?[]:Ae({})},null),H}}),U(qt,{get when(){return r.selectedTab=="BOM"},get children(){return U(Ns,{get orderLines(){return Ii()},hiddenColumns:["Order Code","Supplier","Specifications","Notes","User Notes To Supplier","Weight"]})}}),U(qt,{get when(){return r.selectedTab=="Documents"},get children(){return U(Ls,{get documents(){return wn()}})}}),U(qt,{get when(){return r.selectedTab=="HLR Drawing Test"},children:()=>{let[H,de]=st(!1),Se;return[(()=>{const Ie=Kc.cloneNode(!0),Ee=Ie.firstChild;return Ee.addEventListener("change",qe=>{de(qe.currentTarget.checked)}),ce(()=>Ee.checked=H()),Ie})(),(()=>{const Ie=Xc.cloneNode(!0),Ee=Se;return typeof Ee=="function"?At(Ee,Ie):Se=Ie,ie(Ie,()=>v(()=>{if(g==null||a==null)return;let[qe,Ae]=Ne(Nn()),[Et,kn]=st([]);(async()=>{let ht=await wc(Be(),N());di(oi=>{if(ht!=null)kn(ht.svgPaths.flatMap(sn=>typeof sn=="string"?[sn]:sn).map(sn=>(()=>{const li=Gc.cloneNode(!0);return K(li,"d",sn),li})()));else{if(g==null||a==null){oi();return}let sn=[],li=ba(a,h),zt=vi.empty();for(let ri of li){let Un=ri.v1,Yn=ri.v2;zt.includePoint(Un),zt.includePoint(Yn),sn.push((()=>{const gn=Hc.cloneNode(!0);return ce(Wt=>{const In=Un.x,si=-Un.y,ai=Yn.x,Po=-Yn.y;return In!==Wt._v$7&&K(gn,"x1",Wt._v$7=In),si!==Wt._v$8&&K(gn,"y1",Wt._v$8=si),ai!==Wt._v$9&&K(gn,"x2",Wt._v$9=ai),Po!==Wt._v$10&&K(gn,"y2",Wt._v$10=Po),Wt},{_v$7:void 0,_v$8:void 0,_v$9:void 0,_v$10:void 0}),gn})())}if(Number.isFinite(zt.minX)){let ri=.5*(zt.minX+zt.maxX),Un=.5*(zt.minY+zt.maxY),Yn=zt.maxX-zt.minX,gn=zt.maxY-zt.minY;setTimeout(()=>{if(Se=Se,Se==null)return;let In=Math.min(Se.clientWidth/Yn,Se.clientHeight/gn),si=ri-.5*Se.clientWidth/In,ai=-Un-.5*Se.clientHeight/In;$e(()=>{Ae("scale",In),Ae("panX",si),Ae("panY",ai)})})}kn(sn)}oi()})})();let Ht=new Ml({state:qe,setState:Ae,disablePan:()=>!1});return U(Pi,{get showGrid(){return H()},fontSize:12,state:qe,style:{"flex-grow":"1"},onMouseDown:ht=>{Ht.onMouseDown(ht)},onMouseUp:ht=>{Ht.onMouseUp(ht)},onMouseMove:ht=>{Ht.onMouseMove(ht)},onWheel:ht=>{Ht.onWheel(ht)},onTouchStart:ht=>{Ht.onTouchStart(ht),ht.preventDefault()},onTouchMove:ht=>{Ht.onTouchMove(ht),ht.preventDefault()},onTouchEnd:ht=>{Ht.onTouchEnd(ht),ht.preventDefault()},get children(){return Et()}})})),Ie})()]}}),U(qt,{get when(){return r.selectedTab=="Block Cut List Detailer"},get children(){return U(nu,{roofBlockCutListData:w,setRoofBlockCutListData:S,get roofPlanes(){return N().flatMap(({kit:H,kitId:de,space:Se})=>{let Ie=H;return Ie instanceof Mn?[{id:de,kit:Ie,space:Se()}]:[]})}})}}),U(qt,{get when(){return r.selectedTab=="Paper Space"},get children(){return U(rc,{state:y,setState:_,camera:{get transform(){return d.space()}},get labeler(){return zn()},get kits(){return N().map(H=>({get kitId(){return H.kitId},get kit(){return H.kit},get space(){return H.space()},get localAabb(){return H.localAabb()}}))}})}})]}}),null),ce(H=>{const de=r.extraFunctionality=="Locked"||r.extraFunctionality=="Unlocking",Se=r.extraFunctionality=="Unlocked",Ie=r.selectedTab=="Model",Ee=r.selectedTab=="BOM",qe=r.selectedTab=="Documents",Ae=r.selectedTab=="HLR Drawing Test";return de!==H._v$&&Mi.classList.toggle("fa-lock",H._v$=de),Se!==H._v$2&&Mi.classList.toggle("fa-lock-open",H._v$2=Se),Ie!==H._v$3&&$i.classList.toggle("active",H._v$3=Ie),Ee!==H._v$4&&Ci.classList.toggle("active",H._v$4=Ee),qe!==H._v$5&&Ei.classList.toggle("active",H._v$5=qe),Ae!==H._v$6&&wo.classList.toggle("active",H._v$6=Ae),H},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0,_v$6:void 0}),P})()};Ut(["input","click"]);export{Ef as default};
