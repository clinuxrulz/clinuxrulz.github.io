import{c as B,a as m,W as Me,b as _,m as he,e as U,s as C,N as ce,t as F,X as Xe,Y as Te,Z as We,g as q,A as Ye,f as Ge,o as be,z as qe,l as Ne,i as O,$ as Ze,S as Le,M as oe,d as ke,H as Ce,B as _e,C as at,a0 as ut,a1 as ft}from"./index.5aba22ff.js";import{m as Ee,a as Ie,S as gt}from"./SvgWithPanZoomState.e2089103.js";import{F as ht}from"./FlashingRenderer.e92cafa9.js";import{V as W}from"./Vec3.ce1f4f7a.js";import{L as Oe}from"./Line2D.139781b3.js";import{R as ct}from"./Ray2D.01cdc921.js";import{o as mt}from"./PanelUtils.894b6d74.js";import"./Component.6024a649.js";import"./Component.fa73bdbc.js";import"./PropertiesForm.c69fa44e.js";const Pt=F('<svg><line stroke-width="3" vector-effect="non-scaling-stroke" stroke="blue"></line></svg>',4,!0),St=F('<svg><line stroke-width="3" vector-effect="non-scaling-stroke" stroke="green"></line></svg>',4,!0),Ue=20,vt=Ue*Ue;class pe{constructor(t){let[i,b]=B({selectedSegment:void 0}),s=m(()=>Me(t.flashingPoints())),d=m(()=>Me({...t.flashingPoints(),segments:t.flashingPoints().segments.map(u=>({...u,length:u.farLength??u.length}))})),P=m(()=>t.focusedSvg()=="Near"?s():d()),S=m(()=>{let u=t.mousePos();if(u==null)return;let v=t.screenPtToWorldPt(u);if(v==null)return;let x,h,y,$=0;for(let z of P()){let J=W.create(z.from.x,z.from.y),le=W.create(z.to.x,z.to.y),K=ct.fromOriginDirection(J,le.sub(J)),ee=K.closestTimeToPoint(v);if(!Number.isFinite(ee)){++$;continue}let de=Math.max(0,Math.min(1,ee)),ae=K.pointFromTime(de),V=t.worldPtToScreenPt(ae);if(V==null){++$;continue}let j=u.distanceSquared(V);if(j>vt){++$;continue}(x==null||j<x)&&(x=j,h=Oe.create(J,le),y=$),++$}if(!(h==null||y==null))return y});this.onClick=()=>{let u=S();b("selectedSegment",u)},this.onTouchEnd=this.onClick;let o=u=>{if(u!=null)return Oe.create(W.create(u.from.x,u.from.y),W.create(u.to.x,u.to.y))},a=m(()=>{let u=S();if(u!=null)return o(s()[u])}),r=m(()=>{if(i.selectedSegment!=null)return o(s()[i.selectedSegment])}),n=m(()=>{let u=S();if(u!=null)return o(d()[u])}),g=m(()=>{if(i.selectedSegment!=null)return o(d()[i.selectedSegment])}),f=u=>[_(ce,{get when(){return he(()=>u.nearOrFar=="Near",!0)()?a():n()},children:v=>(()=>{const x=Pt.cloneNode(!0);return U(h=>{const y=v().v1.x,$=-v().v1.y,z=v().v2.x,J=-v().v2.y;return y!==h._v$&&C(x,"x1",h._v$=y),$!==h._v$2&&C(x,"y1",h._v$2=$),z!==h._v$3&&C(x,"x2",h._v$3=z),J!==h._v$4&&C(x,"y2",h._v$4=J),h},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0}),x})()}),_(ce,{get when(){return he(()=>u.nearOrFar=="Near",!0)()?r():g()},children:v=>(()=>{const x=St.cloneNode(!0);return U(h=>{const y=v().v1.x,$=-v().v1.y,z=v().v2.x,J=-v().v2.y;return y!==h._v$5&&C(x,"x1",h._v$5=y),$!==h._v$6&&C(x,"y1",h._v$6=$),z!==h._v$7&&C(x,"x2",h._v$7=z),J!==h._v$8&&C(x,"y2",h._v$8=J),h},{_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0}),x})()})];this.overlayWorldSvg=()=>_(f,{nearOrFar:"Near"}),this.farOverlayWorldSvg=()=>_(f,{nearOrFar:"Far"}),this.onDelete=()=>{if(i.selectedSegment==null)return;let u=JSON.parse(JSON.stringify(t.flashingPoints())),v=u.segments.splice(i.selectedSegment,1)[0];if(i.selectedSegment<u.segments.length){let x=u.segments[i.selectedSegment].turnAngle+v.turnAngle;for(;x<=-180;)x+=360;for(;x>=180;)x-=360;u.segments[i.selectedSegment].turnAngle=x}u.segments.length==0&&(u.start=void 0),b("selectedSegment",void 0),t.updateFlashingPoints(u)},this.actions=m(()=>i.selectedSegment==null?[]:[{displayName:"Delete Segment",doIt:()=>{this.onDelete()}}])}}const bt=F("<b>Draw Mode:</b>"),yt=F('<svg><circle fill="green"></circle></svg>',4,!0),ze=20,xt=ze*ze,$t=5;class wt{disablePan=()=>!0;constructor(t){let[i,b]=B({showEndDraw:!1,flashingPoints:JSON.parse(JSON.stringify(t.flashingPoints)),insertAtIndex:void 0,nextSegmentWorldAngle:void 0});this.showEndDraw=()=>i.showEndDraw;let s=m(()=>Xe(i.flashingPoints)),d=m(()=>{let a=[],r=s(),n=0;for(let g of r)a.push({pt:W.create(g.from.x,g.from.y),idx:n}),g.type=="line"&&++n;if(r.length!=0){let g=r[r.length-1];a.push({pt:W.create(g.to.x,g.to.y),idx:n})}return a}),P=m(()=>{let a=t.mousePos();if(a==null)return;let r,n,g;for(let f of d()){let u=t.worldPtToScreenPt(f.pt);if(u==null)continue;let v=u.distanceSquared(a);v>=xt||(r==null||v<r)&&(r=v,n=f.pt,g=f.idx)}if(!(n==null||g==null))return{pt:n,idx:g}});this.instructions=m(()=>[bt.cloneNode(!0)," Click points to draw lines. Press Escape when done."]);let S=m(()=>i.insertAtIndex==null?!1:i.insertAtIndex===0&&i.flashingPoints.segments.length!=0?!0:(i.insertAtIndex===i.flashingPoints.segments.length,!1)),o=m(()=>{let a=S();if(i.insertAtIndex==null||i.flashingPoints.start==null)return i.flashingPoints;let r=i.flashingPoints.segments.slice(0,i.insertAtIndex),n=i.flashingPoints.segments.slice(i.insertAtIndex),g=t.mousePos();if(g==null)return i.flashingPoints;let f=t.screenPtToWorldPt(g);if(f==null)return i.flashingPoints;let u,v;if(a){let h=Te({start:i.flashingPoints.start,segments:r})?.pt;if(h==null)return i.flashingPoints;if(u={x:i.flashingPoints.start.x-h.x+f.x,y:i.flashingPoints.start.y-h.y+f.y},v=We({start:u,segments:r},h.x,h.y),v!=null){let y=Te({start:u,segments:[...r,v]})?.pt;if(y!=null){let $={x:y.x-h.x,y:y.y-h.y};u={x:u.x-$.x,y:u.y-$.y}}}}else u=i.flashingPoints.start,v=We({start:i.flashingPoints.start,segments:r},f.x,f.y);if(v==null)return i.flashingPoints;let x=[];if(n.length!=0&&i.nextSegmentWorldAngle!=null){let h=0;for(let $ of r){for(h+=$.turnAngle;h<-180;)h+=360;for(;h>180;)h-=360}for(h+=v.turnAngle;h<-180;)h+=360;for(;h>180;)h-=360;let y=i.nextSegmentWorldAngle-h;for(;y<-180;)y+=360;for(;y>180;)y-=360;x=[{...n[0],turnAngle:y},...n.slice(1)]}else x=n;return{start:u,segments:[...r,v,...x]}});this.onClick=()=>{if(i.flashingPoints.start==null){let a=t.mousePos();if(a==null)return;let r=t.screenPtToWorldPt(a);if(r==null)return;let n=r;q(()=>{b("flashingPoints","start",{x:n.x,y:n.y}),b("insertAtIndex",0),b("nextSegmentWorldAngle",void 0)})}else if(i.insertAtIndex==null){let a=P();if(a==null)return;let r=a.idx,n=0;for(let f=0;f<=r&&f<i.flashingPoints.segments.length;++f){for(n+=i.flashingPoints.segments[f].turnAngle;n<-180;)n+=360;for(;n>180;)n-=360}let g=n;q(()=>{b("insertAtIndex",r),b("nextSegmentWorldAngle",g)})}else q(()=>{i.insertAtIndex!=null&&(b("flashingPoints",o()),t.updateFlashingPoints(i.flashingPoints),!S()||i.flashingPoints.segments.length==1?b("insertAtIndex",i.insertAtIndex+1):i.flashingPoints.segments.length>0&&b("nextSegmentWorldAngle",i.flashingPoints.segments[0].turnAngle))})},this.onTouchStart=()=>{if(b("showEndDraw",!0),i.flashingPoints.start==null){let a=t.mousePos();if(a==null)return;let r=t.screenPtToWorldPt(a);if(r==null)return;let n=r;q(()=>{b("flashingPoints","start",{x:n.x,y:n.y}),b("insertAtIndex",0),b("nextSegmentWorldAngle",void 0)})}else if(i.insertAtIndex==null){let a=P();if(a==null)return;let r=a.idx,n=0;for(let f=0;f<=r&&f<i.flashingPoints.segments.length;++f){for(n+=i.flashingPoints.segments[f].turnAngle;n<-180;)n+=360;for(;n>180;)n-=360}let g=n;q(()=>{b("insertAtIndex",r),b("nextSegmentWorldAngle",g)})}},this.onTouchEnd=()=>{q(()=>{i.insertAtIndex!=null&&(b("flashingPoints",o()),t.updateFlashingPoints(i.flashingPoints),!S()||i.flashingPoints.segments.length==1?b("insertAtIndex",i.insertAtIndex+1):i.flashingPoints.segments.length>0&&b("nextSegmentWorldAngle",i.flashingPoints.segments[0].turnAngle))})},this.onEscape=()=>{t.onDone()},this.endDraw=()=>{t.onDone()},this.wipFlashingPoints=()=>o(),this.overlayWorldSvg=()=>{if(i.insertAtIndex!=null)return;let a=P();if(a!=null)return(()=>{const r=yt.cloneNode(!0);return U(n=>{const g=a.pt.x,f=-a.pt.y,u=$t/t.worldScale();return g!==n._v$&&C(r,"cx",n._v$=g),f!==n._v$2&&C(r,"cy",n._v$2=f),u!==n._v$3&&C(r,"r",n._v$3=u),n},{_v$:void 0,_v$2:void 0,_v$3:void 0}),r})()}}}class Re{disablePan=()=>!0;constructor(t){let[i,b]=B({flashingPoints:JSON.parse(JSON.stringify(t.flashingPoints()))});Ye(()=>{let s=t.mousePos();if(s==null)return;let d=t.screenPtToWorldPt(s);if(d==null)return;let P=d.sub(t.fromWorldPos);switch(t.label.type){case"LengthLabel":{b("flashingPoints","segments",t.label.idx,"lengthLabelOffset",{x:(t.flashingPoints().segments[t.label.idx].lengthLabelOffset?.x??0)+P.x,y:(t.flashingPoints().segments[t.label.idx].lengthLabelOffset?.y??0)-P.y});break}case"AngleLabel":{b("flashingPoints","segments",t.label.idx,"angleLabelOffset",{x:(t.flashingPoints().segments[t.label.idx].angleLabelOffset?.x??0)+P.x,y:(t.flashingPoints().segments[t.label.idx].angleLabelOffset?.y??0)-P.y});break}}}),this.onMouseUp=()=>{t.updateFlashingPoints(i.flashingPoints),t.onDone()},this.onTouchEnd=()=>{t.updateFlashingPoints(i.flashingPoints),t.onDone()},this.wipFlashingPoints=()=>i.flashingPoints}}const _t=F("<b>Rotate Mode:</b>");class pt{disablePan=()=>!0;constructor(t){let[i,b]=B({startPoint:void 0}),s=m(()=>{let S=t.mousePos();if(S!=null)return t.screenPtToWorldPt(S)}),d=m(()=>{if(i.startPoint==null)return;let S=s();if(S==null)return;let o=t.orbitWorldPoint(),a=Math.atan2(i.startPoint.y-o.y,i.startPoint.x-o.x);return Math.atan2(S.y-o.y,S.x-o.x)-a}),P=m(()=>{let S=t.flashingPoints(),o=d();if(o==null)return t.flashingPoints();if(S.start==null)return S;let a=Math.cos(o),r=Math.sin(o),n=S.start.x-t.orbitWorldPoint().x,g=S.start.y-t.orbitWorldPoint().y,f;return S.segments.length==0?f=[]:f=[{...S.segments[0],turnAngle:S.segments[0].turnAngle+o*180/Math.PI},...S.segments.slice(1)],{start:{x:n*a-g*r+t.orbitWorldPoint().x,y:g*a+n*r+t.orbitWorldPoint().y},segments:f}});this.instructions=m(()=>[_t.cloneNode(!0)," Drag on screen to rotate flashing."]),this.onMouseDown=()=>{let S=s();S!=null&&b("startPoint",S)},this.onMouseUp=()=>{t.updateFlashingPoints(P()),t.onDone()},this.onTouchStart=this.onMouseDown,this.onTouchEnd=this.onMouseUp,this.wipFlashingPoints=()=>P()}}const Mt=F("<b>Colour Side Mode:</b>");class Nt{disablePan=()=>!0;constructor(t){let i=m(()=>{let b=t.mousePos();if(b!=null)return t.screenPtToWorldPt(b)});this.instructions=m(()=>[Mt.cloneNode(!0)," Click on colour side of the flashing."]),this.onMouseUp=()=>{t.updateColourSide(i()),t.onDone()},this.onTouchEnd=this.onMouseUp,this.wipColourSide=i}}const Qe=F('<svg><circle stroke="none" fill="blue" pointer-events="none"></circle></svg>',4,!0),Je=20,Lt=Je*Je;class kt{constructor(t){let[i,b]=B({selectedPoint:void 0}),s=m(()=>{if(i.selectedPoint!=null)return[];let o=t.flashingPoints(),a;t.focusedSvg()=="Near"?a=o:a={...o,segments:o.segments.map(g=>({...g,length:g.farLength??g.length}))};let r=Me(a);if(r.length==0)return[];let n=[];n.push({index:0,pt:W.create(r[0].from.x,r[0].from.y)});for(let g=0;g<r.length-1;++g){let f=r[g],u=r[g+1],v=u.from.x-f.to.x,x=u.from.y-f.to.y,h=v*v+x*x,y=g+1;h>.001*.001?(n.push({index:y,pt:W.create(f.to.x,f.to.y)}),n.push({index:y,pt:W.create(u.from.x,u.from.y)})):n.push({index:y,pt:W.create(f.to.x,f.to.y)})}return n.push({index:r.length,pt:W.create(r[r.length-1].to.x,r[r.length-1].to.y)}),n}),d=m(()=>{let o=t.mousePos();if(o==null)return;let a,r;for(let n of s()){let g=t.worldPtToScreenPt(n.pt);if(g==null)continue;let f=g.distanceSquared(o);f>Lt||(a==null||f<a)&&(a=f,r=n)}return r}),P=m(()=>{let o=t.mousePos();if(o!=null)return t.screenPtToWorldPt(o)});this.instructions=m(()=>i.selectedPoint==null?"Select a point to add a taper marker to.":"Select the location of the tail of the taper marker arrow.");let S=m(()=>{if(i.selectedPoint==null)return;let o=P();if(o!=null)return{x:o.x,y:o.y,targetPointIndex:i.selectedPoint.index}});this.onClick=()=>{if(i.selectedPoint==null){let o=d();o!=null&&b("selectedPoint",{...o})}else{let o=S();o!=null&&t.insertTaperedPointMarker(o),t.onDone()}},this.onEscape=()=>{t.onDone()},this.wipTaperedPointMarkers=m(()=>[...t.taperedPointMarkers(),...mt(S())]),this.overlayWorldSvg=m(()=>{if(t.focusedSvg()=="Near"&&i.selectedPoint==null)return _(ce,{get when(){return d()},children:o=>(()=>{const a=Qe.cloneNode(!0);return U(r=>{const n=o().pt.x,g=-o().pt.y,f=5/t.nearWorldScale();return n!==r._v$&&C(a,"cx",r._v$=n),g!==r._v$2&&C(a,"cy",r._v$2=g),f!==r._v$3&&C(a,"r",r._v$3=f),r},{_v$:void 0,_v$2:void 0,_v$3:void 0}),a})()})}),this.farOverlayWorldSvg=m(()=>{if(t.focusedSvg()=="Far"&&i.selectedPoint==null)return _(ce,{get when(){return d()},children:o=>(()=>{const a=Qe.cloneNode(!0);return U(r=>{const n=o().pt.x,g=-o().pt.y,f=5/t.nearWorldScale();return n!==r._v$4&&C(a,"cx",r._v$4=n),g!==r._v$5&&C(a,"cy",r._v$5=g),f!==r._v$6&&C(a,"r",r._v$6=f),r},{_v$4:void 0,_v$5:void 0,_v$6:void 0}),a})()})})}}const Et=F('<button type="button" class="btn btn-primary" style="position: absolute; left: 0; top: 0;">End Draw</button>'),At=F('<div style="flex-grow: 1; display: flex; flex-direction: row;"><div style="flex-grow: 1; display: flex; flex-direction: column;"><b>Near:</b></div><div style="flex-grow: 1; display: flex; flex-direction: column;"><b>Far:</b></div></div>'),Dt=F('<div style="flex-grow: 1; display: flex; flex-direction: column"><div><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Clear</button><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Draw</button><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Zoom Extents</button><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Rotate Flashing</button><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Set Colour Side</button><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Unset Colour Side</button><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Insert Tapered Point Marker</button><button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;">Clear Taper Markers</button><br><input id="flashingDesignerShowGrid" type="checkbox" style="margin-left: 5px; margin-bottom: 5px;"><label for="flashingDesignerShowGrid" style="margin-left: 5px;">Show Grid?</label><input id="flashingDesignerTapered" type="checkbox" style="margin-left: 10px; margin-bottom: 5px;"><label for="flashingDesignerTapered" style="margin-left: 5px;">Tapered?</label><br><b>Font Size:</b><input type="range" min="1" max="12"><br></div><div style="position: relative; flex-grow: 1; display: flex;"></div></div>'),Ft=F('<button type="button" class="btn btn-primary" style="margin-left: 5px; margin-bottom: 5px;"></button>'),Tt=p=>{let t,i,b;p.init==null?b=!1:b=p.init.flashingPoints.segments.some(e=>e.farLength==null?!1:e.farLength!=e.length);let[s,d]=B({fontSize:p.init?.fontSize??4,showGrid:!0,tapered:b,flashingPoints:p.init?.flashingPoints??{segments:[]},colourSide:p.init?.colourSide,taperedPointMarkers:p.init?.taperedPointMarkers??[],mkMode:()=>r(),mousePos:void 0,focusedSvg:"Near"});setTimeout(()=>H()),be(()=>{t?.addEventListener("mouseleave",e=>{d("mousePos",void 0)})}),p.onInit&&p.onInit({get fontSize(){return s.fontSize},get showGrid(){return s.showGrid},get flashingPoints(){return s.flashingPoints},get colourSide(){return s.colourSide},get taperedPointMarkers(){return s.taperedPointMarkers}});let P=e=>{d("mkMode",()=>e)},S=()=>s.mousePos,o=e=>(s.focusedSvg=="Near"?y:$).screenPtToWorldPt(e.x,e.y),a=e=>(s.focusedSvg=="Near"?y:$).worldPtToScreenPt(e),r=()=>new pe({focusedSvg:()=>s.focusedSvg,mousePos:S,screenPtToWorldPt:o,worldPtToScreenPt:a,flashingPoints:()=>s.flashingPoints,updateFlashingPoints:e=>d("flashingPoints",e)}),n=m(()=>s.mkMode());const[g,f]=B({...Ee(),panX:-10,panY:-10,scale:5}),[u,v]=B({...Ee(),panX:-10,panY:-10,scale:5}),x=m(()=>n().disablePan?.call(void 0)??!1);let h=m(()=>n().showEndDraw?.call(void 0)??!1),y=new Ie({state:g,setState:f,disablePan:x}),$=new Ie({state:u,setState:v,disablePan:x}),z=e=>l=>{e=="Near"?y.onMouseDown(l):$.onMouseDown(l);let c=n();c.onMouseDown&&c.onMouseDown(),c.onClick&&c.onClick()},J=e=>l=>{e=="Near"?y.onMouseUp(l):$.onMouseUp(l);let c=n();c.onMouseUp&&c.onMouseUp()},le=e=>l=>{e=="Near"?y.onMouseMove(l):$.onMouseMove(l),q(()=>{d("mousePos",W.create(l.offsetX,l.offsetY)),d("focusedSvg",e)})},K=e=>l=>{e=="Near"?y.onWheel(l):$.onWheel(l)},ee=e=>l=>{if(e=="Near"?y.onTouchStart(l):$.onTouchStart(l),l.touches.length==1){let k=e=="Near"?t:i;if(k!=null){let R=k.getBoundingClientRect(),M=l.touches[0],A=M.clientX-R.left,T=M.clientY-R.top;d("mousePos",W.create(A,T))}}let c=n();c.onTouchStart&&c.onTouchStart(),l.preventDefault()},de=e=>l=>{if(e=="Near"?y.onTouchMove(l):$.onTouchMove(l),l.touches.length==1){let c=e=="Near"?t:i;if(c!=null){let k=c.getBoundingClientRect(),R=l.touches[0],M=R.clientX-k.left,A=R.clientY-k.top;d("mousePos",W.create(M,A))}}l.preventDefault()},ae=e=>l=>{e=="Near"?y.onTouchEnd(l):$.onTouchEnd(l);let c=n();c.onTouchEnd&&c.onTouchEnd(),l.preventDefault()},V=e=>{if(e.key=="Escape"){let l=n();l.onEscape&&l.onEscape()}else if(e.key=="Delete"){let l=n();l.onDelete&&l.onDelete()}};be(()=>{document.addEventListener("keydown",V)}),qe(()=>{document.removeEventListener("keydown",V)});let j=m(()=>{let e=n();return e.wipFlashingPoints?e.wipFlashingPoints():s.flashingPoints}),ye=m(()=>{let e=n();if(e.wipFlashingPoints){let l=e.wipFlashingPoints();return{...l,segments:l.segments.map(c=>({...c,length:c.farLength??c.length}))}}return{...s.flashingPoints,segments:s.flashingPoints.segments.map(l=>({...l,length:l.farLength??l.length}))}}),xe=m(()=>{let e=n();return e.wipColourSide?e.wipColourSide():s.colourSide}),N=m(()=>{let e=n();return e.wipTaperedPointMarkers!=null?e.wipTaperedPointMarkers():s.taperedPointMarkers}),w=()=>{P(r)},Q=()=>{window.confirm("Are you sure you wish to start again on the flashing?")&&q(()=>{d("flashingPoints",Ce({start:void 0,segments:[]})),d("colourSide",void 0)})},Y=()=>{q(()=>{d("flashingPoints",{...s.flashingPoints,segments:s.flashingPoints.segments.map(e=>{let l={...e};return delete l.farLength,l})})})},G=()=>{let e=JSON.parse(JSON.stringify(s.flashingPoints));P(()=>new wt({mousePos:S,screenPtToWorldPt:o,worldPtToScreenPt:a,worldScale:()=>g.scale,flashingPoints:e,updateFlashingPoints:l=>{d("flashingPoints",l)},onDone:()=>w()}))},Z=e=>{let l=e=="Near"?t:i;if(l==null)return;let c=l,k=c.clientWidth,R=c.clientHeight,M,A,T,I,ie;e=="Near"?ie=s.flashingPoints:ie={...s.flashingPoints,segments:s.flashingPoints.segments.map(E=>({...E,length:E.farLength??E.length}))};let me=Xe(ie);for(let E of me.flatMap(Se=>[Se.from,Se.to]))(M==null||E.x<M)&&(M=E.x),(A==null||E.x>A)&&(A=E.x),(T==null||E.y<T)&&(T=E.y),(I==null||E.y>I)&&(I=E.y);let X=s.colourSide;X!=null&&((M==null||X.x<M)&&(M=X.x),(A==null||X.x>A)&&(A=X.x),(T==null||X.y<T)&&(T=X.y),(I==null||X.y>I)&&(I=X.y));for(let E of s.taperedPointMarkers)(M==null||E.x<M)&&(M=E.x),(A==null||E.x>A)&&(A=E.x),(T==null||E.y<T)&&(T=E.y),(I==null||E.y>I)&&(I=E.y);if(M==null||A==null||T==null||I==null)return;let re=.7*Math.min(k/(A-M),R/(I-T)),se=M-.5*(k/re-(A-M)),Pe=-I-.5*(R/re-(I-T));q(()=>{e=="Near"?(f("panX",se),f("panY",Pe),f("scale",re)):(v("panX",se),v("panY",Pe),v("scale",re))})},H=()=>{s.tapered?(Z("Near"),Z("Far")):Z("Near")};const ue=(e,l,c)=>{l>=s.flashingPoints.segments.length||(e?d("flashingPoints","segments",l,"farLength",c):q(()=>{if(s.tapered)s.flashingPoints.segments[l].farLength==null&&d("flashingPoints","segments",l,"farLength",s.flashingPoints.segments[l].length);else if(s.flashingPoints.segments[l].farLength!=null){let k={...s.flashingPoints.segments[l]};delete k.farLength,d("flashingPoints","segments",l,Ce(k))}d("flashingPoints","segments",l,"length",c)}))},te=(e,l)=>{if(e>=s.flashingPoints.segments.length-1)return;let c=(180-l)*Math.sign(s.flashingPoints.segments[e+1].turnAngle);for(;c<-180;)c+=360;for(;c>180;)c-=360;d("flashingPoints","segments",e+1,"turnAngle",c)},fe=(e,l,c)=>{if(!(n()instanceof pe)||t==null)return;let k=o(W.create(l,c));if(k==null)return;let R=k;P(()=>new Re({mousePos:S,screenPtToWorldPt:o,label:{type:"LengthLabel",idx:e},fromWorldPos:R,flashingPoints:()=>s.flashingPoints,updateFlashingPoints:M=>{d("flashingPoints",M)},onDone:()=>w()}))},ne=(e,l,c)=>{if(!(n()instanceof pe)||t==null)return;let k=o(W.create(l,c));if(k==null)return;let R=k;P(()=>new Re({mousePos:S,screenPtToWorldPt:o,label:{type:"AngleLabel",idx:e},fromWorldPos:R,flashingPoints:()=>s.flashingPoints,updateFlashingPoints:M=>{d("flashingPoints",M)},onDone:()=>w()}))};let Be=()=>{if(t==null)return;let e=t;P(()=>{let l=m(()=>{let c=e.getBoundingClientRect();return o(W.create(.5*c.width,.5*c.height))??W.zero});return new pt({mousePos:S,screenPtToWorldPt:o,orbitWorldPoint:l,flashingPoints:()=>s.flashingPoints,updateFlashingPoints:c=>{d("flashingPoints",c)},onDone:()=>w()})})},He=()=>{d("mousePos",void 0),P(()=>new Nt({mousePos:S,screenPtToWorldPt:o,updateColourSide:e=>{d("colourSide",e)},onDone:()=>w()}))},Ve=()=>{d("colourSide",void 0)},je=()=>{P(()=>new kt({focusedSvg:()=>s.focusedSvg,mousePos:()=>s.mousePos,screenPtToWorldPt:o,worldPtToScreenPt:a,nearWorldScale:()=>g.scale,farWorldScale:()=>u.scale,flashingPoints:()=>s.flashingPoints,taperedPointMarkers:()=>s.taperedPointMarkers,insertTaperedPointMarker:e=>{d("taperedPointMarkers",[...s.taperedPointMarkers,e])},onDone:()=>w()}))},Ae=m(()=>{let e=n();if(e!=null)return e?.overlayWorldSvg}),Ke=m(()=>{let e=n();if(e!=null)return e.farOverlayWorldSvg}),et=e=>{let l=m(()=>e.showFarEnd?Ke()??Ae():Ae());return he(()=>l()?.call(void 0,{}))},tt=m(()=>{let e=n();return e==null?[]:e.actions?.call(void 0)??[]}),[nt,it]=Ne(()=>{}),[lt,rt]=Ne(()=>{}),$e=m(()=>nt()()??lt()()),st=m(()=>{let e=$e();if(e==null)return[];switch(e.type){case"Length":return[e.index];case"Angle":return[e.index,e.index+1]}}),ot=m(()=>{let e=$e();return e==null?[]:e.type!="Length"?[]:[e.index]}),dt=m(()=>{let e=$e();return e==null?[]:e.type!="Angle"?[]:[e.index]}),we=e=>_(gt,{get showGrid(){return s.showGrid},gridScale:10,get fontSize(){return s.fontSize},get state(){return e.showFarEnd?u:g},style:{"flex-grow":"1","min-width":"400px","min-height":"400px"},onRefSvg:l=>{e.showFarEnd?i=l:t=l},get onMouseDown(){return z(e.showFarEnd?"Far":"Near")},get onMouseUp(){return J(e.showFarEnd?"Far":"Near")},get onMouseMove(){return le(e.showFarEnd?"Far":"Near")},get onWheel(){return K(e.showFarEnd?"Far":"Near")},get onTouchStart(){return ee(e.showFarEnd?"Far":"Near")},get onTouchMove(){return de(e.showFarEnd?"Far":"Near")},get onTouchEnd(){return ae(e.showFarEnd?"Far":"Near")},get children(){return[_(ht,{get flashingPoints(){return he(()=>!!e.showFarEnd,!0)()?ye():j()},get colourSide(){return xe()},get taperedPointMarkers(){return N()},get highlightLinesByIndices(){return st()},get highlightLengthLabelsByIndices(){return ot()},get highlightAngleLabelsByIndices(){return dt()},onSetLength:(l,c)=>ue(e.showFarEnd,l,c),onSetAngle:te,onStartDraggingLengthLabel:fe,onStartDraggingAngleLabel:ne,onInit:({editing:l,cancelEditing:c,labelUnderMouse:k})=>{e.showFarEnd?rt(()=>k):it(()=>k)}}),_(et,{get showFarEnd(){return e.showFarEnd}})]}});return(()=>{const e=Dt.cloneNode(!0),l=e.firstChild,c=l.firstChild,k=c.nextSibling,R=k.nextSibling,M=R.nextSibling,A=M.nextSibling,T=A.nextSibling,I=T.nextSibling,ie=I.nextSibling,me=ie.nextSibling,X=me.nextSibling,re=X.nextSibling,se=re.nextSibling,Pe=se.nextSibling,E=Pe.nextSibling,Se=E.nextSibling,ve=Se.nextSibling;ve.nextSibling;const De=l.nextSibling;return c.$$click=()=>Q(),k.$$click=()=>G(),R.$$click=()=>H(),M.$$click=()=>Be(),A.$$click=()=>He(),T.$$click=()=>Ve(),I.$$click=()=>je(),ie.$$click=()=>d("taperedPointMarkers",[]),O(l,_(Ze,{get each(){return tt()},children:L=>(()=>{const D=Ft.cloneNode(!0);return D.$$click=()=>L.doIt(),O(D,()=>L.displayName),D})()}),me),X.addEventListener("change",L=>{let D=L.target;d("showGrid",D.checked)}),se.addEventListener("change",L=>{let D=L.currentTarget.checked;d("tapered",D),D||Y(),H()}),ve.addEventListener("change",L=>{let D=L.target;d("fontSize",Number.parseInt(D.value))}),ve.$$input=L=>{let D=L.target;d("fontSize",Number.parseInt(D.value))},O(l,()=>n().instructions?.call(void 0),null),O(De,_(Le,{get when(){return h()},get children(){const L=Et.cloneNode(!0);return L.$$click=()=>{n().endDraw?.call(void 0)},L}}),null),O(De,_(ke,{get fallback(){return _(we,{showFarEnd:!1})},get children(){return _(oe,{get when(){return s.tapered},get children(){const L=At.cloneNode(!0),D=L.firstChild;D.firstChild;const ge=D.nextSibling;return ge.firstChild,O(D,_(we,{showFarEnd:!1}),null),O(ge,_(we,{showFarEnd:!0}),null),L}})}}),null),U(L=>{const D=s.colourSide!=null,ge=s.colourSide==null,Fe=s.taperedPointMarkers.length==0;return D!==L._v$&&(A.disabled=L._v$=D),ge!==L._v$2&&(T.disabled=L._v$2=ge),Fe!==L._v$3&&(ie.disabled=L._v$3=Fe),L},{_v$:void 0,_v$2:void 0,_v$3:void 0}),U(()=>X.checked=s.showGrid),U(()=>se.checked=s.tapered),U(()=>ve.value=s.fontSize),e})()};Ge(["click","input"]);const Wt=F('<button type="button" class="btn btn-primary">Retry</button>'),Ct=F('<div style="border-left: 2px solid black; width: 5px; height: 100%;"></div>'),It=F("<hr>"),Ot=F('<div style="flex-grow: 1; display: flex; flex-direction: column; overflow: hidden"><div><button type="button" class="btn btn-primary">Close</button><br></div><div><div><table><thead></thead><tbody><tr><td style="border: none;"><b>Flashing Name:</b></td><td style="border: none;"><input type="text" class="form-control"></td></tr><tr><td style="border: none;"><b>Material Name:</b></td><td style="border: none;"><input type="text" class="form-control"></td></tr><tr><td style="border: none;"><b>Colour:</b></td><td style="border: none;"><input type="text" class="form-control"></td></tr><tr><td style="border: none;" colspan="2"><input class="btn btn-primary" type="button" value="Add a Length/Qty"></td></tr></tbody></table></div></div></div>'),Ut=F("<h2>Flashing for Job #: <!> (<!>)</h2>"),zt=F('<tr><td style="border: none;"><b>Length <!>:</b></td><td style="border: none;"><input type="text" class="form-control"></td></tr>'),Rt=F('<tr><td style="border: none;"><b>Qty <!>:</b></td><td style="border: none;"><input type="text" class="form-control"></td></tr>'),Qt=F('<tr><td style="border: none;" colspan="2"><input class="btn btn-primary" type="button"></td></tr>'),Kt=p=>{let[t,i]=Ne(void 0);const b=(()=>{const o=ut(async a=>{let r=a[0];try{await ft(r),P("saveError",void 0)}catch(n){P("saveError",n)}P("saving",!1)},500);return(...a)=>{_e(()=>d.ignoreSave)||(P("saving",!0),o(a))}})();Ye(()=>{s()});const s=()=>{let o=t();if(o==null||p.id=="")return;let a=o.flashingPoints,r={flashingId:p.id,flashingName:d.flashingName,materialName:d.materialName,colour:d.colour,lengthQtyList:JSON.parse(JSON.stringify(d.lengthQtyList)),fontSize:o.fontSize,flashingPoints:JSON.parse(JSON.stringify(a)),colourSide:o.colourSide,taperedPointMarkers:o.taperedPointMarkers};b(r)};be(()=>{setTimeout(()=>{P("ignoreSave",!1)})});const[d,P]=B({ignoreSave:!0,saving:!1,layout:window.innerWidth>1.2*window.innerHeight?"horizontal":"vertical",flashingName:p.init?.flashingName??"",materialName:p.init?.materialName??"",colour:p.init?.colour??"",lengthQtyList:p.init?.lengthQtyList??[{length:2e3,qty:1}],tryV2:!1});B(Ee());const S=o=>{P("layout",window.innerWidth>1.2*window.innerHeight?"horizontal":"vertical")};return be(()=>{window.addEventListener("resize",S)}),qe(()=>{window.removeEventListener("resize",S)}),(()=>{const o=Ot.cloneNode(!0),a=o.firstChild,r=a.firstChild;r.nextSibling;const n=a.nextSibling,g=n.firstChild,f=g.firstChild,u=f.firstChild,v=u.nextSibling,x=v.firstChild,h=x.firstChild,y=h.nextSibling,$=y.firstChild,z=x.nextSibling,J=z.firstChild,le=J.nextSibling,K=le.firstChild,ee=z.nextSibling,de=ee.firstChild,ae=de.nextSibling,V=ae.firstChild,j=ee.nextSibling,ye=j.firstChild,xe=ye.firstChild;return O(a,_(ce,{get when(){return p.forJob},children:N=>(()=>{const w=Ut.cloneNode(!0),Q=w.firstChild,Y=Q.nextSibling,G=Y.nextSibling,Z=G.nextSibling;return Z.nextSibling,O(w,()=>N().jobNumber,Y),O(w,()=>N().customerName,Z),w})()}),r),r.$$click=()=>p.onClose(),O(a,_(Le,{get when(){return p.id!=""},get children(){return _(ke,{get children(){return[_(oe,{get when(){return d.saving},children:"Saving..."}),_(oe,{get when(){return!d.saving&&d.saveError==null},children:"Saved"}),_(oe,{get when(){return d.saveError!=null},get children(){return[he(()=>d.saveError?.toString()),(()=>{const N=Wt.cloneNode(!0);return N.$$click=()=>s(),N})()]}})]}})}}),null),$.$$input=N=>{let w=N.target;P("flashingName",w.value)},K.$$input=N=>{let w=N.target;P("materialName",w.value)},V.$$input=N=>{let w=N.target;P("colour",w.value)},O(v,_(Ze,{get each(){return d.lengthQtyList},children:(N,w)=>[(()=>{const Q=zt.cloneNode(!0),Y=Q.firstChild,G=Y.firstChild,Z=G.firstChild,H=Z.nextSibling;H.nextSibling;const ue=Y.nextSibling,te=ue.firstChild;return O(G,()=>w()+1,H),te.$$input=fe=>{let ne=Number.parseFloat(fe.currentTarget.value);!Number.isFinite(ne)||P("lengthQtyList",w(),"length",ne)},U(()=>te.value=_e(()=>N.length)),Q})(),(()=>{const Q=Rt.cloneNode(!0),Y=Q.firstChild,G=Y.firstChild,Z=G.firstChild,H=Z.nextSibling;H.nextSibling;const ue=Y.nextSibling,te=ue.firstChild;return O(G,()=>w()+1,H),te.$$input=fe=>{let ne=Number.parseInt(fe.currentTarget.value);!Number.isFinite(ne)||P("lengthQtyList",w(),"qty",ne)},U(()=>te.value=_e(()=>N.qty)),Q})(),_(Le,{get when(){return w()!=0},get children(){const Q=Qt.cloneNode(!0),Y=Q.firstChild,G=Y.firstChild;return G.$$click=()=>{P("lengthQtyList",[...d.lengthQtyList.slice(0,w()),...d.lengthQtyList.slice(w()+1)])},U(()=>G.value="Delete Length/Qty "+(w()+1)),Q}})]}),j),xe.$$click=()=>{P("lengthQtyList",[...d.lengthQtyList,{length:1e3,qty:1}])},O(n,_(ke,{get children(){return[_(oe,{get when(){return d.layout=="horizontal"},get children(){return Ct.cloneNode(!0)}}),_(oe,{get when(){return d.layout=="vertical"},get children(){return It.cloneNode(!0)}})]}}),null),O(n,_(Tt,{get init(){return p.init},onInit:N=>{P("ignoreSave",!0),i(N),setTimeout(()=>{P("ignoreSave",!1)})}}),null),U(N=>{const w=d.saving,Q="flex-grow: 1; display: flex; flex-direction: "+(d.layout=="horizontal"?"row":"column")+"; overflow-y: auto";return w!==N._v$&&(r.disabled=N._v$=w),N._v$2=at(n,Q,N._v$2),N},{_v$:void 0,_v$2:void 0}),U(()=>$.value=d.flashingName),U(()=>K.value=d.materialName),U(()=>V.value=d.colour),o})()};Ge(["click","input"]);export{Kt as default};
